<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <!-- Font Awesome (√≠cones modernos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<!-- Firebase SDKs -->
<script type="module">
  // Importa as fun√ß√µes necess√°rias
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // üîπ Suas configura√ß√µes do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCPA79g3ucoytsNGWoJXXbnrXva40HieAQ",
    authDomain: "sistema-de-estoque-da603.firebaseapp.com",
    databaseURL: "https://sistema-de-estoque-da603-default-rtdb.firebaseio.com",
    projectId: "sistema-de-estoque-da603",
    storageBucket: "sistema-de-estoque-da603.firebasestorage.app",
    messagingSenderId: "873551516123",
    appId: "1:873551516123:web:f7ce215d844e6586e3d7fe",
    measurementId: "G-8R7RY041J9"
  };

  // üîπ Inicializa o Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîπ Exporta para ser usado no restante do sistema
  window.auth = auth;
  window.db = db;
</script>

  <style>
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
      --cinza: #e0e0e0;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }

    /* ========================= HEADER ========================= */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 900;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      background: none;
      border: none;
      color: var(--branco);
      cursor: pointer;
      font-size: 1.3rem;
    }

    header button:hover {
      color: #e2e2e2;
    }

   /* ========================= MENU LATERAL ========================= */
 #sidebar {
  position: fixed;
  top: 0;
  left: -260px; /* escondido 10px a mais */
  width: 250px;
  height: 100%;
  background: var(--azul-escuro);
  color: var(--branco);
  overflow-y: auto;
  transition: left 0.3s ease;
  z-index: 800;
  padding-top: 60px;
  border-right: none;
  box-shadow: none;
}

/* Quando ativo (aberto) */
#sidebar.active {
  left: 0;
}


    #sidebar.active {
      left: 0;
    }

    #sidebar button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      color: var(--branco);
      text-align: left;
      padding: 14px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      transition: background 0.2s;
    }

    #sidebar button i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================= √ÅREA PRINCIPAL ========================= */
   main {
  margin: 20px;
  padding-left: 0;
  transition: margin-left 0.3s ease;
  overflow-x: hidden; /* impede overflow lateral */
}


    @media (min-width: 900px) {
      #sidebar.active + main {
        margin-left: 250px;
      }
    }

    /* ========================= TABELAS ========================= */
.table-wrap {
  max-height: 60vh;          /* altura m√°xima vis√≠vel */
  overflow-y: auto;          /* rolagem vertical */
  overflow-x: auto;          /* rolagem horizontal se necess√°rio */
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  scrollbar-width: thin;     /* Firefox */
  scrollbar-color: #888 #f0f0f0;
}

/* üîπ Mant√©m o cabe√ßalho fixo dentro da √°rea rol√°vel */
.table-wrap table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px; /* evita desalinhamento */
}

.table-wrap table thead th {
  position: sticky;
  top: 0;
  background: var(--azul);
  color: #fff;
  z-index: 10;
  text-align: left;
  padding: 10px 12px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
}

.table-wrap table td {
  border: 1px solid #ddd;
  padding: 10px 12px;
  font-size: 14px;
}

.table-wrap table tr:nth-child(even) {
  background-color: #f9f9f9;
}

/* üîπ Scrollbar estilizada */
.table-wrap::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.table-wrap::-webkit-scrollbar-track {
  background: #f0f0f0;
  border-radius: 8px;
}
.table-wrap::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 8px;
}
.table-wrap::-webkit-scrollbar-thumb:hover {
  background: #555;
}


    /* ========================= BOT√ïES ========================= */
    button {
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background: var(--azul-escuro);
    }

    /* ========================= INPUTS E SELECTS ========================= */
    input, select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--azul);
    }

    /* ========================= IMAGENS ========================= */
    .thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #imagemAmpliada {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #imagemAmpliada img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      cursor: pointer;
    }

    /* ========================= LOGIN ========================= */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
    }

    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
    }
/* üîπ Centraliza√ß√£o est√°vel da tela de login */
#loginView {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  overflow: hidden;
  z-index: 1000;
}

/* Evita o scroll autom√°tico ao alternar login/sistema */
html, body {
  height: 100%;
  overflow-y: auto; /* ativa rolagem vertical */
  overflow-x: hidden; /* evita rolagem lateral */
}
#loginMsg {
  background: #f8d7da;
  border-radius: 5px;
  padding: 8px;
  font-weight: bold;
}
#loginMsg[style*="green"] {
  background: #d4edda;
}

    /* ========================= SE√á√ïES ========================= */
    section {
      display: none;
    }

    section h2 {
      color: var(--azul-escuro);
      border-left: 5px solid var(--azul);
      padding-left: 10px;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
	/* ========================= ROLAGEM POR SE√á√ÉO ========================= */
.section {
  max-height: calc(100vh - 140px); /* altura vis√≠vel abaixo do cabe√ßalho */
  overflow-y: auto; /* ativa rolagem vertical */
  overflow-x: hidden; /* evita rolagem lateral */
  padding-bottom: 20px; /* espa√ßamento inferior */
  scroll-behavior: smooth; /* rolagem suave */
}
/* ========================= DASHBOARD ========================= */
.dash-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dash-card {
  background: var(--branco);
  border-radius: 10px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  padding: 15px 20px;
  transition: transform 0.2s ease;
}

.dash-card:hover {
  transform: scale(1.02);
}

.dash-card h3 {
  color: var(--azul-escuro);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 5px;
  font-size: 16px;
}

.dash-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dash-card ul li {
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.dash-card ul li:last-child {
  border-bottom: none;
}


    /* ========================= RODAP√â (opcional futuro) ========================= */
  </style>
</head>
<body>

  <!-- IMAGEM AMPLIADA (modal) -->
  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>

  <!-- TELA DE LOGIN -->
  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque</h2>
      <input id="usuarioLogin" type="text" placeholder="Usu√°rio" />
      <input id="senhaLogin" type="password" placeholder="Senha" />
      <button onclick="fazerLogin()"><i class="fa fa-right-to-bracket"></i> Entrar</button>
	  <p id="loginMsg" style="display:none; color:red; font-weight:bold; text-align:center;"></p>
      
      </div>
    </div>
  </div>

  <!-- APLICATIVO PRINCIPAL (escondido at√© login) -->
  <div id="mainApp" style="display:none;">

    <!-- CABE√áALHO -->
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="userName" style="font-weight:700">Visitante</div>
        <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>
        <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar" aria-hidden="true">
	  <button onclick="showSection('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro')"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada')"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida')"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque')"><i class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites')"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro')"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios')"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>

    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main>
<!-- SE√á√ÉO: BOAS-VINDAS -->
<section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
  <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
  <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
  <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
</section>

      <!-- SE√á√ÉO: CADASTRO DE PRODUTOS -->
      <section id="cadastro" class="section">
        <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

        <div class="input-row" style="margin-bottom:10px;gap:8px;">
          <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />
		  
          <select id="produtoCategoria">
  <option value="">Selecione a categoria</option>
  <option>Material de Uso e Consumo</option>
  <option>Copa e Cozinha</option>
  <option>Escrit√≥rio</option>
  <option>Implante e Componentes</option>
  <option>Insumo Dental</option>
  <option>Insumo Laborat√≥rio</option>
  <option>Medicamentos</option>
  <option>Material de Limpeza</option>
</select>
          <select id="produtoEmbalagem">
  <option value="">Selecione o tipo de embalagem</option>
  <option>Ampola</option>
  <option>Caixa</option>
  <option>Fardo</option>
  <option>Frasco</option>
  <option>Garrafa</option>
  <option>Gramas</option>
  <option>Litro</option>
  <option>Pacote</option>
  <option>Pe√ßa</option>
  <option>Quilogramas (KG)</option>
  <option>Saco</option>
  <option>Unidade</option>
</select>
          <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />
		  <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

          <input id="produtoFoto" type="file" accept="image/*" />
          <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>
        </div>

        <div style="margin-bottom:10px;">
          <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
        </div>

        <div class="table-wrap">
          <table id="tabelaProdutos">
            <thead>
              <tr>
                <th>#</th>
                <th>Foto</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Embalagem</th>
                <th>Qtd/Emb.</th>
				 <th>C√≥d. Barras</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

     <!-- SE√á√ÉO: ENTRADA DE MATERIAIS -->
<!-- SE√á√ÉO: ENTRADA DE MATERIAIS -->
<section id="entrada" class="section" style="display:none;">

  <h2><i class="fa fa-arrow-down"></i> Entrada de Materiais</h2>
   <div class="input-row" style="margin-bottom:10px;gap:8px;">
<input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" 
       style="min-width:200px;" oninput="buscarProdutoPorCodigo('entrada')" />
  <div class="input-row" style="margin-bottom:10px;gap:8px;">
    <input id="entradaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" />
    <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
    <input id="entradaData" type="date" style="width:160px" />
    <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
    <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
    <input id="entradaCNPJ" type="text" placeholder="CNPJ" />
    <input id="entradaLote" type="text" placeholder="Lote" />
    <input id="entradaValidade" type="date" placeholder="Validade" />
    
    <select id="entradaSetor">
      <option value="">Selecione o Setor Utilizado</option>
      <option>Limpeza da Cl√≠nica</option>
      <option>Laborat√≥rio</option>
      <option>Escrit√≥rio</option>
      <option>Copa e Cozinha</option>
      <option>Cl√≠nico Geral</option>
      <option>Centro Cir√∫rgico</option>
    </select>

    <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
  </div>

  <div class="table-wrap">
  <table id="tabelaEntradas">
    <thead>
      <tr>
        <th>#</th>
        <th>Produto</th>
        <th>C√≥digo de Barras</th>
        <th>Qtd</th>
        <th>Valor (R$)</th>
        <th>Data</th>
        <th>NF</th>
        <th>Fornecedor</th>
        <th>CNPJ</th>
        <th>Lote</th>
        <th>Validade</th>
        <th>Setor</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</section>



 <!-- SE√á√ÉO: SA√çDA DE MATERIAIS -->
<section id="saida" class="section" style="display:none;">
  <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>

  <div class="input-row" style="margin-bottom:10px;gap:8px;">
  <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="atualizarSetorAutomatico()" />

           
    <input id="saidaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico()" />
    <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
    <input id="saidaObservacao" type="text" placeholder="Observa√ß√£o (opcional)" />
    <select id="saidaSetor">
      <option value="">Selecione o Setor</option>
    </select>
    <input id="saidaData" type="date" style="width:160px" />
    <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, setor ou respons√°vel" style="width:98%" oninput="filtrarSaidas()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaSaidas">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
		   <th>C√≥digo de Barras</th>
          <th>Qtd</th>
          <th>Data</th>
          <th>Setor</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>



      <!-- SE√á√ÉO: ESTOQUE ATUAL -->
      <section id="estoque" class="section" style="display:none;">
        <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>

        <div style="margin-bottom:10px;">
          <input id="filtroEstoque" type="text" placeholder="üîç Buscar no estoque (produto, categoria)" style="width:98%" oninput="filtrarEstoque()" />
        </div>

        <div class="table-wrap">
        <table id="tabelaEstoque">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
      <th>C√≥digo de Barras</th>
      <th>Categoria</th>
      <th>Quantidade</th>
      <th>Lote</th>
      <th>Validade</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
        </div>
      </section>

<!-- FIM DO BLOCO 2/5 -->
<!-- üì¶ SE√á√ÉO: ESTOQUE M√çNIMO E M√ÅXIMO -->
<section id="limites" class="section" style="display:none;">
  <h2><i class="fa fa-boxes"></i> Estoque M√≠nimo e M√°ximo</h2>

  <!-- üîπ Resumo de contagem -->
  <div id="resumoEstoque" style="margin-bottom:10px; font-weight:bold; color:#333;">
    üßæ Total de Produtos: 0 |
    ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
    ‚úÖ Dentro do Limite: 0 |
    üì¶ Acima do M√°ximo: 0
  </div>

  <!-- üîç Filtros -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
    <input
      id="filtroLimite"
      type="text"
      placeholder="üîç Buscar por produto"
      style="flex:1; min-width:220px"
      oninput="atualizarTabelaLimites()"
    />

    <select id="filtroCategoria" onchange="atualizarTabelaLimites()" style="min-width:220px;">
      <option value="">Todas as Categorias</option>
      <option>Material de Uso e Consumo</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante e Componentes</option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>
    </select>

    <button onclick="gerarListaCompra()"><i class="fa fa-list"></i> Gerar Lista de Compra</button>
    <button onclick="limparListaCompra()"><i class="fa fa-trash"></i> Limpar Lista</button>
  </div>

  <!-- üìã Tabela principal -->
  <div class="table-wrap">
  <table id="tabelaLimites">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
      <th>C√≥digo de Barras</th>
      <th>Categoria</th>
      <th>Qtd Atual</th>
      <th>M√≠nimo</th>
      <th>M√°ximo</th>
      <th>Status</th>
      <th>Recomenda√ß√£o</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


  </div>

  
  <!-- üõí Lista de compra -->
<div id="listaCompraContainer" style="display:none; margin-top:20px;">
  <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>

 <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto; border:1px solid #ccc;">
    <table id="tabelaListaCompra" class="tabela-padrao">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Qtd Atual</th>
          <th>M√≠nimo</th>
          <th>Recomendado Comprar</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="6" style="text-align:right; font-weight:bold;">Total de Itens:</td>
          <td id="totalItensCompra" style="font-weight:bold;">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- üîπ A√ß√µes de exporta√ß√£o -->
  <div style="margin-top:10px;">
    <button onclick="exportarListaExcel()">
      <i class="fa fa-file-excel"></i> Exportar para Excel
    </button>
    <button onclick="gerarPedidoPDF()">
      <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF)
    </button>
  </div>
</div>

</section>







      <!-- SE√á√ÉO: FINANCEIRO -->
     
<!-- SE√á√ÉO: PAINEL FINANCEIRO -->
<!-- SE√á√ÉO: PAINEL FINANCEIRO -->
<section id="financeiro" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Painel Financeiro</h2>

  <!-- üî∏ Indicadores financeiros detalhados -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">

    <!-- √öltimo valor de entrada -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ √öltimo Valor de Entrada</h3>
      <p id="valorUltimaEntrada" style="font-size:1.4em; font-weight:bold; color:#007bff;">R$ 0,00</p>
    </div>

    <!-- Custo m√©dio ponderado -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üìä Custo M√©dio Ponderado</h3>
      <p id="valorCustoMedio" style="font-size:1.4em; font-weight:bold; color:#6f42c1;">R$ 0,00</p>
    </div>

    <!-- Valor total do estoque atual -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üì¶ Valor Total do Estoque Atual</h3>
      <p id="valorEstoqueAtualPainel" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Indicadores principais existentes -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ Valor Total do Estoque Atual (Cont√°bil)</h3>
      <p id="valorEstoque" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>

    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∏ Valor Total das Sa√≠das (Estimado)</h3>
      <p id="valorSaidas" style="font-size:1.4em; font-weight:bold; color:#dc3545;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Entradas agrupadas -->
  <h3 style="margin-top:25px;"><i class="fa fa-file-invoice"></i> Entradas Agrupadas por Nota Fiscal</h3>
  <div class="table-wrap">
    <table id="tabelaFinanceiro">
      <thead>
        <tr>
          <th>Fornecedor</th>
          <th>Nota Fiscal</th>
          <th>Valor Total da Nota (R$)</th>
          <th>Saldo da Nota (R$)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>




      <!-- SE√á√ÉO: RELAT√ìRIOS -->
    <!-- SE√á√ÉO: RELAT√ìRIOS -->
<section id="relatorios" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Relat√≥rios</h2>

  <!-- üîπ Bot√µes principais -->
  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
    <button onclick="gerarRelatorioProdutos()"><i class="fa fa-file-excel"></i> Produtos</button>
    <button onclick="gerarRelatorioEntradas()"><i class="fa fa-file-excel"></i> Entradas</button>
    <button onclick="gerarRelatorioSaidas()"><i class="fa fa-file-excel"></i> Sa√≠das</button>
    <button onclick="gerarRelatorioEstoque()"><i class="fa fa-file-excel"></i> Estoque</button>
  </div>

  <!-- üîπ Filtro de per√≠odo -->
  <div id="filtroPeriodo" style="margin: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
    <label><b>Data In√≠cio:</b></label>
    <input type="date" id="dataInicioRelatorio" style="padding: 4px 6px;">

    <label><b>Data Fim:</b></label>
    <input type="date" id="dataFimRelatorio" style="padding: 4px 6px;">

    <button onclick="gerarRelatorio()" style="background:#2b6cb0;color:#fff;padding:4px 8px;border:none;border-radius:4px;">
      <i class="fa fa-filter"></i> Filtrar
    </button>

    <button onclick="definirPeriodoRapido('hoje')">Hoje</button>
    <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
    <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
    <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
    <button onclick="limparPeriodo()">Limpar</button>
  </div>

  <!-- üîπ Informativo -->
  <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <p>Os relat√≥rios s√£o gerados em formato Excel (.csv) e incluem todos os dados das tabelas correspondentes.</p>
  </div>
</section>


      <!-- SE√á√ÉO: USU√ÅRIOS E PERFIS -->
      <section id="usuarios" class="section" style="display:none;">
        <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
          <input id="usuarioNome" type="text" placeholder="Nome" />
          <input id="usuarioCPF" type="text" placeholder="CPF" />
          <input id="usuarioEmail" type="email" placeholder="E-mail" />
          <input id="usuarioSenha" type="password" placeholder="Senha" />
          <select id="usuarioPerfil">
            <option value="admin">Administrador</option>
            <option value="simples1">Simples 01</option>
            <option value="simples2">Simples 02</option>
          </select>
          <button onclick="salvarUsuario()"><i class="fa fa-save"></i> Salvar</button>
        </div>

        <div class="table-wrap">
          <table id="tabelaUsuarios">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Email</th>
                <th>Perfil</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
<section id="dashboard" class="section">
  <h2>üìä Dashboard do Sistema</h2>
  <div class="dash-container">

    <div class="dash-card">
      <h3>üïí Produtos Pr√≥ximos do Vencimento</h3>
      <ul id="listaProximosVencer"></ul>
    </div>

    <div class="dash-card">
      <h3>üí∞ Produtos Mais Caros</h3>
      <ul id="listaMaisCaros"></ul>
    </div>

    <div class="dash-card">
      <h3>üì¶ Produtos Mais Utilizados</h3>
      <ul id="listaMaisSaidas"></ul>
    </div>

    <div class="dash-card">
      <h3>üí§ Produtos com Menos Sa√≠das</h3>
      <ul id="listaMenosSaidas"></ul>
    </div>

    <div class="dash-card">
      <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
      <ul id="listaEstoqueCritico"></ul>
    </div>

    <div class="dash-card">
      <h3>üìà Resumo Geral</h3>
      <div id="resumoGeral"></div>
    </div>

  </div>
  
  
</section>

    </main>
  </div> <!-- fim do mainApp -->
<!-- ===================== -->
<!-- ‚öôÔ∏è SCRIPT PRINCIPAL -->
<!-- ===================== -->
<script>
/* =========================
   üîπ Alternar menu lateral
========================= */
let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let saidas = JSON.parse(localStorage.getItem("saidas")) || [];

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  if (sidebar) sidebar.classList.toggle("active");
}

// Fecha o menu lateral se o usu√°rio clicar fora dele
document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.getElementById("menuToggle");
  if (
    sidebar.classList.contains("active") &&
    !sidebar.contains(e.target) &&
    !menuBtn.contains(e.target)
  ) {
    sidebar.classList.remove("active");
  }
});






/* =========================
   üîπ Mostrar se√ß√£o
========================= */
function showSection(id) {
  // üîπ Oculta todas as se√ß√µes
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");

  // üîπ Mostra apenas a se√ß√£o selecionada
  const alvo = document.getElementById(id);
  if (alvo) alvo.style.display = "block";

  // üîπ Fecha automaticamente o menu lateral em qualquer tamanho de tela
  const sidebar = document.getElementById("sidebar");
  if (sidebar && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
  }

  // üîπ Reposiciona o scroll no topo
  window.scrollTo({ top: 0, behavior: "smooth" });

  // üîπ Atualiza dados se for painel financeiro
  if (id === "financeiro" && typeof atualizarPainelFinanceiro === "function") {
    atualizarPainelFinanceiro();
  }

  // üîπ Atualiza dados se for o dashboard
  if (id === "dashboard" && typeof atualizarDashboard === "function") {
    atualizarDashboard();
  }
}

// üîπ Mant√©m a tela centralizada no login
window.scrollTo(0, 0);


/* =========================
   üîπ Logout
========================= */

function logout() {
  // üîπ Remove sess√£o salva
  localStorage.removeItem("usuarioLogado");

  // üîπ Esconde o app e volta para tela de login
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginView").style.display = "flex";

  // üîπ Limpa os campos de login e mensagem
  const usuarioEl = document.getElementById("usuarioLogin");
  const senhaEl = document.getElementById("senhaLogin");
  const msg = document.getElementById("loginMsg");

  if (usuarioEl) usuarioEl.value = "";
  if (senhaEl) senhaEl.value = "";
  if (msg) {
    msg.textContent = "";
    msg.style.display = "none";
  }

  // üîπ Opcional: foco no campo usu√°rio
  usuarioEl.focus();
}

/* =========================
   üîπ Login
========================= */

/* ================================
   üîê LOGIN, VERIFICA√á√ÉO E LOGOUT
================================ */

// Executa quando o DOM estiver pronto
document.addEventListener("DOMContentLoaded", () => {
  verificarSessao();
});

<!-- üîπ Firebase compat√≠vel com GitHub Pages -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCPA79g3ucoytsNGWoJXXbnrXva40HieAQ",
    authDomain: "sistema-de-estoque-da603.firebaseapp.com",
    databaseURL: "https://sistema-de-estoque-da603-default-rtdb.firebaseio.com",
    projectId: "sistema-de-estoque-da603",
    storageBucket: "sistema-de-estoque-da603.appspot.com",
    messagingSenderId: "873551516123",
    appId: "1:873551516123:web:f7ce215d844e6586e3d7fe",
    measurementId: "G-8R7RY041J9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  async function fazerLogin() {
    const nome = document.getElementById("usuarioLogin")?.value.trim();
    const senha = document.getElementById("senhaLogin")?.value.trim();
    const msg = document.getElementById("loginMsg");

    msg.style.display = "none";
    msg.textContent = "";

    if (!nome || !senha) {
      msg.textContent = "‚ö†Ô∏è Preencha usu√°rio e senha.";
      msg.style.display = "block";
      msg.style.color = "red";
      return;
    }

    try {
      const userCredential = await auth.signInWithEmailAndPassword(nome, senha);
      const user = userCredential.user;

      msg.textContent = "‚úÖ Login realizado com sucesso!";
      msg.style.display = "block";
      msg.style.color = "green";

      const sessao = { email: user.email, logado: true, loginTime: Date.now() };
      localStorage.setItem("usuarioLogado", JSON.stringify(sessao));

      setTimeout(() => mostrarSistema(sessao), 600);
    } catch (error) {
      console.error("Erro no login:", error.message);
      msg.textContent = "‚ùå Usu√°rio ou senha incorretos!";
      msg.style.display = "block";
      msg.style.color = "red";
    }
  }

  // Permite pressionar ENTER para logar
  document.addEventListener("keydown", function (event) {
    const loginView = document.getElementById("loginView");
    if (loginView && loginView.style.display !== "none" && event.key === "Enter") {
      event.preventDefault();
      fazerLogin();
    }
  });

  window.fazerLogin = fazerLogin;
</script>






// === MOSTRA SISTEMA ===
function mostrarSistema(sessao) {
  const loginView = document.getElementById("loginView");
  const mainApp = document.getElementById("mainApp");
  const userName = document.getElementById("userName");
  const perfilBadge = document.getElementById("perfilBadge");
  const sidebar = document.getElementById("sidebar");

  if (loginView && mainApp) {
    loginView.style.display = "none";
    mainApp.style.display = "block";
  }

  if (userName && sessao?.nome) userName.textContent = sessao.nome;
  if (perfilBadge && sessao?.perfil)
    perfilBadge.textContent = "Perfil: " + sessao.perfil.toUpperCase();

  // üîπ Mostra mensagem de boas-vindas
  const nomeBemVindo = document.getElementById("nomeUsuarioBemVindo");
  if (nomeBemVindo) nomeBemVindo.textContent = sessao.nome;

  // üîπ Oculta todas as outras se√ß√µes e mostra apenas a de boas-vindas
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
  const boasVindas = document.getElementById("boasVindas");
  if (boasVindas) boasVindas.style.display = "block";

  // üîπ Garante que o menu lateral esteja fechado
  if (sidebar && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
  }

  // üîπ Atualiza vari√°veis e permiss√µes
  window.usuarioLogado = sessao;

  if (typeof aplicarPermissoes === "function") aplicarPermissoes();
  if (typeof bloquearAcoesSimples2 === "function") bloquearAcoesSimples2();
}



// === VERIFICA√á√ÉO DE SESS√ÉO (ao carregar) ===
function verificarSessao() {
  const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado") || "{}");

  const loginView = document.getElementById("loginView");
  const mainApp = document.getElementById("mainApp");

  if (!loginView || !mainApp) {
    console.warn("‚ö†Ô∏è Estrutura de interface ainda n√£o carregada.");
    return;
  }

  if (usuarioLogado.logado) {
    mostrarSistema(usuarioLogado);
  } else {
    voltarParaLogin();
  }
}

// === FUN√á√ÉO DE LOGOUT ===
function sairDoSistema() {
  localStorage.removeItem("usuarioLogado");
  alert("Sess√£o encerrada. Fa√ßa login novamente.");
  voltarParaLogin();
}

// === VOLTAR PARA LOGIN ===
function voltarParaLogin() {
  const loginView = document.getElementById("loginView");
  const mainApp = document.getElementById("mainApp");

  if (loginView && mainApp) {
    loginView.style.display = "block";
    mainApp.style.display = "none";
  }

  localStorage.removeItem("usuarioLogado");
}




/* =========================
   üîπ Permiss√µes
========================= */
function aplicarPermissoes() {
  const perfil = window.usuarioLogado?.perfil;
  const botoes = document.querySelectorAll("#sidebar button");
  botoes.forEach((b) => (b.style.display = "block"));

  if (perfil === "simples1") {
    ocultarBotoes(["financeiro"]);
  } else if (perfil === "simples2") {
    ocultarBotoes([
      "cadastro",
      "entrada",
      "saida",
      "limites",
      "financeiro",
      "usuarios",
    ]);
  }
}

function ocultarBotoes(lista) {
  lista.forEach((id) => {
    const botao = document.querySelector(`#sidebar button[onclick*="${id}"]`);
    if (botao) botao.style.display = "none";
  });
}

/* =========================
   üîπ Bloquear a√ß√µes Simples 02
========================= */
function bloquearAcoesSimples2() {
  const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (!usuario || usuario.perfil !== "simples2") return;
  document.querySelectorAll("button").forEach((btn) => {
    const t = btn.textContent.toLowerCase();
    if (t.includes("salvar") || t.includes("editar") || t.includes("excluir") || t.includes("registrar")) {
      btn.disabled = true;
      btn.style.opacity = "0.6";
      btn.style.cursor = "not-allowed";
    }
  });
}

/* =========================
   üîπ Cadastro de produtos
========================= */
/* =========================
   üîπ Cadastro de produtos
========================= */
function cadastrarProduto() {
  if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();

  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEl = document.getElementById("produtoQtdEmbalagem");
  const fotoInput = document.getElementById("produtoFoto");
  const codigoBarrasEl = document.getElementById("produtoCodigoBarras");
  const codigoBarras = codigoBarrasEl ? codigoBarrasEl.value.trim() : "";

  // üîπ Remove marca√ß√µes anteriores
  [nomeEl, categoriaEl, embalagemEl, qtdEl, fotoInput, codigoBarrasEl].forEach(el => {
    if (el) el.style.border = "1px solid #ccc";
  });

  // üîπ Valida√ß√µes ‚Äî mant√©m o que foi digitado
  if (!nomeEl.value.trim()) {
    alert("Informe o nome do produto!");
    nomeEl.style.border = "2px solid red";
    nomeEl.focus();
    return false;
  }

  if (!categoriaEl.value.trim()) {
    alert("Selecione a categoria do produto!");
    categoriaEl.style.border = "2px solid red";
    categoriaEl.focus();
    return false;
  }

  if (!embalagemEl.value.trim()) {
    alert("Selecione o tipo de embalagem!");
    embalagemEl.style.border = "2px solid red";
    embalagemEl.focus();
    return false;
  }

  if (!qtdEl.value || Number(qtdEl.value) <= 0) {
    alert("Informe a quantidade por embalagem!");
    qtdEl.style.border = "2px solid red";
    qtdEl.focus();
    return false;
  }

  if (!fotoInput.files || !fotoInput.files[0]) {
    alert("√â obrigat√≥rio inserir uma foto do produto!");
    fotoInput.style.border = "2px solid red";
    fotoInput.focus();
    return false;
  }

  // üîπ Verifica se j√° existe um produto com o mesmo nome
  const nome = nomeEl.value.trim();
  const nomeNormalizado = nome.toLowerCase();
  const produtoDuplicado = produtos.some(
    (p) => p.nome && p.nome.trim().toLowerCase() === nomeNormalizado
  );

  if (produtoDuplicado) {
    alert(`J√° existe um produto cadastrado com o nome "${nome}".`);
    nomeEl.style.border = "2px solid red";
    nomeEl.focus();
    return false;
  }

  // üîπ Verifica duplicidade de c√≥digo de barras
  if (codigoBarras) {
    const existeCodigo = produtos.some(p => p.codigoBarras === codigoBarras);
    if (existeCodigo) {
      alert("J√° existe um produto cadastrado com este c√≥digo de barras!");
      codigoBarrasEl.style.border = "2px solid red";
      codigoBarrasEl.focus();
      return false;
    }
  }

  // üîπ Coleta dados restantes
  const categoria = categoriaEl.value.trim();
  const embalagem = embalagemEl.value.trim();
  const qtdEmbalagem = qtdEl.value;

  // üîπ L√™ a imagem antes de salvar
  const reader = new FileReader();
  reader.onload = (e) => {
    const foto = e.target.result;

    produtos.push({
      nome,
      categoria,
      embalagem,
      qtdEmbalagem,
      foto,
      quantidade: 0,
      codigoBarras: codigoBarras || ""
    });

    localStorage.setItem("produtos", JSON.stringify(produtos));
    atualizarTabelaProdutos();

    if (typeof ordenarListasAlfabeticamente === "function") ordenarListasAlfabeticamente();

    alert("Produto cadastrado com sucesso!");

    // ‚úÖ Limpa os campos somente ap√≥s sucesso
    [nomeEl, categoriaEl, embalagemEl, qtdEl, fotoInput, codigoBarrasEl].forEach(el => el.value = "");
  };

  reader.readAsDataURL(fotoInput.files[0]);
  return true;
}







function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  tbody.innerHTML = "";
  produtos.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.foto ? `<img src="${p.foto}" class="thumb" onclick="ampliarImagem('${p.foto}')">` : "-"}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.embalagem}</td>
      <td>${p.qtdEmbalagem}</td>
      <td style="font-size:12px; color:#555;">${p.codigoBarras || "-"}</td>
      <td>
        <button onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
        <button onclick="excluirProduto(${i})"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}


function excluirProduto(i) {
  if (!confirm("Excluir este produto?")) return;
  produtos.splice(i, 1);
  localStorage.setItem("produtos", JSON.stringify(produtos));
  atualizarTabelaProdutos();
  preencherProdutosSelect();
}

function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  modal.style.display = "flex";
  modal.querySelector("img").src = src;
}
function editarProduto(i) {
  const p = produtos[i];
  document.getElementById("produtoNome").value = p.nome;
  document.getElementById("produtoCategoria").value = p.categoria;
  document.getElementById("produtoEmbalagem").value = p.embalagem;
  document.getElementById("produtoQtdEmbalagem").value = p.qtdEmbalagem;

  // Remove o produto da lista temporariamente para regravar
  produtos.splice(i, 1);
  localStorage.setItem("produtos", JSON.stringify(produtos));
  atualizarTabelaProdutos();
  
sincronizarNomeProdutoAntigo(novoNome, nomeAntigo);
  alert("Edite os campos e clique em 'Cadastrar' para salvar as altera√ß√µes.");
}

/* =========================
   üîπ Registrar Entrada (vers√£o corrigida)
========================= */
/* =========================
   üîπ Registrar Entrada (vers√£o final)
========================= */
function registrarEntrada() {
  // üîπ Carrega arrays globais
  entradas = JSON.parse(localStorage.getItem("entradas")) || [];
  produtos = JSON.parse(localStorage.getItem("produtos")) || [];

  // üîπ Refer√™ncias dos campos
  const produtoEl = document.getElementById("entradaProduto");
  const qtdEl = document.getElementById("entradaQuantidade");
  const valorEl = document.getElementById("entradaValor");
  const dataEl = document.getElementById("entradaData");
  const notaEl = document.getElementById("entradaNota");
  const fornecedorEl = document.getElementById("entradaFornecedor");
  const cnpjEl = document.getElementById("entradaCNPJ");
  const loteEl = document.getElementById("entradaLote");
  const validadeEl = document.getElementById("entradaValidade");
  const setorEl = document.getElementById("entradaSetor");

  const campos = [produtoEl, qtdEl, valorEl, dataEl, notaEl, fornecedorEl, cnpjEl, loteEl, validadeEl, setorEl];
  campos.forEach(el => (el.style.border = "1px solid #ccc"));

  // üîπ Valida√ß√£o simples
  if (!produtoEl.value.trim()) return alert("Informe o nome do produto!");
  if (!qtdEl.value || Number(qtdEl.value) <= 0) return alert("Informe a quantidade!");
  if (!valorEl.value || Number(valorEl.value) <= 0) return alert("Informe o valor unit√°rio!");
  if (!dataEl.value) return alert("Selecione a data!");
  if (!notaEl.value.trim()) return alert("Informe a nota fiscal!");
  if (!fornecedorEl.value.trim()) return alert("Informe o fornecedor!");

  // üîπ CNPJ (deve ter 14 d√≠gitos)
  const cnpj = cnpjEl.value.trim();
  const apenasNums = cnpj.replace(/\D/g, "");
  if (apenasNums.length !== 14) {
    alert("CNPJ deve conter 14 n√∫meros. Exemplo: 12.345.678/0001-90");
    cnpjEl.style.border = "2px solid red";
    return false;
  }

  if (!loteEl.value.trim()) return alert("Informe o n√∫mero do lote!");
  if (!validadeEl.value) return alert("Selecione a validade!");
  if (!setorEl.value.trim()) return alert("Selecione o setor!");

  // üîπ Monta o objeto da nova entrada
  const novaEntrada = {
    produto: produtoEl.value.trim(),
    qtd: Number(qtdEl.value),
    valor: Number(valorEl.value),
    data: dataEl.value,
    nota: notaEl.value.trim(),
    fornecedor: fornecedorEl.value.trim(),
    cnpj: cnpj,
    lote: loteEl.value.trim(),
    validade: validadeEl.value,
    setor: setorEl.value.trim(),
  };

  // üîπ Salva no localStorage
  entradas.push(novaEntrada);
  localStorage.setItem("entradas", JSON.stringify(entradas));

  // üîπ Atualiza produto relacionado
  const produtoRef = produtos.find(p => p.nome.trim().toLowerCase() === novaEntrada.produto.trim().toLowerCase());
  if (produtoRef) {
    produtoRef.lote = novaEntrada.lote;
    produtoRef.validade = novaEntrada.validade;
    localStorage.setItem("produtos", JSON.stringify(produtos));
  }

  // üîπ Atualiza as tabelas
  atualizarEstoque(novaEntrada.produto, novaEntrada.qtd);
  atualizarTabelaEntradas();
  atualizarTabelaEstoque();
  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();

  alert("Entrada registrada com sucesso!");

  // üîπ Limpa todos os campos para novo lan√ßamento
  campos.forEach(el => {
    if (el.tagName === "SELECT") el.selectedIndex = 0;
    else el.value = "";
  });

  // üîπ Posiciona o cursor no campo de produto
  produtoEl.focus();

  return true;
}







function buscarCodigoBarrasDoProduto(nomeProduto) {
  if (!Array.isArray(produtos)) return "-";
  const prod = produtos.find(p => p.nome === nomeProduto);
  return prod ? prod.codigoBarras : "-";
}





function atualizarTabelaEntradas() {
  const tbody = document.querySelector("#tabelaEntradas tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  // üîπ Pega todas as entradas do localStorage
  const entradas = JSON.parse(localStorage.getItem("entradas")) || [];

  // üîπ Caso n√£o haja registros
  if (!entradas || entradas.length === 0) {
    tbody.innerHTML = `<tr><td colspan="13" style="text-align:center; color:#777;">Nenhuma entrada registrada.</td></tr>`;
    return;
  }

  // üîπ Ordena alfabeticamente pelo nome do produto
  const entradasOrdenadas = [...entradas].sort((a, b) =>
    (a.produto || "").localeCompare(b.produto || "", "pt-BR", { sensitivity: "base" })
  );

  // üîπ Recria as linhas da tabela
  entradasOrdenadas.forEach((e, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${e.produto || "-"}</td>
      <td>${buscarCodigoBarrasDoProduto(e.produto) || "-"}</td>
      <td>${e.qtd || 0}</td>
      <td>${(e.valor !== undefined && e.valor !== null) ? Number(e.valor).toFixed(2) : "0.00"}</td>
      <td>${e.data || "-"}</td>
      <td>${e.nota || "-"}</td>
      <td>${e.fornecedor || "-"}</td>
      <td>${e.cnpj || "-"}</td>
      <td>${e.lote || "-"}</td>
      <td>${e.validade || "-"}</td>
      <td>${e.setor || "-"}</td>
      <td>
        <button class="btnEditar" onclick="editarEntradaPorNota(${JSON.stringify(e.nota)})">
          <i class="fa fa-edit"></i>
        </button>
        <button class="btnExcluir" onclick="excluirEntradaPorNota(${JSON.stringify(e.nota)})">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function editarEntrada(i) {
  const e = entradas[i];
  if (!e) return;

  document.getElementById("entradaProduto").value = e.produto;
  document.getElementById("entradaQuantidade").value = e.qtd;
  document.getElementById("entradaValor").value = e.valor;
  document.getElementById("entradaData").value = e.data;
  document.getElementById("entradaNota").value = e.nota;
  document.getElementById("entradaFornecedor").value = e.fornecedor;
  document.getElementById("entradaCNPJ").value = e.cnpj;
  document.getElementById("entradaLote").value = e.lote;
  document.getElementById("entradaValidade").value = e.validade;
  document.getElementById("entradaSetor").value = e.setor;

  // guarda o √≠ndice e a quantidade anterior
  localStorage.setItem("indiceEntradaEditando", i);
  localStorage.setItem("entradaQtdAnterior", e.qtd);

  alert("Edite os campos e clique em 'Registrar Entrada' para salvar as altera√ß√µes.");
}


function excluirEntrada(i) {
  if (!confirm("Excluir esta entrada?")) return;
  entradas.splice(i, 1);
  localStorage.setItem("entradas", JSON.stringify(entradas));
  atualizarTabelaEntradas();
}
// Retorna true se o CNPJ for v√°lido (verifica√ß√£o dos d√≠gitos verificadores)
function validarCNPJ(cnpj) {
  if (!cnpj) return false;
  const apenasNums = cnpj.replace(/\D/g, "");
  if (apenasNums.length !== 14) return false;

  // Elimina CNPJs repetidos como "00000000000000", "11111111111111", ...
  if (/^(\d)\1+$/.test(apenasNums)) return false;

  const validarDigito = (base, fatores) => {
    let soma = 0;
    for (let i = 0; i < base.length; i++) {
      soma += parseInt(base.charAt(i), 10) * fatores[i];
    }
    const resto = soma % 11;
    return resto < 2 ? 0 : 11 - resto;
  };

  const nums = apenasNums.split("").map(n => parseInt(n, 10));
  // fatores para o primeiro digito verificador
  const fatores1 = [5,4,3,2,9,8,7,6,5,4,3,2];
  const dv1 = validarDigito(nums.slice(0,12).join(""), fatores1);
  if (dv1 !== nums[12]) return false;

  // fatores para o segundo digito verificador
  const fatores2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
  const dv2 = validarDigito(nums.slice(0,13).join(""), fatores2);
  if (dv2 !== nums[13]) return false;

  return true;
}

// Formata em xx.xxx.xxx/xxxx-xx conforme digita/cola
function aplicarMascaraCNPJ(valor) {
  let v = valor.replace(/\D/g, "").substring(0,14);
  if (v.length > 12) {
    return v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, "$1.$2.$3/$4-$5");
  } else if (v.length > 8) {
    return v.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4})/, "$1.$2.$3/$4");
  } else if (v.length > 5) {
    return v.replace(/^(\d{2})(\d{3})(\d{0,3})/, "$1.$2.$3");
  } else if (v.length > 2) {
    return v.replace(/^(\d{2})(\d{0,3})/, "$1.$2");
  }
  return v;
}

// Aplica m√°scara em inputs que tenham "cnpj" no id ou name
document.addEventListener("input", (e) => {
  const el = e.target;
  if (!(el.tagName === "INPUT" && el.type === "text")) return;

  if (/cnpj/i.test((el.id || "") + (el.name || ""))) {
    const pos = el.selectionStart;
    const antes = el.value;
    const form = aplicarMascaraCNPJ(antes);
    el.value = form;

    // tenta restaurar cursor de forma razo√°vel
    // calcula diferen√ßa de comprimento e ajusta cursor para a direita
    const diff = form.length - antes.length;
    const novoPos = Math.max(0, pos + diff);
    try { el.setSelectionRange(novoPos, novoPos); } catch (err) {}
  }
});

// Ao colar, for√ßa formata√ß√£o correta (para casos em que cola com pontos/tra√ßos)
document.addEventListener("paste", (e) => {
  const el = e.target;
  if (!(el.tagName === "INPUT" && el.type === "text")) return;
  if (/cnpj/i.test((el.id || "") + (el.name || ""))) {
    e.preventDefault();
    const texto = (e.clipboardData || window.clipboardData).getData('text') || '';
    el.value = aplicarMascaraCNPJ(texto);
  }
});

/* =========================
   üîπ Busca produto pelo c√≥digo de barras (Entrada ou Sa√≠da)
========================= */
function buscarProdutoPorCodigo(contexto) {
  const campoCodigo = document.getElementById(`${contexto}CodigoBarras`);
  if (!campoCodigo) return;

  const codigo = campoCodigo.value.trim();
  if (!codigo) return;

  const produto = produtos.find(p => p.codigoBarras === codigo);
  if (!produto) {
    campoCodigo.style.border = "2px solid red";
    campoCodigo.title = "C√≥digo de barras n√£o encontrado.";
    return;
  }

  campoCodigo.style.border = "1px solid #ccc";
  campoCodigo.title = "";

  // Preenche o campo do nome automaticamente
  const campoProduto = document.getElementById(`${contexto}Produto`);
  if (campoProduto) campoProduto.value = produto.nome;
}



/* =========================
   üîπ Sa√≠das
========================= */


// Fun√ß√£o principal: valida e grava a sa√≠da (retorna true em sucesso, false em erro)
function registrarSaida() {
  if (typeof padronizarCamposAntesDeSalvar === "function") padronizarCamposAntesDeSalvar();

  const produtoEl = document.getElementById("saidaProduto");
  const qtdEl = document.getElementById("saidaQuantidade");
  const responsavelEl = document.getElementById("saidaResponsavel");
  const observacaoEl = document.getElementById("saidaObservacao");
  const setorEl = document.getElementById("saidaSetor");
  const dataEl = document.getElementById("saidaData");

  // Protege caso algum elemento falte no DOM (evita TypeError)
  const camposParaReset = [produtoEl, qtdEl, responsavelEl, setorEl, dataEl];
  camposParaReset.forEach(el => { if (el) el.style.border = "1px solid #ccc"; });

  // Valida√ß√µes ‚Äî mant√™m os valores preenchidos em caso de erro
  if (!produtoEl || !produtoEl.value.trim()) {
    alert("Informe o nome do produto!");
    if (produtoEl) { produtoEl.style.border = "2px solid red"; produtoEl.focus(); }
    return false;
  }

  if (!qtdEl || !qtdEl.value || Number(qtdEl.value) <= 0) {
    alert("Informe a quantidade da sa√≠da (maior que zero)!");
    if (qtdEl) { qtdEl.style.border = "2px solid red"; qtdEl.focus(); }
    return false;
  }

  if (!setorEl || !setorEl.value.trim()) {
    alert("Selecione o setor!");
    if (setorEl) { setorEl.style.border = "2px solid red"; setorEl.focus(); }
    return false;
  }

  if (!dataEl || !dataEl.value) {
    alert("Selecione a data da sa√≠da!");
    if (dataEl) { dataEl.style.border = "2px solid red"; dataEl.focus(); }
    return false;
  }

  if (!responsavelEl || !responsavelEl.value.trim()) {
    alert("Informe o respons√°vel pela sa√≠da!");
    if (responsavelEl) { responsavelEl.style.border = "2px solid red"; responsavelEl.focus(); }
    return false;
  }

  // Coleta os valores (observa√ß√£o opcional)
  const produto = produtoEl.value.trim();
  const qtd = Number(qtdEl.value);
  const setor = setorEl.value.trim();
  const data = dataEl.value;
  const responsavel = responsavelEl.value.trim();
  const observacao = observacaoEl ? observacaoEl.value.trim() : "";

  // Verifica exist√™ncia do produto no cadastro
  const produtoEstoque = produtos.find(p => (p.nome || "").trim().toLowerCase() === produto.toLowerCase());
  if (!produtoEstoque) {
    alert(`Produto "${produto}" n√£o encontrado no cadastro.`);
    if (produtoEl) { produtoEl.style.border = "2px solid red"; produtoEl.focus(); }
    return false;
  }

  // Verifica estoque suficiente
  const estoqueAtual = Number(produtoEstoque.quantidade || 0);
  if (estoqueAtual < qtd) {
    alert(`Estoque insuficiente: h√° ${estoqueAtual} unidade(s) dispon√≠veis.`);
    if (qtdEl) { qtdEl.style.border = "2px solid red"; qtdEl.focus(); }
    return false;
  }

  // Tudo ok -> registra a sa√≠da
  saidas.push({ produto, qtd, data, setor, responsavel, observacao });
  localStorage.setItem("saidas", JSON.stringify(saidas));

  // Atualiza estoque (subtrai) e tabelas
  atualizarEstoque(produto, -qtd);
  if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();

  alert("Sa√≠da registrada com sucesso!");
  return true;
}

// Wrapper: chama registrarSaida e limpa os campos somente se retornar true
const _registrarSaidaOriginal = registrarSaida;
registrarSaida = function() {
  try {
    const result = _registrarSaidaOriginal();
    if (result === true) {
      // limpa os campos da se√ß√£o "saida" ap√≥s sucesso
      setTimeout(() => limparCampos("saida"), 300);
    } else {
      // mant√©m os dados e navega at√© o campo com erro (se houver)
      const erroEl = document.querySelector("#saida input[style*='red'], #saida select[style*='red']");
      if (erroEl) erroEl.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  } catch (err) {
    console.error("Erro ao registrar sa√≠da:", err);
  }
};


function atualizarTabelaSaidas() {
  const tbody = document.querySelector("#tabelaSaidas tbody");
  tbody.innerHTML = "";
  saidas.forEach((s, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
  <td>${i + 1}</td>
  <td>${s.produto || "-"}</td>
  <td>${buscarCodigoBarrasDoProduto(s.produto) || "-"}</td>
  <td>${s.qtd || 0}</td>
  <td>${s.data || "-"}</td>
  <td>${s.setor || "-"}</td>
  <td>${s.responsavel || "-"}</td>
  <td>${s.observacao || "-"}</td>
  <td>
    <button onclick="editarSaida(${i})"><i class="fa fa-edit"></i></button>
    <button onclick="excluirSaida(${i})"><i class="fa fa-trash"></i></button>
  </td>
`;

    tbody.appendChild(row);
  });
}
function atualizarSetoresPorProduto() {
  const produtoNome = document.getElementById("saidaProduto").value.trim();
  const setorSelect = document.getElementById("saidaSetor");

  // Deixa apenas a op√ß√£o padr√£o ao carregar / quando o campo estiver vazio
  setorSelect.innerHTML = `<option value="">Selecione o Setor</option>`;

  // Se o usu√°rio n√£o digitou nada, manter somente a op√ß√£o padr√£o (vazio)
  if (!produtoNome) return;

  // Se o usu√°rio come√ßou a digitar, preenche com a lista COMPLETA de setores
  const setoresCompletos = [
    "Limpeza da Cl√≠nica",
    "Laborat√≥rio",
    "Escrit√≥rio",
    "Copa e Cozinha",
    "Cl√≠nico Geral",
    "Centro Cir√∫rgico"
  ];

  setorSelect.innerHTML = setoresCompletos
    .map(s => `<option value="${s}">${s}</option>`)
    .join("");
}








function editarSaida(i) {
  const s = saidas[i];
  document.getElementById("saidaProduto").value = s.produto;
  document.getElementById("saidaQuantidade").value = s.qtd;
  document.getElementById("saidaResponsavel").value = s.responsavel;
  document.getElementById("saidaObservacao").value = s.observacao;
  document.getElementById("saidaSetor").value = s.setor;
  document.getElementById("saidaData").value = s.data;

  saidas.splice(i, 1);
  localStorage.setItem("saidas", JSON.stringify(saidas));
  atualizarTabelaSaidas();
  ordenarListasAlfabeticamente();

  atualizarSetoresPorProduto(); // üîπ garante que o select de setores seja recarregado

  alert("Edite os campos e clique em 'Registrar Sa√≠da' para salvar as altera√ß√µes.");
}


function excluirSaida(i) {
  if (!confirm("Excluir esta sa√≠da?")) return;
  saidas.splice(i, 1);
  localStorage.setItem("saidas", JSON.stringify(saidas));
  atualizarTabelaSaidas();
  ordenarListasAlfabeticamente(); 
}

/* =========================
   üîπ Atualiza setor automaticamente ao digitar ou ler c√≥digo de barras
========================= */
function atualizarSetorAutomatico() {
  const produtoInput = document.getElementById("saidaProduto");
  const codigoInput = document.getElementById("saidaCodigoBarras");
  const setorSelect = document.getElementById("saidaSetor");

  if (!produtoInput || !setorSelect) return;

  const nomeProduto = produtoInput.value.trim();
  const codigo = codigoInput ? codigoInput.value.trim() : "";

  let entradaEncontrada = null;

  // üîπ Primeiro tenta achar pela leitura do c√≥digo de barras
  if (codigo && Array.isArray(produtos)) {
    const produto = produtos.find(p => p.codigoBarras === codigo);
    if (produto) {
      produtoInput.value = produto.nome;
      entradaEncontrada = (entradas || []).slice().reverse().find(e => e.produto === produto.nome);
    }
  }

  // üîπ Se n√£o achou pelo c√≥digo, busca pelo nome
  if (!entradaEncontrada && nomeProduto) {
    entradaEncontrada = (entradas || []).slice().reverse().find(e => e.produto === nomeProduto);
  }

  // üîπ Atualiza o campo de setor
  if (entradaEncontrada) {
    setorSelect.innerHTML = `<option value="${entradaEncontrada.setor}">${entradaEncontrada.setor}</option>`;
  } else {
    setorSelect.innerHTML = `<option value="">Setor n√£o encontrado</option>`;
  }
}



/* =========================
   üîπ Atualizar Estoque
========================= */
function atualizarEstoque(produto, delta) {
  const item = produtos.find((p) => p.nome === produto);
  if (item) {
    item.quantidade = (item.quantidade || 0) + delta;
    if (item.quantidade < 0) item.quantidade = 0;
    localStorage.setItem("produtos", JSON.stringify(produtos));
    atualizarTabelaEstoque();
	ordenarListasAlfabeticamente();
  }
}

function atualizarTabelaEstoque() {
  const tbody = document.querySelector("#tabelaEstoque tbody");
  tbody.innerHTML = "";

  if (!Array.isArray(produtos) || produtos.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#777;">Nenhum produto em estoque.</td></tr>`;
    return;
  }

  produtos.forEach((p, i) => {
    const status = p.quantidade > 0 ? "‚úÖ OK" : "‚ö†Ô∏è Vazio";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome || "-"}</td>
      <td>${p.codigoBarras || "-"}</td>
      <td>${p.categoria || "-"}</td>
      <td>${p.quantidade || 0}</td>
      <td>${p.lote || "-"}</td>
      <td>${p.validade || "-"}</td>
      <td>${status}</td>
    `;
    tbody.appendChild(row);
  });
}



// üîπ Atualiza a tabela principal de produtos com limites
function atualizarTabelaLimites() {
  const produtos = JSON.parse(localStorage.getItem("produtos")) || [];
  const filtroTexto = (document.getElementById("filtroLimite")?.value || "").toLowerCase();
  const filtroCategoria = (document.getElementById("filtroCategoria")?.value || "").toLowerCase();
  const tbody = document.querySelector("#tabelaLimites tbody");
  const resumo = document.getElementById("resumoEstoque");

  if (!tbody) return;
  tbody.innerHTML = "";

  let total = 0,
      abaixo = 0,
      dentro = 0,
      acima = 0;

  if (!produtos.length) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; color:#777;">Nenhum produto cadastrado.</td></tr>`;
    if (resumo)
      resumo.innerHTML = `üßæ Total de Produtos: 0 | ‚ö†Ô∏è Abaixo do M√≠nimo: 0 | ‚úÖ Dentro do Limite: 0 | üì¶ Acima do M√°ximo: 0`;
    return;
  }

  produtos.forEach((p, i) => {
    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();

    const minimo = Number(p.minimo) || 0;
    const maximo = Number(p.maximo) || 0;
    const qtd = Number(p.quantidade) || 0;

    // calcula status e recomenda√ß√£o ANTES do filtro de texto
    let statusTexto = "";
    let statusCor = "";
    let recomendacao = "";

    if (qtd < minimo) {
      statusTexto = "‚ö†Ô∏è Abaixo do m√≠nimo";
      statusCor = "red";
      recomendacao = `Comprar ${minimo - qtd} unidade(s)`;
    } else if (maximo && qtd > maximo) {
      statusTexto = "üì¶ Acima do m√°ximo";
      statusCor = "orange";
      recomendacao = "Reduzir estoque";
    } else {
      statusTexto = "‚úÖ Dentro do limite";
      statusCor = "green";
      recomendacao = "OK";
    }

    // ------- FILTROS -------
    // filtroCategoria (mant√©m comportamento anterior)
    if (filtroCategoria && filtroCategoria !== "" && categoria !== filtroCategoria) return;

    // filtroTexto: busca em v√°rios campos (produto, codigoBarras, categoria, qtd, status, recomenda√ß√£o)
    if (filtroTexto) {
      const codigo = (p.codigoBarras || "").toLowerCase();
      const qtdStr = String(qtd).toLowerCase();
      const statusLower = statusTexto.toLowerCase();
      const recLower = (recomendacao || "").toLowerCase();

      const matches =
        nome.includes(filtroTexto) ||
        codigo.includes(filtroTexto) ||
        categoria.includes(filtroTexto) ||
        qtdStr.includes(filtroTexto) ||
        statusLower.includes(filtroTexto) ||
        recLower.includes(filtroTexto);

      if (!matches) return; // n√£o passa no filtro
    }
    // ------------------------

    total++;

    // contadores
    if (qtd < minimo) abaixo++;
    else if (maximo && qtd > maximo) acima++;
    else dentro++;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome || "-"}</td>
      <td>${p.codigoBarras || "-"}</td>
      <td>${p.categoria || "-"}</td>
      <td>${qtd}</td>
      <td><input type="number" id="min-${i}" value="${minimo}" style="width:80px" /></td>
      <td><input type="number" id="max-${i}" value="${maximo}" style="width:80px" /></td>
      <td style="color:${statusCor}; font-weight:bold;">${statusTexto}</td>
      <td>${recomendacao}</td>
      <td><button onclick="salvarLimites(${i})"><i class="fa fa-save"></i></button></td>
    `;
    tbody.appendChild(row);
  });

  // üîπ Atualiza contador superior
  if (resumo)
    resumo.innerHTML = `
      üßæ Total de Produtos: ${total} |
      ‚ö†Ô∏è Abaixo do M√≠nimo: ${abaixo} |
      ‚úÖ Dentro do Limite: ${dentro} |
      üì¶ Acima do M√°ximo: ${acima}
    `;
}





// üîπ Gera lista de compra (todos os produtos abaixo do m√≠nimo)

function gerarListaCompra() {
  const container = document.getElementById("listaCompraContainer");
  const tabela = document.getElementById("tabelaListaCompra");
  const tbody = tabela ? tabela.querySelector("tbody") : null;
  const totalSpan = document.getElementById("totalItensCompra");

  if (!container || !tabela || !tbody || !totalSpan) {
    console.error("‚ö†Ô∏è Elementos da lista de compra n√£o encontrados no DOM.");
    alert("Erro: tabela da lista de compra n√£o encontrada. Verifique o HTML.");
    return;
  }

  const produtos = JSON.parse(localStorage.getItem("produtos")) || [];
  if (!produtos.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#777;">Nenhum produto cadastrado.</td></tr>`;
    totalSpan.textContent = "0";
    container.style.display = "block";
    return;
  }

  // üîπ Filtro de categoria (se existir)
  const filtroCategoria = (document.getElementById("filtroCategoria")?.value || "").toLowerCase();

  // üîπ Filtra produtos abaixo do m√≠nimo
  const produtosAbaixo = produtos.filter(p => {
    const categoria = (p.categoria || "").toLowerCase();
    const qtd = Number(p.quantidade) || 0;
    const minimo = Number(p.minimo) || 0;
    if (filtroCategoria && filtroCategoria !== "" && categoria !== filtroCategoria) return false;
    return qtd < minimo;
  });

  tbody.innerHTML = "";

  if (!produtosAbaixo.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:green;">‚úÖ Nenhum produto abaixo do m√≠nimo.</td></tr>`;
    totalSpan.textContent = "0";
    container.style.display = "block";
    return;
  }

  // üîπ Monta tabela com os valores corretos de ‚ÄúRecomendado Comprar‚Äù
  let totalItens = 0;

  produtosAbaixo.forEach((p, i) => {
    const qtdAtual = Number(p.quantidade) || 0;
    const minimo = Number(p.minimo) || 0;
    const comprar = minimo > qtdAtual ? minimo - qtdAtual : 0;
    const codigoBarras = p.codigoBarras || "-";

    totalItens++;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td>${codigoBarras}</td>
      <td>${p.categoria || "-"}</td>
      <td>${qtdAtual}</td>
      <td>${minimo}</td>
      <td style="color:red; font-weight:bold;">${comprar}</td>
    `;
    tbody.appendChild(row);
  });

  // üîπ Atualiza total e exibe tabela
  totalSpan.textContent = totalItens;
  container.style.display = "block";
}



// üîπ Limpa lista gerada
function limparListaCompra() {
  const tbody = document.querySelector("#tabelaListaCompra tbody");
  const totalSpan = document.getElementById("totalItensCompra");
  const container = document.getElementById("listaCompraContainer");

  // üîπ Limpa a lista de compra
  if (tbody) tbody.innerHTML = "";
  if (totalSpan) totalSpan.textContent = "0";
  if (container) container.style.display = "none";

  // üîπ Retorna a exibi√ß√£o da tabela principal com todos os produtos
  atualizarTabelaLimites(); // üëà volta a mostrar todos os produtos no estoque
}




function salvarLimites(i) {
  const min = +document.getElementById(`min-${i}`).value;
  const max = +document.getElementById(`max-${i}`).value;

  if (isNaN(min) || isNaN(max)) {
    alert("Por favor, insira valores v√°lidos para m√≠nimo e m√°ximo!");
    return;
  }

  produtos[i].minimo = min;
  produtos[i].maximo = max;
  localStorage.setItem("produtos", JSON.stringify(produtos));
  alert("Limites atualizados com sucesso!");
  atualizarTabelaLimites();
  ordenarListasAlfabeticamente();
}




/* =========================
   üîπ Financeiro
========================= */
function atualizarPainelFinanceiro() {
  const entradas = JSON.parse(localStorage.getItem("entradas")) || [];
  const saidas = JSON.parse(localStorage.getItem("saidas")) || [];
  const produtos = JSON.parse(localStorage.getItem("produtos")) || [];

  let valorTotalEntradas = 0;
  let valorTotalSaidas = 0;

  // üîπ Calcular total de entradas e sa√≠das (financeiro geral)
  entradas.forEach(e => {
    valorTotalEntradas += (e.valor || 0) * (e.qtd || 0);
  });

  saidas.forEach(s => {
    // ‚ö†Ô∏è Se o produto existe em entradas, usa o valor unit√°rio dele
    const entradaRelacionado = entradas.find(
      e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
    );
    const valorUnitario = entradaRelacionado ? (entradaRelacionado.valor || 0) : 0;
    valorTotalSaidas += valorUnitario * (s.qtd || 0);
  });

  // üîπ Valor total cont√°bil do estoque (entradas - sa√≠das)
  const valorEstoqueAtual = valorTotalEntradas - valorTotalSaidas;

  // Atualiza os dois indicadores principais (j√° existentes)
  document.getElementById("valorEstoque").textContent = `R$ ${valorEstoqueAtual.toFixed(2)}`;
  document.getElementById("valorSaidas").textContent = `R$ ${valorTotalSaidas.toFixed(2)}`;

  // --------------------------------------------------------------------------------
  // üí∞ C√°lculo de √öltimo valor de entrada, CMP e Estoque Atual (tr√™s novos valores)
  // --------------------------------------------------------------------------------
  let qtdTotal = 0;
  let valorTotalUltimaEntrada = 0;
  let valorTotalCustoMedio = 0;

  produtos.forEach(p => {
    const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
    if (entradasDoProduto.length === 0) return;

    // √öltimo valor de entrada
    const ultimaEntrada = entradasDoProduto.slice(-1)[0];
    const valorUltimo = Number(ultimaEntrada.valor || 0);

    // Custo m√©dio ponderado
    const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + Number(e.qtd || 0), 0);
    const totalValorEntradas = entradasDoProduto.reduce(
      (s, e) => s + (Number(e.qtd || 0) * Number(e.valor || 0)),
      0
    );
    const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;

    const qtdAtual = Number(p.quantidade || 0);
    qtdTotal += qtdAtual;
    valorTotalUltimaEntrada += qtdAtual * valorUltimo;
    valorTotalCustoMedio += qtdAtual * custoMedio;
  });

  const valorTotalEstoqueAtualPainel = (valorTotalUltimaEntrada + valorTotalCustoMedio) / 2;

  // Atualiza os novos indicadores
  document.getElementById("valorUltimaEntrada").textContent = `R$ ${valorTotalUltimaEntrada.toFixed(2)}`;
  document.getElementById("valorCustoMedio").textContent = `R$ ${valorTotalCustoMedio.toFixed(2)}`;
  document.getElementById("valorEstoqueAtualPainel").textContent = `R$ ${valorTotalEstoqueAtualPainel.toFixed(2)}`;

  // --------------------------------------------------------------------------------
  // üì¶ Agrupar por fornecedor e nota fiscal (mantido igual ao seu original)
  // --------------------------------------------------------------------------------
  const agrupadas = {};

  entradas.forEach(e => {
    const fornecedor = e.fornecedor || "Fornecedor n√£o informado";
    const nota = e.nota || "Sem Nota Fiscal";
    const chave = `${fornecedor}_${nota}`;

    if (!agrupadas[chave]) {
      agrupadas[chave] = {
        fornecedor,
        nota,
        valorNota: 0,
        valorSaida: 0
      };
    }

    agrupadas[chave].valorNota += (e.valor || 0) * (e.qtd || 0);
  });

  saidas.forEach(s => {
    const entrada = entradas.find(
      e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
    );
    if (!entrada) return;

    const fornecedor = entrada.fornecedor || "Fornecedor n√£o informado";
    const nota = entrada.nota || "Sem Nota Fiscal";
    const chave = `${fornecedor}_${nota}`;

    const valorUnitario = entrada.valor || 0;
    const valorSaida = valorUnitario * (s.qtd || 0);

    if (agrupadas[chave]) {
      agrupadas[chave].valorSaida += valorSaida;
    }
  });

  // Renderizar tabela agrupada
  const tbody = document.querySelector("#tabelaFinanceiro tbody");
  tbody.innerHTML = "";
  Object.values(agrupadas).forEach(a => {
    const saldo = a.valorNota - a.valorSaida;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.fornecedor}</td>
      <td>${a.nota}</td>
      <td>R$ ${a.valorNota.toFixed(2)}</td>
      <td>R$ ${saldo.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
}





/* =========================
   üîπ Relat√≥rios
========================= */
/* =========================
   üîπ Relat√≥rios (corrigido)
========================= */
function exportarCSV(nome, dados) {
  if (!dados.length) return alert("Nenhum dado encontrado!");
  const header = Object.keys(dados[0]).join(";");
  const rows = dados.map((obj) => Object.values(obj).join(";"));
  const csv = [header, ...rows].join("\n");
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = nome + ".csv";
  link.click();
}

function gerarRelatorioProdutos() {
  exportarCSV("Produtos", produtos);
}

function gerarRelatorioEntradas() {
  exportarCSV("Entradas", entradas);
}

function gerarRelatorioSaidas() {
  exportarCSV("Saidas", saidas);
}

function gerarRelatorioEstoque() {
  const dados = produtos.map((p) => ({
    nome: p.nome,
    categoria: p.categoria,
    quantidade: p.quantidade || 0
  }));
  exportarCSV("Estoque", dados);
}

/* =========================
   üîπ Usu√°rios
========================= */
let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

function salvarUsuario() {
  const nome = document.getElementById("usuarioNome").value.trim();
  const cpf = document.getElementById("usuarioCPF").value.trim();
  const email = document.getElementById("usuarioEmail").value.trim();
  const senha = document.getElementById("usuarioSenha").value.trim();
  const perfil = document.getElementById("usuarioPerfil").value;
  if (!nome || !senha) return alert("Preencha os campos obrigat√≥rios!");

  usuarios.push({ nome, cpf, email, senha, perfil });
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  atualizarTabelaUsuarios();
  ordenarListasAlfabeticamente();
}

function atualizarTabelaUsuarios() {
  const tbody = document.querySelector("#tabelaUsuarios tbody");
  tbody.innerHTML = "";
  usuarios.forEach((u, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${u.nome}</td>
      <td>${u.cpf || "-"}</td>
      <td>${u.email || "-"}</td>
      <td>${u.perfil}</td>
      <td><button onclick="excluirUsuario(${i})"><i class="fa fa-trash"></i></button></td>`;
    tbody.appendChild(row);
  });
}

function excluirUsuario(i) {
  if (!confirm("Excluir este usu√°rio?")) return;
  usuarios.splice(i, 1);
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  atualizarTabelaUsuarios();
}

/* =========================
   üîπ Inicializa√ß√£o
========================= */
window.addEventListener("load", () => {
  produtos = JSON.parse(localStorage.getItem("produtos")) || [];
  entradas = JSON.parse(localStorage.getItem("entradas")) || [];
  saidas = JSON.parse(localStorage.getItem("saidas")) || [];
  usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

  atualizarTabelaProdutos();
  atualizarTabelaEntradas();
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarTabelaUsuarios();
  atualizarPainelFinanceiro();

  const sess = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (sess) {
    window.usuarioLogado = sess;
    document.getElementById("loginView").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
    document.getElementById("userName").textContent = sess.nome;
    document.getElementById("perfilBadge").textContent = "Perfil: " + sess.perfil.toUpperCase();
    aplicarPermissoes();
  }
});
function gerarPedidoPDF() {
  const { jsPDF } = window.jspdf;
  const tabela = document.getElementById("tabelaListaCompra");
  if (!tabela) return alert("Lista de compra n√£o encontrada!");

  // üîπ Obt√©m nome do solicitante do perfil
  const usuario = JSON.parse(localStorage.getItem("usuario")) || {};
  const nomeSolicitante = usuario.nome || "N√£o informado";

  // üîπ Cria documento
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const larguraPagina = doc.internal.pageSize.getWidth();
  const dataAtual = new Date().toLocaleDateString();

  // ---------- CABE√áALHO ----------
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });

  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text("Pedido de Or√ßamento", larguraPagina / 2, 28, { align: "center" });

  doc.setFontSize(10);
  doc.text(`Data: ${dataAtual}`, 14, 38);
  doc.text(`Solicitante: ${nomeSolicitante}`, 14, 44);

  // ---------- LINHA SEPARADORA ----------
  doc.setDrawColor(150);
  doc.line(14, 48, larguraPagina - 14, 48);

  // ---------- CABE√áALHO DA TABELA ----------
  let y = 55;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("#", 14, y);
  doc.text("Produto", 25, y);
  doc.text("Categoria", 105, y);
  doc.text("Recomendado Comprar", 170, y, { align: "right" });

  // ---------- CONTE√öDO DA TABELA ----------
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  y += 7;

  const linhas = tabela.querySelectorAll("tbody tr");

  linhas.forEach((tr) => {
    const cols = tr.querySelectorAll("td");
    if (cols.length >= 6) {
      const index = cols[0].innerText.trim();
      const produto = cols[1].innerText.trim();
      const categoria = cols[2].innerText.trim();
      const comprar = cols[5].innerText.trim();

      // quebra de p√°gina se necess√°rio
      if (y > 270) {
        doc.addPage();
        y = 20;
      }

      // texto alinhado nas margens seguras
      doc.text(index, 14, y);
      doc.text(produto, 25, y, { maxWidth: 75 }); // produto ocupa at√© 75mm
      doc.text(categoria, 105, y, { maxWidth: 55 });
      doc.text(comprar, 170, y, { align: "right" });

      y += 7;
    }
  });

  // ---------- RODAP√â ----------
  doc.setFont("helvetica", "italic");
  doc.setFontSize(9);
  doc.text(
    "Gerado automaticamente pelo sistema de controle de estoque Oral Unic Campo Grande.",
    larguraPagina / 2,
    285,
    { align: "center" }
  );

  // ---------- SALVAR ----------
  const data = new Date().toLocaleDateString().replace(/\//g, "-");
  doc.save(`Pedido_de_Orcamento_${data}.pdf`);
}




/* =========================
   üîπ Modal de imagem
========================= */
document.body.insertAdjacentHTML("beforeend", `
  <div id="imagemAmpliada" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:9999;">
    <img src="" style="max-width:90%;max-height:90%;border:4px solid white;border-radius:8px;">
  </div>
`);
document.getElementById("imagemAmpliada").addEventListener("click", () => {
  document.getElementById("imagemAmpliada").style.display = "none";
});
// Sempre que a p√°gina carregar ou for aberta
document.addEventListener("DOMContentLoaded", () => {
  // üîπ 1. Garante que as listas sejam ordenadas logo ao abrir
  if (typeof ordenarListasAlfabeticamente === "function") {
    ordenarListasAlfabeticamente();
    console.log("Listas carregadas e ordenadas com sucesso!");
  }

  // üîπ 2. Atualiza a tabela de limites (sua fun√ß√£o original)
  if (document.getElementById("tabelaLimites") && typeof atualizarTabelaLimites === "function") {
    atualizarTabelaLimites();
  }
});

/* =========================
   üîπ Padroniza√ß√£o de texto: Primeira letra mai√∫scula, resto min√∫sculo
========================= */
function formatarTextoPadrao(texto) {
  return texto
    .toLowerCase()
    .split(" ")
    .filter(p => p.trim() !== "")
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

/* üî∏ Aplica automaticamente ao sair do campo de texto */
document.addEventListener("blur", (e) => {
  const el = e.target;
  if (el.tagName === "INPUT" && el.type === "text") {
    // Ignora campos que n√£o devem ser alterados
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login")
    ) return;

    el.value = formatarTextoPadrao(el.value);
  }
}, true);

/* üî∏ Garante padroniza√ß√£o antes de salvar/cadastrar */
function padronizarCamposAntesDeSalvar() {
  document.querySelectorAll('input[type="text"]').forEach(el => {
    if (
      !el.id.toLowerCase().includes("cnpj") &&
      !el.id.toLowerCase().includes("email") &&
      !el.id.toLowerCase().includes("login")
    ) {
      el.value = formatarTextoPadrao(el.value);
    }
  });
}

/* ========================= DASHBOARD ========================= */
function atualizarDashboard() {
  const listaProximosVencer = document.getElementById("listaProximosVencer");
  const listaMaisCaros = document.getElementById("listaMaisCaros");
  const listaMaisSaidas = document.getElementById("listaMaisSaidas");
  const listaMenosSaidas = document.getElementById("listaMenosSaidas");
  const listaEstoqueCritico = document.getElementById("listaEstoqueCritico");
  const resumoGeral = document.getElementById("resumoGeral");

  const produtosLocal = JSON.parse(localStorage.getItem("produtos")) || produtos || [];
  const entradasLocal = JSON.parse(localStorage.getItem("entradas")) || entradas || [];
  const saidasLocal = JSON.parse(localStorage.getItem("saidas")) || saidas || [];

  if (!Array.isArray(produtosLocal) || produtosLocal.length === 0) {
    resumoGeral.innerHTML = "<p>Sem dados de produtos no momento.</p>";
    return;
  }

  // ---------- Produtos pr√≥ximos do vencimento ----------
  const proximos = entradasLocal
    .filter(e => e.validade)
    .sort((a, b) => new Date(a.validade) - new Date(b.validade))
    .slice(0, 5);

  listaProximosVencer.innerHTML =
    proximos.length > 0
      ? proximos
          .map(e => `<li>${e.produto} - vence em ${new Date(e.validade).toLocaleDateString("pt-BR")}</li>`)
          .join("")
      : "<li>Nenhum produto com validade pr√≥xima.</li>";

  // ---------- Produtos mais caros ----------
  const mapaValores = {};
  entradasLocal.forEach(e => {
    if (!e.produto || !e.valor) return;
    mapaValores[e.produto] = e.valor; // √∫ltimo valor registrado
  });

  const maisCaros = Object.entries(mapaValores)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);

  listaMaisCaros.innerHTML =
    maisCaros.length > 0
      ? maisCaros.map(([nome, valor]) => `<li>${nome} - R$ ${valor.toFixed(2)}</li>`).join("")
      : "<li>Sem dados de valor.</li>";

  // ---------- Produtos mais e menos utilizados ----------
  const contadorSaidas = {};
  saidasLocal.forEach(s => {
    if (!s.produto || !s.qtd) return;
    contadorSaidas[s.produto] = (contadorSaidas[s.produto] || 0) + Number(s.qtd);
  });

  const maisUsados = Object.entries(contadorSaidas)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  listaMaisSaidas.innerHTML =
    maisUsados.length > 0
      ? maisUsados.map(([nome, qtd]) => `<li>${nome} - ${qtd} sa√≠das</li>`).join("")
      : "<li>Sem sa√≠das registradas.</li>";

  const menosUsados = Object.entries(contadorSaidas)
    .sort((a, b) => a[1] - b[1])
    .slice(0, 5);
  listaMenosSaidas.innerHTML =
    menosUsados.length > 0
      ? menosUsados.map(([nome, qtd]) => `<li>${nome} - ${qtd} sa√≠das</li>`).join("")
      : "<li>Sem sa√≠das registradas.</li>";

  // ---------- Estoque cr√≠tico ----------
  const criticos = produtosLocal.filter(p => p.minimo && p.quantidade <= p.minimo);
  listaEstoqueCritico.innerHTML =
    criticos.length > 0
      ? criticos.map(p => `<li>${p.nome} - Estoque atual: ${p.quantidade}</li>`).join("")
      : "<li>Nenhum produto cr√≠tico no momento.</li>";

  // ---------- Resumo geral ----------
  let totalProdutos = produtosLocal.length;
  let qtdTotal = 0;
  let valorTotalUltimaEntrada = 0;
  let valorTotalCustoMedio = 0;

  produtosLocal.forEach(p => {
    const entradasDoProduto = entradasLocal.filter(e => e.produto === p.nome);
    if (entradasDoProduto.length === 0) return;

    // √öltimo valor de entrada
    const ultimaEntrada = entradasDoProduto.slice(-1)[0];
    const valorUltimo = Number(ultimaEntrada.valor || 0);

    // Custo m√©dio ponderado
    const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + Number(e.qtd || 0), 0);
    const totalValorEntradas = entradasDoProduto.reduce(
      (s, e) => s + (Number(e.qtd || 0) * Number(e.valor || 0)),
      0
    );
    const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;

    const qtdAtual = Number(p.quantidade || 0);
    qtdTotal += qtdAtual;
    valorTotalUltimaEntrada += qtdAtual * valorUltimo;
    valorTotalCustoMedio += qtdAtual * custoMedio;
  });

  // ---------- Valor cont√°bil (entradas - sa√≠das) ----------
  const valorTotalEntradas = entradasLocal.reduce((soma, e) => soma + (e.valor || 0) * (e.qtd || 0), 0);
  const valorTotalSaidas = saidasLocal.reduce((soma, s) => {
    const entradaRelacionado = entradasLocal.find(
      e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
    );
    const valorUnitario = entradaRelacionado ? entradaRelacionado.valor || 0 : 0;
    return soma + valorUnitario * (s.qtd || 0);
  }, 0);

  const valorTotalEstoqueContabil = valorTotalEntradas - valorTotalSaidas;
  const valorTotalEstoqueAtual = (valorTotalUltimaEntrada + valorTotalCustoMedio) / 2;
  const totalSaidas = saidasLocal.reduce((soma, s) => soma + Number(s.qtd || 0), 0);

  // ---------- Renderiza√ß√£o no Resumo Geral ----------
  resumoGeral.innerHTML = `
    <p><b>Total de produtos:</b> ${totalProdutos}</p>
    <p><b>Quantidade total em estoque:</b> ${qtdTotal}</p>
    <p><b>Total de sa√≠das registradas:</b> ${totalSaidas}</p>
    <hr>
    <p><b>üí∞ Valor total (√öltimo valor de entrada):</b> R$ ${valorTotalUltimaEntrada.toFixed(2)}</p>
    <p><b>üìä Valor total (Custo m√©dio ponderado):</b> R$ ${valorTotalCustoMedio.toFixed(2)}</p>
    <p><b>üì¶ Valor total do Estoque Atual:</b> R$ ${valorTotalEstoqueAtual.toFixed(2)}</p>
    <p><b>üíº Valor total do Estoque Atual (Cont√°bil):</b> R$ ${valorTotalEstoqueContabil.toFixed(2)}</p>
  `;
}





/* =========================
   üîπ Ordena√ß√£o geral (produtos, fornecedores, usu√°rios)
========================= */
function ordenarListasAlfabeticamente() {
  // üîπ Produtos (cadastro, entrada, sa√≠da, estoque)
  if (typeof produtos !== "undefined" && Array.isArray(produtos)) {
    produtos.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' }));
    localStorage.setItem("produtos", JSON.stringify(produtos));
	
  }

  // üîπ Entradas (Painel Financeiro ‚Äì fornecedor)
  if (typeof entradas !== "undefined" && Array.isArray(entradas)) {
    entradas.sort((a, b) =>
      (a.fornecedor || "").localeCompare(b.fornecedor || "", 'pt-BR', { sensitivity: 'base' })
    );
    localStorage.setItem("entradas", JSON.stringify(entradas));
  }

  // üîπ Usu√°rios e Perfis (Gerenciar Usu√°rios)
  if (typeof usuarios !== "undefined" && Array.isArray(usuarios)) {
    usuarios.sort((a, b) =>
      (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' })
    );
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
  }

  // üîπ Atualiza tabelas e selects se as fun√ß√µes existirem
  if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
  if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
  if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
  if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
  if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
     if (typeof atualizarDashboard === "function") atualizarDashboard();
  
     if (typeof atualizarDashboard === "function") atualizarDashboard();
  

  // üîπ Atualiza selects de produto (Entrada e Sa√≠da)
  atualizarSelectProdutos();
}

/* üî∏ Atualiza todos os <select> de produtos em ordem alfab√©tica */
/* =========================
   üîπ Atualiza o <select> de produtos em ordem alfab√©tica
========================= */
function atualizarSelectProdutos() {
  const selectEntrada = document.getElementById("entradaProduto");
  if (!selectEntrada) return; // evita erro se o campo n√£o existir ainda

  // limpa todas as op√ß√µes
  selectEntrada.innerHTML = "";

  // garante que a lista esteja ordenada
  const listaOrdenada = [...produtos].sort((a, b) =>
    a.nome.localeCompare(b.nome, "pt-BR", { sensitivity: "base" })
  );

  // adiciona as op√ß√µes
  listaOrdenada.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.nome;
    opt.textContent = p.nome;
    selectEntrada.appendChild(opt);
  });
}

/* =========================
   üîç FILTROS DE BUSCA
========================= */

// üîπ Produtos: busca por nome ou categoria
function filtrarProdutos() {
  const termo = document.getElementById("filtroProduto").value.toLowerCase();
  const tbody = document.querySelector("#tabelaProdutos tbody");
  tbody.querySelectorAll("tr").forEach(tr => {
    const texto = tr.textContent.toLowerCase();
    tr.style.display = texto.includes(termo) ? "" : "none";
  });
}

// üîπ Entradas: busca por produto, fornecedor ou nota fiscal
function filtrarEntradas() {
  const termo = document.getElementById("filtroEntrada").value.toLowerCase();
  const tbody = document.querySelector("#tabelaEntradas tbody");
  tbody.querySelectorAll("tr").forEach(tr => {
    const texto = tr.textContent.toLowerCase();
    tr.style.display = texto.includes(termo) ? "" : "none";
  });
}

// üîπ Sa√≠das: busca por produto, setor ou respons√°vel
function filtrarSaidas() {
  const termo = document.getElementById("filtroSaida").value.toLowerCase();
  const tbody = document.querySelector("#tabelaSaidas tbody");
  tbody.querySelectorAll("tr").forEach(tr => {
    const texto = tr.textContent.toLowerCase();
    tr.style.display = texto.includes(termo) ? "" : "none";
  });
}

// üîπ Estoque: busca por produto ou categoria
function filtrarEstoque() {
  const termo = document.getElementById("filtroEstoque").value.toLowerCase();
  const tbody = document.querySelector("#tabelaEstoque tbody");
  tbody.querySelectorAll("tr").forEach(tr => {
    const texto = tr.textContent.toLowerCase();
    tr.style.display = texto.includes(termo) ? "" : "none";
  });
}
/* =========================
   üßπ LIMPAR CAMPOS AUTOMATICAMENTE (GLOBAL)
========================= */

// üîπ Fun√ß√£o gen√©rica ‚Äî limpa todos os inputs e selects dentro de uma se√ß√£o
function limparCampos(secaoId) {
  const secao = document.getElementById(secaoId);
  if (!secao) return;
  secao.querySelectorAll("input, select").forEach(el => {
    if (el.type === "file") {
      el.value = "";
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0;
    } else {
      el.value = "";
    }
  });
}

/* =========================
   üßæ APLICA√á√ÉO NAS FUN√á√ïES DE A√á√ÉO
========================= */


// üîπ CADASTRO DE PRODUTOS (wrapper seguro: limpa campos somente se houve sucesso)
const _cadastrarProdutoOriginal = cadastrarProduto;
cadastrarProduto = function() {
  try {
    const result = _cadastrarProdutoOriginal();
    // Se a fun√ß√£o retornar true -> sucesso, limpa ap√≥s pequeno delay
    if (result === true) {
      // se houver FileReader ass√≠ncrono, o salvamento j√° far√° persist√™ncia no onload;
      // a limpeza visual pode esperar um curto tempo para garantir que onload tenha rodado.
      setTimeout(() => limparCampos("cadastro"), 350);
    } else {
      // n√£o limpar ‚Äî deixa os valores preenchidos para corre√ß√£o
      // opcional: rolar at√© o primeiro campo com borda vermelha
      const erroEl = document.querySelector("#cadastro input[style*='2px solid red'], #cadastro select[style*='2px solid red']");
      if (erroEl) erroEl.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  } catch (err) {
    console.error("Erro ao cadastrar produto:", err);
    // n√£o limpar em caso de erro
  }
};


// üîπ ENTRADA DE MATERIAIS
// üîπ Wrapper que s√≥ limpa se a fun√ß√£o tiver sucesso
const _registrarEntradaOriginal = registrarEntrada;
registrarEntrada = function() {
  try {
    const result = _registrarEntradaOriginal();
    if (result === true) {
      setTimeout(() => limparCampos("entrada"), 300);
    } else {
      const erroEl = document.querySelector("#entrada input[style*='red'], #entrada select[style*='red']");
      if (erroEl) erroEl.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  } catch (err) {
    console.error("Erro ao registrar entrada:", err);
  }
};






// üîπ GERENCIAR USU√ÅRIOS E PERFIS
if (typeof salvarUsuario === "function") {
  const _salvarUsuarioOriginal = salvarUsuario;
  salvarUsuario = function() {
    _salvarUsuarioOriginal();
    setTimeout(() => limparCampos("usuarios"), 300);
  };
}

/* =========================
   üì¶ A√á√ïES NO ESTOQUE M√çNIMO E M√ÅXIMO
========================= */

// üîπ Ap√≥s gerar lista de compra ‚Üí exibe e permite nova a√ß√£o
const _gerarListaCompraOriginal = gerarListaCompra;
gerarListaCompra = function() {
  _gerarListaCompraOriginal();
  // n√£o limpa nada, apenas garante foco na tabela gerada
  const container = document.getElementById("listaCompraContainer");
  if (container) container.scrollIntoView({ behavior: "smooth" });
};

// üîπ Ap√≥s limpar lista ‚Üí tamb√©m limpa filtros e reseta tela
const _limparListaCompraOriginal = limparListaCompra;
limparListaCompra = function() {
  _limparListaCompraOriginal();
  setTimeout(() => limparCampos("limites"), 200);
};

// üîπ Mostra mensagens visuais no canto da tela
function mostrarMensagem(texto, tipo = "info") {
  let box = document.getElementById("mensagemBox");
  if (!box) {
    box = document.createElement("div");
    box.id = "mensagemBox";
    document.body.appendChild(box);
    Object.assign(box.style, {
      position: "fixed",
      top: "20px",
      right: "20px",
      zIndex: "9999",
      padding: "10px 15px",
      borderRadius: "6px",
      fontFamily: "Segoe UI, sans-serif",
      color: "#fff",
      boxShadow: "0 2px 8px rgba(0,0,0,0.2)",
      transition: "opacity 0.4s",
    });
  }

  box.textContent = texto;
  box.style.background =
    tipo === "erro" ? "#dc3545" :
    tipo === "sucesso" ? "#28a745" :
    "#0d6efd";
  box.style.opacity = "1";
  setTimeout(() => (box.style.opacity = "0"), 3000);
}

// üîπ Destaca o campo com erro
function destacarErro(el, msg) {
  el.style.border = "2px solid red";
  el.focus();
  mostrarMensagem(msg, "erro");
}

// üîπ Remove marca√ß√µes de erro
function limparErros(secaoId) {
  document.querySelectorAll(`#${secaoId} input, #${secaoId} select`).forEach(el => {
    el.style.border = "1px solid #ccc";
  });
}


/* =========================
   üì¶ Exportar Lista de Compra para Excel (compat√≠vel com Excel BR)
========================= */
function exportarListaExcel() {
  const container = document.getElementById("listaCompraContainer");
  const tabela = document.getElementById("tabelaListaCompra");
  const tbody = tabela ? tabela.querySelector("tbody") : null;

  if (!tabela || !tbody) {
    alert("‚ö†Ô∏è Nenhuma lista de compra gerada para exportar!");
    return;
  }

  const estavaOculto = container && container.style.display === "none";
  if (estavaOculto) container.style.display = "block";

  const linhas = [...tbody.querySelectorAll("tr")].filter(tr => tr.textContent.trim() !== "");

  if (linhas.length === 0) {
    alert("‚ö†Ô∏è Nenhum item encontrado na lista de compra.");
    if (estavaOculto) container.style.display = "none";
    return;
  }

  // üîπ Cabe√ßalho id√™ntico √† tabela
  const cabecalho = [
    "#",
    "Produto",
    "C√≥digo de Barras",
    "Categoria",
    "Qtd Atual",
    "M√≠nimo",
    "Recomendado Comprar"
  ];
  let csv = [cabecalho.join(";")];

  // üîπ Linhas de dados
  linhas.forEach(tr => {
    const cols = tr.querySelectorAll("td");
    const linha = [];
    cols.forEach(td => linha.push(td.innerText.trim().replace(/\s+/g, " ")));
    csv.push(linha.join(";"));
  });

  // üîπ Cria o conte√∫do CSV
  const csvContent = csv.join("\n");

  // Cria um Blob em ISO-8859-1 para abrir corretamente no Excel PT-BR
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=ISO-8859-1;" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Lista_de_Compra_Gerada.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  if (estavaOculto) container.style.display = "none";

  alert("‚úÖ Lista de Compra Gerada exportada com sucesso!");
}


/* =========================
   üîπ Controle de per√≠odo do relat√≥rio
========================= */
function definirPeriodoRapido(tipo) {
  const hoje = new Date();
  const inicioEl = document.getElementById("dataInicioRelatorio");
  const fimEl = document.getElementById("dataFimRelatorio");

  let inicio = new Date(hoje);
  let fim = new Date(hoje);

  switch (tipo) {
    case "hoje":
      // Fica o dia atual
      break;
    case "7dias":
      inicio.setDate(hoje.getDate() - 7);
      break;
    case "30dias":
      inicio.setDate(hoje.getDate() - 30);
      break;
    case "mes":
      inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
      break;
  }

  inicioEl.value = inicio.toISOString().split("T")[0];
  fimEl.value = fim.toISOString().split("T")[0];

  
}

function limparPeriodo() {
  document.getElementById("dataInicioRelatorio").value = "";
  document.getElementById("dataFimRelatorio").value = "";
}

/* =========================
   üîπ Gerar relat√≥rio por data (gen√©rico)
========================= */
/* =========================
   üîπ Gerar relat√≥rio por data (sem exibir tabela, exporta direto)
========================= */
function gerarRelatorio() {
  const inicio = document.getElementById("dataInicioRelatorio").value;
  const fim = document.getElementById("dataFimRelatorio").value;

  if (!inicio || !fim) {
    alert("‚ö†Ô∏è Selecione uma data de in√≠cio e fim para gerar o relat√≥rio!");
    return;
  }

  const dataInicio = new Date(inicio);
  const dataFim = new Date(fim);

  if (dataInicio > dataFim) {
    alert("‚ùå A data inicial n√£o pode ser maior que a final!");
    return;
  }

  // üîπ Pega todas as entradas do localStorage
  const entradas = JSON.parse(localStorage.getItem("entradas")) || [];

  // üîπ Filtra somente as que est√£o dentro do intervalo
  const filtradas = entradas.filter(e => {
    const data = new Date(e.data);
    return data >= dataInicio && data <= dataFim;
  });

  if (filtradas.length === 0) {
    alert("üì≠ Nenhum registro encontrado nesse per√≠odo.");
    return;
  }

  // üîπ Exporta os resultados filtrados para Excel
  exportarRelatorioFiltrado(filtradas);

  alert(`üìä Relat√≥rio de Entradas gerado de ${inicio} at√© ${fim}`);
}

/* =========================
   üì¶ Exportar Relat√≥rio Filtrado para Excel
========================= */
function exportarRelatorioFiltrado(lista) {
  let csv = [
    ["Produto", "Quantidade", "Valor (R$)", "Data", "Nota Fiscal", "Fornecedor", "CNPJ", "Lote", "Validade", "Setor"].join(";")
  ];

  lista.forEach(e => {
    csv.push([
      e.produto,
      e.qtd,
      e.valor,
      e.data,
      e.nota,
      e.fornecedor,
      e.cnpj,
      e.lote,
      e.validade,
      e.setor
    ].join(";"));
  });

  const csvContent = csv.join("\n");
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=ISO-8859-1;" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Relatorio_Entradas.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
function sincronizarNomeProdutoAntigo(novoNome, nomeAntigo) {
  let alterado = false;

  // Atualiza nome nas entradas
  entradas.forEach(e => {
    if (e.produto === nomeAntigo) {
      e.produto = novoNome;
      alterado = true;
    }
  });

  // Atualiza nome nas sa√≠das
  saidas.forEach(s => {
    if (s.produto === nomeAntigo) {
      s.produto = novoNome;
      alterado = true;
    }
  });

  // Atualiza nome no estoque (caso mantenha cache separado)
  produtos.forEach(p => {
    if (p.nome === nomeAntigo) {
      p.nome = novoNome;
      alterado = true;
    }
  });

  if (alterado) {
    localStorage.setItem("entradas", JSON.stringify(entradas));
    localStorage.setItem("saidas", JSON.stringify(saidas));
    localStorage.setItem("produtos", JSON.stringify(produtos));
    atualizarTabelaEntradas();
    atualizarTabelaSaidas();
    atualizarTabelaEstoque();
    if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();
    if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();
  }
}




</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>


</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

</body>
</html>
