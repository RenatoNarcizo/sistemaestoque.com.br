<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ========================= VARI√ÅVEIS DE CORES ========================= */
    :root {
      --azul: #0d6efd;
      --azul-escuro: #003b88;
      --cinza-fundo: #f4f6f9;
      --branco: #ffffff;
      --cinza: #e0e0e0;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--cinza-fundo);
      color: #222;
    }
    
    /* üîπ Centraliza√ß√£o est√°vel da tela de login */
    #loginView {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      overflow: hidden;
      z-index: 1000;
    }
    
    .login-card {
      background: var(--branco);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
      width: 320px;
    }

    .login-card h2 {
      color: var(--azul-escuro);
      margin-bottom: 20px;
    }

    .login-card input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .login-card button {
      width: 100%;
      margin-top: 10px;
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-size: 15px;
      cursor: pointer;
    }

    .login-card button:hover {
      background: var(--azul-escuro);
    }
    
    #loginMsg {
      background: #f8d7da;
      border-radius: 5px;
      padding: 8px;
      font-weight: bold;
      margin-top: 10px;
    }
    #loginMsg[style*="green"] {
      background: #d4edda;
    }


    /* ========================= HEADER ========================= */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--azul);
      color: var(--branco);
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 900;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      background: none;
      border: none;
      color: var(--branco);
      cursor: pointer;
      font-size: 1.3rem;
    }

    header button:hover {
      color: #e2e2e2;
    }

   /* ========================= MENU LATERAL ========================= */
   /* Dentro da sua tag <style> */

#sidebar {
    /* ... outras propriedades existentes ... */
    position: fixed;
    top: 50px; /* Ou a altura do seu header */
    left: -220px;
    width: 220px;
    height: calc(100% - 50px); /* Ou o que for necess√°rio */
    background: var(--azul-escuro);
    z-index: 1000;
    padding: 10px 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);

    /* üëà ADICIONE ESTA LINHA: Transi√ß√£o suave de 0.3 segundos */
    transition: left 0.3s ease; 
    
}

    /* Quando ativo (aberto) */
    #sidebar.active {
      left: 0;
    }

    #sidebar button {
      display: block;
      width: 100%;
      border: none;
      background: none;
      color: var(--branco);
      text-align: left;
      padding: 14px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      transition: background 0.2s;
    }

    #sidebar button i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================= √ÅREA PRINCIPAL ========================= */
    main {
      margin: 20px;
      padding-left: 0;
      transition: margin-left 0.3s ease;
      overflow-x: hidden; /* impede overflow lateral */
    }

    @media (min-width: 900px) {
      #sidebar.active + main {
        margin-left: 250px;
      }
    }

    /* ========================= SE√á√ïES ========================= */
    .section {
      display: none;
      max-height: calc(100vh - 140px); /* altura vis√≠vel abaixo do cabe√ßalho */
      overflow-y: auto; /* ativa rolagem vertical */
      overflow-x: hidden; /* evita rolagem lateral */
      padding-bottom: 20px; /* espa√ßamento inferior */
      scroll-behavior: smooth; /* rolagem suave */
    }

    .section h2 {
      color: var(--azul-escuro);
      border-left: 5px solid var(--azul);
      padding-left: 10px;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

/* ========================= DASHBOARD ========================= */
.dash-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dash-card {
  background: var(--branco);
  border-radius: 10px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  padding: 15px 20px;
  transition: transform 0.2s ease;
}

.dash-card:hover {
  transform: scale(1.02);
}

.dash-card h3 {
  color: var(--azul-escuro);
  margin-bottom: 10px;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 5px;
  font-size: 16px;
}

.dash-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dash-card ul li {
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.dash-card ul li:last-child {
  border-bottom: none;
}

    /* ========================= TABELAS ========================= */
    .table-wrap {
      max-height: 60vh; /* altura m√°xima vis√≠vel */
      overflow-y: auto;          /* rolagem vertical */
      overflow-x: auto; /* rolagem horizontal se necess√°rio */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: #888 #f0f0f0;
    }

    .table-wrap table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* evita desalinhamento */
    }

    .table-wrap table thead th {
      position: sticky;
      top: 0;
      background: var(--azul);
      color: #fff;
      z-index: 10;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    .table-wrap table td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 14px;
    }

    .table-wrap table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* üîπ Scrollbar estilizada */
    .table-wrap::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .table-wrap::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 8px;
    }
    .table-wrap::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ========================= BOT√ïES ========================= */
    button {
      background: var(--azul);
      color: var(--branco);
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background: var(--azul-escuro);
    }

    /* ========================= INPUTS E SELECTS ========================= */
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .input-row .flex {
      flex: 1; /* Faz o input expandir o m√°ximo poss√≠vel */
      min-width: 150px;
    }

    input, select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 3px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: var(--azul);
    }

    /* ========================= IMAGENS ========================= */
    .thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: scale(1.08);
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #imagemAmpliada {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #imagemAmpliada img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      cursor: pointer;
    }
    
    /* TOAST MESSAGE */
    #toastMessage {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s, transform 0.4s;
      pointer-events: none; /* N√£o impede cliques */
      font-family: "Segoe UI, sans-serif";
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <div id="imagemAmpliada" onclick="this.style.display='none'">
    <img src="" alt="Imagem ampliada">
  </div>
  
  <div id="toastMessage" style="background:#0d6efd;"></div>

  <div id="loginView" class="login-container">
    <div class="login-card">
      <h2><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque</h2>
      <input id="usuarioLogin" type="text" placeholder="E-mail de Usu√°rio" />
      <input id="senhaLogin" type="password" placeholder="Senha" />
      <button onclick="fazerLogin()"><i class="fa fa-right-to-bracket"></i> Entrar</button>
	  <p id="loginMsg" style="display:none; color:red; font-weight:bold; text-align:center;"></p>
    </div>
  </div>

  <div id="mainApp" style="display:none;">

    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="menuToggle" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
        <h1><i class="fa fa-boxes-stacked"></i> Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
     
        <div id="userName" style="font-weight:700">Visitante</div>
        <div id="perfilBadge" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-size:13px;">PERFIL</div>
        <button onclick="logout()" title="Sair"><i class="fa fa-sign-out-alt"></i></button>
      </div>
    </header>

    <aside id="sidebar" aria-hidden="true">
	  
	  <button onclick="showSection('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
      <button onclick="showSection('cadastro')"><i class="fa fa-box"></i> Cadastro de Produtos</button>
      <button onclick="showSection('entrada')"><i class="fa fa-arrow-down"></i> Entrada de Materiais</button>
      <button onclick="showSection('saida')"><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</button>
      <button onclick="showSection('estoque')"><i class="fa fa-warehouse"></i> Estoque Atual</button>
      <button onclick="showSection('limites')"><i class="fa fa-sliders-h"></i> Estoque M√≠n/M√°x</button>
      <button onclick="showSection('financeiro')"><i class="fa fa-coins"></i> Financeiro</button>
      <button onclick="showSection('relatorios')"><i class="fa fa-file-excel"></i> Relat√≥rios</button>
      <button onclick="showSection('usuarios')"><i class="fa fa-users"></i> Usu√°rios e Perfis</button>

    </aside>

    <main>
		<section id="boasVindas" class="section active" style="text-align:center; padding:100px 20px;">
		  <h1 style="color:#003b88;">üëã Bem-vindo(a) <span id="nomeUsuarioBemVindo"></span>!</h1>
		  <h2 style="color:#0d6efd;">ao Sistema de Controle de Estoque ‚Äì Oral Unic Campo Grande</h2>
		  <p style="margin-top:20px; color:#555;">Use o menu lateral para iniciar suas atividades.</p>
		</section>
		
<section id="dashboard" class="section">
    <h2>üìä Dashboard do Sistema</h2>
    <div class="dash-container">
        <div class="dash-card">
            <h3>üïí Produtos Pr√≥ximos do Vencimento</h3>
            <ul id="listaProximosVencer"></ul>
        </div>
        <div class="dash-card">
            <h3>üí∞ Produtos Mais Caros</h3>
            <ul id="listaMaisCaros"></ul>
        </div>
        <div class="dash-card">
            <h3>üì¶ Produtos Mais Utilizados</h3>
            <ul id="listaMaisSaidas"></ul>
        </div>
        <div class="dash-card">
            <h3>üí§ Produtos com Menos Sa√≠das</h3>
            <ul id="listaMenosSaidas"></ul>
        </div>

        <div class="dash-card">
            <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
            <ul id="listaEstoqueCritico"></ul>
        </div>

        <div class="dash-card">
            <h3>üìà Resumo Geral</h3>
            <div id="resumoGeral"></div>
        </div>
    </div>
</section>


      
   <!-- SE√á√ÉO: CADASTRO DE PRODUTOS -->
<section id="cadastro" class="section">
  <h2><i class="fa fa-box"></i> Cadastro de Produtos</h2>

  <div class="input-row" style="margin-bottom:10px;gap:8px;">
    <input id="produtoNome" type="text" placeholder="Nome do produto" class="flex" />

    <select id="produtoCategoria">
      <option value="">Selecione a categoria</option>
      <option>Material de Uso e Consumo</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante e Componentes</option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>
    </select>

    <select id="produtoEmbalagem">
      <option value="">Selecione o tipo de embalagem</option>
      <option>Ampola</option>
      <option>Caixa</option>
      <option>Fardo</option>
      <option>Frasco</option>
      <option>Garrafa</option>
      <option>Gramas</option>
      <option>Litro</option>
      <option>Pacote</option>
      <option>Pe√ßa</option>
      <option>Quilogramas (KG)</option>
      <option>Saco</option>
      <option>Unidade</option>
    </select>

    <input id="produtoQtdEmbalagem" type="number" placeholder="Qtd por embalagem" style="width:140px" />
    <input id="produtoCodigoBarras" type="text" placeholder="üì∑C√≥digo de Barras (opcional)" style="width:220px" />

    <!-- üü¢ Campo de foto dentro do card -->
<div style="display:flex; flex-direction:column; align-items:flex-start; gap:4px;">
  <div style="display:flex; align-items:center; gap:6px;">
    <!-- Bot√£o personalizado de upload -->
<label for="produtoFoto" 
       style="background:#007bff; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:6px;">
  üì∏ Insira foto do produto
</label>
<input id="produtoFoto" type="file" accept="image/*" style="display:none;">

  </div>
  <div id="fotoPreview" style="margin-top:6px; font-size:13px; color:#555; text-align:center;"></div>
</div>


    <!-- Bot√£o de cadastrar -->
    <button onclick="cadastrarProduto()"><i class="fa fa-save"></i> Cadastrar</button>
	<!-- üßπ Bot√£o de limpar -->
<button onclick="limparCamposProduto()" title="Limpar campos" style="background:#6c757d; color:#fff;">
  <i class="fa fa-broom"></i>
</button>
  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroProduto" type="text" placeholder="üîç Filtrar por nome ou categoria" style="width:98%" oninput="filtrarProdutos()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaProdutos">
      <thead>
        <tr>
          <th>#</th>
          <th>Foto</th>
          <th>Nome</th>
          <th>Categoria</th>
          <th>Embalagem</th>
          <th>Qtd/Emb.</th>
          <th>C√≥d. Barras</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>


     <section id="entrada" class="section">
      <h2><i class="fa fa-arrow-down"></i> Entrada de Materiais</h2>
      <div class="input-row" style="margin-bottom:10px;gap:8px;">
      
        <input id="entradaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" style="min-width:200px;" oninput="buscarProdutoPorCodigo('entrada')" />
        
        <input id="entradaProduto" type="text" placeholder="Nome do produto" list="listaProdutos" style="min-width:220px" />
        <datalist id="listaProdutos"></datalist>
        
        <input id="entradaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
        <input id="entradaValor" type="number" placeholder="Valor Unit√°rio (R$)" step="0.01" style="width:150px" />
        <input id="entradaData" type="date" style="width:160px" />
        <input id="entradaNota" type="text" placeholder="Nota Fiscal" />
        <input id="entradaFornecedor" type="text" placeholder="Fornecedor" />
        <input 
            id="entradaCNPJ" 
            type="text" 
            placeholder="CNPJ" 
            oninput="formatarCNPJ(this)" 
            maxlength="18"
            style="min-width: 180px;"
        />
        <input id="entradaLote" type="text" placeholder="Lote" />
        <input id="entradaValidade" type="date" placeholder="Validade" />

        <select id="entradaSetor">
          <option value="">Selecione o Setor Utilizado</option>
          <option>Limpeza da Cl√≠nica</option>
          <option>Laborat√≥rio</option>
          <option>Escrit√≥rio</option>
          <option>Copa e Cozinha</option>
          <option>Cl√≠nico Geral</option>
          <option>Centro Cir√∫rgico</option>
        </select>

        <button onclick="registrarEntrada()"><i class="fa fa-save"></i> Registrar Entrada</button>
		<!-- üßπ Bot√£o de limpar -->
<button onclick="limparCamposEntrada()" title="Limpar campos" style="background:#6c757d; color:#fff;">
  <i class="fa fa-broom"></i>
</button>

      </div>

      <div style="margin-bottom:10px;">
        <input id="filtroEntrada" type="text" placeholder="üîç Buscar por produto, fornecedor ou NF" style="width:98%" oninput="filtrarEntradas()" />
      </div>

      <div class="table-wrap">
        <table id="tabelaEntradas">
          <thead>
            <tr>
              <th>#</th>
              <th>Produto</th>
              <th>C√≥d. Barras</th>
              <th>Qtd</th>
              <th>Valor (R$)</th>
              <th>Data</th>
              <th>NF</th>
              <th>Fornecedor</th>
              <th>CNPJ</th>
              <th>Lote</th>
              <th>Validade</th>
              <th>Setor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>

     <section id="saida" class="section" style="display:none;">
  <h2><i class="fa fa-arrow-up"></i> Sa√≠da de Materiais</h2>

 <div class="input-row" style="margin-bottom:10px;gap:8px;">
        <input id="saidaCodigoBarras" type="text" placeholder="üì∑ Ler c√≥digo de barras" oninput="atualizarSetorAutomatico()" />

           
    <input id="saidaProduto" type="text" placeholder="Nome do produto" style="min-width:220px" oninput="atualizarSetorAutomatico()" />
    <input id="saidaQuantidade" type="number" placeholder="Quantidade" style="width:120px" />
    <input id="saidaResponsavel" type="text" placeholder="Respons√°vel" />
    <input id="saidaObservacao" type="text" placeholder="Observa√ß√£o (opcional)" />
    <select id="saidaSetor">
      <option value="">Selecione o Setor</option>
    </select>
    <input id="saidaData" type="date" style="width:160px" />
    <button onclick="registrarSaida()"><i class="fa fa-save"></i> Registrar Sa√≠da</button>
	<!-- üßπ Bot√£o de limpar -->
<button onclick="limparCamposSaida()" 
        title="Limpar campos" 
        style="background:#6c757d; color:#fff; border:none; border-radius:5px; padding:6px 10px; margin-left:10px; cursor:pointer; font-size:14px;">
  <i class="fa fa-broom"></i>
</button>

  </div>

  <div style="margin-bottom:10px;">
    <input id="filtroSaida" type="text" placeholder="üîç Buscar por produto, setor ou respons√°vel" style="width:98%" oninput="filtrarSaidas()" />
  </div>

  <div class="table-wrap">
    <table id="tabelaSaidas">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
		   <th>C√≥digo de Barras</th>
          <th>Qtd</th>
          <th>Data</th>
          <th>Setor</th>
          <th>Respons√°vel</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
  
  <section id="estoque" class="section">
  <h2><i class="fa fa-warehouse"></i> Estoque Atual</h2>
  <!-- üîπ Resumo de contagem -->
   <div style="margin-bottom:10px;">
    <input id="filtroEstoque" type="text" placeholder="üîç Filtrar por produto ou categoria" style="width:98%" oninput="filtrarEstoque()" />
	<button onclick="limparFiltroEstoque()" title="Limpar filtro" 
    style="background:#0d6efd; color:#fff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
    <i class="fa fa-broom"></i>
  </button>
   <button onclick="recalcularEstoqueGeral()" title="Recalcular Estoque"
    style="background:#198754; color:#fff; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
    <i class="fa fa-sync-alt"></i>
  </button>
  </div>

  <div class="table-wrap">
    <table id="tabelaEstoque">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Quantidade</th>
          <th>Lote</th>
          <th>√öltimo Valor (R$)</th>
          <th>Validade</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="resumoEstoque" style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);"></div>
</section>

<section id="limites" class="section" style="display:none;">
  <h2><i class="fa fa-boxes"></i> Estoque M√≠nimo e M√°ximo</h2>

  <!-- üìä Resumo correto -->
 <div id="resumoLimites" style="margin-top:10px; font-weight:bold; color:#333;">
  üßæ Total de Produtos: 0 |
  ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
  ‚úÖ Dentro do Limite: 0 |
  üì¶ Acima do M√°ximo: 0
</div>

  <!-- üîç Filtros -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; align-items:center;">
    <input
      id="filtroLimites"
      type="text"
      placeholder="üîç Buscar por produto"
      style="flex:1; min-width:220px"
      oninput="filtrarLimites()"
    />

    <!-- üßπ Bot√£o de limpar filtro (igual aos outros pain√©is) -->
    <button onclick="limparFiltroLimites()" title="Limpar filtro"
      style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>

    <select id="filtroCategoria" onchange="atualizarTabelaLimites()" style="min-width:220px;">
      <option value="">Todas as Categorias</option>
      <option>Material de Uso e Consumo</option>
      <option>Copa e Cozinha</option>
      <option>Escrit√≥rio</option>
      <option>Implante e Componentes</option>
      <option>Insumo Dental</option>
      <option>Insumo Laborat√≥rio</option>
      <option>Medicamentos</option>
      <option>Material de Limpeza</option>
    </select>

    <button onclick="gerarListaCompra()">
      <i class="fa fa-list"></i> Gerar Lista de Compra
    </button>

    <button onclick="limparListaCompra()">
      <i class="fa fa-trash"></i> Limpar Lista
    </button>
  </div>

  <!-- üìã Tabela principal -->
  <div class="table-wrap">
    <table id="tabelaLimites">
      <thead>
        <tr>
          <th>#</th>
          <th>Produto</th>
          <th>C√≥digo de Barras</th>
          <th>Categoria</th>
          <th>Qtd Atual</th>
          <th>M√≠nimo</th>
          <th>M√°ximo</th>
          <th>Status</th>
          <th>Recomenda√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- üõí Lista de compra -->
  <div id="listaCompraContainer" style="display:none; margin-top:20px;">
    <h3><i class="fa fa-shopping-cart"></i> Lista de Compra Gerada</h3>
    <div class="table-wrap" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
     <table id="tabelaListaCompra">
  <thead>
    <tr>
      <th>#</th>
      <th>Produto</th>
      <th>C√≥d. Barras</th>
      <th>Categoria</th>
      <th>Qtd Atual</th>
      <th>Recomenda√ß√£o</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="5" style="text-align:right; font-weight:bold;">Total de Itens:</td>
      <td id="totalItensCompra" style="font-weight:bold;">0</td>
    </tr>
  </tfoot>
</table>

    </div>

    <!-- ‚öôÔ∏è Bot√µes de a√ß√£o -->
    <div style="margin-top:10px;">
      <button onclick="exportarListaExcel()">
        <i class="fa fa-file-excel"></i> Exportar para Excel
      </button>
      <button onclick="gerarPedidoPDF()">
        <i class="fa fa-file-pdf"></i> Gerar Pedido de Or√ßamento (PDF)
      </button>
    </div>
  </div>
</section>

  


    

    
    <section id="financeiro" class="section" style="display:none;">
  <h2><i class="fa fa-chart-line"></i> Painel Financeiro</h2>

  <!-- üî∏ Indicadores financeiros detalhados -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">

    <!-- √öltimo valor de entrada -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ √öltimo Valor de Entrada</h3>
      <p id="valorUltimaEntrada" style="font-size:1.4em; font-weight:bold; color:#007bff;">R$ 0,00</p>
    </div>

    <!-- Custo m√©dio ponderado -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üìä Custo M√©dio Ponderado</h3>
      <p id="valorCustoMedio" style="font-size:1.4em; font-weight:bold; color:#6f42c1;">R$ 0,00</p>
    </div>

    <!-- Valor total do estoque atual -->
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üì¶ Valor Total do Estoque Atual</h3>
      <p id="valorEstoqueAtualPainel" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Indicadores principais existentes -->
  <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∞ Valor Total do Estoque Atual (Cont√°bil)</h3>
      <p id="valorEstoque" style="font-size:1.4em; font-weight:bold; color:#28a745;">R$ 0,00</p>
    </div>

    <div style="flex:1; min-width:250px; background:#f8f9fa; border-radius:8px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3>üí∏ Valor Total das Sa√≠das (Estimado)</h3>
      <p id="valorSaidas" style="font-size:1.4em; font-weight:bold; color:#dc3545;">R$ 0,00</p>
    </div>
  </div>

  <!-- üî∏ Entradas agrupadas -->
  <h3 style="margin-top:25px;"><i class="fa fa-file-invoice"></i> Entradas Agrupadas por Nota Fiscal</h3>
  <div class="table-wrap">
    <table id="tabelaFinanceiro">
      <thead>
        <tr>
          <th>Fornecedor</th>
          <th>Nota Fiscal</th>
          <th>Valor Total da Nota (R$)</th>
          <th>Saldo da Nota (R$)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
    
    <section id="relatorios" class="section">
      <h2><i class="fa fa-file-excel"></i> Gera√ß√£o de Relat√≥rios</h2>
      
      <div class="input-row">
        <label for="dataInicioRelatorio">De:</label>
        <input type="date" id="dataInicioRelatorio" style="width:150px;" />
        <label for="dataFimRelatorio">At√©:</label>
        <input type="date" id="dataFimRelatorio" style="width:150px;" />
        <button onclick="definirPeriodoRapido('7dias')">√öltimos 7 dias</button>
        <button onclick="definirPeriodoRapido('30dias')">√öltimos 30 dias</button>
        <button onclick="definirPeriodoRapido('mes')">M√™s Atual</button>
        <button onclick="limparPeriodo()">Limpar</button>
      </div>

      <div class="input-row" style="margin-top:10px;">
        <button onclick="exportarTabelaExcel('tabelaEntradas', 'Entradas', 'Entradas_')" style="background:#28a745;">
          <i class="fa fa-file-excel"></i> Exportar Entradas
        </button>
        <button onclick="exportarTabelaExcel('tabelaSaidas', 'Sa√≠das', 'Saidas_')" style="background:#dc3545;">
          <i class="fa fa-file-excel"></i> Exportar Sa√≠das
        </button>
        <button onclick="exportarTabelaExcel('tabelaEstoque', 'Estoque', 'Estoque_')" style="background:#0d6efd;">
          <i class="fa fa-file-excel"></i> Exportar Estoque Atual
        </button>
        <button onclick="exportarTabelaExcel('tabelaFinanceiro', 'Financeiro', 'Financeiro_')" style="background:#ffc107;">
          <i class="fa fa-file-excel"></i> Exportar Financeiro
        </button>
      </div>

      <div style="background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:20px;">
        <p>Os relat√≥rios em Excel (.csv) consideram o per√≠odo de data selecionado para Entradas e Sa√≠das. Os relat√≥rios de Estoque e Financeiro consideram o estado atual.</p>
      </div>
    </section>
    
	
   <section id="usuarios" class="section" style="display:none;">
  <h2><i class="fa fa-users"></i> Gerenciar Usu√°rios e Perfis</h2>
  <p style="color:#555; font-size:14px;">
    ‚ö†Ô∏è <b>Funcionalidade Firebase:</b> A cria√ß√£o e autentica√ß√£o de e-mails/senhas s√£o feitas diretamente no Firebase.
    Aqui voc√™ gerencia apenas perfis e metadados locais.
  </p>

  <!-- üßç Cadastro / Edi√ß√£o -->
  <div class="input-row" style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
    <input id="usuarioNome" type="text" placeholder="Nome Completo" class="flex" />
    <input id="usuarioEmail" type="email" placeholder="E-mail (ID do Firebase)" class="flex" />
    <input id="usuarioSenha" type="password" placeholder="Definir Senha (m√≠n. 6 caracteres)" class="flex" style="min-width:200px;" />
    
    <select id="usuarioPerfil" style="width:200px;">
      <option value="">Selecione o Perfil</option>
      <option>ADMIN</option>
      <option>GERENTE</option>
      <option>ESTOQUISTA</option>
    </select>

    <button onclick="salvarUsuarioLocal()" style="background:#198754; color:#fff;">
      <i class="fa fa-user-plus"></i> Salvar / Atualizar Perfil
    </button>
  </div>

  <!-- üîç Campo de busca + bot√£o üßπ -->
  <div style="display:flex; align-items:center; gap:8px; margin-top:10px; margin-bottom:10px;">
    <input
      id="filtroUsuarios"
      type="text"
      placeholder="üîç Buscar por nome ou e-mail"
      oninput="filtrarUsuarios()"
      style="flex:1; min-width:250px;"
    />
    <button onclick="limparFiltroUsuarios()" title="Limpar filtro"
      style="background:#6c757d; color:#fff;">
      <i class="fa fa-broom"></i>
    </button>
  </div>

  <!-- üìã Tabela de usu√°rios -->
  <div class="table-wrap">
    <table id="tabelaUsuarios">
      <thead>
        <tr>
          <th>#</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Perfil</th>
          <th>UID</th>
          <th>Data</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>



<script type="module">
¬† import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
¬† import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
¬† import { getFirestore, collection, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


¬† // Configura√ß√£o do Firebase
¬† const firebaseConfig = {
¬† ¬† apiKey: "AIzaSyCxhDaVIiLuNCagXOkyOSYC0El8KzbGfDw", // ‚ö†Ô∏è MANTENHA ESTA CHAVE PRIVADA
¬† ¬† authDomain: "oralunicestoque.firebaseapp.com",
¬† ¬† projectId: "oralunicestoque",
¬† ¬† storageBucket: "oralunicestoque.appspot.com",
¬† ¬† messagingSenderId: "660233908877",
¬† ¬† appId: "1:660233908877:web:2a6c9cd10b056b41bde8c4"
¬† };
¬†¬†
¬† // Inicializa√ß√£o
¬† const app = initializeApp(firebaseConfig);
¬† const auth = getAuth(app);
¬† const db = getFirestore(app);
// ==========================================================
// ADICIONE ESTE BLOCO NO IN√çCIO DO SEU <script type="module">
// ==========================================================
  
// üîπ Cria√ß√£o de vari√°veis globais com prote√ß√£o
window.produtos = JSON.parse(localStorage.getItem("produtos") || "[]");
window.entradas = JSON.parse(localStorage.getItem("entradas") || "[]");
window.saidas = JSON.parse(localStorage.getItem("saidas") || "[]");
window.usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");

// ‚úÖ Garante que as vari√°veis sejam sempre arrays v√°lidos
if (!Array.isArray(window.produtos)) window.produtos = [];
if (!Array.isArray(window.entradas)) window.entradas = [];
if (!Array.isArray(window.saidas)) window.saidas = [];
if (!Array.isArray(window.usuarios)) window.usuarios = [];

// ‚úÖ Mostra no console os dados carregados
console.log("Dados carregados do localStorage:", {
  produtos: window.produtos.length,
  entradas: window.entradas.length,
  saidas: window.saidas.length,
  usuarios: window.usuarios.length
});


¬†¬†window.PERMISSOES = {
    'ADMIN': {
        canView: ['dashboard', 'produtos', 'entradas', 'saidas', 'estoque', 'limites', 'usuarios', 'relatorios'],
        canEdit: true
    },
    'GERENTE': {
        canView: ['dashboard', 'produtos', 'entradas', 'saidas', 'estoque', 'limites', 'relatorios'],
        canEdit: ['produtos', 'entradas', 'saidas']
    },
    'ESTOQUISTA': {
        canView: ['estoque', 'relatorios'],
        canEdit: false
    },
    'USUARIO': { 
        canView: ['estoque'],
        canEdit: false
    },
};

 
// üîπ Salva dados globais no localStorage com seguran√ßa
function salvarTodosLocal() {
  try {
    localStorage.setItem("produtos", JSON.stringify(window.produtos || []));
    localStorage.setItem("entradas", JSON.stringify(window.entradas || []));
    localStorage.setItem("saidas", JSON.stringify(window.saidas || []));
    localStorage.setItem("usuarios", JSON.stringify(window.usuarios || []));
    
    console.log("Dados salvos localmente:", {
      produtos: window.produtos.length,
      entradas: window.entradas.length,
      saidas: window.saidas.length,
      usuarios: window.usuarios.length
    });
  } catch (e) {
    console.error("‚ö†Ô∏è Erro ao salvar no localStorage:", e);
  }
}

// ‚úÖ Torna a fun√ß√£o acess√≠vel globalmente
window.salvarTodosLocal = salvarTodosLocal;

// üîπ Salva/Busca no Firestore (Corrigida a l√≥gica de usu√°rios)
async function salvarDadosNoFirestore(nomeColecao, dados) {
  if (!auth.currentUser) return;

  try {
    if (nomeColecao === "usuarios") {
      const docRefGlobal = doc(db, "estoqueGlobal", "usuarios");
      await setDoc(docRefGlobal, { usuarios: dados });
    } else {
      const docRefUser = doc(db, "estoqueGlobal", "estoque");
      await setDoc(docRefUser, { [nomeColecao]: dados }, { merge: true });
    }
  } catch (e) {
    console.error("Erro ao salvar no Firestore:", e);
  } finally {
    // üî∏ Garante persist√™ncia local mesmo se o Firestore falhar
    salvarTodosLocal();
  }
}


async function carregarDadosDoFirestore() {
  if (!auth.currentUser) return;

  console.log("üîÑ Carregando dados do Firestore...");

  try {
    const docRefUser = doc(db, "estoqueGlobal", "estoque");
    const docSnapUser = await getDoc(docRefUser);

    if (docSnapUser.exists()) {
      const data = docSnapUser.data();

      // üîπ Garante que s√≥ substitua se o Firestore tiver dados reais
      window.produtos =
        Array.isArray(data.produtos) && data.produtos.length > 0
          ? data.produtos
          : window.produtos;

      window.entradas =
        Array.isArray(data.entradas) && data.entradas.length > 0
          ? data.entradas
          : window.entradas;

      window.saidas =
        Array.isArray(data.saidas) && data.saidas.length > 0
          ? data.saidas
          : window.saidas;

      console.log("‚úÖ Firestore carregado com sucesso.");
    } else {
      console.warn("‚ö†Ô∏è Firestore vazio ‚Äî salvando dados locais para a nuvem...");
      // üîπ Se n√£o existir documento, sobe os dados locais para o Firestore
      await salvarDadosNoFirestore("produtos", window.produtos || []);
      await salvarDadosNoFirestore("entradas", window.entradas || []);
      await salvarDadosNoFirestore("saidas", window.saidas || []);
    }

    // üîπ Carrega tamb√©m os usu√°rios
    const docRefGlobal = doc(db, "estoqueGlobal", "usuarios");
    const docSnapGlobal = await getDoc(docRefGlobal);

    if (docSnapGlobal.exists() && docSnapGlobal.data().usuarios) {
      window.usuarios = docSnapGlobal.data().usuarios;
    } else {
      console.warn("‚ö†Ô∏è Firestore sem usu√°rios ‚Äî mantendo dados locais.");
      await salvarDadosNoFirestore("usuarios", window.usuarios || []);
    }

    // üîπ Salva tudo localmente e atualiza tabelas
    salvarTodosLocal();

    if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
    if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
    if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
    if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
    if (typeof atualizarDashboard === "function") atualizarDashboard();
    if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
    if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
    if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();

    // ‚úÖ ADICIONE AQUI: Atualiza o painel financeiro assim que os dados forem carregados
    if (typeof atualizarPainelFinanceiro === "function") atualizarPainelFinanceiro();

    console.log("‚úÖ Dados carregados com seguran√ßa (Firestore + LocalStorage).");
  } catch (e) {
    console.error("‚ùå Erro CR√çTICO ao carregar dados do Firestore:", e);
    console.warn("‚ö†Ô∏è Mantendo dados locais para evitar perda.");
    salvarTodosLocal();
  }
}
document
  .querySelector("#sidebar button[onclick=\"showSection('financeiro')\"]")
  ?.addEventListener("click", atualizarPainelFinanceiro);
 

 
// üîπ Wrappers para usar o Firestore
window.salvarProdutosNoFirebase = (dados) => salvarDadosNoFirestore("produtos", dados);
window.salvarEntradasNoFirebase = (dados) => salvarDadosNoFirestore("entradas", dados);
window.salvarSaidasNoFirebase = (dados) => salvarDadosNoFirestore("saidas", dados);
window.salvarUsuariosNoFirebase = (dados) => salvarDadosNoFirestore("usuarios", dados);

// === CRIA√á√ÉO DE USU√ÅRIO (FIREBASE AUTH) ===

¬† window.criarUsuarioNoFirebase = async function(email, senha) {
¬† ¬† if (!auth.currentUser) {
¬† ¬† ¬† ¬† mostrarMensagem("Apenas usu√°rios logados podem criar novas contas.", "erro");
¬† ¬† ¬† ¬† return false;
¬† ¬† }
¬† ¬†¬†
¬† ¬† try {
¬† ¬† ¬† ¬† const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
¬† ¬† ¬† ¬† return userCredential.user;
¬† ¬† } catch (error) { 
¬† ¬† ¬† ¬† let msg = "Erro ao criar usu√°rio: " + error.code;
¬† ¬† ¬† ¬† if (error.code === 'auth/weak-password') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "A senha deve ter pelo menos 6 caracteres.";
¬† ¬† ¬† ¬† } else if (error.code === 'auth/email-already-in-use') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "O e-mail j√° est√° em uso por outra conta.";
¬† ¬† ¬† ¬† } else if (error.code === 'auth/invalid-email') {
¬† ¬† ¬† ¬† ¬† ¬† msg = "E-mail inv√°lido.";
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† mostrarMensagem(msg, "erro");
¬† ¬† ¬† ¬† console.error("Erro ao criar usu√°rio:", error.code, error.message);
¬† ¬† ¬† ¬† return false;
¬† ¬† }
¬† } 

// =================================================================================
// === FUN√á√ïES DE GERENCIAMENTO DE USU√ÅRIOS E PERFIS (INTEGRADO AQUI) ===
// =================================================================================

window.salvarUsuarioLocal = async function() {

    // üö® PASSO 1: ARMAZENA O CONTEXTO ATUAL DO ADMIN
    const adminEmailLogado = auth.currentUser ? auth.currentUser.email.toLowerCase() : null;

    // 1. Coleta e valida√ß√£o dos campos do PERFIL
    const nomeEl = document.getElementById("usuarioNome");
    const emailEl = document.getElementById("usuarioEmail");
    const senhaEl = document.getElementById("usuarioSenha");
    const perfilEl = document.getElementById("usuarioPerfil");
    
    // ... (Valida√ß√µes e coleta de dados, Mantidas)
    if (typeof limparErros === 'function') limparErros("usuarios");
    emailEl.disabled = false;
    
    if (!nomeEl.value.trim()) return typeof destacarErro === 'function' ? destacarErro(nomeEl, "Informe o nome!") : alert("Informe o nome!");
    if (!emailEl.value.trim().includes("@")) return typeof destacarErro === 'function' ? destacarErro(emailEl, "Informe um e-mail v√°lido!") : alert("Informe um e-mail v√°lido!");
    if (!perfilEl.value.trim()) return typeof destacarErro === 'function' ? destacarErro(perfilEl, "Selecione o perfil!") : alert("Selecione o perfil!");

    const email = emailEl.value.trim().toLowerCase();
    const nome = nomeEl.value.trim(); 
    const perfil = perfilEl.value.trim();
    const senha = senhaEl.value.trim();
    
    const index = window.usuarios.findIndex(u => u.email.toLowerCase() === email);
    let isNovoUsuario = index === -1;

    try {
        if (isNovoUsuario) {
            
            if (!senha || senha.length < 6) {
                return typeof destacarErro === 'function' ? destacarErro(senhaEl, "A senha √© obrigat√≥ria (m√≠n. 6 caracteres) para um novo usu√°rio.") : alert("A senha √© obrigat√≥ria (m√≠n. 6 caracteres) para um novo usu√°rio.");
            }
            
            // Cria o usu√°rio no Firebase Auth (Isto dispara o evento de login tempor√°rio)
            const firebaseUser = await window.criarUsuarioNoFirebase(email, senha);

            if (!firebaseUser) {
                return; 
            }
            
            const novoUsuarioPerfil = {
                uid: firebaseUser.uid, 
                email: email,
                nome: nome,
                perfil: perfil,
                criadoEm: new Date().toISOString()
            };
            
            window.usuarios.push(novoUsuarioPerfil);
            
            if (typeof mostrarMensagem === 'function') mostrarMensagem(`‚úÖ Usu√°rio "${nome}" criado no Firebase Auth e perfil salvo!`, "sucesso");

        } else {
            // A√á√ÉO 2: EDI√á√ÉO DE PERFIL (Mantida)
            window.usuarios[index].nome = nome;
            window.usuarios[index].perfil = perfil;
            
            if (senha) {
                 if (typeof mostrarMensagem === 'function') mostrarMensagem("‚ö†Ô∏è Senha n√£o alterada. Use o painel do Firebase para alterar senhas de outros usu√°rios.", "info");
            } else {
                 if (typeof mostrarMensagem === 'function') mostrarMensagem(`‚úèÔ∏è Perfil de "${nome}" atualizado!`, "sucesso");
            }
            
            emailEl.disabled = false;
        }
        
        // Preven√ß√£o de Duplicatas (Mantida)
        const uidsUnicos = new Set();
        const usuariosSemDuplicatas = [];
        window.usuarios.forEach(u => {
            if (!uidsUnicos.has(u.uid)) {
                uidsUnicos.add(u.uid);
                usuariosSemDuplicatas.push(u);
            }
        });
        window.usuarios = usuariosSemDuplicatas;
        
        // 3. Persiste os dados atualizados no LocalStorage e no Firestore
        if (typeof salvarTodosLocal === 'function') salvarTodosLocal();
        await window.salvarUsuariosNoFirebase(window.usuarios); 
        
        // üö® PASSO 2: RESTAURA O CONTEXTO DO ADMIN MANUALMENTE
        if (adminEmailLogado) {
             // 1. Tenta encontrar o PERFIL DO ADMIN na lista ATUALIZADA
             const adminPerfilNaLista = window.usuarios.find(u => u.email.toLowerCase() === adminEmailLogado);
             
             if (adminPerfilNaLista) {
                 // 2. Cria um contexto de usu√°rio (objeto simples) com o perfil encontrado
                 const userContextAdmin = { 
                     email: adminPerfilNaLista.email, 
                     uid: adminPerfilNaLista.uid
                 };
                 // 3. For√ßa a exibi√ß√£o do sistema usando o perfil conhecido do Admin
                 mostrarSistema(userContextAdmin); 
             } else {
                 // Fallback para o m√©todo padr√£o
                 mostrarSistema(auth.currentUser); 
             }
        }
        
        // 4. Atualiza a interface da tabela
        if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
        
        // 5. Limpa os campos ap√≥s o sucesso
        if (typeof limparCampos === 'function') {
             limparCampos("usuarioNome", "usuarioEmail", "usuarioSenha", "usuarioPerfil"); 
        } else {
            nomeEl.value = ''; emailEl.value = ''; senhaEl.value = ''; perfilEl.value = '';
        }
        
    } catch (e) {
        console.error("Erro ao salvar usu√°rio:", e);
        if (typeof mostrarMensagem === 'function') mostrarMensagem("‚ùå Erro ao salvar o usu√°rio. Verifique o console.", "erro");
    }
};

/**
 * üîπ Fun√ß√£o utilit√°ria para preencher os campos para EDI√á√ÉO (Exposta no window)
 */
window.editarUsuarioLocal = function(i) {
    const usuario = window.usuarios[i];
    if (!usuario) return;

    document.getElementById("usuarioNome").value = usuario.nome || '';
    document.getElementById("usuarioEmail").value = usuario.email || '';
    document.getElementById("usuarioPerfil").value = usuario.perfil || '';
    document.getElementById("usuarioSenha").value = ''; 

    document.getElementById("usuarioEmail").disabled = true;
    document.getElementById("usuarioNome").focus();
    
    if (typeof mostrarMensagem === 'function') mostrarMensagem(`Editando perfil de ${usuario.nome}. Clique em Salvar/Atualizar Perfil para finalizar.`, "info");
}

/**
 * üîπ Fun√ß√£o para EXCLUIR APENAS O PERFIL LOCAL (Exposta no window)
 */
window.excluirUsuarioLocal = function(i) {
    // üö® VERIFICA√á√ÉO DE SEGURAN√áA
    if (!window.usuarios[i]) {
        console.warn("Usu√°rio com √≠ndice inv√°lido, recarregando tabela.");
        window.atualizarTabelaUsuarios();
        return;
    }

    const usuario = window.usuarios[i];
    
    // ... (o restante da fun√ß√£o continua)
    if (!confirm(`Excluir o perfil local de "${usuario.nome}" (${usuario.email})? Note que isso N√ÉO exclui o usu√°rio do Firebase Authentication.`)) return; 
    
    window.usuarios.splice(i, 1);
    
    if (typeof salvarTodosLocal === 'function') salvarTodosLocal();
    window.salvarUsuariosNoFirebase(window.usuarios);
    
    window.atualizarTabelaUsuarios();
    
    if (typeof mostrarMensagem === 'function') mostrarMensagem(`Perfil local de ${usuario.nome} exclu√≠do.`, "sucesso");
}

/**
 * üîπ Fun√ß√£o para ATUALIZAR A TABELA de Usu√°rios na interface (Exposta no window)
 */
window.atualizarTabelaUsuarios = function() {
    const tbody = document.querySelector("#tabelaUsuarios tbody");
    if (!tbody) return; 

    const filtroEl = document.getElementById("filtroUsuarios");
    const filtro = filtroEl ? filtroEl.value.toLowerCase() : "";
    tbody.innerHTML = "";

    window.usuarios.forEach((u, i) => {
        const nome = (u.nome || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        
        if (filtro && !nome.includes(filtro) && !email.includes(filtro)) return;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i + 1}</td>
            <td style="font-weight: bold;">${u.nome || "-"}</td>
            <td>${u.email || "-"}</td>
            <td><span style="background:#0d6efd; color:white; padding:4px 8px; border-radius:5px; font-size:12px;">${u.perfil || "-"}</span></td>
            <td>${u.uid ? u.uid.substring(0, 8) + '...' : 'N/A'}</td>
            <td>${u.criadoEm ? new Date(u.criadoEm).toLocaleDateString('pt-BR') : 'Desconhecido'}</td>
            <td>
                <button onclick="editarUsuarioLocal(${i})" title="Editar Perfil"><i class="fa fa-edit"></i></button>
                <button onclick="excluirUsuarioLocal(${i})" title="Excluir Perfil Local"><i class="fa fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
};

/**
 * üîπ Fun√ß√£o auxiliar de filtro (Exposta no window)
 */
window.filtrarUsuarios = function() {
    window.atualizarTabelaUsuarios();
}

/**
 * üîπ Limpa o filtro de busca E os campos do formul√°rio de usu√°rio
 */
window.limparFiltroUsuarios = function() {
  // üßπ Campos do formul√°rio
  const nome = document.getElementById("usuarioNome");
  const email = document.getElementById("usuarioEmail");
  const senha = document.getElementById("usuarioSenha");
  const perfil = document.getElementById("usuarioPerfil");
  const filtro = document.getElementById("filtroUsuarios");

  if (nome) nome.value = "";
  if (email) {
    email.value = "";
    email.disabled = false; // Garante que o campo volte a ser edit√°vel
  }
  if (senha) senha.value = "";
  if (perfil) perfil.value = "";
  if (filtro) filtro.value = "";

  // Atualiza a tabela de usu√°rios
  if (typeof window.atualizarTabelaUsuarios === "function") {
    window.atualizarTabelaUsuarios();
  }

  // Mensagem de feedback
  if (typeof mostrarMensagem === "function") {
    mostrarMensagem("Campos e filtro de usu√°rios limpos.", "info");
  }
};


// =================================================================================
// === FIM DAS FUN√á√ïES DE GERENCIAMENTO DE USU√ÅRIOS ===
// =================================================================================

// === LOGIN E SESS√ÉO ===
¬†¬†
function mostrarSistema(user) {
    // ... (Seu c√≥digo inicial, Mantido)
    const loginView = document.getElementById("loginView");
    const mainApp = document.getElementById("mainApp");
    const userNameEl = document.getElementById("userName");
    const perfilBadgeEl = document.getElementById("perfilBadge");
    const nomeBemVindoEl = document.getElementById("nomeUsuarioBemVindo");

    if (loginView && mainApp) {
        loginView.style.display = "none";
        mainApp.style.display = "block";
    }

    const usuarioLogado = window.usuarios.find(u => u.email.toLowerCase() === user.email.toLowerCase());
    const nomeFallback = user.email.split('@')[0];
    
    // üö® GARANTINDO O PERFIL CORRETO
    const nome = usuarioLogado ? usuarioLogado.nome : nomeFallback;
    const perfil = usuarioLogado ? usuarioLogado.perfil.toUpperCase() : "USUARIO";
    
    if (userNameEl) userNameEl.textContent = nome;
    if (perfilBadgeEl) perfilBadgeEl.textContent = "Perfil: " + perfil;
    if (nomeBemVindoEl) nomeBemVindoEl.textContent = nome;

    // ==========================================================
    // APLICA√á√ÉO DAS PERMISS√ïES: Agora usa a vari√°vel global window.PERMISSOES
    // ==========================================================
    const permissoesDoUsuario = window.PERMISSOES[perfil] || window.PERMISSOES['USUARIO'];
    
    // 1. Oculta ou exibe os itens de menu
    const menuLinks = document.querySelectorAll('#sidebar a[data-section]');
    menuLinks.forEach(link => {
        const sectionName = link.getAttribute('data-section');
        // Usa a lista canView para determinar o que mostrar
        if (permissoesDoUsuario.canView.includes(sectionName)) { 
            link.style.display = ''; 
        } else {
            link.style.display = 'none'; 
        }
    });

    // 2. Redireciona para a primeira se√ß√£o permitida
    let initialSection = permissoesDoUsuario.canView.includes('dashboard') ? 'dashboard' : permissoesDoUsuario.canView[0];
    
    if (typeof showSection === "function") {
         showSection(initialSection);
    }
    // ==========================================================

    // Se√ß√µes de Cadastro e Movimenta√ß√£o devem ser desabilitadas para Estoquista
    // O GERENTE tem permiss√£o de edi√ß√£o nas se√ß√µes.
    const podeEditar = permissoesDoUsuario.canEdit === true || (Array.isArray(permissoesDoUsuario.canEdit) && (permissoesDoUsuario.canEdit.includes('produtos') || permissoesDoUsuario.canEdit.includes('entradas') || permissoesDoUsuario.canEdit.includes('saidas')));
    
    const entradaBtn = document.getElementById('adicionarEntradaBtn');
    const saidaBtn = document.getElementById('adicionarSaidaBtn');
    const addProdutoBtn = document.getElementById('adicionarProdutoBtn'); 
    
    if (!podeEditar) {
         if (entradaBtn) entradaBtn.style.display = 'none';
         if (saidaBtn) saidaBtn.style.display = 'none';
         if (addProdutoBtn) addProdutoBtn.style.display = 'none';
    } else {
         if (entradaBtn) entradaBtn.style.display = '';
         if (saidaBtn) saidaBtn.style.display = '';
         if (addProdutoBtn) addProdutoBtn.style.display = '';
    }
}
¬†¬†
¬† window.fazerLogin = async function() {
    // 1. Coleta os valores e garante que os campos vazios sejam tratados
    const usuarioEl = document.getElementById("usuarioLogin");
    const senhaEl = document.getElementById("senhaLogin");

    const usuario = usuarioEl.value.trim(); // Limpa espa√ßos
    const senha = senhaEl.value.trim();     // Limpa espa√ßos

    if (!usuario || !senha) {
        // Usa a fun√ß√£o de erro se estiver dispon√≠vel, sen√£o usa alert
        if (typeof destacarErro === 'function') {
            if (!usuario) destacarErro(usuarioEl, "Informe o e-mail!");
            if (!senha) destacarErro(senhaEl, "Informe a senha!");
        } else {
            alert("Preencha e-mail e senha!");
        }
        return;
    }

    // 2. Padroniza o e-mail para garantir o formato correto (min√∫sculas)
    const email = usuario.toLowerCase(); 

    // 3. Valida√ß√£o de formato de e-mail antes de enviar ao Firebase (boa pr√°tica)
    if (!email.includes("@") || email.length < 5) {
        if (typeof destacarErro === 'function') {
            destacarErro(usuarioEl, "O formato do e-mail √© inv√°lido.");
        } else {
            alert("O formato do e-mail √© inv√°lido.");
        }
        return;
    }

    try {
        // Tenta logar no Firebase Auth
        await signInWithEmailAndPassword(auth, email, senha);
        // O onAuthStateChanged cuidar√° da transi√ß√£o da tela
    } catch (error) {
        console.error(error.code, error.message);
        
        let mensagemErro = "Erro desconhecido ao tentar logar.";
        
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            mensagemErro = "E-mail ou senha inv√°lidos. Verifique suas credenciais.";
        } else if (error.code === 'auth/invalid-email') {
            // Este erro deve ser capturado pela nossa valida√ß√£o antes, mas √© bom manter aqui
            mensagemErro = "O formato do e-mail √© inv√°lido.";
        } else {
            mensagemErro = `Erro: ${error.message}`;
        }

        if (typeof mostrarMensagem === 'function') {
            mostrarMensagem(mensagemErro, "erro");
        } else {
            alert(mensagemErro);
        }
    }
};
¬†
¬†
// === MONITORAR LOGIN (VERS√ÉO CORRIGIDA E SINCRONIZADA) ===
onAuthStateChanged(auth, async (user) => {
  const login = document.getElementById("loginView");
  const appDiv = document.getElementById("mainApp");

  if (user) {
    // Usu√°rio logado
    login.style.display = "none";
    appDiv.style.display = "block";

    const emailLogado = user.email.toLowerCase();
    const perfilExiste = window.usuarios.find(
      (u) => u.email.toLowerCase() === emailLogado
    );

    // Cria perfil local se ainda n√£o existir
    if (!perfilExiste) {
      const novoPerfil = {
        uid: user.uid,
        email: emailLogado,
        nome: emailLogado.split("@")[0],
        perfil: "USUARIO",
        criadoEm: new Date().toISOString(),
      };
      window.usuarios.push(novoPerfil);
      // Salva no Firestore tamb√©m
      window.salvarUsuariosNoFirebase(window.usuarios);
    }

    // üîπ Aguarda carregar dados do Firestore ANTES de atualizar interface
    console.log("üîÑ Carregando dados do Firestore, aguarde...");
    await carregarDadosDoFirestore();
    console.log("‚úÖ Dados do Firestore carregados e sincronizados.");

    // üîπ Garante que os dados locais n√£o sejam sobrescritos se Firestore estiver vazio
    salvarTodosLocal();

    // üîπ Mostra sistema e atualiza todas as tabelas
    mostrarSistema(user);

    const usuario = window.usuarios.find(
      (u) => u.email.toLowerCase() === emailLogado
    );
    const nomeUsuario =
      (usuario && usuario.nome) || user.email.split("@")[0] || "Usu√°rio";

    document.getElementById("nomeUsuarioBemVindo").innerText = nomeUsuario;

    // üîπ Recarrega tabelas e se√ß√µes ap√≥s garantir dados carregados
    setTimeout(() => {
      if (typeof atualizarTabelaProdutos === "function") atualizarTabelaProdutos();
      if (typeof atualizarTabelaEntradas === "function") atualizarTabelaEntradas();
      if (typeof atualizarTabelaSaidas === "function") atualizarTabelaSaidas();
      if (typeof atualizarTabelaEstoque === "function") atualizarTabelaEstoque();
      if (typeof atualizarDashboard === "function") atualizarDashboard();
      if (typeof atualizarTabelaUsuarios === "function") atualizarTabelaUsuarios();
      if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
	  if (typeof atualizarTabelaLimites === "function") atualizarTabelaLimites();

      // Mostra a se√ß√£o de boas-vindas (ou a √∫ltima usada)
      showSection("boasVindas");
    }, 500);

  } else {
    // Usu√°rio deslogado
    login.style.display = "flex";
    appDiv.style.display = "none";
    document.getElementById("userName").innerText = "Visitante";
    document.getElementById("perfilBadge").innerText = "PERFIL";
  }
});




¬† // === LOGOUT ===
¬† window.logout = async function() {
¬† ¬† await signOut(auth);
¬† ¬† mostrarMensagem("Sess√£o encerrada!", "info");
¬† };
¬†¬†
¬† // Expor Firestore para uso em outras fun√ß√µes, se necess√°rio
¬† window.db = db;
¬† window.auth = auth;
// üîπ Fun√ß√µes utilit√°rias globais simples (caso n√£o estejam definidas em outro lugar)
window.showSection = function(sectionId) {
  document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
  const section = document.getElementById(sectionId);
  if (section) section.style.display = "block";
};

// =============================
// ‚úÖ CONTROLE DO MENU LATERAL (VERS√ÉO FINAL FUNCIONAL)
// =============================
window.toggleSidebar = function () {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.querySelector("main");
  if (!sidebar || !mainContent) return;

  const isOpen = sidebar.style.left === "0px";

  if (isOpen) {
    // Fechar menu
    sidebar.style.left = "-220px";
    mainContent.style.marginLeft = "20px";
    sidebar.setAttribute("aria-hidden", "true");
  } else {
    // Abrir menu
    sidebar.style.left = "0px";
    mainContent.style.marginLeft = "240px";
    sidebar.setAttribute("aria-hidden", "false");
  }
};

// ‚úÖ Fecha o menu automaticamente ao clicar fora dele
document.addEventListener("click", (event) => {
  const sidebar = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menuToggle");
  if (!sidebar || !menuToggle) return;

  const clickDentroSidebar = sidebar.contains(event.target);
  const clickNoToggle = menuToggle.contains(event.target);

  if (!clickDentroSidebar && !clickNoToggle && sidebar.style.left === "0px") {
    window.toggleSidebar(); // fecha o menu
  }
});

// ‚úÖ NOVO: Fecha o menu automaticamente ao clicar em QUALQUER item do menu
document.addEventListener("click", (event) => {
  const sidebar = document.getElementById("sidebar");
  const mainContent = document.querySelector("main");
  if (!sidebar || !mainContent) return;

  // Verifica se o clique foi em um item do menu (ou algo dentro dele)
  const itemMenu = event.target.closest("#sidebar a, #sidebar button, #sidebar li");
  if (itemMenu) {
    sidebar.style.left = "-220px";
    mainContent.style.marginLeft = "20px";
    sidebar.setAttribute("aria-hidden", "true");
  }
});
;
¬†¬†
¬†</script>


<script>
// --- VARI√ÅVEIS GLOBAIS ---
// Elas s√£o inicializadas no script type="module" acima, mas devem ser declaradas aqui para o escopo global.
if (typeof produtos === "undefined") window.produtos = [];
if (typeof entradas === "undefined") window.entradas = [];
if (typeof saidas === "undefined") window.saidas = [];
if (typeof usuarios === "undefined") window.usuarios = [];



// --- EXECU√á√ÉO INICIAL (AJUSTADA) ---

document.addEventListener("DOMContentLoaded", () => {
    // A autentica√ß√£o Firebase (no script type="module" acima) cuida do carregamento e atualiza√ß√£o inicial.
    // Garante que o menu de setor √© preenchido na se√ß√£o de Sa√≠da
    if (typeof atualizarSetorAutomatico === "function") atualizarSetorAutomatico(); 
});


// üö® CORRE√á√ÉO DO EVENT LISTENER (para fechar ao clicar fora)
document.addEventListener('click', (event) => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    if (!sidebar || !menuToggle) return;
    
    // L√™ o valor atual usando a mesma l√≥gica robusta
    const currentLeft = parseFloat(window.getComputedStyle(sidebar).getPropertyValue('left'));

    // Se a sidebar estiver vis√≠vel (currentLeft >= 0)
    if (currentLeft >= 0) {
        
        // Verifica se o clique foi dentro da sidebar OU no bot√£o de toggle
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickOnToggle = menuToggle.contains(event.target);

        // Se o clique n√£o foi dentro da sidebar E n√£o foi no bot√£o de toggle, fecha
        if (!isClickInsideSidebar && !isClickOnToggle) {
            toggleSidebar();
        }
    }
});






// =============================
// ‚úÖ MOSTRAR SE√á√ïES DO SISTEMA
// =============================
function showSection(id) {
  // Esconde todas as se√ß√µes
  document.querySelectorAll("section").forEach((section) => {
    section.style.display = "none";
  });

  // Mostra apenas a se√ß√£o selecionada
  const sectionToShow = document.getElementById(id);
  if (sectionToShow) {
    sectionToShow.style.display = "block";
  }

  // Fecha o menu se ele estiver aberto
  const sidebar = document.getElementById("sidebar");
  if (sidebar.style.left === "0px") {
    toggleSidebar();
  }

  // Atualiza automaticamente os pain√©is conforme a se√ß√£o
  if (id === "dashboard") atualizarDashboard();
  if (id === "estoque") atualizarTabelaEstoque();
  if (id === "limites") atualizarTabelaLimites();
  if (id === "financeiro") atualizarPainelFinanceiro();
  if (id === "cadastro") atualizarTabelaProdutos();
  if (id === "entrada") atualizarTabelaEntradas();
  if (id === "saida") atualizarTabelaSaidas();
  if (id === "usuarios") atualizarTabelaUsuarios();
}

// =============================
// ‚úÖ MOSTRAR TELA DE BOAS-VINDAS AP√ìS LOGIN
// =============================
// Dentro do onAuthStateChanged (l√° no seu script type="module"),
// troque qualquer chamada "showSection('dashboard')" por isto:
showSection('boasVindas');


/**
 * üîπ Exibe uma notifica√ß√£o de "toast" no rodap√©
 */
function mostrarMensagem(texto, tipo = "info") {
  const box = document.getElementById("toastMessage");
  if (!box) {
      // Cria a caixa se n√£o existir
      const newBox = document.createElement("div");
      newBox.id = "toastMessage";
      document.body.appendChild(newBox);
      // Reaplica a vari√°vel box
      box = document.getElementById("toastMessage");
  }

  box.textContent = texto;
  box.style.background = tipo === "erro" ? "#dc3545" : tipo === "sucesso" ? "#28a745" : "#0d6efd";
  box.style.opacity = "1";
  box.style.transform = "translateX(-50%) translateY(0)"; // Move para cima

  setTimeout(() => {
      box.style.opacity = "0";
      box.style.transform = "translateX(-50%) translateY(20px)"; // Move para baixo
  }, 4000);
}

/**
 * üîπ Destaca o campo com erro
 */
function destacarErro(el, msg) {
  el.style.border = "2px solid red";
  el.focus();
  mostrarMensagem(msg, "erro");
}

/**
 * üîπ Remove marca√ß√µes de erro
 */
function limparErros(secaoId) {
    document.querySelectorAll(`#${secaoId} input, #${secaoId} select`).forEach(el => {
        el.style.border = "1px solid #ccc";
        el.title = "";
    });
}

/**
 * üîπ Fun√ß√£o gen√©rica ‚Äî limpa todos os inputs e selects dentro de uma se√ß√£o
 */
function limparCampos(secaoId) {
  const secao = document.getElementById(secaoId);
  if (!secao) return;
  secao.querySelectorAll("input, select").forEach(el => {
    if (el.type === "file") {
      el.value = "";
    } else if (el.tagName === "SELECT") {
      el.selectedIndex = 0;
    } else {
      el.value = "";
    }
  });
}

/**
 * üîπ Amplia a imagem do produto no modal
 */
function ampliarImagem(src) {
  const modal = document.getElementById("imagemAmpliada");
  modal.querySelector("img").src = src;
  modal.style.display = "flex";
}

/**
 * üîπ Fun√ß√£o utilit√°ria: busca c√≥digo de barras do produto
 */
function buscarCodigoBarrasDoProduto(nome) {
    const p = produtos.find(p => p.nome === nome);
    return p ? p.codigoBarras : "-";
}

/**
 * üîπ Atualiza o campo 'quantidade' no estoque global
 */
function atualizarEstoque(nomeProduto, quantidadeDelta, ultimoValor = null, lote = "", validade = "") {
  const produtoRef = produtos.find(
    p => p.nome.trim().toLowerCase() === nomeProduto.trim().toLowerCase()
  );

  if (produtoRef) {
    let qtdAtual = Number(produtoRef.quantidade || 0);
    qtdAtual += quantidadeDelta;
    produtoRef.quantidade = Math.max(0, qtdAtual);

    // üîπ Atualiza campos adicionais com dados da √∫ltima entrada
    if (ultimoValor !== null && !isNaN(ultimoValor)) produtoRef.ultimoValor = Number(ultimoValor);
    if (lote) produtoRef.lote = lote;
    if (validade) produtoRef.validade = validade;

    salvarProdutosNoFirebase(produtos);
    atualizarTabelaEstoque();
    atualizarDashboard();
    atualizarPainelFinanceiro();
  }
}


// --- PADRONIZA√á√ÉO DE DADOS ---

/**
 * üîπ Formata o texto para padr√£o (Primeira Letra Mai√∫scula)
 */
function formatarTextoPadrao(texto) {
  if (!texto) return "";
  return texto
    .toLowerCase()
    .split(" ")
    .filter(p => p.trim() !== "")
    .map(p => p.charAt(0).toUpperCase() + p.slice(1))
    .join(" ");
}

/**
 * üî∏ Aplica automaticamente a padroniza√ß√£o ao sair de campos de texto
 */
document.addEventListener("blur", (e) => {
  const el = e.target;
  if (el.tagName === "INPUT" && el.type === "text") {
    // Ignora campos que n√£o devem ser alterados (ex: c√≥digos, e-mail)
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  }
}, true);

/**
 * üî∏ Garante padroniza√ß√£o em todos os campos antes de salvar/cadastrar
 */
function padronizarCamposAntesDeSalvar() {
  document.querySelectorAll('input[type="text"]').forEach(el => {
    // Mesma l√≥gica de ignorar campos espec√≠ficos
    if (
      el.id.toLowerCase().includes("cnpj") ||
      el.id.toLowerCase().includes("email") ||
      el.id.toLowerCase().includes("login") ||
      el.id.toLowerCase().includes("lote") ||
      el.id.toLowerCase().includes("barras")
    ) return;
    el.value = formatarTextoPadrao(el.value);
  });
}



// ===============================================
// ‚úÖ CADASTRO E EDI√á√ÉO DE PRODUTOS (com foto obrigat√≥ria)
// ===============================================
window.cadastrarProduto = async function () {
  limparErros("cadastro");

  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEmbEl = document.getElementById("produtoQtdEmbalagem");
  const codBarrasEl = document.getElementById("produtoCodigoBarras");
  const fotoEl = document.getElementById("produtoFoto");

  const nome = nomeEl.value.trim();
  const categoria = categoriaEl.value.trim();
  const embalagem = embalagemEl.value.trim();
  const qtdEmb = parseInt(qtdEmbEl.value.trim()) || 0;
  const codBarras = codBarrasEl.value.trim();

  // === Valida√ß√µes obrigat√≥rias ===
  if (!nome) return destacarErro(nomeEl, "Informe o nome do produto!");
  if (!categoria) return destacarErro(categoriaEl, "Selecione a categoria!");
  if (!embalagem) return destacarErro(embalagemEl, "Selecione o tipo de embalagem!");
  if (!qtdEmb) return destacarErro(qtdEmbEl, "Informe a quantidade por embalagem!");
  // === Valida√ß√£o de imagem ===
let fotoBase64 = "";
const isEdicao = typeof indiceEdicaoProduto === "number" && indiceEdicaoProduto !== null;

// Se for novo produto, exige foto obrigat√≥ria
if (!isEdicao && !fotoEl.files[0]) {
  return destacarErro(fotoEl, "A foto do produto √© obrigat√≥ria!");
}

// Se o usu√°rio escolheu uma nova foto, l√™ o arquivo
if (fotoEl.files && fotoEl.files[0]) {
  const file = fotoEl.files[0];
  fotoBase64 = await new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.readAsDataURL(file);
  });
}


  // === Se for modo de edi√ß√£o ===
  if (typeof indiceEdicaoProduto === "number" && indiceEdicaoProduto !== null) {
    const produtoAntigo = window.produtos[indiceEdicaoProduto];
    const nomeAntigo = produtoAntigo.nome;

    produtoAntigo.nome = nome;
    produtoAntigo.categoria = categoria;
    produtoAntigo.embalagem = embalagem;
    produtoAntigo.qtdEmbalagem = qtdEmb;
    produtoAntigo.codBarras = codBarras;
    if (fotoBase64) {
  produtoAntigo.foto = fotoBase64;
}

    // Atualiza outras tabelas que dependem do nome
    atualizarReferenciasProduto(nomeAntigo, nome);

    mostrarMensagem(`‚úÖ Produto "${nome}" atualizado com sucesso!`, "sucesso");

    indiceEdicaoProduto = null;
    mostrarBotaoCancelar(false);
  } else {
    // === Novo produto ===
    const novoProduto = {
      id: Date.now(),
      nome,
      categoria,
      embalagem,
      qtdEmbalagem: qtdEmb,
      codBarras,
      foto: fotoBase64,
      criadoEm: new Date().toISOString(),
    };

    window.produtos.push(novoProduto);
    mostrarMensagem(`‚úÖ Produto "${nome}" cadastrado com sucesso!`, "sucesso");
  }

  // === Salvar e atualizar ===
  salvarTodosLocal();
  if (typeof window.salvarProdutosNoFirebase === "function") {
    window.salvarProdutosNoFirebase(window.produtos);
  }

  atualizarTabelaProdutos();
  atualizarTabelaEstoque?.();
  atualizarTabelaEntradas?.();
  atualizarTabelaSaidas?.();
  atualizarTabelaLimites?.();
  atualizarDashboard?.();

 // === Limpa campos ap√≥s cadastrar ou editar ===
nomeEl.value = "";
categoriaEl.value = "";
embalagemEl.value = "";
qtdEmbEl.value = "";
codBarrasEl.value = "";
fotoEl.value = "";

// üü¢ Limpa o preview da foto ap√≥s salvar
const fotoPreview = document.getElementById("fotoPreview");
if (fotoPreview) fotoPreview.innerHTML = "";

document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr) => {
  tr.style.background = "";
});
};

// ===============================================
// ‚úÖ Torna fun√ß√£o de cancelar edi√ß√£o global
// ===============================================
window.cancelarEdicaoProduto = function () {
  indiceEdicaoProduto = null;

  if (typeof limparCampos === "function") {
    limparCampos("cadastro");
  }

  document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

if (typeof window.mostrarBotaoCancelar === "function") {
  window.mostrarBotaoCancelar(false);
}

// üü¢ Limpa o preview da foto ao cancelar a edi√ß√£o
const fotoPreview = document.getElementById("fotoPreview");
if (fotoPreview) fotoPreview.innerHTML = "";

mostrarMensagem("üö´ Edi√ß√£o cancelada.", "info");
};


// ===============================================
// ‚úÖ Fun√ß√£o global para atualizar refer√™ncias de produtos
// ===============================================
window.atualizarReferenciasProduto = function (nomeAntigo, nomeNovo) {
  if (!nomeAntigo || !nomeNovo || nomeAntigo === nomeNovo) return;

  // Atualiza o nome nas listas de entradas e sa√≠das
  window.entradas?.forEach((e) => {
    if (e.produto === nomeAntigo) e.produto = nomeNovo;
  });

  window.saidas?.forEach((s) => {
    if (s.produto === nomeAntigo) s.produto = nomeNovo;
  });

  // Atualiza tamb√©m na lista principal de produtos
  window.produtos?.forEach((p) => {
    if (p.nome === nomeAntigo) p.nome = nomeNovo;
  });

  // Salva tudo localmente se a fun√ß√£o existir
  if (typeof window.salvarTodosLocal === "function") {
    window.salvarTodosLocal();
  }

  mostrarMensagem("üîÑ Refer√™ncias atualizadas em todo o sistema.", "info");
};


// ===============================================
// ‚úÖ CORRE√á√ÉO: Atualiza tabela de produtos
// ===============================================
window.atualizarTabelaProdutos = function () {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  if (!tbody) return;

  const filtroEl = document.getElementById("filtroProduto");
  const filtro = filtroEl ? filtroEl.value.toLowerCase() : "";

  tbody.innerHTML = "";

  if (!Array.isArray(window.produtos)) window.produtos = [];

  if (window.produtos.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="8" style="text-align:center; color:#777;">Nenhum produto cadastrado.</td>`;
    tbody.appendChild(row);
    return;
  }

  window.produtos.forEach((produto, i) => {
    const nome = produto.nome?.toLowerCase() || "";
    const categoria = produto.categoria?.toLowerCase() || "";
    if (filtro && !nome.includes(filtro) && !categoria.includes(filtro)) return;

    const row = document.createElement("tr");
    const foto = produto.foto || "";
    const codigoBarras = produto.codBarras || produto.codigoBarras || "-";

    const fotoHtml = foto
      ? `<img src="${foto}" class="thumb" onclick="ampliarImagem('${foto}')" alt="Foto do produto">`
      : `<span style="color:red;font-weight:bold;">‚ùå</span>`;

    row.innerHTML = `
      <td>${i + 1}</td>
      <td style="text-align:center;">${fotoHtml}</td>
      <td style="font-weight:600;">${produto.nome || "-"}</td>
      <td>${produto.categoria || "-"}</td>
      <td>${produto.embalagem || "-"}</td>
      <td>${produto.qtdEmbalagem || "-"}</td>
      <td>${codigoBarras}</td>
      <td style="text-align:center;">
        <button title="Editar" onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
        <button title="Excluir" onclick="excluirProduto(${i})" style="background:#dc3545;"><i class="fa fa-trash"></i></button>
      </td>
    `;

    if (typeof indiceEdicaoProduto === "number" && indiceEdicaoProduto === i) {
      row.style.background = "#fff3cd"; // amarelo
    }

    tbody.appendChild(row);
  });
};


// ===============================================
// ‚úÖ FUN√á√ÉO UNIFICADA: Atualizar tabela de produtos
// ===============================================
window.atualizarTabelaProdutos = function () {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  if (!tbody) return;

  const filtroEl = document.getElementById("filtroProduto");
  const filtro = filtroEl ? filtroEl.value.toLowerCase() : "";

  tbody.innerHTML = "";

  if (!Array.isArray(window.produtos)) window.produtos = [];

  if (window.produtos.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="8" style="text-align:center; color:#777;">Nenhum produto cadastrado.</td>`;
    tbody.appendChild(row);
    return;
  }

  window.produtos.forEach((produto, i) => {
    const nome = produto.nome?.toLowerCase() || "";
    const categoria = produto.categoria?.toLowerCase() || "";
    if (filtro && !nome.includes(filtro) && !categoria.includes(filtro)) return;

    const row = document.createElement("tr");

    // üîπ Corrige nomes de campos (compat√≠vel com ambos formatos)
    const foto = produto.foto || "";
    const codigoBarras = produto.codigoBarras || produto.codBarras || "-";

    const fotoHtml = foto
      ? `<img src="${foto}" class="thumb" onclick="ampliarImagem('${foto}')" alt="Foto do produto">`
      : `<i class="fa fa-box" style="font-size:22px;color:#0d6efd;text-align:center;display:block;"></i>`;

    row.innerHTML = `
      <td>${i + 1}</td>
      <td style="text-align:center;">${fotoHtml}</td>
      <td style="font-weight:600;">${produto.nome || "-"}</td>
      <td>${produto.categoria || "-"}</td>
      <td>${produto.embalagem || "-"}</td>
      <td>${produto.qtdEmbalagem || "-"}</td>
      <td>${codigoBarras}</td>
      <td style="text-align:center;">
        <button title="Editar" onclick="editarProduto(${i})"><i class="fa fa-edit"></i></button>
        <button title="Excluir" onclick="excluirProduto(${i})" style="background:#dc3545;"><i class="fa fa-trash"></i></button>
      </td>
    `;

    // üîπ Mant√©m destaque do produto em edi√ß√£o
    if (typeof indiceEdicaoProduto === "number" && indiceEdicaoProduto === i) {
      row.style.background = "#fff3cd"; // amarelo claro
    }

    tbody.appendChild(row);
  });
};

// ===============================================
// ‚úÖ EDI√á√ÉO DE PRODUTO (com preview da foto atual)
// ===============================================
window.editarProduto = function (index) {
  const produto = window.produtos[index];
  if (!produto) return;

  indiceEdicaoProduto = index;

  document.getElementById("produtoNome").value = produto.nome || "";
  document.getElementById("produtoCategoria").value = produto.categoria || "";
  document.getElementById("produtoEmbalagem").value = produto.embalagem || "";
  document.getElementById("produtoQtdEmbalagem").value = produto.qtdEmbalagem || "";
  document.getElementById("produtoCodigoBarras").value = produto.codigoBarras || produto.codBarras || "";

  // üü° Exibe foto atual na √°rea de preview
const fotoPreview = document.getElementById("fotoPreview");
if (fotoPreview) {
  if (produto.foto) {
    fotoPreview.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <img src="${produto.foto}" alt="Foto atual" style="width:60px; height:60px; object-fit:cover; border:1px solid #ccc; border-radius:5px;">
        <span>üì∏ Foto atual ‚Äî ser√° mantida se voc√™ n√£o escolher outra.</span>
      </div>
    `;
  } else {
    fotoPreview.innerHTML = `
      <span style="color:#888;">Nenhuma foto cadastrada para este produto.</span>
    `;
  }
}


  // üîπ Destaca linha na tabela
  document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr, i) => {
    tr.style.background = i === index ? "#fff3cd" : "";
  });

  mostrarBotaoCancelar(true);
  mostrarMensagem(`‚úèÔ∏è Editando o produto: ${produto.nome}`, "info");
};

// ===============================================
// ‚úÖ EXCLUS√ÉO DE PRODUTO
// ===============================================
window.excluirProduto = function (i) {
  if (!confirm(`Excluir o produto "${window.produtos[i].nome}"? Todas as entradas e sa√≠das relacionadas ser√£o mantidas, mas o estoque ser√° recontado.`)) return;
  
  const nomeProduto = window.produtos[i].nome;
  window.produtos.splice(i, 1);

  if (typeof window.salvarProdutosNoFirebase === "function") {
    window.salvarProdutosNoFirebase(window.produtos);
  }

  salvarTodosLocal?.();
  atualizarTabelaProdutos?.();
  atualizarTabelaEstoque?.();
  atualizarSelectProdutos?.();
  ordenarListasAlfabeticamente?.();

  mostrarMensagem(`üóëÔ∏è Produto "${nomeProduto}" exclu√≠do com sucesso.`, "sucesso");

  // üîπ Limpa preview caso produto exclu√≠do estivesse sendo editado
  const fotoPreview = document.getElementById("fotoPreview");
  if (fotoPreview) fotoPreview.innerHTML = "";
};

// ===============================================
// ‚úÖ Preview de imagem com visual moderno (redondo e centralizado)
// ===============================================
document.getElementById("produtoFoto").addEventListener("change", (e) => {
  const file = e.target.files[0];
  const fotoPreview = document.getElementById("fotoPreview");
  if (!fotoPreview) return;

  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      fotoPreview.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
          <img src="${ev.target.result}" 
               alt="Nova foto" 
               style="width:80px; height:80px; object-fit:cover; border:2px solid #ccc; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,0.15);">
          <span>üñºÔ∏è Nova foto: <strong>${file.name}</strong></span>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  } else {
    // Se o usu√°rio cancelar a sele√ß√£o, volta para a foto atual (caso exista)
    const index = window.indiceEdicaoProduto;
    const produto = window.produtos?.[index];
    if (produto && produto.foto) {
      fotoPreview.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
          <img src="${produto.foto}" 
               alt="Foto atual" 
               style="width:80px; height:80px; object-fit:cover; border:2px solid #ccc; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,0.15);">
          <span>üì∏ Foto atual ‚Äî ser√° mantida se voc√™ n√£o escolher outra.</span>
        </div>
      `;
    } else {
      fotoPreview.textContent = "Nenhuma foto cadastrada.";
    }
  }
});


// ===============================================
// ‚úÖ Fun√ß√£o para limpar os campos de cadastro
// ===============================================
window.limparCamposProduto = function () {
  const nomeEl = document.getElementById("produtoNome");
  const categoriaEl = document.getElementById("produtoCategoria");
  const embalagemEl = document.getElementById("produtoEmbalagem");
  const qtdEmbEl = document.getElementById("produtoQtdEmbalagem");
  const codBarrasEl = document.getElementById("produtoCodigoBarras");
  const fotoEl = document.getElementById("produtoFoto");
  const fotoPreview = document.getElementById("fotoPreview");

  if (nomeEl) nomeEl.value = "";
  if (categoriaEl) categoriaEl.value = "";
  if (embalagemEl) embalagemEl.value = "";
  if (qtdEmbEl) qtdEmbEl.value = "";
  if (codBarrasEl) codBarrasEl.value = "";
  if (fotoEl) fotoEl.value = "";
  if (fotoPreview) fotoPreview.innerHTML = "";

  // Remove destaque de produto em edi√ß√£o
  if (typeof indiceEdicaoProduto !== "undefined") {
    indiceEdicaoProduto = null;
  }

  // Restaura visual dos bot√µes e tabela
  document.querySelectorAll("#tabelaProdutos tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

  // Esconde bot√£o "Cancelar Edi√ß√£o" se estiver vis√≠vel
  if (typeof window.mostrarBotaoCancelar === "function") {
    window.mostrarBotaoCancelar(false);
  }

  mostrarMensagem("üßπ Campos limpos.", "info");
};


// ===============================================
// ‚úÖ Torna fun√ß√£o de mostrar/ocultar bot√£o global
// ===============================================
window.mostrarBotaoCancelar = function (exibir) {
  let botaoCancelar = document.getElementById("botaoCancelarEdicao");

  if (exibir) {
    if (!botaoCancelar) {
      botaoCancelar = document.createElement("button");
      botaoCancelar.id = "botaoCancelarEdicao";
      botaoCancelar.textContent = "Cancelar Edi√ß√£o";
      botaoCancelar.style.background = "#dc3545";
      botaoCancelar.style.color = "#fff";
      botaoCancelar.style.marginLeft = "10px";
      botaoCancelar.style.borderRadius = "5px";
      botaoCancelar.onclick = window.cancelarEdicaoProduto; // importante: window. para funcionar globalmente

      const botaoCadastrar = document.querySelector('#cadastro button[onclick*="cadastrarProduto"]');
      if (botaoCadastrar) {
        botaoCadastrar.insertAdjacentElement("afterend", botaoCancelar);
      }
    }
  } else {
    if (botaoCancelar) botaoCancelar.remove();
  }
};


// --- ENTRADA DE MATERIAIS ---

function atualizarSelectProdutos() {
  const selectEntrada = document.getElementById("listaProdutos");
  
  if (!selectEntrada) return;
  
  // limpa todas as op√ß√µes
  selectEntrada.innerHTML = "";

  // garante que a lista esteja ordenada
  const listaOrdenada = [...produtos].sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR", { sensitivity: 'base' }));

  listaOrdenada.forEach(p => {
    const option = document.createElement("option");
    option.value = p.nome;
    selectEntrada.appendChild(option);
  });
}

function buscarProdutoPorCodigo(contexto) {
  const campoCodigo = document.getElementById(`${contexto}CodigoBarras`);
  const campoProduto = document.getElementById(`${contexto}Produto`);
  
  if (!campoCodigo || !campoProduto) return;
  
  const codigo = campoCodigo.value.trim();
  
  // Limpa o erro anterior
  campoCodigo.style.border = "1px solid #ccc";
  campoCodigo.title = "";
  campoProduto.value = "";
  
  if (!codigo) return;
  
  // üîπ Corrige o nome do campo do produto
  const produto = produtos.find(p => p.codBarras === codigo || p.codigoBarras === codigo);
  
  if (!produto) {
    campoCodigo.style.border = "2px solid red";
    campoCodigo.title = "C√≥digo de barras n√£o encontrado.";
    mostrarMensagem("C√≥digo de barras n√£o encontrado!", "erro");
    return;
  }
  
  // Preenche o campo do nome automaticamente
  campoProduto.value = produto.nome;
  mostrarMensagem(`Produto "${produto.nome}" encontrado.`, "info");
}

// üîπ Executa a busca automaticamente quando o leitor termina o c√≥digo
document.getElementById("entradaCodigoBarras")?.addEventListener("change", () => buscarProdutoPorCodigo("entrada"));
document.getElementById("entradaCodigoBarras")?.addEventListener("blur", () => buscarProdutoPorCodigo("entrada"));


// ===============================================
// ‚úÖ REGISTRO E EDI√á√ÉO DE ENTRADAS DE MATERIAIS (vers√£o final unificada)
// ===============================================
function registrarEntrada() {
  const produto = document.getElementById("entradaProduto").value.trim();
  const qtd = parseFloat(document.getElementById("entradaQuantidade").value.trim()) || 0;
  const valor = parseFloat(document.getElementById("entradaValor").value.trim()) || 0;
  const data = document.getElementById("entradaData").value.trim();
  const nota = document.getElementById("entradaNota").value.trim();
  const fornecedor = document.getElementById("entradaFornecedor").value.trim();
  const cnpj = document.getElementById("entradaCNPJ").value.trim();
  const lote = document.getElementById("entradaLote").value.trim();
  const validade = document.getElementById("entradaValidade").value.trim();
  const setor = document.getElementById("entradaSetor").value.trim();
  const codigoBarras = document.getElementById("entradaCodigoBarras").value.trim();

  // === Valida√ß√£o dos campos obrigat√≥rios ===
  if (!produto) return mostrarMensagem("‚ö†Ô∏è O campo 'Nome do produto' √© obrigat√≥rio!", "erro");
  if (!qtd) return mostrarMensagem("‚ö†Ô∏è Informe a quantidade!", "erro");
  if (!valor) return mostrarMensagem("‚ö†Ô∏è Informe o valor unit√°rio!", "erro");
  if (!data) return mostrarMensagem("‚ö†Ô∏è Informe a data de entrada!", "erro");
  if (!nota) return mostrarMensagem("‚ö†Ô∏è Informe o n√∫mero da nota fiscal!", "erro");
  if (!fornecedor) return mostrarMensagem("‚ö†Ô∏è Informe o nome do fornecedor!", "erro");
  if (!cnpj) return mostrarMensagem("‚ö†Ô∏è Informe o CNPJ do fornecedor!", "erro");
  if (!validade) return mostrarMensagem("‚ö†Ô∏è Informe a data de vencimento do material!", "erro");
  if (!setor) return mostrarMensagem("‚ö†Ô∏è Selecione o setor utilizado!", "erro");

  // === Edi√ß√£o de entrada existente ===
  if (typeof indiceEdicaoEntrada === "number" && indiceEdicaoEntrada !== null) {
    const e = window.entradas[indiceEdicaoEntrada];
    if (!e) return;

    e.produto = produto;
    e.qtd = qtd;
    e.valor = valor;
    e.data = data;
    e.nota = nota;
    e.fornecedor = fornecedor;
    e.cnpj = cnpj;
    e.lote = lote;
    e.validade = validade;
    e.setor = setor;
    e.codigoBarras = codigoBarras;

    mostrarMensagem(`‚úÖ Entrada de "${produto}" atualizada com sucesso!`, "sucesso");

    indiceEdicaoEntrada = null;
    if (typeof window.mostrarBotaoCancelarEntrada === "function") {
      window.mostrarBotaoCancelarEntrada(false);
    }
  } else {
    // === Nova entrada ===
    const novaEntrada = {
      produto,
      qtd,
      valor,
      data,
      nota,
      fornecedor,
      cnpj,
      lote,
      validade,
      setor,
      codigoBarras,
    };

    window.entradas.push(novaEntrada);
    mostrarMensagem(`‚úÖ Entrada registrada para "${produto}"`, "sucesso");
  }

  // === Atualiza estoque real ===
  const produtoRef = window.produtos.find(p => p.nome === produto);
  if (produtoRef) {
    produtoRef.quantidade = (produtoRef.quantidade || 0) + qtd;
    produtoRef.ultimoValor = valor;
    if (typeof salvarProdutosNoFirebase === "function") {
      salvarProdutosNoFirebase(window.produtos);
    }
  }

  // === Salva localmente ===
  salvarTodosLocal?.();

  // === üîπ Sincroniza com o Firestore ===
  if (typeof window.salvarEntradasNoFirebase === "function") {
    window.salvarEntradasNoFirebase(window.entradas);
    console.log(`‚òÅÔ∏è Entradas sincronizadas com Firestore (${window.entradas.length} registros).`);
  }

  // === Atualiza tabelas e pain√©is ===
  atualizarTabelaEntradas?.();
  atualizarTabelaEstoque?.();
  atualizarPainelFinanceiro?.();
  atualizarDashboard?.();

  // === LIMPA TODOS OS CAMPOS ===
  document.querySelectorAll('#entrada input, #entrada select, #entrada textarea').forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });

  // === Remove destaque da linha editada ===
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach(tr => tr.style.background = "");

  // === Restaura estado de edi√ß√£o ===
  indiceEdicaoEntrada = null;
  if (typeof window.mostrarBotaoCancelarEntrada === "function") {
    window.mostrarBotaoCancelarEntrada(false);
  }

  // === Foco autom√°tico no leitor de c√≥digo ===
  document.getElementById("entradaCodigoBarras")?.focus();

  // === Feedback final ===
  mostrarMensagem("‚úÖ Entrada salva, sincronizada e campos limpos.", "sucesso");
}


// ===============================================
// ‚úÖ LIMPAR CAMPOS DE ENTRADA (fun√ß√£o global)
// ===============================================
window.limparCamposEntrada = function () {
  const formElements = document.querySelectorAll('#entrada input, #entrada select, #entrada textarea');
  formElements.forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });

  // Remove destaque visual de edi√ß√£o
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach(tr => tr.style.background = "");

  // Reseta modo de edi√ß√£o e oculta bot√£o "Cancelar Edi√ß√£o"
  indiceEdicaoEntrada = null;
  if (typeof window.mostrarBotaoCancelarEntrada === "function") {
    window.mostrarBotaoCancelarEntrada(false);
  }

  mostrarMensagem("üßπ Campos de entrada limpos.", "info");

  // Foco de volta no leitor de c√≥digo de barras
  document.getElementById("entradaCodigoBarras")?.focus();
};





function excluirEntrada(i) {
  const entrada = entradas[i];
  if (!confirm(`Excluir a entrada do produto "${entrada.produto}" (Qtd: ${entrada.qtd})? O estoque ser√° ajustado.`)) return;

  
  
  // üîπ Remove a entrada
  entradas.splice(i, 1);
  salvarEntradasNoFirebase(entradas); 
  
  // üîπ Atualiza
  atualizarTabelaEntradas();
  atualizarTabelaEstoque();
  atualizarPainelFinanceiro();
  mostrarMensagem("Entrada exclu√≠da e estoque ajustado.", "sucesso");
}

function filtrarEntradas() {
    atualizarTabelaEntradas();
}
// ADICIONE ESTA FUN√á√ÉO AO SEU <script type="module">
function aplicarMascaraCNPJ(valor) {
    // Remove tudo que n√£o for d√≠gito
    let v = valor.replace(/\D/g, "");
    
    // Aplica a m√°scara: XX.XXX.XXX/XXXX-XX
    if (v.length > 2) {
        v = v.replace(/^(\d{2})(\d)/, "$1.$2");
    }
    if (v.length > 6) {
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
    }
    if (v.length > 10) {
        v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4");
    }
    if (v.length > 15) {
        v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
    }
    
    // Limita o tamanho m√°ximo (18 caracteres com a m√°scara)
    return v.substring(0, 18);
}
// ADICIONE ESTA FUN√á√ÉO AO SEU <script type="module">
function formatarCNPJ(input) {
    input.value = aplicarMascaraCNPJ(input.value);
}

function atualizarTabelaEntradas() {
  const tbody = document.querySelector("#tabelaEntradas tbody");
  const filtro = document.getElementById("filtroEntrada").value.toLowerCase();
  tbody.innerHTML = "";

  entradas.slice().reverse().forEach((e, i) => { // Inverte para mostrar as mais recentes primeiro
    const idxOriginal = entradas.length - 1 - i;
    const produto = (e.produto || "").toLowerCase();
    const fornecedor = (e.fornecedor || "").toLowerCase();
    const nota = (e.nota || "").toLowerCase();
    
    if (filtro && !produto.includes(filtro) && !fornecedor.includes(filtro) && !nota.includes(filtro)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${idxOriginal + 1}</td>
      <td>${e.produto || "-"}</td>
      <td style="font-size:12px; color:#555;">${e.codigoBarras || "-"}</td>
      <td>${e.qtd || 0}</td>
      <td>${(e.valor || 0).toFixed(2)}</td>
      <td>${e.data || "-"}</td>
      <td>${e.nota || "-"}</td>
      <td>${e.fornecedor || "-"}</td>
      <td>${e.cnpj || "-"}</td>
      <td>${e.lote || "-"}</td>
      <td>${e.validade || "-"}</td>
      <td>${e.setor || "-"}</td>
      <td>
        <button onclick="editarEntrada(${idxOriginal})" title="Editar Entrada"><i class="fa fa-edit"></i></button>
        <button onclick="excluirEntrada(${idxOriginal})" title="Excluir Entrada"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}
// =============================
// ‚úÖ EDI√á√ÉO DE ENTRADAS DE MATERIAIS
// =============================

// √çndice global para controle da entrada em edi√ß√£o
let indiceEdicaoEntrada = null;

/**
 * üîπ Inicia a edi√ß√£o de uma entrada
 */
function editarEntrada(index) {
  const entrada = window.entradas[index];
  if (!entrada) return;

  indiceEdicaoEntrada = index;

  // Preenche os campos do formul√°rio com os dados da entrada
  document.getElementById("entradaProduto").value = entrada.produto || "";
  document.getElementById("entradaQuantidade").value = entrada.quantidade || "";
  document.getElementById("entradaValor").value = entrada.valor || "";
  document.getElementById("entradaData").value = entrada.data || "";
  document.getElementById("entradaNota").value = entrada.nota || "";
  document.getElementById("entradaFornecedor").value = entrada.fornecedor || "";
  document.getElementById("entradaCNPJ").value = entrada.cnpj || "";
  document.getElementById("entradaLote").value = entrada.lote || "";
  document.getElementById("entradaValidade").value = entrada.validade || "";
  document.getElementById("entradaSetor").value = entrada.setor || "";
  document.getElementById("entradaCodigoBarras").value = entrada.codigoBarras || "";

  // Destaca a linha em edi√ß√£o
 const total = window.entradas.length;
document.querySelectorAll("#tabelaEntradas tbody tr").forEach((tr, i) => {
  const idxOriginal = total - 1 - i; // inverte a ordem para coincidir com o array
  tr.style.background = idxOriginal === index ? "#fff3cd" : "";
});

  // Mostra bot√£o "Cancelar Edi√ß√£o"
  mostrarBotaoCancelarEntrada(true);

  mostrarMensagem(`‚úèÔ∏è Editando entrada do produto: ${entrada.produto}`, "info");
}

/**
 * üîπ Cancela a edi√ß√£o da entrada atual
 */
function cancelarEdicaoEntrada() {
  indiceEdicaoEntrada = null;
  limparCampos("entrada");

  // Remove o destaque da tabela
  document.querySelectorAll("#tabelaEntradas tbody tr").forEach((tr) => {
    tr.style.background = "";
  });

  // Esconde o bot√£o de cancelar
  mostrarBotaoCancelarEntrada(false);

  mostrarMensagem("üö´ Edi√ß√£o de entrada cancelada.", "info");
}



// =============================
// ‚úÖ SA√çDA DE MATERIAIS (UNIFICADA)
// =============================

let indiceEdicaoSaida = null;

// üîπ Registrar nova sa√≠da ou atualizar uma existente
function registrarSaida() {
  limparErros("saida");

  const produto = document.getElementById("saidaProduto").value.trim();
  const qtd = parseFloat(document.getElementById("saidaQuantidade").value.trim()) || 0;
  const data = document.getElementById("saidaData").value.trim();
  const setor = document.getElementById("saidaSetor").value.trim();
  const responsavel = document.getElementById("saidaResponsavel").value.trim();
  const observacao = document.getElementById("saidaObservacao").value.trim();
  const codigoBarras = document.getElementById("saidaCodigoBarras").value.trim();

  if (!produto) return destacarErro(document.getElementById("saidaProduto"), "Informe o nome do produto!");
  if (!qtd || qtd <= 0) return destacarErro(document.getElementById("saidaQuantidade"), "Informe a quantidade!");
  if (!data) return destacarErro(document.getElementById("saidaData"), "Informe a data da sa√≠da!");
  if (!setor) return destacarErro(document.getElementById("saidaSetor"), "Selecione o setor!");
  if (!responsavel) return destacarErro(document.getElementById("saidaResponsavel"), "Informe o respons√°vel!");

  const produtoRef = window.produtos.find(p => p.nome.toLowerCase() === produto.toLowerCase());
  if (!produtoRef) return destacarErro(document.getElementById("saidaProduto"), "Produto n√£o encontrado no cadastro!");

  const estoqueAtual = Number(produtoRef.quantidade || 0);
  if (qtd > estoqueAtual) {
    return destacarErro(document.getElementById("saidaQuantidade"), `Estoque insuficiente! Restam ${estoqueAtual} unidade(s).`);
  }

  // Atualiza√ß√£o ou nova sa√≠da
  if (typeof indiceEdicaoSaida === "number" && indiceEdicaoSaida !== null) {
    const s = window.saidas[indiceEdicaoSaida];
    if (!s) return;

    Object.assign(s, { produto, qtd, data, setor, responsavel, observacao, codigoBarras });
    mostrarMensagem(`‚úÖ Sa√≠da de "${produto}" atualizada com sucesso!`, "sucesso");
    indiceEdicaoSaida = null;
    mostrarBotaoCancelarSaida(false);
  } else {
    const novaSaida = {
      produto, qtd, data, setor, responsavel, observacao, codigoBarras,
      usuario: auth.currentUser ? auth.currentUser.email : "desconhecido",
      timestamp: new Date().toISOString(),
    };
    window.saidas.push(novaSaida);
    mostrarMensagem(`‚úÖ Sa√≠da registrada para "${produto}"`, "sucesso");
  }

  // Atualiza estoque e salva
  produtoRef.quantidade = (produtoRef.quantidade || 0) - qtd;
  salvarTodosLocal();
  salvarProdutosNoFirebase(window.produtos);
  salvarSaidasNoFirebase(window.saidas);

  // Atualiza interface
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  atualizarPainelFinanceiro?.();
  atualizarDashboard?.();

  // Limpa campos
  document.querySelectorAll("#saida input, #saida select, #saida textarea").forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") el.checked = false;
    else el.value = "";
  });
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  document.getElementById("saidaCodigoBarras")?.focus();
}

// üîπ Atualiza a tabela de sa√≠das
function atualizarTabelaSaidas() {
  const tbody = document.querySelector("#tabelaSaidas tbody");
  const filtro = document.getElementById("filtroSaida")?.value.toLowerCase() || "";
  tbody.innerHTML = "";

  window.saidas.slice().reverse().forEach((s, i) => {
    const idxOriginal = window.saidas.length - 1 - i;
    const produto = (s.produto || "").toLowerCase();
    const responsavel = (s.responsavel || "").toLowerCase();
    const setor = (s.setor || "").toLowerCase();

    if (filtro && !produto.includes(filtro) && !responsavel.includes(filtro) && !setor.includes(filtro)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${idxOriginal + 1}</td>
      <td>${s.produto || "-"}</td>
      <td style="font-size:12px; color:#555;">${s.codigoBarras || "-"}</td>
      <td>${s.qtd ?? s.quantidade ?? 0}</td>
      <td>${s.data || "-"}</td>
      <td>${s.setor || "-"}</td>
      <td>${s.responsavel || "-"}</td>
      <td>${s.observacao || "-"}</td>
      <td>
        <button onclick="editarSaida(${idxOriginal})"><i class="fa fa-edit"></i></button>
        <button onclick="excluirSaida(${idxOriginal})"><i class="fa fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// üîπ Editar, cancelar e excluir
function editarSaida(index) {
  const s = window.saidas[index];
  if (!s) return;

  indiceEdicaoSaida = index;

  document.getElementById("saidaProduto").value = s.produto || "";
  document.getElementById("saidaQuantidade").value = s.qtd ?? s.quantidade ?? "";
  document.getElementById("saidaResponsavel").value = s.responsavel || "";
  document.getElementById("saidaObservacao").value = s.observacao || "";
  document.getElementById("saidaSetor").value = s.setor || "";
  document.getElementById("saidaData").value = s.data || "";
  document.getElementById("saidaCodigoBarras").value = s.codigoBarras || "";

  document.querySelectorAll("#tabelaSaidas tbody tr").forEach((tr, i) => {
    tr.style.background = i === index ? "#fff3cd" : "";
  });

  mostrarBotaoCancelarSaida(true);
  mostrarMensagem(`‚úèÔ∏è Editando sa√≠da de: ${s.produto}`, "info");
}

function cancelarEdicaoSaida() {
  indiceEdicaoSaida = null;
  limparCampos("saida");
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  mostrarBotaoCancelarSaida(false);
  mostrarMensagem("üö´ Edi√ß√£o de sa√≠da cancelada.", "info");
}

function mostrarBotaoCancelarSaida(exibir) {
  let botaoCancelar = document.getElementById("botaoCancelarEdicaoSaida");
  if (exibir) {
    if (!botaoCancelar) {
      botaoCancelar = document.createElement("button");
      botaoCancelar.id = "botaoCancelarEdicaoSaida";
      botaoCancelar.textContent = "Cancelar Edi√ß√£o";
      botaoCancelar.style.background = "#dc3545";
      botaoCancelar.style.color = "#fff";
      botaoCancelar.style.marginLeft = "10px";
      botaoCancelar.style.borderRadius = "5px";
      botaoCancelar.onclick = cancelarEdicaoSaida;

      const botaoRegistrar = document.querySelector('#saida button[onclick*="registrarSaida"]');
      if (botaoRegistrar) botaoRegistrar.insertAdjacentElement("afterend", botaoCancelar);
    }
  } else if (botaoCancelar) botaoCancelar.remove();
}

function excluirSaida(i) {
  const s = window.saidas[i];
  if (!s) return;

  if (!confirm(`Excluir sa√≠da do produto "${s.produto}" (Qtd: ${s.qtd ?? s.quantidade})?`)) return;

  atualizarEstoque(s.produto, +((s.qtd ?? s.quantidade) || 0));
  window.saidas.splice(i, 1);
  salvarSaidasNoFirebase(window.saidas);
  salvarTodosLocal();
  atualizarTabelaSaidas();
  atualizarTabelaEstoque();
  mostrarMensagem(`üóëÔ∏è Sa√≠da de "${s.produto}" exclu√≠da.`, "sucesso");
  salvarTodosLocal();
}
// üîπ Fun√ß√£o para limpar todos os campos da Sa√≠da de Materiais
function limparCamposSaida() {
  const formElements = document.querySelectorAll('#saida input, #saida select, #saida textarea');

  formElements.forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") {
      el.checked = false;
    } else {
      el.value = "";
    }
  });

  // Remove destaque da tabela e reseta edi√ß√£o
  document.querySelectorAll("#tabelaSaidas tbody tr").forEach(tr => tr.style.background = "");
  indiceEdicaoSaida = null;
  if (typeof mostrarBotaoCancelarSaida === "function") {
    mostrarBotaoCancelarSaida(false);
  }

  mostrarMensagem("üßπ Campos da sa√≠da limpos!", "info");
  document.getElementById("saidaCodigoBarras")?.focus();
}


// üîπ Setor autom√°tico
function atualizarSetorAutomatico() {
  const produtoInput = document.getElementById("saidaProduto");
  const setorSelect = document.getElementById("saidaSetor");
  const codigoInput = document.getElementById("saidaCodigoBarras");
  
  if (!produtoInput || !setorSelect) return;

  const nomeProduto = produtoInput.value.trim();
  const codigo = codigoInput ? codigoInput.value.trim() : "";
  let entradaEncontrada = null;

  if (codigo && Array.isArray(produtos)) {
    const produto = produtos.find(p => p.codigoBarras === codigo);
    if (produto) entradaEncontrada = entradas.slice().reverse().find(e => e.produto === produto.nome);
  }

  if (!entradaEncontrada && nomeProduto) {
    entradaEncontrada = entradas.slice().reverse().find(e => e.produto.toLowerCase() === nomeProduto.toLowerCase());
  }

  const setoresUnicos = Array.from(new Set(entradas.map(e => e.setor).filter(s => s)));
  setorSelect.innerHTML = '<option value="">Selecione o Setor</option>';
  setoresUnicos.forEach(setor => {
    const option = document.createElement("option");
    option.value = setor;
    option.textContent = setor;
    setorSelect.appendChild(option);
  });
  
  if (entradaEncontrada && entradaEncontrada.setor) {
    setorSelect.value = entradaEncontrada.setor;
  }
}

function atualizarSetoresPorProduto() {
  const produtoNome = document.getElementById("saidaProduto").value.trim();
  const setorSelect = document.getElementById("saidaSetor");
  setorSelect.innerHTML = `<option value="">Selecione o Setor</option>`;

  if (!produtoNome) return;

  const setoresCompletos = [
    "Limpeza da Cl√≠nica",
    "Laborat√≥rio",
    "Escrit√≥rio",
    "Copa e Cozinha",
    "Cl√≠nico Geral",
    "Centro Cir√∫rgico"
  ];

  setorSelect.innerHTML = setoresCompletos
    .map(s => `<option value="${s}">${s}</option>`)
    .join("");
}

// ==========================================================
// üß† AUTO-COMPLETE NO CAMPO "Sa√≠da de Materiais"
// ==========================================================
function configurarAutoCompleteSaida() {
  const saidaInput = document.getElementById("saidaProduto");
  if (!saidaInput) return;

  // Cria ou obt√©m datalist para sugest√µes
  let dataList = document.getElementById("listaProdutosSaida");
  if (!dataList) {
    dataList = document.createElement("datalist");
    dataList.id = "listaProdutosSaida";
    document.body.appendChild(dataList);
    saidaInput.setAttribute("list", "listaProdutosSaida");
  }

  // Preenche o datalist com os produtos existentes
  atualizarListaSugestoesSaida();
}

// üîÑ Atualiza sugest√µes conforme os produtos no estoque
function atualizarListaSugestoesSaida() {
  const dataList = document.getElementById("listaProdutosSaida");
  if (!dataList) return;

  const nomesProdutos = [...new Set((window.produtos || []).map(p => p.nome).filter(Boolean))];
  dataList.innerHTML = nomesProdutos.map(nome => `<option value="${nome}"></option>`).join("");
}

// üß© Inicializa quando carregar os dados
document.addEventListener("DOMContentLoaded", configurarAutoCompleteSaida);

// ====================================================
// üì¶ ESTOQUE ATUAL (corrigido e aprimorado)
// ====================================================
function atualizarTabelaEstoque() {
  const tabela = document.querySelector("#tabelaEstoque tbody");
  if (!tabela) return;

  const filtro = (document.getElementById("filtroEstoque")?.value || "").toLowerCase();
  tabela.innerHTML = "";

  const produtos = window.produtos || [];
  const entradas = window.entradas || [];
  const saidas = window.saidas || [];

  if (!Array.isArray(produtos) || produtos.length === 0) {
    tabela.innerHTML = `
      <tr><td colspan="9" style="text-align:center; color:#888;">
        Nenhum produto encontrado no estoque ou os dados ainda est√£o sendo carregados.
      </td></tr>`;
    return;
  }

  // üîπ Cria o mapa de movimenta√ß√µes (entradas - sa√≠das)
  const mapaEstoque = {};
  entradas.forEach(e => {
    const nome = e.produto || e.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] += Number(e.qtd || e.quantidade || 0);
  });
  saidas.forEach(s => {
    const nome = s.produto || s.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] -= Number(s.qtd || s.quantidade || 0);
  });

  // üîπ Monta a tabela
  produtos.forEach((p, i) => {
    const nome = (p.nome || "").toLowerCase();
    const categoria = (p.categoria || "").toLowerCase();
    if (filtro && !nome.includes(filtro) && !categoria.includes(filtro)) return;

    let qtdReal = mapaEstoque[p.nome] ?? p.quantidade ?? 0;
    if (qtdReal < 0) qtdReal = 0; // nunca negativo
    p.quantidade = qtdReal; // mant√©m sincronizado

    const valor = Number(p.ultimoValor || 0);

    const linha = document.createElement("tr");
    linha.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome || "-"}</td>
      <td>${p.codigoBarras || "-"}</td>
      <td>${p.categoria || "-"}</td>
      <td style="text-align:center;">${qtdReal}</td>
      <td>${p.lote || "-"}</td>
      <td>${valor ? valor.toFixed(2) : "-"}</td>
      <td>${p.validade || "-"}</td>
      <td style="font-weight:bold; color:${qtdReal > 0 ? '#198754' : '#dc3545'};">
        ${qtdReal > 0 ? "‚úÖ Em Estoque" : "‚ùå Zerado"}
      </td>
    `;
    tabela.appendChild(linha);
  });

  // üíæ Salva atualiza√ß√µes
  salvarTodosLocal();
  salvarProdutosNoFirebase(window.produtos);
}

// üîç Filtro r√°pido
function filtrarEstoque() {
  atualizarTabelaEstoque();
}

// üßπ Limpar filtro
function limparFiltroEstoque() {
  const campo = document.getElementById("filtroEstoque");
  campo.value = "";
  atualizarTabelaEstoque();
  campo.focus();
}

// üîÑ Recalcular estoque geral
function recalcularEstoqueGeral() {
  const produtos = window.produtos || [];
  const entradas = window.entradas || [];
  const saidas = window.saidas || [];

  const mapaEstoque = {};
  entradas.forEach(e => {
    const nome = e.produto || e.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] += Number(e.qtd || e.quantidade || 0);
  });
  saidas.forEach(s => {
    const nome = s.produto || s.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] -= Number(s.qtd || s.quantidade || 0);
  });

  produtos.forEach(p => {
    let qtdReal = mapaEstoque[p.nome] ?? 0;
    if (qtdReal < 0) qtdReal = 0;
    p.quantidade = qtdReal;
  });

  salvarTodosLocal();
  salvarProdutosNoFirebase(produtos);
  atualizarTabelaEstoque();
  mostrarMensagem("üîÑ Estoque recalculado e atualizado com sucesso!", "sucesso");
}

/// ====================================================
// ‚öôÔ∏è ESTOQUE M√çNIMO E M√ÅXIMO (corrigido e com resumo ativo)
// ====================================================
function atualizarTabelaLimites() {
  const tabela = document.querySelector("#tabelaLimites tbody");
  if (!tabela) return;

  const produtos = window.produtos || [];
  const entradas = window.entradas || [];
  const saidas = window.saidas || [];
  const resumoDiv = document.getElementById("resumoLimites");

  tabela.innerHTML = "";

  if (!Array.isArray(produtos) || produtos.length === 0) {
    tabela.innerHTML = `
      <tr>
        <td colspan="10" style="text-align:center; color:#888; padding: 20px;">
          Nenhum produto cadastrado ou os dados ainda est√£o sendo carregados.
        </td>
      </tr>`;
    if (resumoDiv)
      resumoDiv.innerHTML = `
        üßæ Total de Produtos: 0 |
        ‚ö†Ô∏è Abaixo do M√≠nimo: 0 |
        ‚úÖ Dentro do Limite: 0 |
        üì¶ Acima do M√°ximo: 0`;
    return;
  }

  let total = 0, abaixo = 0, dentro = 0, acima = 0;

  // üîπ Cria o mapa de estoque real (entradas - sa√≠das)
  const mapaEstoque = {};
  entradas.forEach(e => {
    const nome = e.produto || e.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] += Number(e.qtd || e.quantidade || 0);
  });
  saidas.forEach(s => {
    const nome = s.produto || s.nomeProduto || "";
    if (!mapaEstoque[nome]) mapaEstoque[nome] = 0;
    mapaEstoque[nome] -= Number(s.qtd || s.quantidade || 0);
  });

  produtos.forEach((p, i) => {
    total++;

    let qtd = mapaEstoque[p.nome] ?? p.quantidade ?? 0;
    if (qtd < 0) qtd = 0;

    const minimo = Number(p.minimo || 0);
    const maximo = Number(p.maximo || 0);

    let status = "‚úÖ Dentro do Limite";
    let recomendacao = "-";

    if (qtd < minimo) {
      status = "‚ö†Ô∏è Abaixo do M√≠nimo";
      recomendacao = `Comprar ${minimo - qtd}`;
      abaixo++;
    } else if (maximo > 0 && qtd > maximo) {
      status = "üì¶ Acima do M√°ximo";
      recomendacao = `Excedente de ${qtd - maximo}`;
      acima++;
    } else {
      dentro++;
    }

    const linha = document.createElement("tr");
    linha.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome || "-"}</td>
      <td>${p.codigoBarras || "-"}</td>
      <td>${p.categoria || "-"}</td>
      <td style="text-align:center;">${qtd}</td>
      <td><input type="number" id="min_${i}" value="${minimo}" style="width:80px"></td>
      <td><input type="number" id="max_${i}" value="${maximo}" style="width:80px"></td>
      <td>${status}</td>
      <td>${recomendacao}</td>
      <td>
        <button onclick="salvarLimites(${i})" title="Salvar Limites">
          <i class="fa fa-save"></i>
        </button>
      </td>
    `;
    tabela.appendChild(linha);
  });

  // üî∏ Atualiza o resumo (mostrado no painel Estoque M√≠nimo e M√°ximo)
  if (resumoDiv) {
    resumoDiv.innerHTML = `
      üßæ Total de Produtos: ${total} |
      ‚ö†Ô∏è Abaixo do M√≠nimo: ${abaixo} |
      ‚úÖ Dentro do Limite: ${dentro} |
      üì¶ Acima do M√°ximo: ${acima}
    `;
  }
}



// ====================================================
// üõí GERAR LISTA DE COMPRA (vers√£o final corrigida)
// ====================================================
function gerarListaCompra() {
  const container = document.getElementById("listaCompraContainer");
  const tabela = document.getElementById("tabelaListaCompra");
  const tbody = tabela ? tabela.querySelector("tbody") : null;
  const totalSpan = document.getElementById("totalItensCompra");
  const filtroCategoria = document.getElementById("filtroCategoria")?.value || "";

  // üîç Seguran√ßa: elementos obrigat√≥rios
  if (!container || !tabela || !tbody || !totalSpan) {
    console.error("‚ö†Ô∏è Elementos da lista de compra n√£o encontrados no DOM.");
    mostrarMensagem("Erro: tabela da lista de compra n√£o encontrada.", "erro");
    return;
  }

  const produtos = Array.isArray(window.produtos) ? window.produtos : [];
  const entradas = Array.isArray(window.entradas) ? window.entradas : [];
  const saidas = Array.isArray(window.saidas) ? window.saidas : [];

  // üîπ 1. Mapa de estoque real (entradas - sa√≠das)
  const mapaEstoque = {};
  entradas.forEach(e => {
    const nome = (e.produto || e.nomeProduto || "").trim().toLowerCase();
    if (!nome) return;
    mapaEstoque[nome] = (mapaEstoque[nome] || 0) + Number(e.qtd || e.quantidade || 0);
  });
  saidas.forEach(s => {
    const nome = (s.produto || s.nomeProduto || "").trim().toLowerCase();
    if (!nome) return;
    mapaEstoque[nome] = (mapaEstoque[nome] || 0) - Number(s.qtd || s.quantidade || 0);
  });

  // üîπ 2. Identifica produtos abaixo do m√≠nimo
  const produtosAbaixo = produtos
    .map(p => {
      const nome = (p.nome || "").trim().toLowerCase();
      const qtdAtual = Number(mapaEstoque[nome] ?? p.quantidade ?? 0);
      const minimo = Number(p.minimo || 0);
      const categoria = p.categoria || "-";
      const diferenca = minimo - qtdAtual;

      return {
        nome: p.nome,
        codigoBarras: p.codigoBarras || "-",
        categoria,
        qtd: qtdAtual,
        recomendacao: diferenca > 0 ? `Comprar ${diferenca}` : ""
      };
    })
    .filter(p => p.recomendacao)
    .filter(p => !filtroCategoria || p.categoria === filtroCategoria)
    .sort((a, b) => a.nome.localeCompare(b.nome));

  // üîπ 3. Monta a tabela
  tbody.innerHTML = "";

  // Se nenhum produto abaixo do m√≠nimo ‚Üí mostra aviso
  if (produtosAbaixo.length === 0) {
    const mensagem = filtroCategoria
      ? `Nenhum item abaixo do estoque m√≠nimo na categoria <b>${filtroCategoria}</b>.`
      : `Nenhum item abaixo do estoque m√≠nimo.`;

    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; color:#777;">${mensagem}</td>
      </tr>
    `;

    totalSpan.textContent = "0";
    container.style.display = "block";
    mostrarMensagem("Nenhum produto abaixo do estoque m√≠nimo encontrado.", "info");
    return; // ‚úÖ termina corretamente a fun√ß√£o aqui
  }

  // üîπ 4. Preenche linhas da tabela
  produtosAbaixo.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.nome}</td>
      <td>${p.codigoBarras}</td>
      <td>${p.categoria}</td>
      <td style="text-align:center;">${p.qtd}</td>
      <td style="font-weight:bold; color:#0d6efd;">${p.recomendacao}</td>
    `;
    tbody.appendChild(row);
  });

  // üîπ 5. Exibe resumo
  totalSpan.textContent = produtosAbaixo.length.toString();
  container.style.display = "block";
  container.scrollIntoView({ behavior: "smooth" });
  mostrarMensagem(`Lista de compra gerada com ${produtosAbaixo.length} item(ns).`, "sucesso");
}


// ====================================================
// üßπ LIMPAR E GERENCIAR LISTA DE COMPRA
// ====================================================

function limparListaCompra() {
  const tabela = document.querySelector("#tabelaListaCompra tbody");
  const totalSpan = document.getElementById("totalItensCompra");
  const container = document.getElementById("listaCompraContainer");

  if (tabela) tabela.innerHTML = "";
  if (totalSpan) totalSpan.textContent = "0";
  if (container) container.style.display = "none";

  mostrarMensagem("üßπ Lista de compra limpa com sucesso.", "info");
}

function removerItemListaCompra(botao) {
  const linha = botao.closest("tr");
  if (linha) {
    linha.remove();
    const totalSpan = document.getElementById("totalItensCompra");
    if (totalSpan) {
      const novoTotal = Math.max(0, Number(totalSpan.textContent) - 1);
      totalSpan.textContent = novoTotal.toString();
    }
    mostrarMensagem("üóëÔ∏è Item removido da lista.", "info");
  }
}

// üßæ Mensagem visual (reutiliza o mesmo estilo das suas mensagens existentes)
function mostrarMensagem(texto, tipo = "info") {
  const div = document.createElement("div");
  div.textContent = texto;
  div.className = `mensagem mensagem-${tipo}`;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}





// ====================================================
// üíæ SALVAR / LIMPAR / FILTRAR LIMITES
// ====================================================

function salvarLimites(i) {
  const minEl = document.getElementById(`min_${i}`);
  const maxEl = document.getElementById(`max_${i}`);

  if (!window.produtos[i]) return;

  window.produtos[i].minimo = Number(minEl.value) || 0;
  window.produtos[i].maximo = Number(maxEl.value) || 0;

  salvarProdutosNoFirebase(window.produtos);
  salvarTodosLocal();
  mostrarMensagem(`Limites do produto "${window.produtos[i].nome}" atualizados com sucesso!`, "sucesso");
  atualizarTabelaLimites();
}

function removerLimites(nome) {
  const produtoRef = window.produtos.find(p => p.nome === nome);
  if (!produtoRef) return;

  if (confirm(`Remover limites do produto "${nome}"?`)) {
    produtoRef.minimo = 0;
    produtoRef.maximo = 0;
    salvarProdutosNoFirebase(window.produtos);
    salvarTodosLocal();
    atualizarTabelaLimites();
    mostrarMensagem(`Limites de "${nome}" removidos com sucesso.`, "sucesso");
  }
}

function filtrarLimites() {
  const filtro = document.getElementById("filtroLimites");
  window.filtroLimites = filtro?.value || "";
  atualizarTabelaLimites();
}

function limparFiltroLimites() {
  const filtro = document.getElementById("filtroLimites");
  if (filtro) filtro.value = "";
  window.filtroLimites = "";
  atualizarTabelaLimites();
  mostrarMensagem("Filtro de Estoque M√≠nimo e M√°ximo limpo.", "info");
}

// --- PAINEL FINANCEIRO ---
// ====================================================
// üí∞ PAINEL FINANCEIRO ‚Äî Corre√ß√£o completa e autom√°tica
// ====================================================
function atualizarPainelFinanceiro() {
  // üîπ Garante que os dados estejam dispon√≠veis
  const entradas = Array.isArray(window.entradas) ? window.entradas : [];
  const saidas = Array.isArray(window.saidas) ? window.saidas : [];
  const produtos = Array.isArray(window.produtos) ? window.produtos : [];

  // Se n√£o houver dados ainda, tenta novamente ap√≥s 1s
  if (entradas.length === 0 && saidas.length === 0 && produtos.length === 0) {
    console.warn("‚è≥ Dados ainda n√£o carregados, tentando novamente...");
    setTimeout(atualizarPainelFinanceiro, 1000);
    return;
  }

  let valorTotalEntradas = 0;
  let valorTotalSaidas = 0;
  let valorTotalCustoMedioGeral = 0;
  let valorTotalUltimaEntradaGeral = 0;

  // --- C√ÅLCULO DE ENTRADAS E CUSTO M√âDIO ---
  entradas.forEach(e => {
    valorTotalEntradas += (Number(e.valor) || 0) * (Number(e.qtd) || 0);
  });

  produtos.forEach(p => {
    const entradasDoProduto = entradas.filter(e => e.produto === p.nome);
    const qtdAtual = Number(p.quantidade || 0);

    if (entradasDoProduto.length > 0) {
      const totalQtdEntradas = entradasDoProduto.reduce((s, e) => s + (Number(e.qtd) || 0), 0);
      const totalValorEntradas = entradasDoProduto.reduce((s, e) => s + ((Number(e.qtd) || 0) * (Number(e.valor) || 0)), 0);
      const custoMedio = totalQtdEntradas > 0 ? totalValorEntradas / totalQtdEntradas : 0;

      const valorUltimo = Number(entradasDoProduto.slice(-1)[0].valor || 0);

      valorTotalCustoMedioGeral += qtdAtual * custoMedio;
      valorTotalUltimaEntradaGeral += qtdAtual * valorUltimo;
    }
  });

  // --- SA√çDAS ---
  saidas.forEach(s => {
    const entradaRelacionado = entradas.find(
      e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
    );
    const valorUnitario = entradaRelacionado ? (Number(entradaRelacionado.valor) || 0) : 0;
    valorTotalSaidas += valorUnitario * (Number(s.qtd) || 0);
  });

  // --- C√ÅLCULOS GERAIS ---
  const valorTotalEstoqueContabil = valorTotalEntradas - valorTotalSaidas;
  const valorEstoqueAtualEstimado = valorTotalUltimaEntradaGeral;

  // --- ATUALIZA OS CARDS ---
  const setText = (id, valor) => {
    const el = document.getElementById(id);
    if (el) el.textContent = `R$ ${valor.toFixed(2)}`;
  };

  setText("valorUltimaEntrada", valorTotalUltimaEntradaGeral);
  setText("valorCustoMedio", valorTotalCustoMedioGeral);
  setText("valorEstoqueAtualPainel", valorEstoqueAtualEstimado);
  setText("valorEstoque", valorTotalEstoqueContabil);
  setText("valorSaidas", valorTotalSaidas);

  // --- ATUALIZA A TABELA FINANCEIRA ---
  const tbody = document.querySelector("#tabelaFinanceiro tbody");
  if (tbody) {
    tbody.innerHTML = "";

    const agrupadas = {};

    entradas.forEach(e => {
      const fornecedor = e.fornecedor || "Fornecedor n√£o informado";
      const nota = e.nota || "Sem Nota Fiscal";
      const chave = `${fornecedor}_${nota}`;

      if (!agrupadas[chave]) {
        agrupadas[chave] = { fornecedor, nota, valorNota: 0, valorSaida: 0 };
      }

      agrupadas[chave].valorNota += (Number(e.valor) || 0) * (Number(e.qtd) || 0);
    });

    saidas.forEach(s => {
      const entrada = entradas.find(
        e => e.produto && s.produto && e.produto.toLowerCase() === s.produto.toLowerCase()
      );
      if (!entrada) return;

      const fornecedor = entrada.fornecedor || "Fornecedor n√£o informado";
      const nota = entrada.nota || "Sem Nota Fiscal";
      const chave = `${fornecedor}_${nota}`;

      const valorUnitario = Number(entrada.valor) || 0;
      const valorSaida = valorUnitario * (Number(s.qtd) || 0);

      if (agrupadas[chave]) agrupadas[chave].valorSaida += valorSaida;
    });

    const registros = Object.values(agrupadas);
    if (registros.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="4" style="text-align:center; color:#777;">Nenhum dado financeiro encontrado.</td></tr>`;
    } else {
      registros.forEach(a => {
        const saldo = a.valorNota - a.valorSaida;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${a.fornecedor}</td>
          <td>${a.nota}</td>
          <td>R$ ${a.valorNota.toFixed(2)}</td>
          <td>R$ ${saldo.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });
    }
  }

  console.log("‚úÖ Painel Financeiro atualizado com sucesso!");
}


// --- DASHBOARD ---

function calcularFrequenciaSaida() {
    const frequencia = {};
    const hoje = new Date();
    const trintaDiasAtras = new Date(hoje);
    trintaDiasAtras.setDate(hoje.getDate() - 30);

    saidas.forEach(s => {
        const dataSaida = new Date(s.data);
        if (dataSaida >= trintaDiasAtras) {
            frequencia[s.produto] = (frequencia[s.produto] || 0) + (s.qtd || 0);
        }
    });

    // Converte para array para ordenar
    return Object.entries(frequencia)
        .map(([produto, qtd]) => ({ produto, qtd }))
        .sort((a, b) => b.qtd - a.qtd); // Mais sa√≠das primeiro
}

// ===============================================
// FUN√á√ïES AUXILIARES DO DASHBOARD
// ===============================================

/**
 * Fun√ß√£o auxiliar para formatar valores como moeda Real (R$).
 */
function formatarMoeda(valor) {
    // Converte o valor para n√∫mero e formata como Real Brasileiro
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(Number(valor));
}

/**
 * Fun√ß√£o auxiliar para montar o bloco de Resumo Geral com o design EXATO da imagem.
 */
function atualizarBlocoResumo(totalProdutos, qtdTotalEstoque, totalSaidas, valorUltimaEntrada, valorEstoqueContabil, criticosCount) {
    const resumoEl = document.getElementById("resumoGeral"); 
    if (!resumoEl) return; 

    // O HTML INJETADO USA AS CLASSES CSS FORNECIDAS
    resumoEl.innerHTML = `
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-boxes resumo-icon icon-produtos"></i> Total de Produtos Cadastrados:</span>
            <span class="resumo-value">${totalProdutos}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-box-open resumo-icon icon-estoque"></i> Quantidade Total em Estoque (Unid):</span>
            <span class="resumo-value">${qtdTotalEstoque.toFixed(0)}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-sign-out-alt resumo-icon icon-saidas"></i> Total de Sa√≠das Registradas:</span>
            <span class="resumo-value">${totalSaidas}</span>
        </div>
        <hr style="margin: 10px 0; border-color: #ddd;">
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-coins resumo-icon icon-valor"></i> Valor Total (√öltimo Custo):</span>
            <span class="resumo-value">${formatarMoeda(valorUltimaEntrada)}</span>
        </div>
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-chart-line resumo-icon icon-contabil"></i> Valor Total do Estoque (C.M.P):</span>
            <span class="resumo-value">${formatarMoeda(valorEstoqueContabil)}</span>
        </div>
        <hr style="margin: 10px 0; border-color: #ddd;">
        <div class="resumo-metric">
            <span class="resumo-label"><i class="fas fa-exclamation-triangle resumo-icon" style="color: ${criticosCount > 0 ? 'red' : 'green'};"></i> Produtos em Estoque Cr√≠tico:</span>
            <span class="resumo-value" style="color: ${criticosCount > 0 ? 'red' : 'green'};">${criticosCount}</span>
        </div>
    `;
}

// ===============================================
// FUN√á√ÉO PRINCIPAL DO DASHBOARD
// ===============================================

function atualizarDashboard() {
    // Busca dados no cache local (window.produtos, window.entradas, window.saidas)
    const produtosLocal = window.produtos || [];
    const entradasLocal = window.entradas || [];
    const saidasLocal = window.saidas || [];

    // Fun√ß√µes de Busca e C√°lculo
    function buscarValorUnitario(nomeProduto) {
        // Busca o √∫ltimo valor de entrada registrado
        const ultimaEntrada = entradasLocal
            .filter(e => e.produto === nomeProduto && Number(e.valor) > 0)
            .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
        return Number(ultimaEntrada?.valor) || 0;
    }

    // Calcula a soma total de sa√≠das por nome do produto
    const contagemSaidas = saidasLocal.reduce((acc, s) => {
        const nome = s.produto;
        // Tenta usar 'qtd' ou 'quantidade' para compatibilidade
        const qtdSaida = Number(s.qtd || s.quantidade) || 0; 
        acc[nome] = (acc[nome] || 0) + qtdSaida;
        return acc;
    }, {});
    
    // 2. PREPARA√á√ÉO DE DADOS DETALHADOS POR PRODUTO
    const estoqueDetalhado = produtosLocal.map(p => {
        const qtdAtual = Number(p.quantidade) || 0;
        // CORRIGIDO: Chama a fun√ß√£o com o nome correto
        const valorUnitario = buscarValorUnitario(p.nome); 
        const qtdSaidas = contagemSaidas[p.nome] || 0;

        // C√ÅLCULO CUSTO M√âDIO PONDERADO (CMP)
        // Usa 'qtd' ou 'quantidade'
        const entradasProduto = entradasLocal.filter(e => e.produto === p.nome && Number(e.valor) > 0 && Number(e.qtd || e.quantidade) > 0);
        const custoTotalProduto = entradasProduto.reduce((sum, e) => sum + (Number(e.valor) * Number(e.qtd || e.quantidade)), 0);
        const qtdTotalEntradaProduto = entradasProduto.reduce((sum, e) => sum + Number(e.qtd || e.quantidade), 0);
        const CMP_produto = qtdTotalEntradaProduto > 0 ? custoTotalProduto / qtdTotalEntradaProduto : 0;

        // Calcula a validade mais pr√≥xima
        let validadeMaisProxima = null;
        entradasLocal.filter(e => e.produto === p.nome && e.validade)
                     .forEach(e => {
            const dataValidade = new Date(e.validade + 'T00:00:00'); 
            if (!validadeMaisProxima || dataValidade < validadeMaisProxima) {
                validadeMaisProxima = dataValidade;
            }
        });

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const diasVencer = validadeMaisProxima ? Math.ceil((validadeMaisProxima.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24)) : Infinity;

        return {
            nome: p.nome,
            qtdAtual: qtdAtual,
            embalagem: p.embalagem || 'un',
            minimo: Number(p.minimo) || 0,
            ultimoCusto: valorUnitario,
            cmp: CMP_produto,
            qtdSaidas: qtdSaidas,
            validade: validadeMaisProxima,
            diasVencer: diasVencer,
            isCritico: qtdAtual < (Number(p.minimo) || 0) && (Number(p.minimo) || 0) > 0,
        };
    });


    // --- 3. POPULANDO AS LISTAS TOP 5 ---
    const criarLi = (item) => `<li>${item}</li>`;

    // a. üïí Produtos Pr√≥ximos do Vencimento
    const proximosVencer = estoqueDetalhado
        .filter(p => p.validade && p.qtdAtual > 0 && p.diasVencer > -30) 
        .sort((a, b) => a.diasVencer - b.diasVencer) 
        .slice(0, 5);
    
    const listaVencer = document.getElementById("listaProximosVencer");
    if (listaVencer) {
        listaVencer.innerHTML = proximosVencer.length > 0 
            ? proximosVencer.map(p => {
                const status = p.diasVencer <= 0 ? `<span style="color: red; font-weight: bold;">(VENCIDO)</span>` : `(Vence em: ${p.diasVencer} dias)`;
                return criarLi(`${p.nome} (${p.qtdAtual} ${p.embalagem}) - ${status}`);
            }).join('') 
            : criarLi('Nenhum produto pr√≥ximo do vencimento.');
    }

    // b. üí∞ Produtos Mais Caros
    const maisCaros = estoqueDetalhado
        .filter(p => p.ultimoCusto > 0)
        .sort((a, b) => b.ultimoCusto - a.ultimoCusto)
        .slice(0, 5);
    
    const listaMaisCarosEl = document.getElementById("listaMaisCaros");
    if (listaMaisCarosEl) {
        listaMaisCarosEl.innerHTML = maisCaros.length > 0 
            ? maisCaros.map(p => criarLi(`${p.nome} (${formatarMoeda(p.ultimoCusto)}/${p.embalagem})`)).join('') 
            : criarLi('Nenhum custo registrado.');
    }

    // c. üì¶ Produtos Mais Utilizados
    const maisSaidas = estoqueDetalhado
        .filter(p => p.qtdSaidas > 0) 
        .sort((a, b) => b.qtdSaidas - a.qtdSaidas)
        .slice(0, 5);
    
    const listaMaisSaidasEl = document.getElementById("listaMaisSaidas");
    if (listaMaisSaidasEl) {
        listaMaisSaidasEl.innerHTML = maisSaidas.length > 0 
            ? maisSaidas.map(p => criarLi(`${p.nome} (${p.qtdSaidas} sa√≠das)`)).join('') 
            : criarLi('Nenhuma sa√≠da registrada.');
    }

    // d. üí§ Produtos com Menos Sa√≠das
    const menosSaidas = estoqueDetalhado
        .filter(p => p.qtdAtual > 0) 
        .sort((a, b) => a.qtdSaidas - b.qtdSaidas)
        .slice(0, 5);
    
    const listaMenosSaidasEl = document.getElementById("listaMenosSaidas");
    if (listaMenosSaidasEl) {
        listaMenosSaidasEl.innerHTML = menosSaidas.length > 0 
            ? menosSaidas.map(p => criarLi(`${p.nome} (${p.qtdSaidas} sa√≠das)`)).join('') 
            : criarLi('Nenhum produto encontrado em estoque.');
    }
    
    // e. ‚ö†Ô∏è Estoque Cr√≠tico
    const criticos = estoqueDetalhado
        .filter(p => p.isCritico) 
        .sort((a, b) => (a.qtdAtual - a.minimo) - (b.qtdAtual - b.minimo))
        .slice(0, 5);
    
    const listaCriticos = document.getElementById("listaEstoqueCritico");
    if (listaCriticos) {
        listaCriticos.innerHTML = criticos.length > 0 
            ? criticos.map(p => criarLi(`${p.nome} (${p.qtdAtual} ${p.embalagem} - M√≠n: ${p.minimo})`)).join('') 
            : criarLi('Tudo OK!');
    }


   // --- 4. C√ÅLCULOS PARA O RESUMO GERAL ---
¬† ¬†¬†
¬† ¬† const totalProdutos = produtosLocal.length;
¬† ¬† const qtdTotalEmEstoque = estoqueDetalhado.reduce((sum, p) => sum + p.qtdAtual, 0);
¬† ¬† // Soma a quantidade total de sa√≠das registradas (e n√£o apenas o n√∫mero de registros)
¬† ¬† const totalSaidasRegistradas = saidasLocal.reduce((sum, s) => sum + (Number(s.qtd || s.quantidade) || 0), 0);¬†
¬† ¬† const criticosCount = estoqueDetalhado.filter(p => p.isCritico).length;
¬† ¬†¬†
¬† ¬† const valorUltimaEntrada = estoqueDetalhado.reduce((sum, p) => sum + (p.qtdAtual * p.ultimoCusto), 0);
¬† ¬† const valorEstoqueCustoMedio = estoqueDetalhado.reduce((sum, p) => sum + (p.qtdAtual * p.cmp), 0); 
    
    // VARI√ÅVEIS DO NOVO MODELO (Ajustadas para o seu c√°lculo):
    const valorTotalUltimaEntrada = valorUltimaEntrada; // O seu 'valorUltimaEntrada'
    const valorTotalCustoMedio = valorEstoqueCustoMedio; // O seu 'valorEstoqueContabil'
    
    // O valor Total do Estoque Atual √© geralmente o Custo M√©dio Ponderado
    const valorTotalEstoqueAtual = valorEstoqueCustoMedio; 
    
    // O valor Cont√°bil (usando o seu CMP)
    const valorTotalEstoqueContabil = valorEstoqueCustoMedio; 


¬† ¬† // 5. EXIBI√á√ÉO DO RESUMO GERAL
    const resumoGeral = document.getElementById("resumoGeral");
    
   if (resumoGeral) {
        resumoGeral.innerHTML = `
            <p><b>Total de produtos:</b> ${totalProdutos}</p>
            <p><b>Quantidade total em estoque:</b> ${qtdTotalEmEstoque}</p>
            <p><b>Total de sa√≠das registradas:</b> ${totalSaidasRegistradas}</p>
            <hr>
            <p><b>üí∞ Valor total (√öltimo valor de entrada):</b> R$ ${valorTotalUltimaEntrada.toFixed(2)}</p>
            <p><b>üìä Valor total (Custo m√©dio ponderado):</b> R$ ${valorTotalCustoMedio.toFixed(2)}</p>
            <p><b>üì¶ Valor total do Estoque Atual:</b> R$ ${valorTotalEstoqueAtual.toFixed(2)}</p>
            <p><b>üíº Valor total do Estoque Atual (Cont√°bil):</b> R$ ${valorTotalEstoqueContabil.toFixed(2)}</p>
            
            `;
    }
}

// Para garantir que o dashboard atualize ao ser acessado:
document.querySelector("#sidebar button[onclick=\"showSection('dashboard')\"]").addEventListener('click', () => {
    // √â importante que 'atualizarDashboard()' seja chamada ap√≥s 'carregarDadosDoFirestore()'
    // Se a fun√ß√£o 'carregarDadosDoFirestore' estiver funcionando e chamando 'atualizarDashboard'
    // no final, voc√™ n√£o precisa disso. Mas √© uma garantia.
    if (typeof carregarDadosDoFirestore === 'function') {
        carregarDadosDoFirestore();
    } else {
        atualizarDashboard();
    }
});

// --- RELAT√ìRIOS ---

function definirPeriodoRapido(tipo) {
  const hoje = new Date();
  let dataInicio, dataFim;

  if (tipo === '7dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 7);
  } else if (tipo === '30dias') {
    dataInicio = new Date(hoje);
    dataInicio.setDate(hoje.getDate() - 30);
  } else if (tipo === 'mes') {
    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  } else {
    return; // N√£o faz nada se o tipo for inv√°lido
  }
  
  dataFim = hoje;
  
  document.getElementById("dataInicioRelatorio").value = dataInicio.toISOString().split('T')[0];
  document.getElementById("dataFimRelatorio").value = dataFim.toISOString().split('T')[0];
  mostrarMensagem(`Per√≠odo definido para: ${tipo}.`, "info");
}

function limparPeriodo() {
  document.getElementById("dataInicioRelatorio").value = "";
  document.getElementById("dataFimRelatorio").value = "";
  mostrarMensagem("Filtro de per√≠odo limpo.", "info");
}

/**
 * üîπ Fun√ß√£o gen√©rica para exportar qualquer tabela para Excel (CSV)
 */
function exportarTabelaExcel(idTabela, nomeArquivoBase, prefixo) {
  const tabela = document.getElementById(idTabela);
  if (!tabela) return alert("Tabela n√£o encontrada.");
  
  const dataInicio = document.getElementById("dataInicioRelatorio").value;
  const dataFim = document.getElementById("dataFimRelatorio").value;
  
  let dadosFiltrados = [];
  let cabecalho = [];

  // 1. Obt√©m o cabe√ßalho
  tabela.querySelectorAll('thead th').forEach(th => {
    // Ignora colunas de A√ß√µes e Foto para um CSV mais limpo
    if (th.textContent.trim() !== "A√ß√µes" && th.textContent.trim() !== "Foto") {
      cabecalho.push(th.textContent.trim());
    }
  });

  // 2. Obt√©m os dados e filtra por data (se for tabela de Entradas ou Sa√≠das)
  const isEntradaOuSaida = idTabela === 'tabelaEntradas' || idTabela === 'tabelaSaidas';
  const dataColuna = isEntradaOuSaida ? 5 : -1; // Coluna 5 √© a 'Data' em Entradas e Sa√≠das (√≠ndice 0)

  tabela.querySelectorAll('tbody tr').forEach(row => {
    let rowData = [];
    let shouldInclude = true;
    let dataDaLinha = "";
    
    row.querySelectorAll('td').forEach((td, index) => {
      // Ignora a √∫ltima coluna (A√ß√µes) e a segunda (Foto)
      if (index === row.cells.length - 1 || td.querySelector('.thumb')) return;
      
      const texto = td.textContent.trim();
      rowData.push(texto);
      
      if (isEntradaOuSaida && index === dataColuna) {
        dataDaLinha = texto;
      }
    });
    
    // Filtra por data se aplic√°vel
    if (isEntradaOuSaida && dataDaLinha && dataInicio && dataFim) {
        const dataLinha = new Date(dataDaLinha);
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        // Adiciona um dia ao fim para incluir a data final
        fim.setDate(fim.getDate() + 1); 

        if (dataLinha < inicio || dataLinha >= fim) {
            shouldInclude = false;
        }
    }

    if (shouldInclude && rowData.length > 0) {
      dadosFiltrados.push(rowData);
    }
  });
  
  if (dadosFiltrados.length === 0) {
      alert("Nenhum dado encontrado para exportar com base nos filtros (se houver).");
      return;
  }

  // 3. Cria o conte√∫do CSV
  let csvContent = cabecalho.join(";") + "\n";
  dadosFiltrados.forEach(row => {
    // Substitui v√≠rgulas por pontos e v√≠rgulas para evitar problemas de formata√ß√£o em Excel
    csvContent += row.map(item => item.replace(/;/g, ",").replace(/\r?\n|\r/g, " ")).join(";") + "\n";
  });

  // 4. Cria o Blob e baixa o arquivo
  const nomeCompleto = `${prefixo || ""}${nomeArquivoBase}_${new Date().toISOString().split('T')[0]}.csv`;
  const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for BOM (UTF-8 encoding in Excel)
  const link = document.createElement("a");
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", nomeCompleto);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarMensagem(`Relat√≥rio '${nomeArquivoBase}' exportado com sucesso!`, "sucesso");
  }
}

function exportarListaExcel() {
    exportarTabelaExcel('tabelaListaCompra', 'Lista_de_Compra', 'Compra_');
}

/**
 * üîπ Fun√ß√£o para gerar Pedido de Or√ßamento em PDF (usando jspdf e autotable)
 */
function gerarPedidoPDF() {
    if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        alert("Erro: Biblioteca jsPDF n√£o carregada. Verifique as tags <script> no final do arquivo.");
        return;
    }
    
    // Pega os dados da lista de compra ATUAL (o que est√° na tela)
    const tabela = document.getElementById("tabelaListaCompra");
    const tbody = tabela ? tabela.querySelector("tbody") : null;
    if (!tbody || tbody.textContent.includes("Nenhum item abaixo")) {
        alert("‚ö†Ô∏è Nenhuma Lista de Compra gerada para exportar!");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Paisagem, mil√≠metros, A4
    const larguraPagina = doc.internal.pageSize.getWidth();
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    // --- CABE√áALHO ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("ORAL UNIC CAMPO GRANDE", larguraPagina / 2, 20, { align: "center" });
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text("Pedido de Or√ßamento", larguraPagina / 2, 28, { align: "center" });
    
    doc.setFontSize(10);
    doc.text(`Data: ${dataAtual}`, 14, 38);
    doc.text(`Solicitante: ${document.getElementById("userName").textContent}`, 14, 44);

    // --- LINHA SEPARADORA ---
    doc.setDrawColor(180);
    doc.line(14, 48, larguraPagina - 14, 48);
    
    // --- TABELA ---
    const headers = [
        ['#', 'Produto', 'C√≥d. Barras', 'Categoria', 'Qtd Atual', 'M√≠nimo', 'Recomenda√ß√£o', 'Observa√ß√£o']
    ];
    
    const body = [];
    tbody.querySelectorAll("tr").forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length > 1) { // Ignora linha de rodap√© e linha de erro
            body.push([
                cols[0].textContent.trim(),
                cols[1].textContent.trim(),
                cols2.textContent.trim(), // C√≥d. Barras
                cols[3].textContent.trim(),
                cols[4].textContent.trim(),
                cols[5].textContent.trim(),
                cols[6].textContent.trim(),
                '' // Coluna vazia para observa√ß√£o manual do fornecedor
            ]);
        }
    });

    doc.autoTable({
        head: headers,
        body: body,
        startY: 55,
        theme: 'striped',
        headStyles: { fillColor: [13, 110, 253] }, // Azul
        columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 40 },
            2: { cellWidth: 25 },
            6: { fontStyle: 'bold' },
        },
        styles: { fontSize: 8, overflow: 'linebreak' },
    });
    
    // --- RODAP√â ---
    const finalY = doc.autoTable.previous.finalY;
    doc.setFontSize(10);
    doc.setFont("helvetica", "italic");
    doc.text("Este documento n√£o √© um pedido oficial de compra, mas um pedido de or√ßamento.", 14, finalY + 10);
    
    doc.save(`Pedido_Orcamento_${new Date().toISOString().split('T')[0]}.pdf`);
    mostrarMensagem("Pedido de Or√ßamento exportado para PDF.", "sucesso");
}



// --- UTILIT√ÅRIOS GLOBAIS ---

function ordenarListasAlfabeticamente() {
  if (typeof produtos !== "undefined" && Array.isArray(produtos)) {
    produtos.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
    // N√£o precisa salvar, pois esta √© apenas uma fun√ß√£o de ordena√ß√£o visual/de refer√™ncia
  }

  if (typeof entradas !== "undefined" && Array.isArray(entradas)) {
    entradas.sort((a, b) => (a.fornecedor || "").localeCompare(b.fornecedor || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof saidas !== "undefined" && Array.isArray(saidas)) {
    saidas.sort((a, b) => (a.produto || "").localeCompare(b.produto || "", 'pt-BR', { sensitivity: 'base' }));
  }

  if (typeof usuarios !== "undefined" && Array.isArray(usuarios)) {
    usuarios.sort((a, b) => (a.nome || "").localeCompare(b.nome || "", 'pt-BR', { sensitivity: 'base' }));
  }
  
  // Atualiza selects de produto
  if (typeof atualizarSelectProdutos === "function") atualizarSelectProdutos();
}


// --- EXECU√á√ÉO INICIAL ---

document.addEventListener("DOMContentLoaded", () => {
    // A autentica√ß√£o Firebase (no script type="module" acima) cuida do carregamento e atualiza√ß√£o inicial.
    // Garante que o menu de setor √© preenchido na se√ß√£o de Sa√≠da
    atualizarSetorAutomatico(); 
});
document.addEventListener('click', (event) => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    if (!sidebar || !menuToggle) return;

    // Use a mesma l√≥gica robusta: Se a sidebar n√£o estiver completamente escondida
    const currentLeft = parseFloat(window.getComputedStyle(sidebar).getPropertyValue('left'));
    
    // Se a sidebar estiver vis√≠vel (left: 0px)
    if (currentLeft >= 0) {
        
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickOnToggle = menuToggle.contains(event.target);

        // Se o clique n√£o foi dentro da sidebar e n√£o foi no bot√£o de toggle, fecha
        if (!isClickInsideSidebar && !isClickOnToggle) {
            // Chamamos toggleSidebar para fechar a sidebar
            toggleSidebar();
        }
    }
});


</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>


