<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Cota√ß√£o e Or√ßamentos</title>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4b8.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- üî• FIREBASE SDK (VERS√ÉO 8 COMPATIBILITY PARA M√ÅXIMA COMPATIBILIDADE) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
      --primaria: #661155;
      /* Official Purple */
      --secundaria: #3ab9b6;
      /* Official Turquoise */
      --fundo: #000000;
      --texto: #ffffff;
      --input-fundo: #1a1a1a;
      --borda: #661155;
      --card: #111;
    }


    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--fundo);
      color: var(--texto);
    }

    /* CABE√áALHO */
    header {
      background: var(--primaria);
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 0 10px rgba(102, 17, 85, 0.6);
    }

    header h1 {
      font-size: 1.4em;
      margin: 0;
      text-align: center;
      width: 100%;
    }

    .btn-sair {
      position: absolute;
      left: 15px;
      top: 6px;
      background: transparent;
      border: 1px solid #fff;
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      line-height: 1;
      width: fit-content;
    }

    .btn-sair:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    /* LOGIN */
    #login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .login-box {
      background: #111;
      box-shadow: 0 0 15px rgba(102, 17, 85, 0.5);
      border-radius: 8px;
      width: 360px;
      padding: 30px 25px;
      text-align: center;
      border: 1px solid var(--borda);
    }

    .login-box h1 {
      color: var(--primaria);
      font-size: 1.6em;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
      font-weight: 600;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--borda);
      border-radius: 4px;
      background: var(--input-fundo);
      color: var(--texto);
      font-size: 14px;
      outline: none;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-color: var(--primaria);
      box-shadow: 0 0 5px var(--primaria);
    }

    button {
      background: var(--primaria);
      color: var(--texto);
      border: none;
      font-weight: bold;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #882277;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primaria);
      margin-top: 10px;
    }

    .btn-outline:hover {
      background: rgba(102, 17, 85, 0.2);
    }

    .alerta {
      color: #ff8080;
      font-size: 14px;
      margin-top: 5px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin-top: 15px;
    }

    /* DASHBOARD */
    #dashboard {
      display: none;
    }

    .dashboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 40px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--borda);
      border-radius: 10px;
      width: 250px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 0 10px rgba(102, 17, 85, 0.4);
      transition: transform 0.2s, box-shadow 0.3s;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 15px rgba(102, 17, 85, 0.8);
    }

    .card i {
      font-size: 40px;
      color: var(--primaria);
      margin-bottom: 10px;
    }

    .rodape {
      text-align: center;
      color: #777;
      padding: 10px;
      border-top: 1px solid var(--borda);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primaria);
      margin-top: 10px;
      color: var(--primaria);
    }

    .btn-outline:hover {
      background: rgba(102, 17, 85, 0.2);
    }

    /* For√ßa o modal a aparecer sobre as sections */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 999999;
      align-items: flex-start;
      /* Start from top for long content */
      justify-content: center;
      overflow-y: auto;
      /* Enable scroll on the overlay wrapper */
      padding: 40px 10px;
      /* Space around the modal */
      box-sizing: border-box;
    }




    /* Garante que tabelas dentro do modal apare√ßam */
    .modal-content table {
      width: 100%;
      color: white;
      border-collapse: collapse;
      margin-top: 15px;
    }


    .modal-content h2 {
      color: var(--primaria);
      margin-bottom: 15px;
    }

    .close-btn {
      background: transparent;
      color: #ccc;
      border: none;
      font-size: 18px;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
    }

    .btn-menu {
      background: transparent;
      border: 1px solid #fff;
      color: white;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      position: absolute;
      left: 15px;
      top: 10px;
      transition: background 0.3s, transform 0.2s;
    }

    .btn-menu:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    /* === AJUSTE VISUAL DAS SE√á√ïES INTERNAS === */
    section {
      background-color: #1a1a1a;
      min-height: 100vh;
      color: white;
    }

    /* Centraliza o conte√∫do principal */
    section>div {
      box-sizing: border-box;
    }

    /* Estiliza√ß√£o dos t√≠tulos */
    section h1 {
      color: #fff;
      text-align: center;
    }

    /* Estilo geral para input e label */
    .input-group label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      color: #ccc;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      background: #1a1a1a;
      border: 1px solid #661155;
      border-radius: 5px;
      color: white;
      padding: 8px;
    }


    .modal-responder-box {
      background: #111;
      border: 1px solid #661155;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      /* üîë limite da altura */
      padding: 20px;
      color: white;
      box-shadow: 0 0 15px rgba(102, 17, 85, 0.6);
      display: flex;
      flex-direction: column;
    }

    /* üîΩ somente o conte√∫do rola */
    #modalResponderConteudo {
      overflow-y: auto;
      margin-top: 10px;
      padding-right: 5px;
    }

    #listaProdutosResponder {
      max-height: 260px;
      /* üîë altura da lista */
      overflow-y: auto;
      /* üîë scroll s√≥ nos itens */
      margin-top: 10px;
      border: 1px solid #661155;
      border-radius: 5px;
    }

    .linha-cotacao {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1a1a1a;
      border: 1px solid #661155;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .linha-cotacao .acoes button {
      background: #661155;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
    }

    .top-header {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #661155;
      height: 60px;
      position: relative;
    }

    .top-header .btn-menu {
      position: absolute;
      left: 20px;
      background: transparent;
      border: 1px solid #fff;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .top-header .titulo-tela {
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .btn-status {
      background: #333;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      width: auto;
    }

    .btn-status.ativo {
      background: #661155;
    }

    .status-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .status-buttons button {
      background: #333;
      color: white;
      border: 1px solid #661155;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      width: auto;
    }

    .status-buttons button.ativo {
      background: #661155;
    }

    .lista-aprovacao {
      margin-top: 15px;
    }

    .usuario-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1a1a1a;
      border: 1px solid #661155;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 10px;
    }

    .usuario-info strong {
      color: #fff;
    }

    .usuario-info span {
      color: #aaa;
      font-size: 13px;
    }

    .usuario-acoes button {
      background: #333;
      border: 1px solid #661155;
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 6px;
    }

    .usuario-acoes button:hover {
      background: #661155;
    }

    /* ======================================================
   üìä MATRIZ DE AN√ÅLISE ‚Äî LAYOUT PREMIUM
====================================================== */

    /* Modal maior */
    #modalAnaliseCotacao .modal-content {
      max-width: 98vw;
      width: 98vw;
      background: #000;
      border: 1px solid #444;
      overflow: hidden;
      /* Prevent parent from scrolling */
    }




    /* ======================================================
   üìå CABE√áALHO
====================================================== */

    .matriz-cotacao thead th {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #500a40;
      /* Roxo mais escuro conforme imagem */
      color: white;
      font-weight: 600;
      border-bottom: 2px solid #333;
    }




    /* ===== C√âLULAS ===== */
    .matriz-cotacao td {
      padding: 12px 8px;
      text-align: center;
      vertical-align: middle;
      border-bottom: 1px solid #222;
    }

    /* Zebra Striping */
    .matriz-cotacao tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.03);
    }

    .matriz-cotacao tbody tr:hover {
      background: rgba(102, 17, 85, 0.1) !important;
    }

    /* ======================================================
   üî¢ COLUNA √çNDICE (#)
====================================================== */
    /* ======================================================
       üî¢ COLUNAS FIXAS (OPTIMIZED)
    ====================================================== */
    .matriz-cotacao th:first-child,
    .matriz-cotacao td:first-child {
      position: sticky;
      left: 0;
      z-index: 31;
      background: #0a0a0a;
      width: 40px;
      min-width: 40px;
    }

    .matriz-cotacao th.col-idx,
    .matriz-cotacao td.col-idx {
      position: sticky;
      left: 40px;
      z-index: 31;
      background: #0a0a0a;
      min-width: 50px;
      width: 50px;
    }

    .matriz-cotacao .col-fixa {
      position: sticky;
      left: 90px;
      z-index: 31;
      background: #0a0a0a;
      min-width: 180px;
      max-width: 220px;
    }

    .matriz-cotacao .col-fixa-2 {
      position: sticky;
      left: 270px;
      z-index: 31;
      background: #0a0a0a;
      min-width: 80px;
      width: 80px;
    }

    .matriz-cotacao .col-fixa-3 {
      position: sticky;
      left: 350px;
      z-index: 31;
      background: #0a0a0a;
      min-width: 60px;
      width: 60px;
      border-right: 2px solid #333;
    }





    /* ======================================================
   üßæ ITEM ‚Äî TEXTO GRANDE SEM INVADIR
====================================================== */
    .item-nome {
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
    }


    /* ======================================================
   üè∑Ô∏è BADGE #
====================================================== */
    .badge-idx {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #661155;
      border-radius: 8px;
      font-weight: bold;
      color: #fff;
      background: #0f0f0f;
    }

    /* ======================================================
   üìÑ COLUNA ITEM
====================================================== */


    /* Nome do item */
    .matriz-cotacao .item-nome {
      width: 100%;
      white-space: normal;
      word-break: break-word;
      line-height: 1.35;
      font-size: 14px;
    }






    /* ======================================================
   üßæ ITEM / QTD
====================================================== */


    /* Nome do item ‚Äì nunca invade colunas */
    .matriz-cotacao .item-nome {
      max-width: 320px;
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
    }

    /* Colunas de pre√ßos */
    .matriz-cotacao td.preco {
      min-width: 140px;
      padding: 14px 12px;
      text-align: center;
    }

    /* Cabe√ßalho dos fornecedores */
    .matriz-cotacao {
      border-collapse: separate;
      /* Essential for sticky */
      border-spacing: 0;
    }

    .matriz-cotacao thead th {
      padding: 14px 18px;
      position: sticky;
      top: 0;
      background: #500a40 !important;
      /* Constant background */
      z-index: 500 !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid #333;
    }

    /* ======================================================
       üè∑Ô∏è RANKING BADGES (CIRCULAR MODEL)
    ====================================================== */
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 800;
      margin-right: 6px;
      border: 2px solid transparent;
    }

    .rank-1 {
      border-color: #00ff99;
      color: #00ff99;
    }

    .rank-2 {
      border-color: #ffcc00;
      color: #ffcc00;
    }

    .rank-3 {
      border-color: #ff3366;
      color: #ff3366;
    }

    .preco-melhor {
      color: #00ff99;
      font-weight: bold;
    }

    /* ======================================================
       üèÜ ESCOLHIDO BOX
    ====================================================== */
    .vencedor-box {
      background: rgba(0, 255, 153, 0.1);
      border: 1px solid #00ff99;
      border-radius: 6px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #00ff99;
      font-weight: 800;
      font-size: 13px;
      width: 100%;
      min-height: 32px;
      position: relative;
      cursor: pointer;
    }

    .vencedor-box select {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      appearance: none;
    }

    /* Alta Densidade */
    .matriz-cotacao td,
    .matriz-cotacao th {
      padding: 6px 4px !important;
      height: 48px !important;
    }

    .vencedor-box select option {
      background: #222;
      color: #fff;
    }

    .matriz-cotacao tr {
      border-bottom: 1px solid #222;
    }

    /* ======================================================
       üìä MODO COMPACTO (Foco em Densidade)
    ====================================================== */
    .compact-mode .matriz-cotacao {
      border-spacing: 0 2px;
    }

    .compact-mode .matriz-cotacao td,
    .compact-mode .matriz-cotacao th {
      padding: 6px 4px !important;
      font-size: 13px !important;
    }

    /* ======================================================
       üîç MODO FOCALIZADO (TOTAL FOCUS - M√ÅXIMO DE LINHAS)
    ====================================================== */
    body.modo-focalizado #modalAnaliseCotacao h2,
    body.modo-focalizado #modalAnaliseCotacao .close-btn,
    body.modo-focalizado #modalAnaliseCotacao .cabecalho-cotacao,
    body.modo-focalizado #modalAnaliseCotacao #statusAprovacao,
    body.modo-focalizado #modalAnaliseCotacao #acoesFechada,
    body.modo-focalizado #modalAnaliseCotacao #contEnviarAprovacao {
      display: none !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
    }

    body.modo-focalizado #modalAnaliseCotacao .modal-content {
      padding: 0px !important;
      background: #000 !important;
      height: 99vh !important;
      max-height: 99vh !important;
      width: 99vw !important;
      max-width: 99vw !important;
      display: flex !important;
      flex-direction: column !important;
    }

    body.modo-focalizado .matriz-cotacao td,
    body.modo-focalizado .matriz-cotacao th {
      padding: 0px 2px !important;
      height: 22px !important;
      min-height: 22px !important;
      font-size: 10px !important;
      line-height: 1 !important;
      border-bottom: 1px solid #1a1a1a !important;
    }

    body.modo-focalizado .badge-idx {
      padding: 0px 4px !important;
      font-size: 9px !important;
      border: none !important;
      background: transparent !important;
      margin: 0 !important;
    }

    body.modo-focalizado .vencedor-box {
      min-height: 16px !important;
      height: 16px !important;
      padding: 0px 4px !important;
      font-size: 9px !important;
      border-radius: 2px !important;
      border: 1px solid rgba(0, 255, 153, 0.3) !important;
    }

    body.modo-focalizado .rank-badge {
      width: 12px !important;
      height: 12px !important;
      font-size: 7px !important;
      margin-right: 1px !important;
      border-width: 1px !important;
    }

    body.modo-focalizado #analiseConteudo {
      margin: 0 !important;
      padding: 0 !important;
      height: 100% !important;
      flex: 1 !important;
      overflow-y: auto !important;
    }

    .compact-mode .matriz-cotacao .col-fixa {
      min-width: 180px !important;
      left: 80px !important;
    }

    .compact-mode .matriz-cotacao .col-fixa-2 {
      min-width: 90px !important;
      width: 90px !important;
      left: 260px !important;
    }

    .compact-mode .matriz-cotacao .col-fixa-3 {
      min-width: 60px !important;
      width: 60px !important;
      left: 350px !important;
    }

    .compact-mode .matriz-cotacao th:first-child,
    .compact-mode .matriz-cotacao td:first-child {
      width: 30px !important;
      min-width: 30px !important;
    }

    .compact-mode .matriz-cotacao th.col-idx,
    .compact-mode .matriz-cotacao td.col-idx {
      width: 50px !important;
      min-width: 50px !important;
      left: 30px !important;
    }

    .compact-mode .badge-idx {
      padding: 2px 6px;
      font-size: 11px;
    }

    .compact-mode .item-nome {
      max-width: 170px;
    }



    .matriz-cotacao {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }


    /* ======================================================
       üîê LOGIN
    ====================================================== */

    .matriz-cotacao td.preco {
      text-align: center;
      font-weight: bold;
      border-radius: 8px;
      padding: 10px 6px;
    }

    /* cores */
    .preco-melhor {
      color: #00ff99;
    }

    .preco-neutro {
      color: #888;
    }

    .preco-medio {
      background: #664d03;
    }

    .preco-ruim {
      background: #842029;
    }

    /* ======================================================
   üèÖ RANKING
====================================================== */

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      font-size: 11px;
      font-weight: 800;
      border-radius: 50%;
      margin-right: 8px;
      background: #000;
    }

    .rank-1 {
      border: 2px solid #00ff99;
      color: #00ff99;
      box-shadow: 0 0 5px rgba(0, 255, 153, 0.3);
    }

    .rank-2 {
      border: 2px solid #ffd966;
      color: #ffd966;
      box-shadow: 0 0 5px rgba(255, 217, 102, 0.3);
    }

    .rank-3 {
      border: 2px solid #ff4488;
      color: #ff4488;
      box-shadow: 0 0 5px rgba(255, 68, 136, 0.3);
    }

    /* Coluna Vencedor Premium */
    .vencedor-box {
      display: flex;
      align-items: center;
      background: #111;
      border: 1px solid #33a852;
      /* Verde suave para o vencedor */
      border-radius: 6px;
      padding: 5px 10px;
      gap: 10px;
    }

    .vencedor-box i {
      color: #ffcc00;
      /* Dourado */
      font-size: 14px;
    }

    .vencedor-box select {
      background: transparent !important;
      border: none !important;
      padding: 2px 0 !important;
      font-weight: 600;
      color: #33a852;
      cursor: pointer;
      outline: none;
      font-size: 13px;
    }

    /* ======================================================
   üéØ A√á√ÉO
====================================================== */

    .matriz-cotacao td.acao {
      min-width: 180px;
      text-align: left;
      padding-left: 10px;
    }

    .matriz-cotacao select {
      width: 100%;
      min-width: 165px;
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #661155;
      padding: 6px;
      border-radius: 4px;
      font-size: 13px;
    }


    #modalAnaliseCotacao .close-btn,
    #modalCotacao .close-btn,
    #modalFornecedores .close-btn,
    #modalResponder .close-btn,
    #modalDetalhesRespostaFornecedor .close-btn,
    #modalRejeicaoAprovacao .close-btn {


      position: absolute;
      top: 12px;
      right: 12px;

      width: 34px;
      height: 34px;

      background: #661155;
      color: #fff;

      border: none;
      border-radius: 50%;

      font-size: 18px;
      font-weight: bold;

      display: flex;
      align-items: center;
      justify-content: center;

      cursor: pointer;
      box-shadow: 0 0 8px rgba(102, 17, 85, 0.7);

      transition: background 0.2s, transform 0.15s;
    }

    #modalRejeicaoAprovacao {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000000;
      /* maior que modalAnaliseCotacao e modo foco */
      display: none;
      align-items: center;
      justify-content: center;
    }

    /* üéØ AJUSTE FINO DO X ‚Äî MODAL RESPONDER */
    #modalResponder .close-btn {
      top: 10px;
      /* sobe levemente */
      right: 10px;
      /* aproxima da borda */
      width: 32px;
      /* levemente menor */
      height: 32px;
      font-size: 17px;
      /* proporcional ao card */
    }

    #modalResponder .modal-content {
      position: relative;
    }

    #modalAnaliseCotacao .close-btn:hover,
    #modalCotacao .close-btn:hover,
    #modalFornecedores .close-btn:hover,
    #modalResponder .close-btn:hover,
    #modalDetalhesRespostaFornecedor .close-btn:hover {
      background: #882277;
      transform: scale(1.05);
    }


    /* alinhamento REAL por coluna */
    #modalResponder .tabela-responder {
      table-layout: fixed;
      width: 100%;
    }

    #modalResponder .tabela-responder th,
    #modalResponder .tabela-responder td {
      text-align: center;
      padding-left: 0;
      padding-right: 0;
    }

    /* centraliza o input sem mudar apar√™ncia */
    #modalResponder .tabela-responder td input {
      margin: 0 auto;
    }

    /* Alinhamento exato da tabela do responder cota√ß√£o */
    #listaProdutosResponder table {
      width: 100%;
      border-collapse: collapse;
    }

    #listaProdutosResponder th,
    #listaProdutosResponder td {
      text-align: center;
      vertical-align: middle;
    }

    #listaProdutosResponder td input {
      display: block;
      margin: 0 auto;
      /* centraliza o campo */
    }

    #modalDetalhesRespostaFornecedor .tabela-responder {
      table-layout: fixed;
      width: 100%;
    }

    #modalDetalhesRespostaFornecedor .tabela-responder th,
    #modalDetalhesRespostaFornecedor .tabela-responder td {
      text-align: center;
      vertical-align: middle;
    }

    /* ======================================================
   üßæ TABELA RESPONDER / MINHA RESPOSTA ‚Äî VISUAL EM GRADE
====================================================== */

    .tabela-responder {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: #111;
    }

    /* Cabe√ßalho */
    .tabela-responder thead th {
      background: #661155;
      color: #fff;
      padding: 10px;
      text-align: center;
      border: 1px solid #661155;
      font-weight: 600;
    }

    /* Linhas */
    .tabela-responder tbody tr {
      background: #1a1a1a;
    }

    /* C√©lulas */
    .tabela-responder td {
      border: 1px solid #661155;
      padding: 8px 6px;
      text-align: center;
      vertical-align: middle;
      color: #fff;
    }

    /* Produto mais leg√≠vel */
    .tabela-responder td:first-child {
      text-align: left;
      padding-left: 12px;
    }

    /* Zebra (ajuda MUITO com muitas linhas) */
    .tabela-responder tbody tr:nth-child(even) {
      background: #151515;
    }

    /* Input de pre√ßo (mant√©m centralizado e limpo) */
    .tabela-responder td input {
      width: 90px;
      background: #1a1a1a;
      border: 1px solid #661155;
      border-radius: 5px;
      color: #fff;
      padding: 4px 6px;
      text-align: center;
    }

    /* üîπ LINHA FINA ABAIXO DO CABE√áALHO (FUNCIONA COM border-collapse: separate) */
    .tabela-responder thead th {
      box-shadow: inset 0 -2px 0 #661155;
    }

    #modalDetalhesRespostaFornecedor {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 99999 !important;
      /* Maior que qualquer menu */
      display: none;
      /* JS muda para flex */
      justify-content: center;
      align-items: center;
    }


    /* ======================================================
   üîë BASE UNIVERSAL PARA TODOS OS MODAIS
====================================================== */
    .modal-content {
      position: relative;
      /* üîë ESSENCIAL para o X */
      background: #111;
      border: 1px solid #661155;
      border-radius: 10px;
      padding: 25px;
      color: white;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      margin: auto;
      /* Centers modal if content is short */
      max-height: none;
      /* Let content determine height */
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(102, 17, 85, 0.8);
    }

    input,
    select,
    textarea {
      background: #1a1a1a;
      color: white;
      border: 1px solid #661155;
      border-radius: 5px;
      padding: 6px;
      font-size: 14px;
    }

    /* üéØ PADR√ÉO DO BOT√ÉO X ‚Äî MODAL DETALHES DA SOLICITA√á√ÉO */
    #modalDetalhesSolicitacao .modal-content {
      position: relative;
      /* üîë garante refer√™ncia correta */
    }

    #modalDetalhesSolicitacao .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;

      width: 34px;
      height: 34px;

      background: #661155;
      color: #fff;

      border: none;
      border-radius: 50%;

      font-size: 18px;
      font-weight: bold;

      display: flex;
      align-items: center;
      justify-content: center;

      cursor: pointer;
      box-shadow: 0 0 8px rgba(102, 17, 85, 0.7);

      transition: background 0.2s, transform 0.15s;
    }

    #modalDetalhesSolicitacao .close-btn:hover {
      background: #882277;
      transform: scale(1.05);
    }



    /* üëÅÔ∏è OLHO DA SENHA ‚Äî CENTRALIZADO E LIMPO */
    /* wrapper exclusivo do input */
    .input-wrapper {
      position: relative;
      width: 100%;
    }

    /* üëÅÔ∏è OLHO ‚Äî CENTRALIZA√á√ÉO PERFEITA */
    .toggle-senha {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);

      color: #661155;
      /* roxo padr√£o */
      font-size: 16px;

      cursor: pointer;
      opacity: 0.9;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-senha:hover {
      opacity: 1;
    }

    /* Espa√ßamento correto entre label e input */
    .input-group label,
    #cadastroMaterial label {
      margin-bottom: 6px;
      display: block;
    }

    /* ===============================
   ‚úÖ CADASTRO DE MATERIAL ‚Äî LIMPO
================================ */

    /* grid correto */
    #cadastroMaterial .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 18px;
      row-gap: 20px;
      margin-top: 18px;
    }

    /* cada campo com altura est√°vel */
    #cadastroMaterial .form-grid>div {
      display: flex;
      flex-direction: column;
    }

    /* label consistente */
    #cadastroMaterial label {
      margin-bottom: 6px;
      font-weight: 500;
      color: #ccc;
    }

    /* üîß AJUSTE FINO ‚Äî RESPIRO ENTRE COLUNAS DO CADASTRO MATERIAL */
    #cadastroMaterial .form-grid>div:nth-child(odd) {
      padding-right: 6px;
    }

    #cadastroMaterial .form-grid>div:nth-child(even) {
      padding-left: 6px;
    }


    /* ======================================================
   üìä CABE√áALHO ‚Äî AN√ÅLISE DE COTA√á√ÉO
====================================================== */
    .cabecalho-cotacao {
      background: #0f0f0f;
      border: 1px solid #661155;
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 20px;
    }

    .cabecalho-cotacao .linha-principal {
      font-size: 18px;
      font-weight: bold;
    }

    .numero-cotacao {
      color: #661155;
    }

    .descricao-cotacao {
      margin-top: 8px;
      font-size: 14px;
      color: #ccc;
      line-height: 1.4;
    }

    .linha-datas {
      display: flex;
      gap: 30px;
      margin-top: 12px;
      font-size: 13px;
      color: #aaa;
    }

    .linha-datas strong {
      color: #fff;
    }

    /* ======================================================
   üìä MATRIZ ‚Äî DEFINI√á√ÉO FINAL (√öNICA)
====================================================== */

    .matriz-cotacao {
      width: max-content;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0 12px;
      font-size: 13px;
    }

    .matriz-cotacao td,
    .matriz-cotacao th {
      border: none;
      background-clip: padding-box;
    }

    /* LINHA COMO CARD */
    .matriz-cotacao tbody tr td {
      background: #111;
      border-top: 1px solid #661155;
      border-bottom: 1px solid #661155;
    }

    .matriz-cotacao tbody tr td:first-child {
      border-left: 1px solid #661155;
      border-top-left-radius: 14px;
      border-bottom-left-radius: 14px;
    }

    .matriz-cotacao tbody tr td:last-child {
      border-right: 1px solid #661155;
      border-top-right-radius: 14px;
      border-bottom-right-radius: 14px;
    }

    /* CABE√áALHO */
    .matriz-cotacao thead th {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #661155;
    }

    /* COLUNAS FIXAS */
    .matriz-cotacao th.col-idx,
    .matriz-cotacao td.col-idx {
      position: sticky;

      left: 0;
      z-index: 60;
      background: #111;
      min-width: 70px;
    }

    .matriz-cotacao th.col-item,
    .matriz-cotacao td.col-item {
      position: sticky;

      left: 70px;
      z-index: 49;
      background: #111;
      min-width: 360px;
      max-width: 360px;
      text-align: left;
    }

    .matriz-cotacao th.col-qtd,
    .matriz-cotacao td.col-qtd {
      position: sticky;

      left: 430px;
      z-index: 48;
      background: #111;
      min-width: 80px;
      text-align: center;
    }

    .item-nome {
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
    }

    /* ======================================================
   üîí FIXA√á√ÉO REAL DAS COLUNAS # / ITEM / QTD
====================================================== */

    /* tabela precisa crescer mais que o container */
    .matriz-cotacao {
      width: max-content;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0 14px;
      /* espa√ßo entre as linhas (card) */
    }



    /* =======================
   COLUNA #
======================= */
    .matriz-cotacao th.col-idx,
    .matriz-cotacao td.col-idx {
      position: sticky;
      left: 0;
      z-index: 100;
      background: #111;
      min-width: 70px;
      text-align: center;
    }

    /* =======================
   COLUNA ITEM
======================= */
    .matriz-cotacao th.col-item,
    .matriz-cotacao td.col-item {
      position: sticky;
      left: 70px;
      /* largura da coluna # */
      z-index: 99;
      background: #111;
      min-width: 360px;
      max-width: 360px;
      text-align: left;
    }

    /* texto do item n√£o invade */
    .matriz-cotacao .item-nome {
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
    }

    /* =======================
   COLUNA QTD
======================= */
    .matriz-cotacao th.col-qtd,
    .matriz-cotacao td.col-qtd {
      position: sticky;
      left: 430px;
      /* 70 (#) + 360 (Item) */
      z-index: 98;
      background: #111;
      min-width: 80px;
      text-align: center;
      box-shadow: 4px 0 6px rgba(0, 0, 0, 0.5);
      /* separa√ß√£o visual */
    }

    /* =======================
   CABE√áALHO FIXO
======================= */
    .matriz-cotacao thead th {
      position: sticky;

      z-index: 110;
      background: #661155;
    }

    /* ===============================
   COLUNAS DOS FORNECEDORES
================================ */
    .matriz-cotacao th.col-fornecedor,
    .matriz-cotacao td.col-fornecedor {
      min-width: 160px;
      max-width: 160px;
      text-align: center;
    }

    /* ======================================================
       üìä MATRIZ DE AN√ÅLISE ‚Äî FIXA√á√ÉO FINAL (STICKY)
    ====================================================== */

    .matriz-cotacao {
      width: max-content;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      /* Removido espa√ßamento para evitar v√£os no sticky */
      font-size: 13px;
    }

    /* 1. FIXAR TOPO (Voz do "Renato Narcizo" e outros) */
    .matriz-cotacao thead th {
      position: sticky;
      top: 0;
      z-index: 150;
      /* Z-index alto para ficar acima de tudo ao rolar */
      background: #661155;
      padding: 14px 18px;
      color: white;
      border-bottom: 2px solid #000;
    }

    /* 2. FIXAR COLUNA # (ID) */
    .matriz-cotacao th.col-idx,
    .matriz-cotacao td.col-idx {
      position: sticky;
      left: 0;
      z-index: 100;
      background: #111;
      min-width: 70px;
      text-align: center;
      border-right: 1px solid #333;
    }

    /* 3. FIXAR COLUNA ITEM */
    .matriz-cotacao th.col-item,
    .matriz-cotacao td.col-item {
      position: sticky;
      left: 70px;
      /* Largura da col-idx */
      z-index: 99;
      background: #111;
      min-width: 360px;
      max-width: 360px;
      text-align: left;
      border-right: 1px solid #333;
    }

    /* 4. FIXAR COLUNA QTD */
    .matriz-cotacao th.col-qtd,
    .matriz-cotacao td.col-qtd {
      position: sticky;
      left: 430px;
      /* 70 (idx) + 360 (item) */
      z-index: 98;
      background: #111;
      min-width: 80px;
      text-align: center;
      box-shadow: 4px 0 6px rgba(0, 0, 0, 0.5);
      /* Sombra para indicar rolagem lateral */
    }

    /* 5. INTERSEC√á√ÉO FIXA (Os cantos superiores esquerdos do cabe√ßalho) */
    .matriz-cotacao thead th.col-idx,
    .matriz-cotacao thead th.col-item,
    .matriz-cotacao thead th.col-qtd {
      z-index: 200;
      /* Deve ser o maior de todos */
      background: #661155;
      /* Cor do cabe√ßalho */
    }

    /* ESTILO DAS LINHAS (EFEITO CARD) */
    .matriz-cotacao tbody tr td {
      padding: 14px 12px;
      background: #111;
      border-bottom: 1px solid #333;
    }



    /* BOT√ÉO FECHAR (X) */
    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      background: #661155;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
    }

    /* INPUTS GERAIS */
    input,
    select,
    textarea {
      background: #1a1a1a;
      color: white;
      border: 1px solid #661155;
      border-radius: 5px;
      padding: 6px;
    }

    #boxMotivoRejeicao {
      display: none;
    }

    /* ======================================================
    üîò COLUNA DO BOT√ÉO EXPANDIR (FIXA NO ZERO)
====================================================== */
    .matriz-cotacao th.col-expand,
    .matriz-cotacao td.col-expand {
      position: sticky;
      left: 0;
      z-index: 400;
      /* O maior de todos para ficar por cima */
      background: #111;
      width: 15px;
      min-width: 15px;
      max-width: 15px;
      text-align: center;
      border-right: 1px solid #333;
    }

    /* No cabe√ßalho, o fundo deve ser roxo */
    .matriz-cotacao thead th.col-expand {
      background: #661155;
      z-index: 500;
    }

    /* ======================================================
    üî¢ COLUNA # (FIXA AP√ìS O BOT√ÉO)
====================================================== */
    .matriz-cotacao th.col-idx,
    .matriz-cotacao td.col-idx {
      position: sticky;
      left: 50px;
      /* Largura da col-expand */
      z-index: 390;
      background: #111;
      min-width: 70px;
      max-width: 70px;
      text-align: center;
      border-right: 1px solid #333;
    }

    .matriz-cotacao thead th.col-idx {
      background: #661155;
      z-index: 490;
    }

    /* ======================================================
    üìÑ COLUNA ITEM (FIXA AP√ìS O #)
====================================================== */
    .matriz-cotacao th.col-item,
    .matriz-cotacao td.col-item {
      position: sticky;
      left: 120px;
      /* 50 (expand) + 70 (#) */
      z-index: 380;
      background: #111;
      min-width: 300px;
      max-width: 300px;
      text-align: left;
      border-right: 1px solid #333;
    }

    .matriz-cotacao thead th.col-item {
      background: #661155;
      z-index: 480;
    }

    /* ======================================================
    üî¢ COLUNA QTD (FIXA AP√ìS O ITEM)
====================================================== */
    .matriz-cotacao th.col-qtd,
    .matriz-cotacao td.col-qtd {
      position: sticky;
      left: 420px;
      /* 50 + 70 + 300 */
      z-index: 370;
      background: #111;
      min-width: 50px;
      max-width: 50px;
      text-align: center;
      box-shadow: 4px 0 6px rgba(0, 0, 0, 0.5);
      /* Sombra final da parte fixa */
    }

    .matriz-cotacao thead th.col-qtd {
      background: #661155;
      z-index: 470;
    }

    /* Ajuste do bot√£o dentro da c√©lula */
    .btn-expand {
      background: #661155;
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }


    /* ===============================
   üîç MODO FOCO ‚Äî RESPOSTAS
================================ */
    .wrapper-matriz.modo-foco {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 96vw;
      height: calc(100vh - 120px);
      background: #0f0f0f;
      z-index: 99999;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
      overflow: auto;
    }

    /* fundo escurecido */
    .wrapper-matriz.modo-foco::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: -1;
    }

    .wrapper-matriz {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      /* üîë scroll horizontal */
      overflow-y: hidden;
      padding-bottom: 6px;
      /* espa√ßo pro scrollbar */
    }

    /* ======================================================
   ‚ùå MODAL DE REJEI√á√ÉO ‚Äî AJUSTE DEFINITIVO
====================================================== */

    #modalRejeicaoAprovacao {
      display: none;
      /* JS controla */
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 20000000;
      /* acima de tudo */
      align-items: center;
      justify-content: center;
    }

    #modalRejeicaoAprovacao .modal-content {
      display: block;
      opacity: 1;
      visibility: visible;
      transform: none;

      background: #111;
      border: 1px solid #661155;
      border-radius: 10px;

      width: 90%;
      max-width: 500px;
      /* üîë tamanho correto */
      max-height: none;
      /* üîë remove limita√ß√£o */

      padding: 25px;
    }

    /* ======================================================
       üíì STATUS PULSANTE - NOVO WORKFLOW
    ====================================================== */
    .status-pulsante {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 13px;
      text-transform: uppercase;
      animation: pulse-sm 1.5s infinite;
    }

    @keyframes pulse-sm {
      0% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
      }

      100% {
        transform: scale(0.98);
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
      }
    }

    .status-pendente {
      background: #333;
      color: #aaa;
      border: 1px solid #555;
    }

    .status-cotacao {
      background: #ffd900;
      color: #000;
      border: 1px solid #ccaa00;
    }

    .status-finalizada {
      background: #00ff99;
      color: #000;
      border: 1px solid #00cc77;
      animation: none !important;
    }

    /* Estilo para links de rodap√© na login */
    .login-box a {
      color: var(--secundaria);
      text-decoration: none;
      font-size: 14px;
      margin-top: 15px;
      display: inline-block;
    }

    .login-box a:hover {
      text-decoration: underline;
    }

    /* ======================================================
       STEPPER WORKFLOW
    ====================================================== */
    .stepper-container {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      position: relative;
    }

    .stepper-container::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 2px;
      background: #333;
      z-index: 0;
    }

    .step-item {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      background: #1a1a1a;
      border: 2px solid #555;
      border-radius: 50%;
      margin: 0 auto 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #777;
      transition: all 0.3s;
    }

    .step-label {
      font-size: 11px;
      color: #777;
    }

    /* Estados */
    .step-item.active .step-circle {
      border-color: #661155;
      background: #111;
      color: #fff;
      box-shadow: 0 0 10px rgba(102, 17, 85, 0.5);
    }

    .step-item.active .step-label {
      color: #fff;
      font-weight: bold;
    }

    .step-item.completed .step-circle {
      background: #661155;
      border-color: #661155;
      color: white;
    }

    .step-item.completed .step-label {
      color: #aaa;
    }

    /* Preenchimento da barra */
    .progress-bar-stepper {
      position: absolute;
      top: 15px;
      left: 0;
      height: 2px;
      background: #661155;
      z-index: 0;
      transition: width 0.5s;
    }

    /* ======================================================
       üîê MODAL TROCA DE SENHA OBRIGAT√ìRIA (OVERLAY)
    ====================================================== */
    #modalTrocaSenha {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000000;
      /* Acima de tudo */
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .troca-senha-box {
      background: #111;
      border: 1px solid var(--primaria);
      box-shadow: 0 0 30px rgba(102, 17, 85, 0.8);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      padding: 30px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .troca-senha-box h2 {
      color: var(--primaria);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .troca-senha-box p {
      font-size: 14px;
      color: #ccc;
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .troca-senha-box .input-group {
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <section id="login-container">
    <div class="login-box">

      <div class="icon"><i class="fa-solid fa-file-invoice-dollar" style="font-size:40px;color:#661155;"></i></div>
      <h1>Sistema de Cota√ß√£o</h1>

      <form onsubmit="login(); return false;">
        <div class="input-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" placeholder="Digite seu e-mail" required />
        </div>

        <div class="input-group">
          <label for="senha">Senha</label>
          <div class="input-wrapper">
            <input type="password" id="senha" placeholder="Digite sua senha" required />
            <span class="toggle-senha" onclick="toggleSenha()">
              <i class="fa-solid fa-eye"></i>
            </span>
          </div>
        </div>

        <button type="submit"
          style="width: auto; margin: 20px auto 0; display: block; padding: 10px 40px;">Entrar</button>
      </form>

      <div id="msgLogin" class="alerta"></div>

      <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">

        <a href="#" onclick="abrirTrabalheConosco()">üöÄ Trabalhe Conosco (Autocadastro)</a>
      </div>

      <footer>¬© 2026 Sistema de Cota√ß√£o ‚Ä¢ Todos os direitos reservados</footer>
    </div>
  </section>

  <!-- üîê MODAL TROCA DE SENHA OBRIGAT√ìRIA -->
  <div id="modalTrocaSenha" style="display:none;">
    <div class="troca-senha-box">
      <i class="fa-solid fa-lock" style="font-size: 40px; color: var(--primaria); margin-bottom: 15px;"></i>
      <h2>Troca de Senha Obrigat√≥ria</h2>
      <p>Para sua seguran√ßa, identicamos que esta √© uma senha tempor√°ria. Por favor, cadastre uma nova senha para
        continuar.</p>

      <form onsubmit="confirmarTrocaSenha(); return false;">
        <div class="input-group">
          <label>Nova Senha</label>
          <div class="input-wrapper">
            <input type="password" id="novaSenha" placeholder="Digite a nova senha" required minlength="6">
          </div>
        </div>

        <div class="input-group">
          <label>Confirma√ß√£o de Senha</label>
          <div class="input-wrapper">
            <input type="password" id="confirmarNovaSenha" placeholder="Confirme a nova senha" required minlength="6">
          </div>
        </div>

        <div id="msgTrocaSenha" class="alerta"></div>

        <button type="submit" style="margin-top: 15px;">Atualizar e Acessar</button>
      </form>
    </div>
  </div>

  <!-- TRABALHE CONOSCO (AUTOCADASTRO) -->
  <section id="trabalhe-conosco" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarParaLogin()">‚¨ÖÔ∏è Voltar ao Login</button>
      <h1>Portal do Fornecedor</h1>
    </header>

    <div
      style="background:#111; border:1px solid #661155; border-radius:10px; padding:25px; margin:30px auto; width:90%; max-width:900px; color:white; box-shadow:0 0 15px rgba(102,17,85,0.6);">
      <h2 style="color:#661155;">üìã Proposta de Parceria</h2>
      <p style="opacity: 0.8; margin-bottom: 25px;">Preencha seus dados para an√°lise da nossa equipe de suprimentos.</p>

      <div style="display:grid; grid-template-columns:1fr 1fr; column-gap:15px; row-gap:20px;">
        <div>
          <label>Nome da Empresa</label>
          <input id="autoFornNome" type="text" placeholder="Raz√£o Social">
        </div>
        <div>
          <label>CNPJ</label>
          <input id="autoFornCnpj" type="text" placeholder="00.000.000/0000-00">
        </div>
        <div style="grid-column: 1 / span 2;">
          <label>E-mail Corporativo</label>
          <input id="autoFornEmail" type="email" placeholder="contato@empresa.com.br">
        </div>
        <div>
          <label>WhatsApp</label>
          <input id="autoFornWhats" type="text" placeholder="(00) 00000-0000">
        </div>
        <div>
          <label>Categoria principal</label>
          <select id="autoFornTipo">
            <option value="">Selecione...</option>
            <option>Materiais El√©tricos</option>
            <option>Constru√ß√£o Civil</option>
            <option>Servi√ßos T√©cnicos</option>
            <option>Transporte e Log√≠stica</option>
            <option>Inform√°tica e TI</option>
            <option>Outros</option>
          </select>
        </div>
        <div style="grid-column: 1 / span 2;">
          <label>Dados Banc√°rios (Banco, Ag√™ncia, Conta)</label>
          <textarea id="autoFornBanco" style="height: 60px;" placeholder="Banco: X - Ag√™ncia: Y - Conta: Z"></textarea>
        </div>
        <div style="grid-column: 1 / span 2;">
          <label>Anexar Documenta√ß√£o (Contrato Social / CND)</label>
          <input type="file" id="autoFornDoc" multiple style="border-style: dashed; padding: 20px;">
        </div>
      </div>

      <button onclick="enviarAutoCadastro()" style="margin-top: 30px; padding: 15px; font-size: 16px;">
        üöÄ Enviar para Aprova√ß√£o
      </button>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard">
    <header>
      <button class="btn-sair" onclick="sair()">Sair</button>
      <h1>Painel de Controle</h1>
    </header>

    <div class="dashboard">
      <div class="card" onclick="abrirModalCotacao()">
        <i class="fa-solid fa-file-circle-plus"></i>
        <h3>Criar Cota√ß√£o</h3>
        <p>Gerar novo pedido de or√ßamento</p>
      </div>

      <!-- üìù Solicita√ß√£o de Compra -->
      <div class="card" id="cardSolicitacaoCompra" onclick="abrirSolicitacaoCompra()">
        <i class="fa-solid fa-clipboard-list"></i>
        <h3>Solicita√ß√£o de Compra</h3>
        <p>Solicitar materiais ou servi√ßos</p>
      </div>

      <!-- üìù Solicita√ß√µes de Compra (COMPRADOR) -->
      <div class="card" id="cardSolicitacoesCompra" onclick="abrirSolicitacoesCompra()">
        <i class="fa-solid fa-inbox"></i>
        <h3>Gest√£o de Requisi√ß√µes</h3>
        <p>Solicita√ß√µes enviadas pelos requisitantes</p>
      </div>



      <div class="card" onclick="abrirCadastroFornecedor()">
        <i class="fa-solid fa-truck-field"></i>
        <h3>Cadastrar Fornecedor</h3>
        <p>Adicionar novos fornecedores</p>
      </div>

      <div class="card" onclick="abrirCadastroMaterial()">
        <i class="fa-solid fa-boxes-stacked"></i>
        <h3>Cadastrar Material</h3>
        <p>Inserir novos materiais</p>
      </div>

      <div class="card" onclick="abrirCadastroServico()">
        <i class="fa-solid fa-screwdriver-wrench"></i>
        <h3>Cadastrar Servi√ßo</h3>
        <p>Adicionar servi√ßos no sistema</p>
      </div>

      <div class="card" onclick="abrirTela('financeiro'); carregarFinanceiroFornecedor()">
        <i class="fa-solid fa-file-invoice-dollar"></i>
        <h3>Gest√£o Financeira</h3>
        <p>Notas Fiscais e Boletos</p>
      </div>

      <div class="card" onclick="abrirTela('responderCotacao')">
        <i class="fa-solid fa-envelope-open-text"></i>
        <h3>Responder Cota√ß√£o</h3>
        <p>Ver e responder solicita√ß√µes recebidas</p>
      </div>

      <!-- ‚öôÔ∏è CONFIGURA√á√ïES (Removido a pedido do usu√°rio)
      <div class="card" id="cardConfig" onclick="abrirTela('configuracoes')">
        <i class="fa-solid fa-gear"></i>
        <h3>Configura√ß√µes</h3>
        <p>Ajustes do sistema e logo</p>
      </div>
      -->


      <div class="card" onclick="abrirTela('cotacoesRespondidas')">
        <i class="fa-solid fa-circle-check"></i>
        <h3>Cota√ß√µes Respondidas</h3>
        <p>Visualizar respostas recebidas dos fornecedores</p>
      </div>

      <div class="card" onclick="abrirAprovarCompras()">
        <i class="fa-solid fa-check-circle"></i>
        <h3>Aprovar Compras</h3>
        <p>Visualizar e aprovar cota√ß√µes finalizadas</p>
      </div>

      <div class="card" onclick="abrirTela('usuarios'); carregarUsuarios()">
        <i class="fa-solid fa-users-gear"></i>
        <h3>Gerenciar Usu√°rios</h3>
        <p>Adicionar e controlar acessos do sistema</p>
      </div>
    </div>

    <div class="rodape">
      ¬© 2026 Sistema de Cota√ß√£o ‚Ä¢ Desenvolvido com üíú #661155
    </div>
  </section>

  <!-- GEST√ÉO FINANCEIRA (FORNECEDORES) -->
  <section id="financeiro" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Gest√£o Financeira</h1>
    </header>

    <div style="
        background:#111;
        border:1px solid #661155;
        border-radius:10px;
        padding:25px;
        margin:30px auto;
        width:90%;
        max-width:1000px;
        color:white;
        box-shadow:0 0 15px rgba(102,17,85,0.6);
    ">
      <h2 style="color:#661155; margin-bottom:20px;">üìÑ Recebimento de Notas Fiscais e Boletos</h2>
      <p style="margin-bottom:20px; color:#ccc;">Acompanhe abaixo os documentos enviados pelos fornecedores.</p>

      <!-- FORMUL√ÅRIO MANUAL -->
      <!-- FORMUL√ÅRIO MANUAL -->
      <div id="formManualFinanceiro" style="text-align: center; margin-top: 20px; display:none;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 10px; color: #ccc;">N√∫mero da Cota√ß√£o (ex: COT-2026...)</label>
          <input type="text" id="inputNumeroCotacaoManual" placeholder="Digite o n√∫mero da cota√ß√£o..."
            style="width: 100%; max-width: 400px; padding: 12px; border-radius: 5px; border: 1px solid #661155; background: #1a1a1a; color: white; text-align: center; font-size: 16px;">
        </div>

        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap:wrap;">
          <button onclick="uploadManual('Nota Fiscal')"
            style="padding: 15px 30px; background: #661155; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
            üìÑ Sel. Nota
          </button>
          <button onclick="uploadManual('Boleto')"
            style="padding: 15px 30px; background: #661155; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px;">
            üí≤ Sel. Boleto
          </button>
        </div>

        <!-- √Årea de Feedback e Envio -->
        <div id="feedbackUploadManual" style="margin-top: 20px; display: none;">
          <p id="msgArquivoSelecionado"
            style="color: #0dcaf0; margin-bottom: 10px; font-size:14px; background:#333; padding:10px; border-radius:5px; border:1px dashed #661155; display:inline-block;">
          </p>
          <div style="margin-top:10px;">
            <button onclick="enviarArquivoManual()"
              style="padding: 10px 25px; background: #00ff99; color: #111; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">
              üöÄ Enviar Arquivo
            </button>
            <button onclick="cancelarUploadManual()"
              style="margin-left:10px; padding: 10px 20px; background: transparent; border: 1px solid #aaa; color: #aaa; border-radius: 8px; cursor: pointer;">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- LISTA DO COMPRADOR (HIST√ìRICO) -->
      <div id="listaFinanceiroComprador" style="display:none; margin-top:20px;">
        <!-- JS Preenche com cards de cota√ß√µes que t√™m documentos -->
      </div>

      <!-- Container oculto para compatibilidade (se necess√°rio) -->
      <div id="listaFinanceiro" style="display:none;"></div>
    </div>
  </section>

  <!-- MODAL DE CRIA√á√ÉO DE COTA√á√ÉO -->
  <div id="modalCotacao" class="modal">
    <div class="modal-content" style="max-width:650px;width:90%;">
      <button class="close-btn" onclick="fecharModal()">&times;</button>
      <h2> üìä Nova Cota√ß√£o</h2>
      <p>Escolha como deseja criar sua cota√ß√£o:</p>

      <div style="display:flex;flex-direction:column;gap:18px;margin-top:25px;">
        <button onclick="abrirCotacaoExcel()" style="padding:14px;font-size:15px;">üìä Importar via Excel</button>
        <button onclick="abrirCotacaoManual()" style="padding:14px;font-size:15px;">üßæ Criar Manualmente</button>
        <button onclick="abrirCotacaoMateriais()" style="padding:14px;font-size:15px;">üì¶ A partir de Materiais</button>
        <button onclick="abrirCotacaoServicos()" style="padding:14px;font-size:15px;">üõ†Ô∏è A partir de Servi√ßos</button>
      </div>
    </div>
  </div>

  <input type="file" id="arquivoExcel" accept=".xlsx" style="display:none;" onchange="arquivoSelecionado(event)">

  <!-- COTA√á√ÉO VIA EXCEL -->
  <section id="cotacaoExcel" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Nova Cota√ß√£o (Excel)</h1>
    </header>

    <div
      style="background:#111;border:1px solid #661155;border-radius:10px;padding:20px;margin:30px auto;width:90%;max-width:900px;color:white;box-shadow:0 0 10px rgba(102,17,85,0.6);text-align:left;">
      <h2 style="color:#661155;">üìä Nova Cota√ß√£o</h2>

      <p><strong>N√∫mero:</strong> <span id="numeroCotacaoExcel"></span></p>

      <!-- DESCRI√á√ÉO -->
      <label>Descri√ß√£o da Cota√ß√£o</label>
      <input type="text" id="descricaoCotacaoExcel" style="width:100%;margin-bottom:8px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:6px;">

      <p><strong>Data de Cria√ß√£o:</strong> <span id="dataCriacaoExcel"></span></p>

      <label>Data e hora de Fechamento:</label>
      <input type="datetime-local" id="dataFechamentoExcel" style="width:250px;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;">

      <button onclick="abrirSelecaoFornecedores(this)" data-origem="excel"
        style="background:#661155;border:none;color:white;padding:8px 12px;border-radius:5px;margin-bottom:10px;">
        ‚ûï Inserir Fornecedores
      </button>

      <textarea id="fornecedoresCotacaoExcel" readonly style="width:100%;height:60px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;margin-bottom:10px;"></textarea>

      <h3 style="margin-top:20px;">Produtos Importados</h3>

      <table style="width:100%; border-collapse: separate; border-spacing: 0 10px; margin-top:10px;">
        <thead>
          <tr style="background:#661155;">
            <th>#</th>
            <th style="padding-left: 10px;">Nome do Produto</th>
            <th style="padding-left: 15px;">Marca</th>
            <th style="padding-left: 15px;">Quantidade</th>
          </tr>
        </thead>
        <tbody id="tabelaCotacaoExcelCorpo"></tbody>
      </table>

      <button onclick="publicarCotacao('excel')" style="margin-top:20px;background:#661155;color:white;
           padding:10px;border:none;border-radius:5px;width:100%;">
        üöÄ Publicar Cota√ß√£o
      </button>
    </div>
  </section>

  <!-- COTA√á√ÉO MANUAL -->
  <section id="cotacaoManual" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Nova Cota√ß√£o (Manual)</h1>
    </header>

    <div
      style="background:#111;border:1px solid #661155;border-radius:10px;padding:20px;margin:30px auto;width:90%;max-width:900px;color:white;box-shadow:0 0 10px rgba(102,17,85,0.6);text-align:left;">
      <h2 style="color:#661155;">üßæ Nova Cota√ß√£o</h2>

      <p><strong>N√∫mero:</strong> <span id="numCotacaoManual"></span></p>

      <!-- DESCRI√á√ÉO -->
      <label>Descri√ß√£o da Cota√ß√£o</label>
      <input type="text" id="descricaoCotacaoManual" style="width:100%;margin-bottom:8px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:6px;">

      <p><strong>Data de Cria√ß√£o:</strong> <span id="dataCriacaoManual"></span></p>

      <label>Data e hora de Fechamento:</label>
      <input type="datetime-local" id="dataFechamentoManual" style="width:250px;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;">

      <button onclick="abrirSelecaoFornecedores(this)" data-origem="manual"
        style="background:#661155;border:none;color:white;padding:8px 12px;border-radius:5px;margin-bottom:10px;">
        ‚ûï Inserir Fornecedores
      </button>

      <textarea id="fornecedoresCotacaoManual" readonly style="width:100%;height:60px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;margin-bottom:10px;"></textarea>

      <h3 style="margin-top:20px;">Produtos</h3>

      <table id="tabelaManual" style="width:100%; border-collapse: separate; border-spacing: 0 10px; margin-top:10px;">
        <thead>
          <tr style="background:#661155;">
            <th>#</th>
            <th style="padding-left: 10px;">Nome do Produto</th>
            <th style="padding-left: 15px;">Marca</th>
            <th style="padding-left: 15px;">Quantidade</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tabelaManualCorpo">
          <tr>
            <td>1</td>
            <td style="padding-left: 10px;"><input type="text"
                style="width:100%;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;">
            </td>
            <td style="padding-left: 15px;"><input type="text"
                style="width:100%;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;">
            </td>
            <td style="padding-left: 15px;"><input type="number"
                style="width:80px;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;">
            </td>
            <td><button onclick="removerLinhaManual(this)"
                style="background:#661155;color:white;border:none;border-radius:4px;padding:5px 10px;">üóëÔ∏è</button></td>
          </tr>
        </tbody>
      </table>

      <button onclick="adicionarLinhaManual()"
        style="margin-top:10px;background:#661155;border:none;color:white;padding:8px 12px;border-radius:5px;">
        ‚ûï Adicionar Linha
      </button>

      <button onclick="publicarCotacao('manual')" style="display:block;margin-top:20px;background:#661155;color:white;
           padding:10px;border:none;border-radius:5px;width:100%;">
        üöÄ Publicar Cota√ß√£o
      </button>
    </div>
  </section>

  <!-- COTA√á√ÉO A PARTIR DE MATERIAIS -->
  <section id="cotacaoMateriais" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Nova Cota√ß√£o (Materiais)</h1>
    </header>

    <div
      style="background:#111;border:1px solid #661155;border-radius:10px;padding:20px;margin:30px auto;width:90%;max-width:900px;color:white;box-shadow:0 0 10px rgba(102,17,85,0.6);text-align:left;">
      <h2 style="color:#661155;">üìÑ Nova Cota√ß√£o</h2>

      <p><strong>N√∫mero:</strong> <span id="numeroCotacaoMateriais"></span></p>

      <!-- DESCRI√á√ÉO -->
      <label>Descri√ß√£o da Cota√ß√£o</label>
      <input type="text" id="descricaoCotacaoMateriais" style="width:100%;margin-bottom:8px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:6px;">

      <p><strong>Data de Cria√ß√£o:</strong> <span id="dataCriacaoMateriais"></span></p>

      <label>Data e hora de Fechamento:</label>
      <input type="datetime-local" id="dataFechamentoMateriais" style="width:250px;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;">

      <button onclick="abrirSelecaoFornecedores(this)" data-origem="materiais"
        style="background:#661155;border:none;color:white;padding:8px 12px;border-radius:5px;margin-bottom:10px;">
        ‚ûï Inserir Fornecedores
      </button>

      <textarea id="fornecedoresCotacaoMateriais" readonly style="width:100%;height:60px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;margin-bottom:15px;"></textarea>

      <h3 style="margin-top:20px;">üì¶ Materiais</h3>

      <input type="text" id="buscaMaterialCotacao" placeholder="üîé Buscar material..."
        oninput="filtrarMateriaisCotacao()" style="width:100%;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:8px;">

      <div id="listaMateriaisCotacao"></div>

      <button onclick="publicarCotacao('materiais')" style="margin-top:20px;background:#661155;color:white;
           padding:10px;border:none;border-radius:5px;width:100%;">
        üöÄ Publicar Cota√ß√£o
      </button>
    </div>
  </section>

  <!-- COTA√á√ÉO SERVI√áOS -->
  <section id="cotacaoServicos" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Nova Cota√ß√£o (Servi√ßos)</h1>
    </header>

    <div
      style="background:#111;border:1px solid #661155;border-radius:10px;padding:20px;margin:30px auto;width:90%;max-width:900px;color:white;box-shadow:0 0 10px rgba(102,17,85,0.6);text-align:left;">
      <h2 style="color:#661155;">üìÑ Nova Cota√ß√£o</h2>

      <p><strong>N√∫mero:</strong> <span id="numeroCotacaoServicos"></span></p>

      <!-- DESCRI√á√ÉO -->
      <label>Descri√ß√£o da Cota√ß√£o</label>
      <input type="text" id="descricaoCotacaoServicos" style="width:100%;margin-bottom:8px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:6px;">

      <p><strong>Data de Cria√ß√£o:</strong> <span id="dataCriacaoServicos"></span></p>

      <label>Data e hora de Fechamento:</label>
      <input type="datetime-local" id="dataFechamentoServicos" style="width:250px;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;">

      <button onclick="abrirSelecaoFornecedores(this)" data-origem="servicos"
        style="background:#661155;border:none;color:white;padding:8px 12px;border-radius:5px;margin-bottom:10px;">
        ‚ûï Inserir Fornecedores
      </button>

      <textarea id="fornecedoresCotacaoServicos" readonly style="width:100%;height:60px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:5px;margin-bottom:15px;"></textarea>

      <h3 style="margin-top:20px;">üõ†Ô∏è Servi√ßos</h3>

      <input type="text" id="buscaServicoCotacao" placeholder="üîé Buscar servi√ßo..." oninput="filtrarServicosCotacao()"
        style="width:100%;margin-bottom:10px;background:#1a1a1a;color:white;
           border:1px solid #661155;border-radius:5px;padding:8px;">

      <div id="listaServicosCotacao"></div>

      <button onclick="publicarCotacao('servicos')" style="margin-top:20px;background:#661155;color:white;
           padding:10px;border:none;border-radius:5px;width:100%;">
        üöÄ Publicar Cota√ß√£o
      </button>
    </div>
  </section>

  <!-- ======================================================
     ‚úÖ TELA: APROVAR COMPRAS
====================================================== -->
  <section id="aprovarCompras" style="display:none;">

    <header>
      <button class="btn-sair" onclick="voltarMenu()">
        üè† Menu Principal
      </button>

      <h1>Aprovar Compras</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:10px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:1000px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <div style="text-align:center;margin-bottom:20px;">
        <button onclick="carregarPendentesAprovacao()" style="
          background:#661155;
          color:white;
          border:none;
          padding:12px 30px;
          border-radius:6px;
          cursor:pointer;
          font-size:15px;
        ">
          ‚è≥ Carregar Cota√ß√µes Pendentes
        </button>
      </div>

      <div id="listaPendentesAprovacao">
        <!-- conte√∫do gerado via JS -->
      </div>

    </div>
  </section>


  <!-- MODAL DE SELE√á√ÉO DE FORNECEDORES (COMPARTILHADO) -->
  <div id="modalFornecedores" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:800px;">
      <button class="close-btn" onclick="fecharModalFornecedores()">&times;</button>
      <h2>üìã Selecionar Fornecedores</h2>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="buscaFornecedor" placeholder="üîé Buscar por nome..." oninput="filtrarFornecedores()"
          style="flex:2; background:#1a1a1a; color:white; border:1px solid #661155; border-radius:5px; padding:8px;">
        <select id="filtroTipoFornecedor" onchange="filtrarFornecedores()"
          style="flex:1; background:#1a1a1a; color:white; border:1px solid #661155; border-radius:5px; padding:8px;">
          <option value="">Todos os tipos</option>
          <option>Materiais El√©tricos</option>
          <option>Constru√ß√£o Civil</option>
          <option>Servi√ßos T√©cnicos</option>
          <option>Transporte e Log√≠stica</option>
          <option>Inform√°tica e TI</option>
          <option>Outros</option>
        </select>
      </div>

      <div id="listaFornecedoresModal"
        style="max-height:300px; overflow-y:auto; border:1px solid #661155; border-radius:5px; padding:10px; background:#111;">
        <!-- Lista gerada dinamicamente -->
      </div>

      <div style="text-align:center; margin-top:15px;">
        <button onclick="confirmarFornecedoresCotacao()"
          style="background:#661155; border:none; color:white; padding:10px 20px; border-radius:5px;">‚úÖ Confirmar
          Sele√ß√£o</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE REJEI√á√ÉO (APROVA√á√ÉO) - ADICIONADO PARA CORRIGIR ERRO -->
  <div id="modalRejeicaoAprovacao" class="modal"
    style="display:none; align-items:center; justify-content:center; z-index: 200000;">
    <div class="modal-content"
      style="max-width:500px; background:#111; border:1px solid #dc3545; box-shadow:0 0 20px rgba(220, 53, 69, 0.4); position:relative;">

      <button class="close-btn" onclick="window.fecharRejeicaoV2()"
        style="position:absolute; top:10px; right:15px; background:transparent; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>

      <h2 style="color:#dc3545; margin-top:0;">‚ùå Rejeitar Cota√ß√£o</h2>
      <p style="color:#ccc;">Informe o motivo da rejei√ß√£o para o comprador:</p>

      <textarea id="motivoRejeicaoAprovacao" rows="4"
        style="width:100%; padding:10px; background:#222; color:white; border:1px solid #444; border-radius:5px; resize:vertical;"
        placeholder="Descreva o motivo..."></textarea>

      <div style="margin-top:20px; text-align:right;">
        <button onclick="window.confirmarRejeicaoV2()"
          style="background:#dc3545; border:none; color:white; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">
          Confirmar Rejei√ß√£o
        </button>
      </div>
    </div>
  </div>

  <section id="cadastroFornecedor" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Cadastro de Fornecedor</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:10px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:900px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <h2 style="color:#661155;">üßæ Gest√£o de Fornecedores</h2>

      <!-- ABAS -->
      <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #661155; padding-bottom:10px;">
        <button onclick="alternarAbaFornecedor('manual')" id="btnAbaManual"
          style="background:#661155; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
          ‚ûï Cadastro Manual
        </button>
        <button onclick="alternarAbaFornecedor('aprovacao')" id="btnAbaAprovacao"
          style="background:#333; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
          ‚è≥ Aprova√ß√£o Online <span id="badgeFornPendentes"
            style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:11px; display:none;">0</span>
        </button>
      </div>

      <!-- CONTE√öDO: CADASTRO MANUAL -->
      <div id="conteudoFornManual">
        <h3 style="color:#ccc; margin-bottom:15px;">Novo Fornecedor Interno</h3>

        <!-- FORMUL√ÅRIO -->
        <div style="
      display:grid;
      grid-template-columns:1fr 1fr;
      column-gap:15px;
      row-gap:22px;
      margin-top:15px;
    ">

          <!-- Nome / CNPJ -->
          <div style="margin-right:8px;">
            <label>Nome da Empresa</label>
            <input id="fornNome" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <div style="margin-left:8px;">
            <label>CNPJ</label>
            <input id="fornCnpj" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- Logradouro -->
          <div style="grid-column:1 / span 2;">
            <label>Logradouro</label>
            <input id="fornLogradouro" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- N√∫mero / Bairro -->
          <div style="margin-right:8px;">
            <label>N√∫mero</label>
            <input id="fornNumero" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <div style="margin-left:8px;">
            <label>Bairro</label>
            <input id="fornBairro" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- Cidade / CEP -->
          <div style="margin-right:8px;">
            <label>Cidade</label>
            <input id="fornCidade" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <div style="margin-left:8px;">
            <label>CEP</label>
            <input id="fornCep" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- Telefone / WhatsApp -->
          <div style="margin-right:8px;">
            <label>Telefone</label>
            <input id="fornTelefone" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <div style="margin-left:8px;">
            <label>WhatsApp</label>
            <input id="fornWhats" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- Emails -->
          <div style="grid-column:1 / span 2;">
            <label>E-mails</label>
            <input id="fornEmails" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <!-- Respons√°vel / Tipo -->
          <div style="margin-right:8px;">
            <label>Respons√°vel pela Cota√ß√£o</label>
            <input id="fornResponsavel" type="text"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
          </div>

          <div style="margin-left:8px;">
            <label>Tipo de Produto / Servi√ßo</label>
            <select id="fornTipo"
              style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
              <option value="">Selecione...</option>
              <option>Materiais El√©tricos</option>
              <option>Constru√ß√£o Civil</option>
              <option>Servi√ßos T√©cnicos</option>
              <option>Transporte e Log√≠stica</option>
              <option>Inform√°tica e TI</option>
              <option>Outros</option>
            </select>
          </div>

        </div>

        <!-- BOT√ïES (EMPILHADOS) -->
        <div style="margin-top:20px;">

          <button onclick="salvarFornecedor()" style="
          width:100%;
          background:#661155;
          color:white;
          border:none;
          padding:12px;
          border-radius:6px;
          cursor:pointer;
          margin-bottom:12px;
        ">
            üíæ Salvar Fornecedor
          </button>

          <button onclick="mostrarListaFornecedores()" style="
          width:100%;
          background:#333;
          color:white;
          border:1px solid #661155;
          padding:12px;
          border-radius:6px;
          cursor:pointer;
        ">
            üìã Lista de Fornecedores
          </button>

        </div>

        <!-- LISTA -->
        <div id="listaFornecedoresCadastrados" style="display:none;margin-top:15px;">

          <h3 style="color:#661155;text-align:center;margin-bottom:10px;">
            üìã Fornecedores Cadastrados
          </h3>

          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#661155;">
                  <th>Empresa</th>
                  <th>Endere√ßo</th>
                  <th>WhatsApp</th>
                  <th>Respons√°vel</th>
                  <th style="text-align:center;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaFornecedores"></tbody>
            </table>
          </div>

        </div>

      </div>

      <!-- CONTE√öDO: APROVA√á√ÉO ONLINE -->
      <div id="conteudoFornAprovacao" style="display:none;">
        <h3 style="color:#ccc; margin-bottom:15px;">Solicita√ß√µes de Cadastro (Trabalhe Conosco)</h3>

        <div id="listaFornPendentes">
          <!-- JS Popula -->
        </div>
      </div>

    </div>
  </section>

  <!-- üëÅÔ∏è MODAL ‚Äì VISUALIZAR FORNECEDOR -->
  <div id="modalVerFornecedor" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:900px;">

      <button class="close-btn" onclick="fecharModalVerFornecedor()">&times;</button>

      <h2 style="color:#661155;">üëÅÔ∏è Ficha do Fornecedor</h2>

      <div id="conteudoVerFornecedor"></div>

    </div>
  </div>


  <!-- CADASTRO DE MATERIAL -->

  <section id="cadastroMaterial" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Cadastro de Material</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:10px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:900px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
    text-align:left;
  ">
      <h2 style="color:#661155;">üì¶ Novo Material</h2>

      <!-- üîß GRID AJUSTADO -->
      <div class="form-grid">

        <div>
          <label>Nome do Produto</label>
          <input type="text" id="matNome" placeholder="Ex: Parafuso de A√ßo" style="width:100%; background:#1a1a1a; border:1px solid #661155;
                 border-radius:5px; color:white; padding:8px;">
        </div>

        <div>
          <label>C√≥digo do Produto</label>
          <input type="text" id="matCodigo" placeholder="Ex: PRF-001" style="width:100%; background:#1a1a1a; border:1px solid #661155;
                 border-radius:5px; color:white; padding:8px;">
        </div>

        <div>
          <label>Embalagem</label>
          <input type="text" id="matEmbalagem" placeholder="Ex: Caixa" style="width:100%; background:#1a1a1a; border:1px solid #661155;
                 border-radius:5px; color:white; padding:8px;">
        </div>

        <div>
          <label>Qtd / Embalagem</label>
          <input type="number" id="matQtdEmb" placeholder="Ex: 100" style="width:100%; background:#1a1a1a; border:1px solid #661155;
                 border-radius:5px; color:white; padding:8px;">
        </div>

        <div style="grid-column:1 / span 2;">
          <label>Foto (opcional)</label>
          <input type="file" id="matFoto" accept="image/*" style="width:100%; background:#1a1a1a; border:1px solid #661155;
                 border-radius:5px; color:white; padding:8px;">
        </div>
      </div>

      <div style="text-align:center; margin-top:25px;">
        <button onclick="salvarMaterial()" style="background:#661155; color:white; border:none;
               padding:10px 20px; border-radius:5px; cursor:pointer;">
          üíæ Salvar Material
        </button>
      </div>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="abrirListaMateriais()" style="background:#333; color:white; border:1px solid #661155;
               padding:10px 20px; border-radius:5px; cursor:pointer;">
          üìã Lista de Materiais
        </button>
      </div>

      <!-- LISTA DE MATERIAIS -->
      <div id="listaMateriais" style="display:none; margin-top:25px;">
        <h3 style="color:#661155;">üìÉ Materiais Cadastrados</h3>
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr style="background:#661155;">
              <th>Nome</th>
              <th>C√≥digo</th>
              <th>Embalagem</th>
              <th>Qtd/Emb</th>
              <th style="text-align:center;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="materiaisTabela" style="background:#1a1a1a;"></tbody>
        </table>
      </div>
    </div>
  </section>


  <!-- CADASTRO DE SERVI√áO -->
  <section id="cadastroServico" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Cadastro de Servi√ßo</h1>
    </header>

    <!-- CARD PRINCIPAL -->
    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:10px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:900px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
    text-align:left;
  ">

      <h2 style="color:#661155;">üõ†Ô∏è Novo Servi√ßo</h2>

      <!-- FORMUL√ÅRIO -->
      <div style="
      display:grid;
      grid-template-columns:1fr 1fr;
      column-gap:15px;
      row-gap:22px;
      margin-top:15px;
    ">

        <div style="margin-right:8px;">
          <label>Nome do Servi√ßo</label>
          <input id="servNome" type="text"
            style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
        </div>

        <div style="margin-left:8px;">
          <label>C√≥digo do Servi√ßo</label>
          <input id="servCodigo" type="text"
            style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
        </div>

        <div style="grid-column:1 / span 2;">
          <label>Categoria do Servi√ßo</label>
          <select id="servCategoria"
            style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
            <option value="">Selecione uma categoria...</option>
            <option>Consultoria de TI</option>
            <option>El√©trica</option>
            <option>Hidr√°ulica</option>
            <option>Jardinagem</option>
            <option>Limpeza Externa</option>
            <option>Manuten√ß√£o de Ar Condicionado</option>
            <option>Pintura</option>
            <option>Servi√ßo de Pedreiro</option>
            <option>Troca de Fechaduras</option>
            <option>Transporte</option>
            <option>Vigil√¢ncia e Seguran√ßa</option>
          </select>
        </div>

        <div style="grid-column:1 / span 2;">
          <label>Descri√ß√£o Detalhada</label>
          <textarea id="servDescricao"
            style="width:100%;height:100px;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;"></textarea>
        </div>

        <div style="grid-column:1 / span 2;">
          <label>Pre√ßo de Refer√™ncia (opcional)</label>
          <input id="servPreco" type="number"
            style="width:100%;background:#1a1a1a;border:1px solid #661155;border-radius:5px;color:white;padding:8px;">
        </div>

      </div>

      <!-- BOT√ïES -->
      <div style="margin-top:25px;">
        <button onclick="salvarServico()"
          style="width:100%;background:#661155;color:white;border:none;padding:12px;border-radius:6px;margin-bottom:12px;">
          üíæ Salvar Servi√ßo
        </button>

        <button onclick="abrirListaServicos()"
          style="width:100%;background:#333;color:white;border:1px solid #661155;padding:12px;border-radius:6px;">
          üìã Lista de Servi√ßos
        </button>
      </div>

      <!-- ‚úÖ LISTA DENTRO DO CARD (SEM ESPA√áO FANTASMA) -->
      <div id="listaServicos" style="
      display:none;
      margin-top:8px;
      background:#111;
      border:1px solid #661155;
      border-radius:10px;
      padding:20px;
      box-shadow:0 0 15px rgba(102,17,85,0.4);
    ">

        <h3 style="color:#661155;text-align:center;margin-bottom:15px;">
          üìã Servi√ßos Cadastrados
        </h3>

        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#661155;">
                <th>Servi√ßo</th>
                <th>C√≥digo</th>
                <th>Categoria</th>
                <th>Pre√ßo</th>
                <th style="text-align:center;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="servicosTabela"></tbody>
          </table>
        </div>

      </div>

    </div>
  </section>



  <!-- üì¨ RESPONDER COTA√á√ÉO -->
  <section id="responderCotacao" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Responder Cota√ß√£o</h1>
    </header>

    <div style="background:#111; border:1px solid #661155; border-radius:10px;
              padding:25px; margin:30px auto; width:90%; max-width:1000px;
              color:white; box-shadow:0 0 15px rgba(102,17,85,0.6);">

      <h2 style="color:#661155;">üìã Cota√ß√µes Recebidas</h2>

      <!-- Navega√ß√£o entre abas -->
      <div style="display:flex; gap:10px; margin-top:15px; justify-content:center;">
        <button onclick="mostrarAbaCotacao('abertas')" id="btnAbertas" style="background:#661155; color:white; border:none; padding:10px 20px;
                     border-radius:5px; cursor:pointer;">üì¨ Abertas</button>
        <button onclick="mostrarAbaCotacao('respondidas')" id="btnRespondidas" style="background:#333; color:white; border:none; padding:10px 20px;
                     border-radius:5px; cursor:pointer;">üì§ Respondidas</button>
        <button onclick="mostrarAbaCotacao('encerradas')" id="btnEncerradas" style="background:#333; color:white; border:none; padding:10px 20px;
                     border-radius:5px; cursor:pointer;">‚è≥ Encerradas</button>
      </div>

      <!-- Listas -->
      <div id="listaAbertas" style="margin-top:25px;"></div>
      <div id="listaRespondidas" style="margin-top:25px; display:none;"></div>
      <div id="listaEncerradas" style="margin-top:25px; display:none;"></div>
    </div>
  </section>

  <!-- ‚öôÔ∏è CONFIGURA√á√ïES -->
  <section id="configuracoes" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Configura√ß√µes</h1>
    </header>

    <div style="background:#111; border:1px solid var(--primaria); border-radius:12px;
                padding:25px; margin:30px auto; width:90%; max-width:600px;
                color:white; box-shadow:0 0 15px rgba(102,17,85,0.6);">

      <div
        style="background:#1a1a1a; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid var(--secundaria);">
        <h3 style="color:var(--secundaria); margin-top:0;"><i class="fa-solid fa-image"></i> Logotipo do PDF</h3>
        <p style="font-size:14px; opacity:0.8;">Este logotipo aparecer√° no cabe√ßalho dos Pedidos de Compra (PDF) gerados
          pelo sistema.</p>

        <div id="previewLogo" style="
          width: 100%;
          height: 150px;
          background: #000;
          border: 2px dashed var(--primaria);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          overflow: hidden;
        ">
          <span style="color:#666;">Aguardando sele√ß√£o...</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input type="file" id="inputLogo" accept="image/*" style="display:none;" onchange="previewLogo(this)">
          <button onclick="document.getElementById('inputLogo').click()" style="flex:1; background:var(--primaria);">
            <i class="fa-solid fa-upload"></i> Selecionar Imagem
          </button>
          <button onclick="salvarConfiguracoes()" style="flex:1; background:#198754;">
            <i class="fa-solid fa-save"></i> Salvar Altera√ß√µes
          </button>
          <button onclick="removerLogo()" style="background:#842029; width:auto; padding:10px 15px;">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>

      <div
        style="background:#1a1a1a; padding:15px; border-radius:8px; border:1px solid #333; font-size:13px; color:#aaa;">
        <i class="fa-solid fa-circle-info"></i>
        <strong>Dica:</strong> A logo enviada pela conversa pode ser selecionada aqui para se tornar o padr√£o do
        sistema.
      </div>
    </div>
  </section>


  <!-- üí¨ MODAL DE RESPOSTA DE COTA√á√ÉO -->
  <div id="modalResponder" class="modal" style="display:none;">
    <div class="modal-content modal-responder-box" style="width: 90%; max-width: 90vw;">

      <!-- ‚ùå fechar -->
      <button class="close-btn" onclick="fecharModalResponder()">√ó</button>

      <!-- üßæ cabe√ßalho -->
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
          <h2>üßæ Responder Cota√ß√£o</h2>
          <p><strong>N√∫mero da Cota√ß√£o:</strong> <span id="respNumero"></span></p>
          <p><strong>Data de Cria√ß√£o:</strong> <span id="respDataCriacao"></span></p>
          <p><strong>Data e hora de Fechamento:</strong> <span id="respDataFechamento"></span></p>
          <p><strong>Descri√ß√£o:</strong> <span id="respDescricao"></span></p>
        </div>

        <!-- ‚è≥ TIMER REL√ìGIO -->
        <div id="timerCotacao" style="
            background: #222;
            border: 1px solid #661155;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 200px;
            box-shadow: 0 0 10px rgba(102, 17, 85, 0.3);
        ">
          <div style="font-size:12px; color:#aaa; margin-bottom:4px;">TEMPO RESTANTE</div>
          <div id="timerDisplay" style="font-size:24px; font-weight:bold; color:#00ff99;">--d --h --m --s</div>
        </div>
      </div>

      <!-- üîΩ LISTA DE PRODUTOS -->
      <div id="listaProdutosResponder" style="max-height:60vh; overflow:auto;">
        <table class="tabela-responder" style="width:100%; border-collapse: separate; border-spacing: 0 10px;">
          <colgroup>
            <col style="width:35%"> <!-- Produto -->
            <col style="width:20%"> <!-- Marca -->
            <col style="width:15%"> <!-- Pre√ßo -->
            <col style="width:30%"> <!-- Quantidade -->
          </colgroup>

          <thead>
            <tr>
              <th style="text-align: left; padding-left: 15px;">Produto</th>
              <th style="text-align: center;">Marca</th>
              <th style="text-align: center;">Quantidade</th>
              <th style="text-align: center;">Pre√ßo Unit√°rio (R$)</th>
            </tr>
          </thead>

          <tbody id="tabelaResponderCorpo" style="background:#1a1a1a;"></tbody>
        </table>
      </div>

      <!-- üìé Anexo -->
      <div style="margin-top:15px;">
        <label>Anexar Or√ßamento (PDF ou imagem):</label>
        <input type="file" id="respAnexo" accept=".pdf,image/*" style="
          width:100%;
          background:#1a1a1a;
          border:1px solid #661155;
          border-radius:5px;
          color:white;
          padding:8px;
        ">
      </div>

      <!-- üîò A√á√ïES -->
      <div style="text-align:center; margin-top:18px;">

        <!-- ‚úèÔ∏è EDITAR (modo visualiza√ß√£o) -->
        <button id="btnEditarResposta" onclick="habilitarEdicaoResposta()" style="
          background:#333;
          border:1px solid #661155;
          color:white;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          display:none;
        ">
          ‚úèÔ∏è Editar Resposta
        </button>

        <!-- üì§ SALVAR / ENVIAR -->
        <button id="btnEnviarResposta" onclick="salvarRespostaComAnexo()" style="
          background:#661155;
          border:none;
          color:white;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          display:none;
          margin-left:10px;
        ">
          üì§ Enviar Resposta
        </button>

      </div>

    </div>
  </div>


  </section>
  <section id="cotacoesRespondidas" style="display:none;">

    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Cota√ß√µes Respondidas</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:10px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:1000px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <div style="max-width: fit-content; margin: 0 auto;">
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:nowrap; justify-content:center;">
          <button class="btn-status" id="btnPublicadas" onclick="toggleListaRespondidas('publicadas')">
            üì¢ Publicadas
          </button>

          <button class="btn-status" id="btnAnalise" onclick="toggleListaRespondidas('analise')">
            üìä An√°lise de Respostas
          </button>

          <button class="btn-status" id="btnAprovacao" onclick="toggleListaRespondidas('aprovacao')">
            ‚è≥ Aguardando Aprova√ß√£o
          </button>

          <button class="btn-status" id="btnFechadas" onclick="toggleListaRespondidas('fechada')">
            üîí Fechadas
          </button>
        </div>

        <!-- üîç FILTRO DE BUSCA (Ajuste fino de largura) -->
        <div style="margin-bottom: 25px; width: 100%;">
          <input type="text" id="buscaCotacaoRespondida" placeholder="üîç Buscar por nome ou n√∫mero da cota√ß√£o..."
            onkeyup="filtrarCotacoesInstantaneo()"
            style="width:100%; box-sizing: border-box; padding:12px; border-radius:8px; border:1px solid #661155; background:#1a1a1a; color:white; font-size:14px; outline:none; transition: all 0.3s;"
            onfocus="this.style.boxShadow='0 0 10px rgba(102,17,85,0.8)'" onblur="this.style.boxShadow='none'">
        </div>
      </div>

      <div id="listaPublicadas" style="display:none;"></div>
      <div id="listaAnalise" style="display:none;"></div>
      <div id="listaAprovacao" style="display:none;"></div>
      <div id="listaFechadas" style="display:none;"></div>

    </div>
  </section>

  <!-- ======================================================
     üìä MODAL DE AN√ÅLISE DE COTA√á√ÉO (COMPRADOR)
====================================================== -->
  <div id="modalAnaliseCotacao" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:98vw;
              width: 98vw;
              display:flex;
              flex-direction:column;
              padding: 20px;">

      <button class="close-btn" onclick="fecharModalAnalise()"
        style="position:absolute; top:15px; right:15px; background:#661155; border:none; color:white; border-radius:50%; width:32px; height:32px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.5);">
        <i class="fa-solid fa-times" style="font-size:16px;"></i>
      </button>

      <div style="display:flex; align-items:center; gap:10px; padding-bottom:15px; border-bottom:1px solid #333;">
        <span style="font-size:32px;">üìä</span>
        <h2 style="margin:0; font-size:20px; color:#661155;">An√°lise de Cota√ß√£o</h2>
      </div>

      <!-- üìå CABE√áALHO DA COTA√á√ÉO -->
      <div class="cabecalho-cotacao"
        style="background:#111; padding:15px; border-radius:8px; margin-top:20px; border:1px solid #333;">

        <div class="linha-principal" style="margin-bottom:8px;">
          <span class="numero-cotacao" id="analiseNumero"
            style="display:block; font-size:18px; font-weight:bold; color:#a6acb8; margin-bottom:5px;"></span>
          <div class="descricao-cotacao" id="analiseDescricao" style="font-size:14px; color:#ccc;"></div>
        </div>

        <div class="linha-datas" style="display:flex; gap:30px; font-size:12px; color:#888; margin-top:10px;">
          <div>
            <strong style="color:#fff;">Abertura:</strong>
            <span id="analiseDataCriacao"></span>
          </div>
          <div>
            <strong style="color:#fff;">Fechamento:</strong>
            <span id="analiseDataFechamento"></span>
          </div>
        </div>

      </div>


      <div id="analiseConteudo" style="margin-top:10px;">
      </div>

      <!-- üîÅ STATUS -->
      <div id="statusAprovacao" style="text-align:center;
                font-size:16px;
                font-weight:bold;
                margin:15px 0;">
      </div>

      <!-- üîë A√á√ïES DE COTA√á√ÉO FECHADA -->
      <div id="acoesFechada"
        style="display:none; flex-direction: column; align-items: center; margin-bottom:15px; gap:10px;">
        <button onclick="gerarPedidoCompraPDF()" style="background:#198754;
               color:white;
               border:none;
               padding:10px 25px;
               border-radius:6px;
               cursor:pointer;">
          üßæ Gerar Pedido de Compra (PDF)
        </button>
        <button onclick="abrirMapaPrecos(document.getElementById('analiseNumero').textContent.trim())" style="background:#661155;
               color:white;
               border:none;
               padding:10px 25px;
               border-radius:6px;
               cursor:pointer;">
          üó∫Ô∏è Gerar Mapa de Pre√ßos
        </button>
      </div>

      <!-- ‚úÖ A√á√ÉO DO COMPRADOR -->
      <div id="contEnviarAprovacao" style="text-align:center;margin-bottom:10px;">
        <button id="btnVerTodosAnexos"
          onclick="visualizarDocumentos(document.getElementById('analiseNumero').textContent.trim())" style="
            background:#3ab9b6;
            color:white;
            padding:10px 25px;
            border:none;
            border-radius:6px;
            display:none;
            cursor:pointer;
            margin-right: 15px; 
            margin-bottom: 5px;
          ">
          üìÇ Ver Todos os Anexos
        </button>
        <br>
        <button id="btnEnviarAprovacao" onclick="enviarParaAprovacao()" style="background:#661155;
               color:white;
               padding:10px 25px;
               border:none;
               border-radius:6px;
               display:none;
               cursor:pointer;">
          ‚úÖ Enviar para Aprova√ß√£o
        </button>
      </div>

      <!-- üëÅÔ∏è MOTIVO DA REJEI√á√ÉO (SOMENTE VISUALIZA√á√ÉO EM REAN√ÅLISE) -->

      <div id="contMotivoRejeicao" style="margin:15px 0; text-align:center;">

        <button id="btnMotivoRejeicao" onclick="toggleMotivoRejeicao()" style="
      background:#661155;
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    ">
          üìÑ Ver motivo da rejei√ß√£o
        </button>

        <div id="boxMotivoRejeicao" style="display:none; margin-top:10px;">

          <label><strong>Motivo da Rejei√ß√£o</strong></label>

          <textarea id="motivoRejeicao" readonly style="
        width:100%;
        min-height:90px;
        background:#1a1a1a;
        border:1px solid #661155;
        border-radius:6px;
        color:white;
        padding:10px;
        margin-top:6px;
      ">
    </textarea>

        </div>
      </div>

    </div>
  </div>

  <!-- ‚ùå MODAL ‚Äì REJEI√á√ÉO NA APROVA√á√ÉO -->
  <div id="modalRejeicaoAprovacao" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:500px; position:relative;">

      <!-- ‚ùå FECHAR (PADR√ÉO CORRETO) -->
      <button class="close-btn" onclick="document.getElementById('modalRejeicaoAprovacao').style.display='none'" style="
        position:absolute;
        top:12px;
        right:12px;
        background:none;
        border:none;
        font-size:22px;
        color:#ff4d6d;
        cursor:pointer;
      ">
        &times;
      </button>

      <h2>‚ùå Rejeitar Cota√ß√£o</h2>

      <label><strong>Motivo da Rejei√ß√£o</strong></label>
      <textarea id="motivoRejeicaoAprovacao" placeholder="Descreva o motivo da rejei√ß√£o..." style="
        width:100%;
        min-height:100px;
        background:#1a1a1a;
        border:1px solid #661155;
        border-radius:6px;
        color:white;
        padding:10px;
        margin-top:8px;
      ">
    </textarea>

      <div style="text-align:right;margin-top:15px;">
        <button onclick="confirmarRejeicaoAprovacao()" style="
          background:#842029;
          color:white;
          padding:10px 22px;
          border:none;
          border-radius:6px;
        ">
          ‚ùå Confirmar Rejei√ß√£o
        </button>
      </div>

    </div>
  </div>



  <!-- üë• GERENCIAR USU√ÅRIOS -->
  <section id="usuarios" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Gerenciar Usu√°rios</h1>
    </header>

    <div
      style="background:#111; border:1px solid #661155; border-radius:10px; padding:25px; margin:30px auto; width:90%; max-width:900px; color:white; box-shadow:0 0 15px rgba(102,17,85,0.6);">
      <h2 style="color:#661155;">‚ûï Novo Usu√°rio</h2>
      <div style="display:grid; grid-template-columns:1fr 1fr; column-gap:30px; row-gap:18px;">
        <div class="input-group">
          <label>Nome</label>
          <input type="text" id="userNome" placeholder="Nome do usu√°rio">
        </div>
        <div class="input-group">
          <label>E-mail</label>
          <input type="email" id="userEmail" placeholder="email@empresa.com">
        </div>
        <div class="input-group">
          <label>Senha</label>
          <input type="password" id="userSenha" placeholder="Senha de acesso">
        </div>
        <div class="input-group">
          <label>Perfil</label>
          <select id="userTipo">
            <option value="">Selecione o perfil</option>
            <option value="administrador">Administrador</option>
            <option value="comprador">Comprador</option>
            <option value="aprovador">Aprovador</option>
            <option value="fornecedor">Fornecedor</option>
            <option value="requisitante">Requisitante</option>
          </select>
        </div>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button onclick="criarUsuario()">üíæ Criar Usu√°rio</button>
      </div>

      <hr style="margin:30px 0; border-color:#661155;">

      <h2 style="color:#661155;">üè¢ Usu√°rios da Empresa</h2>
      <div style="text-align:center; margin-bottom:10px;">
        <button onclick="toggleUsuariosEmpresa()">üè¢ Lista de Usu√°rios da Empresa</button>
      </div>
      <div id="listaUsuariosEmpresa" style="display:none; margin-top:15px;"></div>

      <h2 style="color:#661155; margin-top:30px;">üöö Usu√°rios Fornecedores</h2>
      <div style="text-align:center; margin-bottom:10px;">
        <button onclick="toggleUsuariosFornecedores()">üöö Lista de Usu√°rios Fornecedores</button>
      </div>
      <div id="listaUsuariosFornecedores" style="display:none; margin-top:15px;"></div>

      <hr style="margin:40px 0; border-color:#333;">



    </div>
  </section>


  <!-- üëÅÔ∏è MODAL ‚Äì DETALHES DA RESPOSTA DO FORNECEDOR -->
  <div id="modalDetalhesRespostaFornecedor" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="fecharDetalhesRespostaFornecedor()">&times;</button>
      <h2 id="detalheTitulo">Detalhes da Resposta</h2>
      <p><strong>Fornecedor:</strong> <span id="detalheFornecedor"></span></p>

      <table class="tabela-responder">
        <thead>
          <tr>
            <th>Produto/Servi√ßo</th>
            <th>Qtd</th>
            <th>Pre√ßo Unit.</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="detalhesTabelaItens"></tbody>
      </table>

      <div style="margin-top:20px; text-align:right;">
        <button onclick="fecharDetalhesRespostaFornecedor()" style="width:150px;">Fechar</button>
      </div>
    </div>
  </div>



  <!-- ======================================================
     üìù SOLICITA√á√ÉO DE COMPRA (REQUISITANTE)
====================================================== -->
  <section id="solicitacaoCompra" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Solicita√ß√£o de Compra</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:12px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:800px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <h2 style="color:#661155;">üìù Nova Solicita√ß√£o</h2>

      <!-- SOLICITANTE -->
      <div class="input-group">
        <label>Solicitante</label>
        <input id="solSolicitante" type="text" placeholder="Nome do solicitante">
      </div>

      <!-- SETOR -->
      <div class="input-group">
        <label>Setor / Departamento</label>
        <input id="solSetor" type="text" placeholder="Ex: TI, Manuten√ß√£o, Administrativo">
      </div>

      <!-- TIPO -->
      <div class="input-group">
        <label>Tipo de Solicita√ß√£o</label>
        <select id="solTipo">
          <option value="">Selecione...</option>
          <option value="material">Material</option>
          <option value="servico">Servi√ßo</option>
        </select>
      </div>

      <!-- üßæ ITENS MANUAIS (SIMPLES) -->
      <h3 style="color:#661155; margin-top:20px;">üì¶ Itens (opcional)</h3>

      <div id="listaItensSolicitacao">
        <div style="
        display:grid;
        grid-template-columns:2fr 2fr 1fr auto;
        gap:10px;
        margin-bottom:10px;
      ">
          <input placeholder="Nome do item">
          <input placeholder="Marca (opcional)">
          <input type="number" min="1" placeholder="Qtd">
          <button onclick="this.parentElement.remove()">üóëÔ∏è</button>
        </div>
      </div>

      <button onclick="adicionarItemSolicitacao()" style="
        margin-bottom:15px;
        background:#661155;
        border:none;
        color:white;
        padding:8px 14px;
        border-radius:6px;
        cursor:pointer;
      ">
        ‚ûï Adicionar Item
      </button>

      <!-- üìé ANEXOS (QUALQUER ARQUIVO / M√öLTIPLOS) -->
      <div class="input-group">
        <label>Anexos (Excel, PDF, imagem, etc)</label>
        <input type="file" id="solAnexos" multiple style="
          width:100%;
          background:#1a1a1a;
          border:1px dashed #661155;
          border-radius:6px;
          color:white;
          padding:8px;
        ">
        <small style="color:#aaa;">
          Pode anexar planilhas, or√ßamentos, fotos ou qualquer arquivo necess√°rio
        </small>
      </div>

      <!-- OBSERVA√á√ïES -->
      <div class="input-group">
        <label>Observa√ß√µes</label>
        <textarea id="solDescricao" placeholder="Descreva a necessidade, finalidade ou urg√™ncia..."
          style="min-height:100px;"></textarea>
      </div>

      <!-- ENVIAR -->
      <div style="text-align:center;margin-top:25px;">
        <button onclick="enviarSolicitacaoCompra()" style="
          background:#661155;
          color:white;
          padding:12px 35px;
          border:none;
          border-radius:8px;
          cursor:pointer;
        ">
          üì§ Enviar Solicita√ß√£o
        </button>
      </div>

      <hr style="margin:30px 0; border-color:#333;">

      <!-- üìã MINHAS SOLICITA√á√ïES (HIST√ìRICO) -->
      <div style="text-align:center;">
        <button onclick="toggleMinhasSolicitacoes()" style="
          background:#333;
          border:1px solid #661155;
          color:white;
          padding:10px 20px;
          border-radius:8px;
          cursor:pointer;
          display:flex;
          align-items:center;
          gap:8px;
          margin:0 auto;
        ">
          üìã Minhas Solicita√ß√µes (Hist√≥rico)
        </button>
      </div>

      <div id="listaMinhasSolicitacoes" style="display:none; margin-top:25px;">
        <p style="text-align:center; opacity:0.6;">Carregando suas solicita√ß√µes...</p>
      </div>

    </div>
  </section>

  <!-- ======================================================
     üì• GEST√ÉO DE REQUISI√á√ïES (COMPRADOR)
====================================================== -->
  <section id="gestaoRequisicoes" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Gest√£o de Requisi√ß√µes</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:12px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:1000px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <h2 style="color:#661155; text-align:center;">
        üì• Solicita√ß√µes Recebidas
      </h2>

      </p>

      <!-- Aqui entraremos com a lista depois -->
      <div id="listaSolicitacoesCompra" style="margin-top:25px;"></div>

    </div>
  </section>

  <!-- ======================================================
     ‚úÖ APROVAR COMPRAS (MISSING SECTION RESTORED)
  ====================================================== -->
  <section id="aprovarCompras" style="display:none;">
    <header>
      <button class="btn-sair" onclick="voltarMenu()">üè† Menu Principal</button>
      <h1>Aprovar Compras</h1>
    </header>

    <div style="
    background:#111;
    border:1px solid #661155;
    border-radius:12px;
    padding:25px;
    margin:30px auto;
    width:90%;
    max-width:1000px;
    color:white;
    box-shadow:0 0 15px rgba(102,17,85,0.6);
  ">

      <h2 style="color:#661155; text-align:center;">
        ‚úÖ Cota√ß√µes Pendentes de Aprova√ß√£o
      </h2>

      <div id="listaPendentesAprovacao" style="margin-top:25px;"></div>

    </div>
  </section>



  <!-- üìã MODAL ‚Äì DETALHES DA SOLICITA√á√ÉO DE COMPRA -->
  <div id="modalDetalhesSolicitacao" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:900px; position:relative; max-height:none;">

      <button class="close-btn" onclick="fecharModalDetalhesSolicitacao()">
        &times;
      </button>

      <h2 style="color:#661155;">üìã Detalhes da Solicita√ß√£o</h2>

      <div id="conteudoDetalhesSolicitacao" style="margin-top:15px; padding-right: 5px;">
        <!-- conte√∫do gerado via JS -->
      </div>

      <!-- üîΩ BOT√ÉO NOVO -->
      <div id="acoesSolicitacao" style="text-align:center; margin-top:25px; display:none;">
        <button onclick="criarCotacaoDaSolicitacao()" style="
          background:#661155;
          color:white;
          padding:12px 30px;
          border:none;
          border-radius:8px;
          cursor:pointer;
        ">
          üìä Criar Cota√ß√£o a partir desta Solicita√ß√£o
        </button>
      </div>

    </div>
  </div>

  <div id="modalMapaPrecos" class="modal" style="display:none;">
    <div class="modal-content"
      style="position: fixed; top:0; left:0; width:100vw; height:100vh; max-width:none; background:#000; border:none; display:flex; flex-direction:column; margin:0; padding:0;">

      <button class="close-btn" onclick="fecharMapaPrecos()"
        style="position:fixed; top:20px; right:25px; background:#661155; border:none; color:white; font-size:24px; cursor:pointer; z-index:999999; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.5);">&times;</button>

      <div style="padding:15px 25px; border-bottom:1px solid #333;">
        <h2 style="color:#661155; margin:0 0 10px 0;">üó∫Ô∏è Mapa de Pre√ßos Premium</h2>
        <div id="cabecalhoMapa" style="display:flex; gap:30px; font-size:14px; opacity:0.9;">
          <!-- JS preenche aqui -->
        </div>
      </div>

      <!-- aqui entra SOMENTE a matriz -->
      <div id="conteudoMapaPrecos" style="padding:0;">
        <!-- JS injeta a tabela -->
      </div>

    </div>
    <!-- ‚è≥ LOADING OVERLAY GLOBAL -->
    <div id="loadingOverlay" style="
    display:none; 
    position:fixed; 
    top:0; left:0; 
    width:100%; height:100%; 
    background:rgba(0,0,0,0.8); 
    z-index:9999999; 
    flex-direction:column; 
    align-items:center; 
    justify-content:center; 
    color:white; 
    font-family:sans-serif;
  ">
      <div style="
      width:50px; height:50px; 
      border:5px solid #333; 
      border-top:5px solid #661155; 
      border-radius:50%; 
      animation: spin 1s linear infinite;
      margin-bottom:15px;
    "></div>
      <span id="loadingText">Processando...</span>
    </div>

    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
    </style>

</body>

</html>

<script>
  /* ======================================================
     üîß CONFIGURA√á√ÉO GLOBAL
  ====================================================== */
  const MODO_DESENVOLVIMENTO = true;




  /* ======================================================
     üî• CONFIGURA√á√ÉO E INICIALIZA√á√ÉO FIREBASE
  ====================================================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCz7BqYiwX4ojRTMBkWwvaB01-Ac71D8No",
    authDomain: "cotacao-oral-unic.firebaseapp.com",
    projectId: "cotacao-oral-unic",
    storageBucket: "cotacao-oral-unic.firebasestorage.app",
    messagingSenderId: "648085968917",
    appId: "1:648085968917:web:26029a08b8dd363c9c961c",
    databaseURL: "https://cotacao-oral-unic-default-rtdb.firebaseio.com"
  };

  // Inicializa Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();
  const rtdb = firebase.database(); // ‚úÖ Realtime Database (substitui Firestore para cota√ß√µes)

  console.log("üî• Firebase inicializado com sucesso! RTDB:", rtdb.app.options.databaseURL);


  /* ======================================================
     üîë STORAGE HELPERS
  ====================================================== */
  function getCotacoes() {
    return JSON.parse(localStorage.getItem("cotacoes")) || [];
  }

  /* ======================================================
      üîí COTA√á√ïES VIS√çVEIS AO USU√ÅRIO (CORRIGIDA)
      - Agora diferencia Abertas de Respondidas individualmente
      - Adicionado par√¢metro 'apenasRespondidas' (true/false)
  ====================================================== */
  function getCotacoesVisiveisUsuario(apenasRespondidas = false) {
    const usuario = getUsuarioLogado();
    const cotacoes = getCotacoes();

    if (!usuario || !usuario.tipo) {
      return [];
    }

    // Se for admin/comprador, v√™ tudo normalmente
    if (usuario.tipo !== "fornecedor") {
      return [...cotacoes];
    }

    const emailLogado = usuario.email.toLowerCase().trim();

    return cotacoes.filter(c => {
      // 1. Verifica se o fornecedor est√° convidado para esta cota√ß√£o
      const convidado = Array.isArray(c.fornecedores) && c.fornecedores.some(f => {
        const emailsForn = (f.email || "").toLowerCase().split(/[,;]+/).map(e => e.trim());
        return emailsForn.includes(emailLogado);
      });

      if (!convidado) return false;

      // 2. Verifica se existe uma resposta INDIVIDUAL deste fornecedor para esta cota√ß√£o
      // A chave deve seguir o padr√£o: resposta_NUMERO_EMAIL
      const chaveResposta = `resposta_${c.numero}_${emailLogado}`;
      const jaRespondeu = localStorage.getItem(chaveResposta) !== null;

      // 3. L√≥gica de Filtro por Aba:
      if (apenasRespondidas) {
        return jaRespondeu; // S√≥ mostra o que ele j√° respondeu
      } else {
        return !jaRespondeu; // S√≥ mostra o que est√° pendente (Abertas)
      }
    });
  }

  function salvarCotacoes(lista) {
    localStorage.setItem("cotacoes", JSON.stringify(lista));
    // Sincroniza com Firebase se o usu√°rio estiver logado
    const usuario = getUsuarioLogado();
    if (usuario) {
      lista.forEach(c => {
        db.collection("cotacoes").doc(String(c.numero || c.id)).set(c);
      });
    }
  }

  async function migrarDadosParaCloud() {
    console.log("üèÅ Iniciando migra√ß√£o de dados locais para Firestore...");
    // Verifica√ß√£o de seguran√ßa para n√£o estourar cota do Firestore
    if (localStorage.getItem("migration_complete") === "true") {
      console.log("‚úÖ Migra√ß√£o j√° realizada anteriormente. Pulando para economizar cota.");
      return;
    }

    const collections = {
      "fornecedores": "fornecedores",
      "materiais": "materiais",
      "cotacoes": "cotacoes",
      "servicos": "servicos",
      "pre_cadastros_fornecedores": "pre_cadastros"
    };

    try {
      for (const [key, collection] of Object.entries(collections)) {
        const data = JSON.parse(localStorage.getItem(key)) || [];
        if (data.length > 0) {
          console.log(`üì¶ Migrando ${data.length} itens de ${key} para cole√ß√£o ${collection}...`);
          // Limita a 50 itens por vez para evitar bloqueio
          const batch = data.slice(0, 50);
          for (const item of batch) {
            const id = String(item.id || item.numero || item.email || Date.now());
            // Usa merge para n√£o sobrescrever dados existentes e economizar se n√£o mudou
            await db.collection(collection).doc(id).set(item, { merge: true });
          }
        }
      }
      localStorage.setItem("migration_complete", "true");
      console.log("‚úÖ Migra√ß√£o finalizada e marcada como completa.");
    } catch (error) {
      console.error("‚ö†Ô∏è Erro parcial na migra√ß√£o (quota ou rede):", error);
      // N√£o marca como completa para tentar novamente depois, mas o erro n√£o deve travar o login
    }
  }



  function getUsuarioLogado() {
    return JSON.parse(sessionStorage.getItem("usuario_logado"));
  }
  /* ======================================================
     VARI√ÅVEIS GLOBAIS
  ====================================================== */
  let contadorCotacoes = Number(localStorage.getItem("contadorCotacao") || 0);
  let fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
  let fornecedorEditando = null;
  let materiais = JSON.parse(localStorage.getItem("materiais")) || [];
  let origemCotacao = null;

  /* ======================================================
     üë• USU√ÅRIOS DE TESTE (GARANTIA DEFINITIVA)
     - Um login por fornecedor
     - Mant√©m padr√£o do sistema
  ====================================================== */
  (function garantirUsuariosTeste() {
    const usuariosSalvos =
      JSON.parse(localStorage.getItem("usuarios_teste"));

    if (!Array.isArray(usuariosSalvos) || usuariosSalvos.length === 0) {
      const usuarios = [
        {
          email: "admin@teste.com",
          senha: "123",
          tipo: "administrador",
          nome: "Administrador"
        },
        {
          email: "comprador@teste.com",
          senha: "123",
          tipo: "comprador",
          nome: "Comprador"
        },
        {
          email: "aprovador@teste.com",
          senha: "123",
          tipo: "aprovador",
          nome: "Aprovador"
        },

        {
          email: "Requisitante@teste.com",
          senha: "123",
          tipo: "requisitante",
          nome: "Requisitante Teste"
        },


        // üîë FORNECEDORES (UM LOGIN POR FORNECEDOR)
        {
          email: "fornecedor@teste.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "Fornecedor 1"
        },
        {
          email: "atendpro.suprimentos@gmail.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "Renato Narcizo"
        },
        {
          email: "gerencia.cgms@gmail.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "Oral Unic"
        },
        {
          email: "teste@teste.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "teste"
        },
        {
          email: "eff@.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "eff"
        },
        {
          email: "surya@teste.com",
          senha: "123",
          tipo: "fornecedor",
          nome: "Surya"
        }
      ];

      localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));
      console.warn("‚ö†Ô∏è Usu√°rios de teste recriados automaticamente");
    }
  })();

  /* ======================================================
      üöÄ AUTOCADASTRO E NAVEGA√á√ÉO DE LOGIN
  ====================================================== */
  window.abrirTrabalheConosco = function () {
    document.getElementById("login-container").style.display = "none";
    document.getElementById("trabalhe-conosco").style.display = "block";
  };

  window.voltarParaLogin = function () {
    document.getElementById("trabalhe-conosco").style.display = "none";
    document.getElementById("login-container").style.display = "flex";
  };

  window.enviarAutoCadastro = async function () {
    const nome = document.getElementById("autoFornNome").value.trim();
    const cnpj = document.getElementById("autoFornCnpj").value.trim();
    const email = document.getElementById("autoFornEmail").value.trim();
    const whats = document.getElementById("autoFornWhats").value.trim();
    const tipo = document.getElementById("autoFornTipo").value;
    const banco = document.getElementById("autoFornBanco").value;

    if (!nome || !cnpj || !email) {
      alert("‚ö†Ô∏è Preencha os campos obrigat√≥rios: Nome, CNPJ e E-mail.");
      return;
    }

    const novoPreCadastro = {
      id: Date.now(),
      nome,
      cnpj,
      email,
      whats,
      tipo,
      banco,
      data: new Date().toLocaleString(),
      status: "pendente"
    };

    // 1. Salva no LocalStorage (Redund√¢ncia)
    const preCadastros = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    preCadastros.push(novoPreCadastro);
    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(preCadastros));

    // 2. Salva no Firebase (Sincroniza√ß√£o Multi-M√°quina)
    try {
      await db.collection("pre_cadastros_fornecedores").doc(String(novoPreCadastro.id)).set(novoPreCadastro);
      console.log("‚úÖ Pr√©-cadastro salvo no Firestore");
    } catch (e) {
      console.warn("‚ö†Ô∏è Falha ao salvar no Firestore (Salvou Localmente):", e);
    }

    alert("‚úÖ Proposta enviada! Nossa equipe analisar√° seus dados em breve.");

    // Limpa campos
    document.getElementById("autoFornNome").value = "";
    document.getElementById("autoFornCnpj").value = "";
    document.getElementById("autoFornEmail").value = "";
    document.getElementById("autoFornWhats").value = "";
    document.getElementById("autoFornBanco").value = "";
    document.getElementById("autoFornTipo").value = "";

    voltarParaLogin();
  };

  /* ======================================================
      üîê LOGIN (COMENTADO PARA REFER√äNCIA - AGORA USANDO FIREBASE)
  ====================================================== */
  async function login() {
    const email = document.getElementById("email").value.trim().toLowerCase();
    const senha = document.getElementById("senha").value.trim();
    const msg = document.getElementById("msgLogin");

    msg.innerText = "‚åõ Verificando...";

    try {
      // 1. TENTA BUSCAR NO FIRESTORE PRIMEIRO
      const userRef = db.collection("usuarios").doc(email);
      const doc = await userRef.get();

      let usuario = null;

      if (doc.exists) {
        usuario = doc.data();
        if (usuario.senha !== senha) {
          msg.innerText = "‚ùå Senha incorreta";
          return;
        }
      } else {
        // 2. FALLBACK: BUSCA NO LOCALSTORAGE (MIGRA√á√ÉO)
        const usuariosLS = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
        usuario = usuariosLS.find(u => u.email.toLowerCase().trim() === email && u.senha === senha);

        if (usuario) {
          console.log("üöÄ Migrando usu√°rio para Firestore:", email);
          await userRef.set(usuario);
        }
      }

      if (!usuario) {
        msg.innerText = "‚ùå Usu√°rio n√£o encontrado";
        return;
      }

      // üî• LIMPA ESTADOS ANTERIORES
      localStorage.removeItem("cotacaoRespostaAtual");
      localStorage.removeItem("cotacaoEmEdicao");
      localStorage.removeItem("respostaEmEdicao");

      // üîê SALVA SESS√ÉO TEMPOR√ÅRIA
      window.usuarioLogando = usuario;

      // üõ°Ô∏è VALIDA√á√ÉO DE SENHA PADR√ÉO (123456)
      if (senha === "123456") {
        document.getElementById("modalTrocaSenha").style.display = "flex";
        document.getElementById("novaSenha").focus();
        msg.innerText = "";
        return;
      }

      finalizarLogin(usuario);
    } catch (error) {
      console.error("Erro no login:", error);
      msg.innerText = "‚ùå Erro ao conectar ao servidor";
    }
  }

  function finalizarLogin(usuario) {
    // üîê SALVA SESS√ÉO DEFINITIVA (MANTEMOS LS/SS PARA COMPATIBILIDADE S√çNCRONA DO RESTO DO APP)
    localStorage.setItem("usuarioLogado", JSON.stringify(usuario));
    sessionStorage.setItem("usuario_logado", JSON.stringify(usuario));
    localStorage.setItem("logado", "true");

    // üîÑ TROCA TELAS
    document.getElementById("login-container").style.display = "none";
    document.getElementById("dashboard").style.display = "block";

    // üîë PERMISS√ïES
    if (typeof aplicarPermissoes === "function") {
      aplicarPermissoes(usuario.tipo);
    }

    // üîÑ Tenta migrar materiais e cota√ß√µes em background se for admin
    if (usuario.tipo === "administrador" || usuario.tipo === "comprador") {
      // ‚ö†Ô∏è DESATIVADO TEMPORARIAMENTE PARA EVITAR ERRO DE COTA (Quota Exceeded)
      // setTimeout(migrarDadosParaCloud, 1000);
    }

    console.log("‚úÖ Login realizado com sucesso para:", usuario.email);
  }

  /* ======================================================
      üîê FUN√á√ÉO: CONFIRMAR TROCA DE SENHA (FIREBASE)
  ====================================================== */
  window.confirmarTrocaSenha = async function () {
    const nova = document.getElementById("novaSenha").value;
    const confirma = document.getElementById("confirmarNovaSenha").value;
    const msg = document.getElementById("msgTrocaSenha");

    if (nova !== confirma) {
      msg.innerText = "‚ùå As senhas n√£o coincidem!";
      return;
    }

    if (nova === "123456") {
      msg.innerText = "‚ùå Por favor, escolha uma senha diferente de 123456";
      return;
    }

    const usuario = window.usuarioLogando;
    if (!usuario) {
      alert("Erro de sess√£o. Fa√ßa login novamente.");
      window.location.reload();
      return;
    }

    try {
      msg.innerText = "‚åõ Salvando na nuvem...";
      usuario.senha = nova;

      // üíæ ATUALIZA NO FIRESTORE
      await db.collection("usuarios").doc(usuario.email.toLowerCase().trim()).set(usuario);

      // üíæ ATUALIZA NO LOCALSTORAGE (LEGACY)
      let usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
      const index = usuarios.findIndex(u => u.email.toLowerCase().trim() === usuario.email.toLowerCase().trim());
      if (index !== -1) {
        usuarios[index].senha = nova;
        localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));
      }

      // üèÅ FINALIZA O LOGIN
      document.getElementById("modalTrocaSenha").style.display = "none";
      finalizarLogin(usuario);
      alert("‚úÖ Senha atualizada na nuvem com sucesso!");
    } catch (error) {
      console.error("Erro ao trocar senha:", error);
      msg.innerText = "‚ùå Erro ao salvar nova senha";
    }
  };


  function toggleSenha() {
    const input = document.getElementById("senha");
    const icon = document.querySelector(".toggle-senha i");

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  function enterLogin(e) {
    if (e.key === "Enter") {
      login();
    }
  }


  /* ======================================================
     PERFIL DO USU√ÅRIO (FIREBASE)
  ====================================================== */
  async function carregarPerfilUsuario() {
    try {
      if (!window.auth || !auth.currentUser) {
        console.warn("Firebase Auth ainda n√£o iniciado");
        return;
      }

      const uid = auth.currentUser.uid;
      const perfilSnap = await getDoc(doc(db, "usuarios", uid));

      if (!perfilSnap.exists()) return;

      const perfil = perfilSnap.data();

      if (perfil.tipo !== "administrador") {
        esconderCardUsuarios();
      }

    } catch (erro) {
      console.error("Erro ao carregar perfil:", erro);
    }
  }

  function obterUsuarios() {
    return JSON.parse(localStorage.getItem("usuarios_local")) || [];
  }

  async function carregarUsuarios() {
    try {
      const listaEmpresa = document.getElementById("listaUsuariosEmpresa");
      const listaFornecedores = document.getElementById("listaUsuariosFornecedores");

      if (!listaEmpresa || !listaFornecedores) {
        console.warn("Containers de lista n√£o encontrados no HTML.");
        return;
      }

      // üîÑ BUSCA NO FIRESTORE (TEMPO REAL)
      let usuarios = [];
      try {
        const snapshot = await db.collection("usuarios").get();
        usuarios = snapshot.docs.map(doc => doc.data());
        localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));
      } catch (e) {
        console.warn("Erro ao buscar usu√°rios do Firebase, usando local:", e);
        usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
      }

      listaEmpresa.innerHTML = "";
      listaFornecedores.innerHTML = "";

      usuarios.forEach((u, index) => {
        if (!u) return;

        const nome = u.nome || "Sem Nome";
        const email = u.email || "Sem E-mail";
        const tipo = (u.tipo || "empresa").toLowerCase();

        const bloco = document.createElement("div");
        bloco.className = "linha-cotacao";
        bloco.innerHTML = `
                <div class="info">
                    <strong>${nome}</strong><br>
                    ${email}<br>
                    <small>Perfil: ${tipo.toUpperCase()}</small>
                </div>
                <div class="acoes">
                    <button onclick="editarUsuario(${index})">‚úèÔ∏è</button>
                    <button onclick='window.excluirUsuarioFirestore("${email}")'>üóëÔ∏è</button>
                </div>
            `;

        if (tipo === "fornecedor") {
          listaFornecedores.appendChild(bloco);
        } else {
          listaEmpresa.appendChild(bloco);
        }
      });
    } catch (erro) {
      console.error("Erro ao carregar usu√°rios:", erro);
    }
  }


  function toggleUsuariosEmpresa() {
    const div = document.getElementById("listaUsuariosEmpresa");
    if (!div) return;

    const aberto = div.style.display === "block";

    // fecha
    if (aberto) {
      div.style.display = "none";
      return;
    }

    // abre
    div.style.display = "block";
    carregarUsuarios();
  }



  function toggleFocoRespostas() {
    const wrapper = document.querySelector(".wrapper-matriz");
    const btn = document.getElementById("btnExpandRespostas");

    if (!wrapper) {
      console.warn("wrapper-matriz n√£o encontrada");
      return;
    }

    const ativo = wrapper.classList.toggle("modo-foco");

    btn.innerText = ativo ? "‚§°" : "‚§¢";
    btn.title = ativo
      ? "Fechar visualiza√ß√£o ampliada"
      : "Ampliar respostas";
  }





  /* ======================================================
     üî¢ CONTROLE DO N√öMERO DA COTA√á√ÉO ATUAL
  ====================================================== */
  let numeroCotacaoAtual = null;

  window.toggleUsuariosEmpresa = toggleUsuariosEmpresa;


  function toggleUsuariosFornecedores() {
    const div = document.getElementById("listaUsuariosFornecedores");
    if (!div) return;

    const aberto = div.style.display === "block";

    // fecha
    if (aberto) {
      div.style.display = "none";
      return;
    }

    // abre
    div.style.display = "block";
    carregarUsuarios();
  }

  /* üîë escopo global */
  let respostaEmEdicao = null;
  let cotacaoEmEdicao = null;

  window.toggleUsuariosFornecedores = toggleUsuariosFornecedores;



  function listarUsuarios() {
    const usuarios = obterUsuarios();

    const empresa = document.getElementById("listaUsuariosEmpresa");
    const fornecedores = document.getElementById("listaUsuariosFornecedores");

    empresa.innerHTML = "";
    fornecedores.innerHTML = "";

    usuarios.forEach(u => {
      const div = document.createElement("div");
      div.className = "linha-cotacao";
      div.innerHTML = `
      <div class="info">
        <strong>${u.nome}</strong><br>
        ${u.email}<br>
        <small>${u.tipo}</small>
      </div>
      <div class="acoes">
        <button onclick="editarUsuario(${u.id})">‚úèÔ∏è</button>
        <button onclick="excluirUsuario(${u.id})">üóëÔ∏è</button>
      </div>
    `;

      if (u.tipo === "fornecedor") {
        fornecedores.appendChild(div);
      } else {
        empresa.appendChild(div);
      }
    });
  }

  async function criarUsuario() {
    const nome = document.getElementById("userNome").value.trim();
    const email = document.getElementById("userEmail").value.trim();
    const senha = document.getElementById("userSenha").value.trim();
    const tipo = document.getElementById("userTipo").value;

    if (!nome || !email || !senha || !tipo) {
      alert("‚ö†Ô∏è Preencha todos os campos");
      return;
    }

    const normalizedEmail = email.toLowerCase().trim();
    const novoUsuario = {
      nome,
      email: normalizedEmail,
      senha,
      tipo
    };

    // 1. Salva no LocalStorage (Legacy)
    const usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
    usuarios.push(novoUsuario);
    localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));

    // 2. Salva no Firestore (Cloud)
    try {
      await db.collection("usuarios").doc(normalizedEmail).set(novoUsuario);
      console.log("‚úÖ Usu√°rio salvo no Firestore");
    } catch (e) {
      console.error("‚ùå Erro ao salvar usu√°rio no Firestore:", e);
    }

    // limpa formul√°rio
    document.getElementById("userNome").value = "";
    document.getElementById("userEmail").value = "";
    document.getElementById("userSenha").value = "";
    document.getElementById("userTipo").value = "";

    alert("‚úÖ Usu√°rio criado com sucesso!");

    // üîë recarrega listas se abertas
    carregarUsuarios();
  }


  function aplicarPermissoes(tipo) {

    // Esconde TODOS os cards primeiro
    document.querySelectorAll(".card").forEach(card => {
      card.style.display = "none";
    });

    // Fun√ß√£o auxiliar para mostrar card pelo t√≠tulo
    function mostrar(titulo) {
      document.querySelectorAll(".card").forEach(card => {
        if (card.querySelector("h3")?.innerText === titulo) {
          card.style.display = "block";
        }
      });
    }

    /* ===========================
       üëë ADMINISTRADOR
    ============================ */
    if (tipo === "administrador") {
      mostrar("Solicita√ß√£o de Compra");
      mostrar("Gest√£o de Requisi√ß√µes");
      mostrar("Criar Cota√ß√£o");
      mostrar("Cadastrar Fornecedor");
      mostrar("Cadastrar Material");
      mostrar("Cadastrar Servi√ßo");
      mostrar("Cota√ß√µes Respondidas");
      mostrar("Aprovar Compras");
      mostrar("Gerenciar Usu√°rios");
      mostrar("Gest√£o Financeira");
      // mostrar("Configura√ß√µes");
    }

    /* ===========================
       üõí COMPRADOR
    ============================ */
    if (tipo === "comprador") {
      mostrar("Criar Cota√ß√£o");
      mostrar("Gest√£o de Requisi√ß√µes");
      mostrar("Cadastrar Fornecedor");
      mostrar("Cadastrar Material");
      mostrar("Cadastrar Servi√ßo");
      mostrar("Cota√ß√µes Respondidas");
      mostrar("Aprovar Compras");
      mostrar("Gest√£o Financeira");
      // mostrar("Configura√ß√µes");
    }


    /* ===========================
       ‚úÖ APROVADOR
    ============================ */
    if (tipo === "aprovador") {
      mostrar("Cota√ß√µes Respondidas");
      mostrar("Aprovar Compras");
      mostrar("Gest√£o Financeira");
    }

    /* ===========================
       üìù Requisitante
    =========================== */
    if (tipo === "requisitante") {
      mostrar("Solicita√ß√£o de Compra");
    }

    /* ===========================
       üöö FORNECEDOR
    ============================ */
    if (tipo === "fornecedor") {
      mostrar("Responder Cota√ß√£o");
      mostrar("Gest√£o Financeira");
    }
  }

  function ocultarConteudoSensivel() {

    // Esconde respostas de fornecedores
    document.querySelectorAll(
      "#listaRespondidas, #analiseConteudo, .respostaFornecedor"
    ).forEach(el => {
      el.style.display = "none";
    });

    // Desativa bot√µes de a√ß√£o sens√≠vel
    document.querySelectorAll(
      "button[onclick*='enviarResposta'], button[onclick*='analisarCotacao']"
    ).forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";
    });
  }

  function usuarioAtual() {
    return JSON.parse(localStorage.getItem("usuario_logado"));
  }

  function bloquearSeNaoFornecedor() {
    const u = usuarioAtual();
    if (!u || u.tipo !== "fornecedor") {
      alert("Acesso negado");
      return true;
    }
    return false;
  }

  async function excluirUsuarioFirestore(email) {
    if (!confirm(`Deseja realmente excluir o usu√°rio ${email}?`)) return;

    try {
      const emailCaminho = email.toLowerCase().trim();

      // 1. Remove da cole√ß√£o de Usu√°rios
      await db.collection("usuarios").doc(emailCaminho).delete();

      // üî• 2. BUSCA E REMOVE NA COLE√á√ÉO DE FORNECEDORES (BUSCA MULTI-TIPO)
      try {
        // Query 1: E-mail min√∫sculo no campo 'email'
        const snapshot1 = await db.collection("fornecedores").where("email", "==", emailCaminho).get();
        // Query 2: E-mail original no campo 'email'
        const snapshot2 = await db.collection("fornecedores").where("email", "==", email.trim()).get();
        // Query 3: E-mail min√∫sculo no campo 'emails' (plural)
        const snapshot3 = await db.collection("fornecedores").where("emails", "==", emailCaminho).get();
        // Query 4: E-mail original no campo 'emails'
        const snapshot4 = await db.collection("fornecedores").where("emails", "==", email.trim()).get();

        const batch = db.batch();
        [snapshot1, snapshot2, snapshot3, snapshot4].forEach(snap => {
          snap.docs.forEach(doc => batch.delete(doc.ref));
        });

        // Tenta tamb√©m pelo ID direto (caso o ID do doc seja o email)
        batch.delete(db.collection("fornecedores").doc(emailCaminho));
        batch.delete(db.collection("fornecedores").doc(email.trim()));

        await batch.commit();
        console.log(`‚úÖ Fornecedores vinculados removidos via busca multivariada.`);

      } catch (fErr) {
        console.warn("Aviso ao buscar/remover fornecedor vinculado:", fErr);
      }

      // 3. Local Cleanup Total (Limpa todas as chaves poss√≠veis)
      const chavesLimpar = ["usuarios_teste", "usuarios_local", "usuario_logado"];
      chavesLimpar.forEach(key => {
        let raw = localStorage.getItem(key) || sessionStorage.getItem(key);
        if (raw) {
          try {
            let dados = JSON.parse(raw);
            if (Array.isArray(dados)) {
              dados = dados.filter(u => (u.email || "").toLowerCase().trim() !== emailCaminho);
              localStorage.setItem(key, JSON.stringify(dados));
            } else if (dados.email && dados.email.toLowerCase().trim() === emailCaminho) {
              localStorage.removeItem(key);
              sessionStorage.removeItem(key);
            }
          } catch (e) { }
        }
      });

      // 4. Limpa tamb√©m o fornecedor local
      let fornecedoresLocal = JSON.parse(localStorage.getItem("fornecedores")) || [];
      fornecedoresLocal = fornecedoresLocal.filter(f =>
        (f.email || "").toLowerCase().trim() !== emailCaminho &&
        (f.emails || "").toLowerCase().trim() !== emailCaminho
      );
      localStorage.setItem("fornecedores", JSON.stringify(fornecedoresLocal));

      alert("‚úÖ Usu√°rio e todos os registros vinculados foram eliminados definitivamente!");
      carregarUsuarios();
      if (typeof mostrarListaFornecedores === "function") mostrarListaFornecedores();
    } catch (e) {
      console.error("Erro ao excluir usu√°rio:", e);
      alert("‚ùå Erro ao excluir usu√°rio do Firebase.");
    }
  }
  window.excluirUsuarioFirestore = excluirUsuarioFirestore;

  function excluirUsuario(index) {
    // Mantido por compatibilidade se algo chamar via index, mas redireciona para o novo fluxo
    const usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
    const u = usuarios[index];
    if (u && u.email) {
      excluirUsuarioFirestore(u.email);
    } else {
      // Se n√£o tem email, remove s√≥ local
      usuarios.splice(index, 1);
      localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));
      carregarUsuarios();
    }
  }

  function editarUsuario(index) {
    const usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
    const u = usuarios[index];
    if (!u) return;

    // Popula o formul√°rio de cadastro
    const inputNome = document.getElementById("userNome");
    const inputEmail = document.getElementById("userEmail");
    const inputSenha = document.getElementById("userSenha");
    const inputTipo = document.getElementById("userTipo");

    if (inputNome) inputNome.value = u.nome || "";
    if (inputEmail) {
      inputEmail.value = u.email || "";
      // Atribui ao atributo customizado para controle de altera√ß√£o de e-mail se necess√°rio
      inputEmail.dataset.oldEmail = u.email || "";
    }
    if (inputSenha) inputSenha.value = u.senha || "";
    if (inputTipo) inputTipo.value = u.tipo || "";

    // Rola para o topo do card de gest√£o de usu√°rios (onde est√° o form)
    const card = document.getElementById("cardGerenciarUsuarios");
    if (card) {
      card.scrollIntoView({ behavior: "smooth" });
    } else {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    console.log(`‚úèÔ∏è Editando usu√°rio: ${u.email}. O salvamento na nuvem ocorrer√° ao clicar em "Criar Usu√°rio" (Upsert).`);
  }

  function sair() {
    // 1. Limpa a sess√£o
    sessionStorage.removeItem("usuario_logado");
    localStorage.removeItem("logado");
    localStorage.removeItem("usuarioLogado"); // Remove tamb√©m do localStorage para evitar conflitos

    // 2. Esconde todas as se√ß√µes
    document.querySelectorAll("section").forEach(sec => {
      sec.style.display = "none";
    });

    // 3. Seleciona os containers (Usando nomes diferentes da fun√ß√£o login)
    const telaLogin = document.getElementById("login-container");
    const telaDashboard = document.getElementById("dashboard");

    // 4. Alterna a visibilidade
    if (telaLogin) telaLogin.style.display = "flex";
    if (telaDashboard) telaDashboard.style.display = "none";

    // 5. Opcional: Recarrega a p√°gina para limpar estados da mem√≥ria
    window.location.reload();
  }

  /* üîë garante escopo global */
  window.sair = sair;

  /* ======================================================
     üì¶ HELPER INDEXEDDB (STORAGE PARA ARQUIVOS GRANDES)
  ====================================================== */
  const dbDocs = {
    dbName: "SistemaCotacaoDocs",
    storeName: "arquivos",
    init() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(this.dbName, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(this.storeName)) {
            db.createObjectStore(this.storeName);
          }
        };
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
      });
    },
    async salvar(chave, dados) {
      const db = await this.init();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.storeName, "readwrite");
        const store = tx.objectStore(this.storeName);
        store.put(dados, chave);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    },
    async buscar(chave) {
      const db = await this.init();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.storeName, "readonly");
        const store = tx.objectStore(this.storeName);
        const req = store.get(chave);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
  };

  /* ======================================================
     NAVEGA√á√ÉO (√öNICA)
  ====================================================== */

  function fecharTodasAsSecoes() {
    // Esconde todas as se√ß√µes
    document.querySelectorAll("section").forEach(sec => {
      sec.style.display = "none";
    });
    // Esconde todos os modais
    document.querySelectorAll(".modal").forEach(m => {
      m.style.display = "none";
    });
    // Garante que o scroll do corpo seja liberado
    document.body.style.overflow = "auto";
  }
  window.fecharTodasAsSecoes = fecharTodasAsSecoes;

  function voltarMenu() {
    fecharTodasAsSecoes();

    // üîí FOR√áA FECHAMENTO DO MODAL DE COTA√á√ÉO POR ID (CR√çTICO)
    const modalCotacao = document.getElementById("modalCotacao");
    if (modalCotacao) modalCotacao.style.display = "none";
    document.body.style.overflow = "auto"; // Libera scroll

    // üîë fecha listas internas (mesmo padr√£o do Material)
    const listaFornecedores = document.getElementById("listaFornecedoresCadastrados");
    if (listaFornecedores) listaFornecedores.style.display = "none";

    const listaMateriais = document.getElementById("listaMateriais");
    if (listaMateriais) listaMateriais.style.display = "none";

    const listaServicos = document.getElementById("listaServicos");
    if (listaServicos) listaServicos.style.display = "none";

    document.getElementById("dashboard").style.display = "block";
  }


  function abrirPagina(pagina) {
    fecharTodasAsSecoes();

    if (pagina === "cadastro_fornecedor.html") {
      document.getElementById("cadastroFornecedor").style.display = "block";

    } else if (pagina === "nova_cotacao.html") {
      document.getElementById("modalCotacao").style.display = "flex";

    } else if (pagina === "cadastro_material.html") {
      document.getElementById("cadastroMaterial").style.display = "block";

    } else if (pagina === "cadastro_servico.html") {
      document.getElementById("cadastroServico").style.display = "block";

    } else if (pagina === "cotas_recebidas.html") {
      abrirResponderCotacao();

    }
    else if (pagina === "aprovacoes.html") {
      abrirAprovarCompras();
    }
    else if (pagina === "financeiro") {
      // üìù Abre a gest√£o financeira do fornecedor
      fecharTodasAsSecoes();
      const sec = document.getElementById("secaoFinanceiro");
      if (sec) {
        sec.style.display = "block";
        carregarFinanceiroFornecedor();
      }
    }
    else {
      alert("Tela em desenvolvimento üöß");
    }
  }

  /* ======================================================
     MODAL COTA√á√ÉO
  ====================================================== */
  function abrirModalCotacao() {
    limparFormulariosCotacao(); // üßπ Sempre come√ßa limpo
    document.getElementById("modalCotacao").style.display = "flex";
    document.body.style.overflow = "hidden"; // üîí Lock background scroll
  }
  function fecharModal() {
    document.getElementById("modalCotacao").style.display = "none";
    document.body.style.overflow = "auto"; // üîì Unlock background scroll
  }
  function abrirModalResposta(idCotacao) {
    // LIMPEZA TOTAL ANTES DE CARREGAR
    document.getElementById('tabelaResponderCorpo').innerHTML = "";
    // Se houver algum campo de observa√ß√£o ou total, limpe tamb√©m:
    // document.getElementById('campoTotal').value = "";

    // Agora sim, busca os dados da cota√ß√£o e preenche...
  }

  function abrirModalResponder(id, modo = 'novo') {
    const usuario = JSON.parse(sessionStorage.getItem("usuario_logado"));
    const todasCotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];

    // Localiza a cota√ß√£o pelo ID ou N√∫mero
    const cotacao = todasCotacoes.find(c => c.id === id || c.numero === id);

    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada.");
      return;
    }

    // --- NOVA L√ìGICA DE DATA (TRATANDO FORMATO BRASILEIRO) ---
    const agora = new Date();
    let dataFechamento;
    let prazoExpirado = false;

    try {
      if (typeof cotacao.dataFechamento === 'string' && cotacao.dataFechamento.includes('/')) {
        const partes = cotacao.dataFechamento.split(', ');
        const dataPartes = partes[0].split('/');
        const horaPartes = partes[1];
        dataFechamento = new Date(`${dataPartes[2]}-${dataPartes[1]}-${dataPartes[0]}T${horaPartes}`);
      } else {
        dataFechamento = new Date(cotacao.dataFechamento);
      }

      if (dataFechamento && !isNaN(dataFechamento.getTime())) {
        if (agora > dataFechamento) prazoExpirado = true;
      }
    } catch (e) {
      console.error("Erro ao converter data:", e);
    }

    if (cotacao.status === "Fechada") {
      alert("üö´ Esta cota√ß√£o foi encerrada pelo comprador.");
      return;
    }

    // SE MODO FOR NOVO E JA EXPIROU
    if (modo === 'novo' && prazoExpirado) {
      alert("üö´ Prazo de resposta expirado.");
      return;
    }

    // --- SE PASSOU NA VALIDA√á√ÉO, ABRE O MODAL ---
    // document.getElementById('numeroCotacaoResponder').innerText = cotacao.numero; // REMOVIDO: ID inexistente

    // Preenche Detalhes
    document.getElementById('respNumero').innerText = cotacao.numero;
    document.getElementById('respDataCriacao').innerText = cotacao.dataCriacao;
    document.getElementById('respDataFechamento').innerText = cotacao.dataFechamento;
    document.getElementById('respDescricao').innerText = cotacao.descricao;

    // üïí INICIA O TIMER
    if (dataFechamento) {
      if (typeof iniciarTimerCotacao === "function") {
        iniciarTimerCotacao(dataFechamento);
      }
    }

    // Limpa e monta a tabela de produtos
    const corpoTabela = document.getElementById('tabelaResponderCorpo');
    corpoTabela.innerHTML = "";

    cotacao.produtos.forEach(prod => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td>${prod.nome}</td>
            <td style="text-align: center;">${prod.marca || '-'}</td>
            <td style="text-align: center;">${prod.quantidade}</td>
            <td style="padding-left: 15px;"><input type="number" step="0.01" class="preco-input" data-produto="${prod.nome}"></td>
        `;
      corpoTabela.appendChild(tr);
    });

    // Se j√° houver resposta salva, preenche os pre√ßos para edi√ß√£o
    const chaveRes = `res_${cotacao.id}_${usuario.email.toLowerCase().trim()}`;
    const respostaSalva = JSON.parse(localStorage.getItem(chaveRes));
    if (respostaSalva) {
      respostaSalva.itens.forEach(item => {
        const input = document.querySelector(`input[data-produto="${item.produto}"]`);
        if (input) input.value = item.preco;
      });
    }

    // üîí CONTROLE DE BOT√ïES (REQ. USU√ÅRIO)
    const btnEnviar = document.getElementById('btnEnviarResposta');
    const btnEditar = document.getElementById('btnEditarResposta');
    const inputs = document.querySelectorAll("#tabelaResponderCorpo input");
    const fileInput = document.getElementById("respAnexo");

    // Reset Inicial
    if (btnEnviar) btnEnviar.style.display = 'none';
    if (btnEditar) btnEditar.style.display = 'none';
    inputs.forEach(i => i.disabled = true);
    if (fileInput) fileInput.disabled = true;

    if (modo === 'novo') {
      // Modo NOVO: Apenas Enviar, Campos Abertos
      if (btnEnviar) btnEnviar.style.display = 'inline-block';
      inputs.forEach(i => i.disabled = false);
      if (fileInput) fileInput.disabled = false;
    }
    else if (modo === 'respondida') {
      // Modo RESPONDIDA: Ver, e se n√£o expirou, pode Editar
      if (!prazoExpirado) {
        if (btnEditar) btnEditar.style.display = 'inline-block';
        // Inputs travados at√© clicar em editar
      } else {
        // Expirou: Apenas visualiza
      }
    }
    else if (modo === 'visualizar') {
      // Hist√≥rico: Tudo travado
    }

    document.getElementById('modalResponder').style.display = 'flex';
    document.body.style.overflow = "hidden"; // üîí Lock background scroll
  }

  // Wrapper para chamar com o modo correto
  window.abrirResponderCotacao = function (id, modo) {
    abrirModalResponder(id, modo);
  };

  // FUN√á√ÉO DO TIMER (SIMPLES E DIRETA)
  function iniciarTimerCotacao(dataFechamento) {
    const display = document.getElementById("timerDisplay");
    if (!display) return;

    // Limpa timer anterior se houver
    if (window.timerInterval) clearInterval(window.timerInterval);

    function atualizar() {
      const agora = new Date();
      const diff = dataFechamento - agora;

      if (diff <= 0) {
        display.innerText = "EXPIRADO";
        display.style.color = "red";
        if (window.timerInterval) clearInterval(window.timerInterval);
        return;
      }

      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const s = Math.floor((diff % (1000 * 60)) / 1000);

      display.innerText = `${d}d ${h}h ${m}m ${s}s`;
      display.style.color = "#00ff99";
    }

    atualizar(); // Roda imediatamente
    window.timerInterval = setInterval(atualizar, 1000); // Repete a cada segundo
  }

  /* ======================================================
     ‚úÖ APROVA√á√ÉO DE COMPRAS (CORRIGIDO)
     ====================================================== */
  window.carregarPendentesAprovacao = function () {
    const listaDiv = document.getElementById("listaPendentesAprovacao");
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];

    listaDiv.innerHTML = "";

    // Filtra status "aprovacao" (aprovada na an√°lise)
    const pendentes = cotacoes.filter(c => c.status === "aprovacao");

    if (pendentes.length === 0) {
      listaDiv.innerHTML = "<p style='text-align:center;color:#ccc;'>Nenhuma cota√ß√£o aguardando aprova√ß√£o final.</p>";
      return;
    }

    pendentes.forEach(cot => {
      const card = document.createElement("div");
      card.className = "card-cotacao";
      card.style.cssText = "background:#1a1a1a; border:1px solid #661155; padding:15px; margin-bottom:10px; border-radius:8px;";

      // Bot√£o leva para o modal de an√°lise mas em modo de aprova√ß√£o (j√° tratado no premium_render)
      card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                 <strong style="color:white; font-size:16px;">${cot.descricao || "Cota√ß√£o Sem Descri√ß√£o"}</strong>
                 <span style="display:block; font-size:12px; color:#aaa;">#${cot.numero} - Encerrada em: ${cot.dataFechamento}</span>
                 <span style="font-size:11px; color:#f39c12;">üíõ Aguardando Decis√£o Final</span>
              </div>
              <button onclick="abrirAnalise('${cot.numero}')" style="background:#661155; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">
                 üîç Avaliar
              </button>
          </div>
      `;
      listaDiv.appendChild(card);
    });
  };

  /* ======================================================
     GERAR N√öMERO DE COTA√á√ÉO (√öNICO)
  ====================================================== */

  contadorCotacoes = Number(localStorage.getItem("contadorCotacao")) || 1000;

  function gerarNumeroCotacao() {
    const agora = new Date();
    const data = `${agora.getFullYear()}${String(agora.getMonth() + 1).padStart(2, "0")}${String(agora.getDate()).padStart(2, "0")}`;
    contadorCotacoes++;
    localStorage.setItem("contadorCotacao", contadorCotacoes);
    return `COT-${data}-${String(contadorCotacoes).padStart(2, "0")}`;
  }


  /* ======================================================
     COTA√á√ÉO EXCEL
  ====================================================== */
  function abrirCotacaoExcel() {
    fecharModal();
    document.getElementById("arquivoExcel").click();
  }

  function arquivoSelecionado(event) {
    const file = event.target.files[0];
    if (!file || !file.name.endsWith(".xlsx")) {
      alert("Selecione um arquivo Excel (.xlsx)");
      return;
    }

    fecharTodasAsSecoes();
    document.getElementById("cotacaoExcel").style.display = "block";

    numeroCotacaoAtual = gerarNumeroCotacao();
    document.getElementById("numeroCotacaoExcel").textContent = numeroCotacaoAtual;

    document.getElementById("dataCriacaoExcel").textContent = new Date().toLocaleString();

    const tbody = document.getElementById("tabelaCotacaoExcelCorpo");
    tbody.innerHTML = "";

    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: "array" });
      const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });

      sheet.slice(1).forEach(r => {
        if (r.length < 4) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${r[0]}</td>
        <td style="padding-left: 10px;">${r[1]}</td>
        <td style="padding-left: 15px;">${r[2]}</td>
        <td style="padding-left: 15px;">${r[3]}</td>
      `;
        tbody.appendChild(tr);
      });
    };

    reader.readAsArrayBuffer(file);
  }


  /* ======================================================
     COTA√á√ÉO MANUAL
  ====================================================== */
  function abrirCotacaoManual() {
    fecharModal();
    fecharTodasAsSecoes();

    document.getElementById("cotacaoManual").style.display = "block";

    numeroCotacaoAtual = gerarNumeroCotacao();
    document.getElementById("numCotacaoManual").textContent = numeroCotacaoAtual;

    document.getElementById("dataCriacaoManual").textContent =
      new Date().toLocaleString();

    // garante tabela limpa ao abrir
    const tabela = document.getElementById("tabelaManualCorpo");
    tabela.innerHTML = "";

    /* ======================================================
       üîó SE VEIO DE UMA SOLICITA√á√ÉO
    ====================================================== */
    if (window.cotacaoOrigemSolicitacao) {
      const sol = window.cotacaoOrigemSolicitacao;

      // üìù DESCRI√á√ÉO
      const campoDescricao = document.getElementById("descricaoCotacaoManual");
      if (campoDescricao) {
        campoDescricao.value =
          `Solicita√ß√£o ${sol.id}\n` +
          `Solicitante: ${sol.solicitante}\n` +
          `Setor: ${sol.setor}\n\n` +
          `${sol.descricao || ""}`;
      }

      // üì¶ ITENS
      if (Array.isArray(sol.itens)) {
        sol.itens.forEach(item => {
          adicionarLinhaManual(
            item.nome || "",
            item.marca || "",
            item.quantidade || ""
          );
        });
      }

      // üîí limpa para n√£o repetir
      window.cotacaoOrigemSolicitacao = null;
    }

  }


  function adicionarLinhaManual(nome = "", marca = "", quantidade = "") {
    const tabela = document.getElementById("tabelaManualCorpo");
    if (!tabela) return;

    const index = tabela.children.length + 1;

    const tr = document.createElement("tr");
    tr.innerHTML = `
    <td>${index}</td>
    <td style="padding-left: 10px;">
      <input
        type="text"
        value="${nome}"
        placeholder="Nome do produto"
        style="width:100%;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;"
      >
    </td>
    <td style="padding-left: 15px;">
      <input
        type="text"
        value="${marca}"
        placeholder="Marca"
        style="width:100%;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;"
      >
    </td>
    <td style="padding-left: 15px;">
      <input
        type="number"
        value="${quantidade}"
        placeholder="Qtd"
        style="width:80px;background:#1a1a1a;color:white;border:1px solid #661155;border-radius:5px;padding:4px;"
      >
    </td>
    <td>
      <button
        onclick="this.closest('tr').remove(); renumerarLinhasManual();"
        style="background:#661155;color:white;border:none;border-radius:4px;padding:5px 10px;"
      >üóëÔ∏è</button>
    </td>
  `;

    tabela.appendChild(tr);
  }



  // garante numera√ß√£o correta ap√≥s excluir
  function renumerarLinhasManual() {
    document.querySelectorAll("#tabelaManualCorpo tr").forEach((tr, i) => {
      tr.children[0].textContent = i + 1;
    });
  }

  function abrirCotacaoMateriais() {
    fecharModal();
    fecharTodasAsSecoes();

    document.getElementById("cotacaoMateriais").style.display = "block";

    numeroCotacaoAtual = gerarNumeroCotacao();
    document.getElementById("numeroCotacaoMateriais").innerText = numeroCotacaoAtual;

    document.getElementById("dataCriacaoMateriais").innerText =
      new Date().toLocaleString();

    carregarMateriaisParaCotacao();
  }

  async function carregarMateriaisParaCotacao() {
    const lista = document.getElementById("listaMateriaisCotacao");

    let materiais = [];
    try {
      const snapshot = await db.collection("materiais").get();
      materiais = snapshot.docs.map(doc => doc.data());
      localStorage.setItem("materiais", JSON.stringify(materiais));
    } catch (e) {
      materiais = JSON.parse(localStorage.getItem("materiais")) || [];
    }

    lista.innerHTML = "";

    materiais.forEach((m, i) => {
      const div = document.createElement("div");
      div.className = "linha-cotacao";

      div.innerHTML = `
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="mat_${i}" data-nome="${m.nome}" data-marca="${m.marca || ""}">
        <strong>${m.nome}</strong> (${m.codigo})
      </label>

      <input type="number" id="qtd_mat_${i}"
        placeholder="Qtd"
        style="margin-top:6px;width:100px;
               background:#1a1a1a;color:white;
               border:1px solid #661155;
               border-radius:5px;padding:4px;">
    `;

      lista.appendChild(div);
    });
  }

  function filtrarMateriaisCotacao() {
    const termo = document.getElementById("buscaMaterialCotacao").value.toLowerCase();
    const linhas = document.querySelectorAll("#listaMateriaisCotacao .linha-cotacao");

    linhas.forEach(linha => {
      const texto = linha.innerText.toLowerCase();
      linha.style.display = texto.includes(termo) ? "block" : "none";
    });
  }

  function abrirCotacaoServicos() {
    fecharModal();
    fecharTodasAsSecoes();

    document.getElementById("cotacaoServicos").style.display = "block";

    numeroCotacaoAtual = gerarNumeroCotacao();
    document.getElementById("numeroCotacaoServicos").innerText = numeroCotacaoAtual;

    document.getElementById("dataCriacaoServicos").innerText =
      new Date().toLocaleString();

    carregarServicosParaCotacao();
  }

  async function carregarServicosParaCotacao() {
    const lista = document.getElementById("listaServicosCotacao");

    let servicos = [];
    try {
      const snapshot = await db.collection("servicos").get();
      servicos = snapshot.docs.map(doc => doc.data());
      localStorage.setItem("servicos", JSON.stringify(servicos));
    } catch (e) {
      servicos = JSON.parse(localStorage.getItem("servicos")) || [];
    }

    lista.innerHTML = "";

    servicos.forEach((s, i) => {
      const div = document.createElement("div");
      div.className = "linha-cotacao";

      div.innerHTML = `
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="srv_${i}" data-nome="${s.nome}">
        <strong>${s.nome}</strong> (${s.codigo})
      </label>

      <input type="number" id="qtd_srv_${i}"
        placeholder="Qtd"
        style="margin-top:6px;width:100px;
               background:#1a1a1a;color:white;
               border:1px solid #661155;
               border-radius:5px;padding:4px;">
    `;

      lista.appendChild(div);
    });
  }

  // ======================================================
  // REGRA GLOBAL DE COMPARA√á√ÉO DE E-MAIL (ANTI-VAZAMENTO)
  // ======================================================
  function normalizarEmail(email) {
    return (email || "").toLowerCase().trim();
  }

  // abre o modal
  function abrirSelecaoFornecedores(btn) {
    origemCotacao = btn.dataset.origem;
    document.getElementById("modalFornecedores").style.display = "flex";
    carregarFornecedoresModal();
  }

  // fecha o modal
  function fecharModalFornecedores() {
    document.getElementById("modalFornecedores").style.display = "none";
  }

  // fun√ß√£o √öNICA de renderiza√ß√£o (layout base)
  function renderizarFornecedoresModal(lista) {
    const listaDiv = document.getElementById("listaFornecedoresModal");
    if (!listaDiv) return;

    if (!lista || lista.length === 0) {
      listaDiv.innerHTML = `<p style="text-align:center;">Nenhum fornecedor encontrado.</p>`;
      return;
    }

    lista.sort((a, b) => a.nome.localeCompare(b.nome));

    listaDiv.innerHTML = lista.map(f => {
      // üü¢ FIX: Combina todos os e-mails dispon√≠veis (string e array)
      let emailsCombo = [];
      if (f.email) emailsCombo.push(f.email);
      if (Array.isArray(f.emails)) emailsCombo.push(...f.emails);

      // Remove duplicatas e junta com v√≠rgula
      const emailFinal = [...new Set(emailsCombo)].join(", ");

      return `
    <label style="display:block; padding:8px; border-bottom:1px solid #333; cursor:pointer;">
      <input
        type="checkbox"
        class="checkFornecedor"
        data-nome="${f.nome}"
        data-email="${emailFinal}" 
        style="margin-right:6px;"
      >
      <strong>${f.nome}</strong> ‚Äî ${f.tipo || "Sem tipo"}<br>
      <small>${f.endereco || "-"}</small><br>
      <small>üìû ${f.telefone || "-"} ‚Ä¢ üí¨ ${f.whats || "-"}</small><br>
      <small>üë§ ${f.responsavel || "-"}</small>
    </label>
  `}).join("");
  }

  // carrega todos os fornecedores (FIREBASE)
  async function carregarFornecedoresModal() {
    try {
      const snapshot = await db.collection("fornecedores").get();
      // üî• MAPEIA COM O ID DO DOCUMENTO (DOCID)
      let listaCrua = snapshot.docs.map(doc => ({
        docId: doc.id,
        ...doc.data()
      }));

      // üî• DEDUPLICA√á√ÉO AGRESSIVA (NOME + EMAIL) - Case Insensitive
      const mapaDeduplicado = new Map();
      listaCrua.forEach(f => {
        const emailKey = (f.email || f.emails || "").toLowerCase().trim();
        const nomeKey = (f.nome || "").toLowerCase().trim();

        if (emailKey && !mapaDeduplicado.has(emailKey)) {
          mapaDeduplicado.set(emailKey, f);
        } else if (nomeKey && !mapaDeduplicado.has(nomeKey)) {
          // Se j√° tem um pelo e-mail, n√£o adiciona pelo nome se o nome for igual
          const jaExistePorNome = Array.from(mapaDeduplicado.values()).some(existing =>
            (existing.nome || "").toLowerCase().trim() === nomeKey
          );
          if (!jaExistePorNome) {
            mapaDeduplicado.set(nomeKey, f);
          }
        }
      });
      const listaForn = Array.from(mapaDeduplicado.values());

      // Sincroniza LS
      localStorage.setItem("fornecedores", JSON.stringify(listaForn));

      renderizarFornecedoresModal(listaForn);
    } catch (e) {
      console.warn("Erro ao buscar fornecedores do Firebase, usando local:", e);
      const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
      renderizarFornecedoresModal(fornecedores);
    }
  }

  // confirma sele√ß√£o
  function confirmarFornecedoresCotacao() {
    const selecionados = [...document.querySelectorAll(".checkFornecedor:checked")];

    if (selecionados.length === 0) {
      alert("Selecione ao menos um fornecedor");
      return;
    }

    const fornecedoresSelecionados = selecionados.map(el => ({
      nome: el.dataset.nome || "",
      email: (el.dataset.email || "").trim().toLowerCase()
    }));

    // salva temporariamente no bot√£o/origem
    window.fornecedoresSelecionadosTemp = fornecedoresSelecionados;

    const texto = fornecedoresSelecionados
      .map(f => `${f.nome} (${f.email})`)
      .join("\n");

    if (origemCotacao === "excel") {
      document.getElementById("fornecedoresCotacaoExcel").value = texto;
    }
    if (origemCotacao === "manual") {
      document.getElementById("fornecedoresCotacaoManual").value = texto;
    }
    if (origemCotacao === "materiais") {
      document.getElementById("fornecedoresCotacaoMateriais").value = texto;
    }
    if (origemCotacao === "servicos") {
      document.getElementById("fornecedoresCotacaoServicos").value = texto;
    }

    fecharModalFornecedores();
  }

  /* ======================================================
     ‚úÖ APROVA√á√ÉO DE COMPRAS (COMPRADOR/APROVADOR)
  ====================================================== */
  window.abrirAprovarCompras = function () {
    fecharTodasAsSecoes();
    document.getElementById("aprovarCompras").style.display = "block";
    carregarPendentesAprovacao();
  };

  window.carregarPendentesAprovacao = async function () {
    const listaDiv = document.getElementById("listaPendentesAprovacao");

    listaDiv.innerHTML = `
      <div style="text-align:center; padding:20px; color:#aaa;">
        <i class="fa-solid fa-cloud-arrow-down fa-bounce"></i><br>
        Buscando cota√ß√µes na nuvem...
      </div>
    `;

    let cotacoes = [];

    // 1. TENTATIVA CLOUD (Prioriade M√°xima - Pedido do Usu√°rio)
    if (typeof db !== "undefined") {
      try {
        console.log("‚òÅÔ∏è Buscando pendentes diretamente do Firestore...");
        const snapshot = await db.collection("cotacoes").where("status", "==", "aprovacao").get();

        const cotacoesCloud = [];
        snapshot.forEach(doc => {
          cotacoesCloud.push({ ...doc.data(), id: doc.id });
        });

        // Se achou na nuvem, usa ela. Se n√£o, fallback pro local (caso offline)
        if (cotacoesCloud.length > 0 || snapshot.size === 0) { // snapshot.size === 0 significa que conectou mas n√£o tem nada
          cotacoes = cotacoesCloud;
          cotacoes = cotacoesCloud;
          // Atualiza local apenas para manter sync
          // (Opcional, mas bom para evitar cache stale misturado)
        }
      } catch (err) {
        console.error("Erro ao buscar da nuvem:", err);
        listaDiv.innerHTML = `<p style="color:red; text-align:center;">Erro de conex√£o com a nuvem.</p>`;
        // Fallback local
        cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      }
    } else {
      cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    }

    // Filtro adicional (para garantir)
    const pendentes = cotacoes.filter(c => c.status === "aprovacao" || (c.status === "respondida" && c.statusAprovacao === "pendente"));

    console.log("‚òÅÔ∏è Pendentes encontradas (Cloud/Final):", pendentes.length);

    listaDiv.innerHTML = "";

    if (pendentes.length === 0) {
      listaDiv.innerHTML = `
        <div style="text-align:center; color:#ccc; padding:20px;">
          <i class="fa-solid fa-folder-open" style="font-size:30px; margin-bottom:10px; color:#555;"></i>
          <p>Nenhuma cota√ß√£o aguardando aprova√ß√£o na nuvem.</p>
        </div>
      `;
      return;
    }

    pendentes.forEach(cot => {
      const card = document.createElement("div");
      card.className = "card-cotacao";
      card.style.background = "#1a1a1a";
      card.style.border = "1px solid #661155";
      card.style.padding = "15px";
      card.style.marginBottom = "10px";
      card.style.borderRadius = "8px";

      card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                   <strong style="color:white; font-size:16px;">${cot.descricao || "Cota√ß√£o sem descri√ß√£o"}</strong>
                   <span style="display:block; font-size:12px; color:#aaa;">
                     #${cot.numero} - ${cot.dataFechamento ? new Date(cot.dataFechamento).toLocaleDateString() : 'Sem data'}
                     <span style="color:#f39c12; margin-left:8px;">(Nuvem)</span>
                   </span>
                </div>
                <button onclick="window.analisarCotacao('${cot.numero}')" style="background:#661155; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">
                   üîç Analisar
                </button>
            </div>
        `;
      listaDiv.appendChild(card);
    });
  };

  // filtro por nome (SEM alterar layout)
  function filtrarFornecedores() {
    const termo = document.getElementById("buscaFornecedor").value.toLowerCase();
    const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];

    const filtrados = fornecedores.filter(f =>
      f.nome.toLowerCase().includes(termo)
    );

    renderizarFornecedoresModal(filtrados);
  }

  /* ======================================================
     üßæ ABA GEST√ÉO DE FORNECEDORES
  ====================================================== */
  /* ======================================================
     üßæ ABA GEST√ÉO DE FORNECEDORES (CORRIGIDO)
  ====================================================== */
  window.abrirCadastroFornecedor = function () {
    // Esconde todos
    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    document.getElementById("cadastroFornecedor").style.display = "block";

    // Inicia na aba de aprova√ß√£o se houver pend√™ncias, sen√£o manual
    const pendentes = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    if (pendentes.length > 0) {
      alternarAbaFornecedor('aprovacao');
    } else {
      alternarAbaFornecedor('manual');
    }
  };

  /* ======================================================
     üìé GEST√ÉO DE DOCUMENTOS (NOTAS/BOLETOS)
  ====================================================== */
  window.abrirUploadDocumentos = function (numeroCotacao, tipoDoc = 'Documento') {
    const input = document.createElement("input");
    input.type = "file";
    input.multiple = true;
    input.accept = ".pdf,.jpg,.png,.xml";

    input.onchange = async function (e) {
      if (e.target.files.length > 0) {
        const idDoc = `docs_${numeroCotacao}`;
        const usuario = getUsuarioLogado();

        for (const file of Array.from(e.target.files)) {
          try {
            console.log(`üì§ Enviando ${file.name} para Storage...`);
            const storageRef = storage.ref(`financeiro/${numeroCotacao}/${Date.now()}_${file.name}`);
            const uploadTask = await storageRef.put(file);
            const downloadURL = await uploadTask.ref.getDownloadURL();

            const novoDoc = {
              nome: file.name,
              tipo: tipoDoc,
              data: new Date().toLocaleString(),
              tamanho: (file.size / 1024).toFixed(2) + " KB",
              url: downloadURL,
              usuario: usuario.nome
            };

            // Salva refer√™ncia no Firestore
            const docRef = db.collection("documentos_cotacao").doc(idDoc);
            const currentDocs = (await docRef.get()).data()?.arquivos || [];
            currentDocs.push(novoDoc);
            await docRef.set({ arquivos: currentDocs });

          } catch (error) {
            console.error("Erro no upload financeiro:", error);
            alert(`Falha ao subir o arquivo ${file.name}`);
          }
        }
        alert(`‚úÖ ${tipoDoc} anexado(a) com sucesso na nuvem!`);
      }
    };

    input.click();
  };

  /* ======================================================
     üìÇ VISUALIZAR DOCUMENTOS (COM MODAL MELHORADO)
  ====================================================== */
  window.visualizarDocumentos = async function (numeroCotacao, filtroUsuario = null) {
    if (!numeroCotacao) return alert("N√∫mero da cota√ß√£o inv√°lido.");
    const numClean = String(numeroCotacao).trim();

    console.log("üîç Visualizando docs:", numClean, "Filtro:", filtroUsuario);

    const idDoc = `docs_${numClean}`;
    let arquivos = [];

    // 1. Busca documentos (FLEX√çVEL: FIRESTORE + LOCAL)
    try {
      // Tenta Firestore primeiro
      const snapshot = await db.collection("documentos_cotacao").doc(idDoc).get();
      if (snapshot.exists) {
        arquivos = snapshot.data().arquivos || [];
      } else {
        // Fallback local (IDB ou LS)
        arquivos = await dbDocs.buscar(idDoc);
        if (!arquivos) {
          arquivos = JSON.parse(localStorage.getItem(idDoc)) || [];
        }
      }

      // 2. Busca documentos da COTA√á√ÉO (se existirem nos dados da cota√ß√£o)
      const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      const cotacao = cotacoes.find(c => c.numero === numClean || c.id === numClean || c.numero === numeroCotacao); // Tenta match robusto

      if (cotacao && Array.isArray(cotacao.anexos)) {
        cotacao.anexos.forEach(anexo => {
          // Evita duplicatas (se j√° vieram do manual)
          const jaExiste = arquivos.some(a => a.nome === anexo.nome && a.tamanho === anexo.tamanho);
          if (!jaExiste) {
            arquivos.push({
              nome: anexo.nome,
              tipo: "Anexo Cota√ß√£o",
              data: cotacao.dataCriacao || new Date().toLocaleDateString(),
              tamanho: anexo.tamanho || "desc.",
              usuario: "Comprador (Origem)", // Identifica que veio da cota√ß√£o
              base64: anexo.base64
            });
          }
        });
      }

      // Filter by user if filtered
      const arquivosExibir = filtroUsuario
        ? arquivos.filter(a => (a.usuario || "").toLowerCase() === filtroUsuario.toLowerCase())
        : arquivos;

      if (arquivosExibir.length === 0) {
        alert("üì≠ Nenhum documento encontrado" + (filtroUsuario ? " para este fornecedor." : "."));
        return;
      }

      // Cria/Reutiliza um modal din√¢mico simples
      let modalDocs = document.getElementById('modalDocsFinanceiro');

      if (!modalDocs) {
        modalDocs = document.createElement('div');
        modalDocs.id = 'modalDocsFinanceiro';
        modalDocs.className = 'modal';
        modalDocs.style.zIndex = '2147483647'; // üî• GARANTE TOPO ABSOLUTO
        modalDocs.style.display = 'none'; // garante start
        modalDocs.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
           <span class="close-btn" onclick="document.getElementById('modalDocsFinanceiro').style.display='none'">&times;</span>
           <h3 style="color:#661155; margin-bottom:15px;">üìÇ Documentos da Cota√ß√£o</h3>
           <div id="listaDocsContent" style="max-height:300px; overflow-y:auto;"></div>
        </div>
      `;
        document.body.appendChild(modalDocs);
      }

      const listaDiv = modalDocs.querySelector('#listaDocsContent');
      listaDiv.innerHTML = arquivosExibir.map((a, i) => `
      <div style="background:#1a1a1a; padding:10px; margin-bottom:8px; border-radius:5px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
         <div>
            <strong style="color:white; display:block;">${a.nome}</strong>
            <small style="color:#aaa;">${a.tipo} ‚Ä¢ ${a.tamanho} ‚Ä¢ ${a.data}</small><br>
            ${a.usuario ? `<small style="color:#0dcaf0;">üë§ Enviado por: ${a.usuario}</small>` : ''}
            ${a.url ? `<br><small style="color:#00ff99;">‚òÅÔ∏è Arquivo em Nuvem</small>` : ''}
         </div>
         <button onclick="abrirArquivoAnexo('${numeroCotacao}', ${i})" style="background:#661155; color:white; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; font-weight:bold;">
            ${a.url ? 'üëÅÔ∏è Abrir' : '‚¨áÔ∏è Baixar'}
         </button>
      </div>
    `).join('');

      modalDocs.style.display = 'flex';
    } catch (e) {
      console.error("Erro visualizarDocumentos:", e);
      alert("Erro ao carregar documentos.");
    }
  };

  window.abrirArquivoAnexo = async function (numeroCotacao, index) {
    const idDoc = `docs_${numeroCotacao}`;
    let arquivos = [];

    // Tenta Firestore
    try {
      const snapshot = await db.collection("documentos_cotacao").doc(idDoc).get();
      if (snapshot.exists) {
        arquivos = snapshot.data().arquivos || [];
      }
    } catch (e) { }

    // Fallback local se n√£o achou no firestore e o index for inv√°lido l√°
    if (!arquivos[index]) {
      arquivos = await dbDocs.buscar(idDoc);
      if (!arquivos) {
        arquivos = JSON.parse(localStorage.getItem(idDoc)) || [];
      }
    }

    const arquivo = arquivos[index];
    if (!arquivo) return alert("Arquivo n√£o encontrado.");

    // SE TEM URL (FIREBASE STORAGE)
    if (arquivo.url) {
      window.open(arquivo.url, '_blank');
      return;
    }

    // SE TEM BASE64 (LEGADO)
    if (arquivo.base64) {
      const win = window.open();
      if (win) {
        win.document.write(`<iframe src="${arquivo.base64}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
      } else {
        alert('üö´ Pop-up bloqueado! Permita pop-ups para visualizar o arquivo.');
      }
    } else {
      alert("‚ö†Ô∏è O conte√∫do deste arquivo n√£o est√° dispon√≠vel na nuvem nem localmente.");
    }
  };

  /* ======================================================
     üí∞ CARREGAR LISTA FINANCEIRA (FORNECEDORES) - NOVO
  ====================================================== */
  window.carregarFinanceiroFornecedor = function () {
    const usuario = getUsuarioLogado();

    // Elementos das duas vis√µes
    const formManual = document.getElementById("formManualFinanceiro");
    const listaComprador = document.getElementById("listaFinanceiroComprador");

    // Reset da vis√£o
    if (formManual) formManual.style.display = "none";
    if (listaComprador) {
      listaComprador.style.display = "none";
      listaComprador.innerHTML = "";
    }

    /* ===========================
       üöö VIS√ÉO DO FORNECEDOR
    =========================== */
    if (usuario.tipo === "fornecedor") {
      if (formManual) {
        formManual.style.display = "block";
        const input = document.getElementById("inputNumeroCotacaoManual");
        if (input) {
          input.value = "";
          input.focus();
        }
      }
    }
    /* ===========================
       üõí VIS√ÉO DO COMPRADOR
    =========================== */
    else {
      if (listaComprador) {
        listaComprador.style.display = "block"; // Em lista, bloco √© melhor que grid
        listaComprador.innerHTML = "";

        // Busca cota√ß√µes com documentos
        const cotacoes = JSON.parse(localStorage.getItem('cotacoes')) || [];
        const itensComDocs = [];

        cotacoes.forEach(c => {
          const idDoc = `docs_${c.numero}`;
          const docs = JSON.parse(localStorage.getItem(idDoc)) || [];

          if (docs.length > 0) {
            // Helper para montar resumo dos tipos (ex: "2 Notas, 1 Boleto")
            const qtdNotas = docs.filter(d => d.tipo === 'Nota Fiscal').length;
            const qtdBoletos = docs.filter(d => d.tipo === 'Boleto').length;
            const resumo = [];
            if (qtdNotas > 0) resumo.push(`${qtdNotas} NF(s)`);
            if (qtdBoletos > 0) resumo.push(`${qtdBoletos} Boleto(s)`);
            const resumoTexto = resumo.join(" + ") || `${docs.length} arq(s)`;

            // Coleta nomes √∫nicos dos fornecedores nos documentos
            const nomesFornecedores = [...new Set(docs.map(d => d.usuario).filter(Boolean))];
            const nomeExibicao = nomesFornecedores.length > 0 ? nomesFornecedores.join(", ") : null;

            itensComDocs.push({
              cotacao: c,
              docs: docs,
              resumoTexto: resumoTexto,
              fornecedores: nomeExibicao
            });
          }
        });

        if (itensComDocs.length === 0) {
          listaComprador.innerHTML = "<p style='color:#ccc; text-align:center; padding:20px;'>Nenhum documento financeiro recebido at√© o momento.</p>";
          return;
        }

        // Agrupamento por M√™s (baseado na data de cria√ß√£o da cota√ß√£o)
        const gruposMes = {};

        itensComDocs.forEach(item => {
          let dataRef = new Date();
          // Tenta pegar a data de cria√ß√£o
          if (item.cotacao.dataCriacao) {
            const partes = item.cotacao.dataCriacao.split(/[\/\s,]+/);
            // DD/MM/YYYY ...
            if (partes.length >= 3) {
              // Nota: m√™s js √© 0-indexado
              dataRef = new Date(partes[2], partes[1] - 1, partes[0]);
            }
          }

          if (isNaN(dataRef.getTime())) dataRef = new Date();

          const mesAno = dataRef.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
          // Capitaliza a primeira letra
          const mesFormatado = mesAno.charAt(0).toUpperCase() + mesAno.slice(1);

          if (!gruposMes[mesFormatado]) gruposMes[mesFormatado] = [];
          gruposMes[mesFormatado].push(item);
        });

        // Ordenar chaves cronologicamente? 
        // Para simplificar, vamos iterar na ordem que aparecem ou chaves (que pode ser aleat√≥rio)
        // Se quis√©ssemos ordem correta, precisar√≠amos de uma l√≥gica de sort de datas. 
        // Vamos mostrar os meses mais recentes primeiro (assumindo que o array cotacoes j√° vem +- ordenado ou reordenamos).

        // Vamos apenas iterar pelas chaves
        Object.keys(gruposMes).forEach(mes => {
          const grupo = gruposMes[mes];

          // Cria√ß√£o do HTML do Grupo
          const section = document.createElement("div");
          section.style.marginBottom = "25px";

          section.innerHTML = `
              <h3 style="color:#661155; border-bottom: 1px solid #444; padding-bottom:5px; margin-bottom:10px; font-size:16px;">
                 üìÖ ${mes}
              </h3>
              <div style="display:flex; flex-direction:column; gap:10px;">
                 ${grupo.map(item => `
                    <div style="
                        display:flex; 
                        justify-content:space-between; 
                        align-items:center; 
                        background:#1a1a1a; 
                        border:1px solid #333; 
                        padding:12px 15px; 
                        border-radius:6px;
                    ">
                        <div style="flex:1;">
                           <strong style="color:white; font-size:15px; display:block;">${item.cotacao.descricao || "Cota√ß√£o #" + item.cotacao.numero}</strong>
                           <span style="color:#888; font-size:12px;">#${item.cotacao.numero} ‚Ä¢ Data: ${item.cotacao.dataCriacao}</span>
                           ${item.fornecedores ? `<div style="margin-top:2px; color:#aaa; font-size:12px;">üë§ Fornecedor(es): <strong>${item.fornecedores}</strong></div>` : ''}
                        </div>

                        <div style="flex:0 0 auto; margin: 0 20px; text-align:center;">
                              <span style="background:#333; color:#0dcaf0; font-size:11px; padding:4px 8px; border-radius:4px; white-space:nowrap;">
                                 üìé ${item.resumoTexto}
                              </span>
                        </div>
                        
                        <div style="flex:0 0 auto;">
                            <button onclick="visualizarDocumentos('${item.cotacao.numero}')" 
                                    style="
                                    background:#661155; 
                                    color:white; 
                                    border:none; 
                                    padding:6px 12px; 
                                    border-radius:4px; 
                                    cursor:pointer; 
                                    font-size:12px;
                                    font-weight:bold;
                                    box-shadow:0 0 3px rgba(102,17,85,0.5);
                                    ">
                                üìÇ Abrir
                            </button>
                        </div>
                    </div>
                 `).join('')}
              </div>
           `;

          listaComprador.appendChild(section);
        });
      }
    }
  };



  /* ======================================================
     üìù UPLOAD MANUAL (POR N√öMERO DA COTA√á√ÉO)
  ====================================================== */
  /* ======================================================
     üìù UPLOAD MANUAL (POR N√öMERO DA COTA√á√ÉO)
  ====================================================== */
  let arquivoSelecionadoTemp = null; // Vari√°vel tempor√°ria

  window.uploadManual = function (tipoDoc) {
    const numero = document.getElementById("inputNumeroCotacaoManual").value.trim();
    if (!numero) {
      alert("Por favor, digite o n√∫mero da cota√ß√£o.");
      return;
    }

    // Valida permiss√£o
    if (!validarPermissaoUpload(numero)) return;

    // Cria input file invis√≠vel
    const input = document.createElement("input");
    input.type = "file";
    input.multiple = true;
    input.accept = ".pdf,.jpg,.png,.xml";

    input.onchange = function (e) {
      if (e.target.files.length > 0) {
        // Guarda arquivos na mem√≥ria tempor√°ria
        arquivoSelecionadoTemp = {
          files: Array.from(e.target.files),
          numeroCotacao: numero,
          tipo: tipoDoc
        };

        // Exibe feedback
        const feedback = document.getElementById("feedbackUploadManual");
        const msg = document.getElementById("msgArquivoSelecionado");

        feedback.style.display = "block";
        msg.innerHTML = `üìå <strong>${e.target.files.length} arquivo(s)</strong> selecionado(s) para <br> Cota√ß√£o: <strong>${numero}</strong> <br> Tipo: <strong>${tipoDoc}</strong>`;

        // Desabilita bot√µes de sele√ß√£o para for√ßar terminar
        document.getElementById("inputNumeroCotacaoManual").disabled = true;
      }
    };

    input.click();
  };

  window.enviarArquivoManual = async function () {
    if (!arquivoSelecionadoTemp) return;

    const { files, numeroCotacao, tipo } = arquivoSelecionadoTemp;

    // Processa todos os arquivos (CLOUD STORAGE)
    const uploadPromises = files.map(async file => {
      try {
        const storageRef = storage.ref(`financeiro/${numeroCotacao}/${Date.now()}_${file.name}`);
        const uploadTask = await storageRef.put(file);
        const downloadURL = await uploadTask.ref.getDownloadURL();

        return {
          nome: file.name,
          tipo: tipo,
          data: new Date().toLocaleString(),
          tamanho: (file.size / 1024).toFixed(2) + " KB",
          url: downloadURL,
          usuario: getUsuarioLogado()?.nome || "Desconhecido"
        };
      } catch (e) {
        console.error("Erro upload ind:", e);
        return null;
      }
    });

    try {
      let novosArquivos = await Promise.all(uploadPromises);
      novosArquivos = novosArquivos.filter(a => a !== null);

      const idDoc = `docs_${numeroCotacao}`;
      const docRef = db.collection("documentos_cotacao").doc(idDoc);
      const snap = await docRef.get();
      const atuais = snap.exists ? (snap.data().arquivos || []) : [];

      await docRef.set({ arquivos: [...atuais, ...novosArquivos] });

      alert(`‚úÖ ${novosArquivos.length} arquivo(s) enviados com sucesso para a nuvem!`);
      cancelarUploadManual();
    } catch (err) {
      console.error(err);
      alert("‚ùå Erro ao enviar arquivos para o Firebase.");
    }
  };

  window.cancelarUploadManual = function () {
    arquivoSelecionadoTemp = null;
    document.getElementById("feedbackUploadManual").style.display = "none";
    document.getElementById("inputNumeroCotacaoManual").value = ""; // Limpa campo
    document.getElementById("inputNumeroCotacaoManual").disabled = false;
    document.getElementById("inputNumeroCotacaoManual").focus();
  };

  function validarPermissaoUpload(numero) {
    const cotacoes = JSON.parse(localStorage.getItem('cotacoes')) || [];
    const cotacao = cotacoes.find(c => c.numero === numero);

    if (!cotacao) {
      alert("‚ùå Cota√ß√£o n√£o encontrada! Verifique o n√∫mero digitado.");
      return false;
    }

    const usuario = getUsuarioLogado();

    // Validar se usu√°rio √© fornecedor
    if (usuario.tipo !== 'fornecedor') return true; // Comprador pode tudo (ou quase)

    const convidado = Array.isArray(cotacao.fornecedores) && cotacao.fornecedores.some(f => {
      // Normaliza compara√ß√£o
      const emailUser = usuario.email.toLowerCase();
      const nomeUser = usuario.nome.toLowerCase();

      if (typeof f === 'string') {
        const fLower = f.toLowerCase();
        return fLower.includes(emailUser) || fLower.includes(nomeUser);
      } else if (typeof f === 'object' && f !== null) {
        const emailF = (f.email || "").toLowerCase();
        const nomeF = (f.nome || "").toLowerCase();
        return emailF.includes(emailUser) || nomeF.includes(nomeUser);
      }
      return false;
    });

    if (!convidado) {
      alert("‚õî Voc√™ n√£o tem permiss√£o para anexar documentos nesta cota√ß√£o.");
      return false;
    }

    return true;
  }

  window.alternarAbaFornecedor = function (aba) {
    document.getElementById("conteudoFornManual").style.display = (aba === "manual") ? "block" : "none";
    document.getElementById("conteudoFornAprovacao").style.display = (aba === "aprovacao") ? "block" : "none";

    document.getElementById("btnAbaManual").style.background = (aba === "manual") ? "#661155" : "#333";
    document.getElementById("btnAbaAprovacao").style.background = (aba === "aprovacao") ? "#661155" : "#333";

    if (aba === "aprovacao") {
      carregarFornecedoresPendentes();
    }
  };

  window.carregarFornecedoresPendentes = function () {
    const listaDiv = document.getElementById("listaFornPendentes");
    const pendentes = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];

    // Atualiza badge
    const badge = document.getElementById("badgeFornPendentes");
    if (badge) {
      badge.innerText = pendentes.length;
      badge.style.display = pendentes.length > 0 ? "inline-block" : "none";
    }

    if (pendentes.length === 0) {
      listaDiv.innerHTML = "<p style='text-align:center; color:#666;'>Nenhuma solicita√ß√£o pendente.</p>";
      return;
    }

    listaDiv.innerHTML = pendentes.map((f, i) => `
      <div style="background:#1a1a1a; border:1px solid #661155; border-radius:8px; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong style="font-size:16px; color:white;">${f.nome}</strong> <span style="font-size:12px; color:#aaa;">(${f.data})</span><br>
          <span style="color:#ccc;">CNPJ: ${f.cnpj}</span><br>
          <span style="color:#ccc;">Email: ${f.email}</span> ‚Ä¢ <span style="color:#ccc;">Whats: ${f.whats || "-"}</span><br>
          <span style="color:#ccc; font-size:12px;">Banco: ${f.banco || "-"}</span>
        </div>
        <div style="display:flex; gap:10px;">
          <button onclick="aprovarPreCadastro(${i})" style="background:#198754; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">‚úî Aprovar</button>
          <button onclick="rejeitarPreCadastro(${i})" style="background:#842029; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">‚ùå Rejeitar</button>
        </div>
      </div>
    `).join("");
  };

  window.aprovarPreCadastro = async function (index) {
    const pendentes = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];

    const aprovado = pendentes[index];
    if (!aprovado) return;

    // Converte para formato oficial
    const novoOficial = {
      id: "F-" + Date.now(),
      nome: aprovado.nome,
      email: aprovado.email,
      cnpj: aprovado.cnpj,
      whats: aprovado.whats,
      tipo: aprovado.tipo,
      banco: aprovado.banco,
      endereco: "Auto-Cadastro",
      responsavel: "Auto-Cadastro",
      status: "ativo"
    };

    fornecedores.push(novoOficial);
    localStorage.setItem("fornecedores", JSON.stringify(fornecedores));

    // üî• SINCRONIZA COM FIRESTORE
    try {
      await db.collection("fornecedores").doc(novoOficial.email.toLowerCase().trim()).set(novoOficial);
      // Remove da cole√ß√£o de pr√©-cadastros tamb√©m
      await db.collection("pre_cadastros_fornecedores").doc(String(aprovado.id)).delete();
      console.log("‚úÖ Fornecedor aprovado e sincronizado com Firestore");
    } catch (e) {
      console.warn("‚ö†Ô∏è Falha ao sincronizar aprova√ß√£o com Firestore (Salvou Localmente):", e);
    }

    // Remove da lista pendente local
    pendentes.splice(index, 1);
    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(pendentes));

    alert(`‚úÖ Fornecedor ${aprovado.nome} cadastrado com sucesso!`);
    carregarFornecedoresPendentes();

    // Notifica (Simula√ß√£o)
    console.log(`üìß Enviando e-mail de boas-vindas para ${novoOficial.email}...`);
  };

  window.rejeitarPreCadastro = function (index) {
    if (!confirm("Tem certeza que deseja rejeitar este cadastro?")) return;

    const pendentes = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    pendentes.splice(index, 1);
    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(pendentes));

    carregarFornecedoresPendentes();
  };

  async function salvarFornecedor() {
    const nome = document.getElementById("fornNome")?.value.trim();
    const cnpj = document.getElementById("fornCnpj")?.value.trim();
    const endereco = `${document.getElementById("fornLogradouro")?.value || ""} ${document.getElementById("fornNumero")?.value || ""}`.trim();
    const telefone = document.getElementById("fornTelefone")?.value.trim();
    const whats = document.getElementById("fornWhats")?.value.trim();
    const email = document.getElementById("fornEmails")?.value.trim();
    const responsavel = document.getElementById("fornResponsavel")?.value.trim();
    const tipo = document.getElementById("fornTipo")?.value;

    // ‚úÖ valida√ß√£o correta
    if (!nome || !email) {
      alert("‚ö†Ô∏è Preencha ao menos Nome e E-mail");
      return;
    }

    const normalizedEmail = email.toLowerCase().trim();
    const novoFornecedor = {
      nome,
      cnpj,
      endereco,
      telefone,
      whats,
      email: normalizedEmail,
      responsavel,
      tipo,
      status: "ativo",
      dataCriacao: new Date().toLocaleString()
    };

    const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];

    // Se estiver editando, remove o antigo antes de inserir o novo (ou atualiza se for o mesmo email)
    if (fornecedorEditando !== null) {
      fornecedores.splice(fornecedorEditando, 1);
      fornecedorEditando = null;
    }

    fornecedores.push(novoFornecedor);
    fornecedores.sort((a, b) => a.nome.localeCompare(b.nome));
    localStorage.setItem("fornecedores", JSON.stringify(fornecedores));

    // üî• SINCRONIZA COM FIRESTORE
    try {
      await db.collection("fornecedores").doc(email.toLowerCase().trim()).set(novoFornecedor);
      console.log("‚úÖ Fornecedor sincronizado com Firestore");
    } catch (e) {
      console.warn("‚ö†Ô∏è Falha ao sincronizar com Firestore (Salvou Localmente):", e);
    }

    alert("‚úÖ Fornecedor salvo com sucesso!");

    // limpa formul√°rio
    [
      "fornNome", "fornCnpj", "fornLogradouro", "fornNumero",
      "fornBairro", "fornCidade", "fornCep",
      "fornTelefone", "fornWhats", "fornEmails",
      "fornResponsavel", "fornTipo"
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    // atualiza lista se estiver aberta
    if (document.getElementById("listaFornecedoresCadastrados")?.style.display === "block") {
      mostrarListaFornecedores();
      // Oculta e mostra novamente para for√ßar atualiza√ß√£o completa se necess√°rio
      mostrarListaFornecedores();
    }
  }
  /* ======================================================
      üì¢ PUBLICAR COTA√á√ÉO (VERS√ÉO COMPLETA E CORRIGIDA)
  ====================================================== */
  async function publicarCotacao(tipo = "manual") {
    let fechamento = "";
    let produtos = [];
    let descricao = "";

    // 1. COLETA DE DADOS POR TIPO
    if (tipo === "excel") {
      fechamento = document.getElementById("dataFechamentoExcel")?.value;
      descricao = document.getElementById("descricaoCotacaoExcel")?.value.trim();
      document.querySelectorAll("#tabelaCotacaoExcelCorpo tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds[1]?.innerText && tds[3]?.innerText) {
          produtos.push({
            nome: tds[1].innerText,
            marca: tds[2]?.innerText || "-",
            quantidade: Number(tds[3].innerText)
          });
        }
      });
    } else if (tipo === "manual") {
      fechamento = document.getElementById("dataFechamentoManual")?.value;
      descricao = document.getElementById("descricaoCotacaoManual")?.value.trim();
      document.querySelectorAll("#tabelaManualCorpo tr").forEach(tr => {
        const inputs = tr.querySelectorAll("input");
        if (inputs[0]?.value && inputs[2]?.value) {
          produtos.push({
            nome: inputs[0].value,
            marca: inputs[1]?.value || "-",
            quantidade: Number(inputs[2].value)
          });
        }
      });
    } else if (tipo === "materiais") {
      fechamento = document.getElementById("dataFechamentoMateriais")?.value;
      descricao = document.getElementById("descricaoCotacaoMateriais")?.value.trim();
      document.querySelectorAll("#listaMateriaisCotacao input[type='number']").forEach(inp => {
        if (Number(inp.value) > 0) {
          produtos.push({
            nome: inp.dataset.nome || "Material",
            marca: inp.dataset.marca || "-",
            quantidade: Number(inp.value)
          });
        }
      });
    } else if (tipo === "servicos") {
      fechamento = document.getElementById("dataFechamentoServicos")?.value;
      descricao = document.getElementById("descricaoCotacaoServicos")?.value.trim();
      document.querySelectorAll("#listaServicosCotacao input[type='number']").forEach(inp => {
        if (Number(inp.value) > 0) {
          produtos.push({
            nome: inp.dataset.nome || "Servi√ßo",
            marca: "-", // Servi√ßos geralmente n√£o tem marca, mas mantemos o campo
            quantidade: Number(inp.value)
          });
        }
      });
    }

    // 2. VALIDA√á√ïES CR√çTICAS
    if (!fechamento) {
      alert("‚ö†Ô∏è Preencha a data e hora de fechamento!");
      return;
    }

    if (produtos.length === 0) {
      alert("‚ö†Ô∏è Informe ao menos um item para a cota√ß√£o!");
      return;
    }

    const fornecedores = window.fornecedoresSelecionadosTemp || [];
    if (fornecedores.length === 0) {
      alert("‚ö†Ô∏è Selecione ao menos um fornecedor antes de publicar!");
      return;
    }

    if (!numeroCotacaoAtual) {
      // Fallback caso o n√∫mero tenha se perdido: gera um timestamp
      numeroCotacaoAtual = "COT-" + Date.now();
    }

    // 3. ESTRUTURA DO OBJETO (Garante compatibilidade com Filtros e Respondidas)
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];

    // üîó VINCULA ANEXOS DA SOLICITA√á√ÉO (SE HOUVER)
    let anexosHerdados = [];
    if (window.cotacaoOrigemSolicitacao && Array.isArray(window.cotacaoOrigemSolicitacao.anexos)) {
      anexosHerdados = window.cotacaoOrigemSolicitacao.anexos;
      console.log("üìé Herdando anexos da solicita√ß√£o:", anexosHerdados.length);
    }

    const novaCotacao = {
      id: numeroCotacaoAtual || "COT-" + Date.now(),
      numero: numeroCotacaoAtual || "000",
      tipo: tipo,
      descricao: (descricao && descricao.length > 0) ? descricao : "Sem descri√ß√£o", // Garante string
      dataCriacao: new Date().toLocaleString(),
      dataFechamento: fechamento, // Mant√©m o valor do input
      fornecedores: fornecedores,
      produtos: produtos,
      anexos: anexosHerdados, // ‚úÖ Salva os anexos
      idSolicitacao: window.cotacaoOrigemSolicitacao ? window.cotacaoOrigemSolicitacao.id : null,
      status: "aberta" // Garante string para o charAt n√£o falhar
    };

    try {
      const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      cotacoes.push(novaCotacao);
      localStorage.setItem("cotacoes", JSON.stringify(cotacoes));

      // üî• SINCRONIZA COM REALTIME DATABASE
      try {
        await rtdb.ref("cotacoes/" + novaCotacao.numero).set(novaCotacao);
        console.log("‚úÖ Cota√ß√£o salva no Realtime Database");
      } catch (errRtdb) {
        console.warn("‚ö†Ô∏è Erro ao salvar no RTDB. Salvo localmente.", errRtdb);
      }

      // üîî NOTIFICA√á√ÉO: NOVA FUN√á√ÉO (WEBHOOK)
      if (typeof enviarNotificacaoCotacao === "function") {
        try {
          // Aguarda envio para garantir que n√£o seja cancelado pelo reload
          await enviarNotificacaoCotacao(novaCotacao);
        } catch (errNotif) {
          console.error("Erro ao notificar (n√£o bloqueante):", errNotif);
        }
      }

      // üîî NOTIFICA√á√ÉO PARA FORNECEDORES (LEGADO)
      if (typeof dispararNotificacaoFornecedores === "function") {
        dispararNotificacaoFornecedores(novaCotacao);
      }

      window.fornecedoresSelecionadosTemp = [];
      numeroCotacaoAtual = null;

      // Volta ao painel sem recarregar (evita logout)
      limparFormulariosCotacao();
      const loginContainer = document.getElementById("login-container");
      const dashboardEl = document.getElementById("dashboard");
      if (loginContainer) loginContainer.style.display = "none";
      if (dashboardEl) dashboardEl.style.display = "block";
      document.querySelectorAll("section.secao").forEach(s => s.style.display = "none");
      if (dashboardEl) dashboardEl.style.display = "block";

    } catch (e) {
      console.error("Erro ao salvar:", e);
      alert("‚ö†Ô∏è Erro ao publicar cota√ß√£o. Verifique sua conex√£o.");
    }
  }

  /* ======================================================
     üßπ LIMPEZA DE FORMUL√ÅRIOS DE COTA√á√ÉO
  ====================================================== */
  function limparFormulariosCotacao() {
    console.log("üßπ Limpando todos os formul√°rios de nova cota√ß√£o...");

    // 1. Zera vari√°veis globais auxiliares
    window.fornecedoresSelecionadosTemp = [];
    window.cotacaoOrigemSolicitacao = null;
    numeroCotacaoAtual = null;

    const idsParaLimpar = [
      // Excel
      "descricaoCotacaoExcel", "dataFechamentoExcel", "fornecedoresCotacaoExcel",
      // Manual
      "descricaoCotacaoManual", "dataFechamentoManual", "fornecedoresCotacaoManual",
      // Materiais
      "descricaoCotacaoMateriais", "dataFechamentoMateriais", "fornecedoresCotacaoMateriais", "buscaMaterialCotacao",
      // Servi√ßos
      "descricaoCotacaoServicos", "dataFechamentoServicos", "fornecedoresCotacaoServicos", "buscaServicoCotacao"
    ];

    idsParaLimpar.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    // Limpa tabelas e listas
    const tbExcel = document.getElementById("tabelaCotacaoExcelCorpo");
    if (tbExcel) tbExcel.innerHTML = "";

    const tbManual = document.getElementById("tabelaManualCorpo");
    if (tbManual) tbManual.innerHTML = "";

    // Reseta checkboxes e inputs de Qtd nas listas de Materiais e Servi√ßos
    document.querySelectorAll("#listaMateriaisCotacao input, #listaServicosCotacao input").forEach(inp => {
      if (inp.type === "checkbox") inp.checked = false;
      if (inp.type === "number") inp.value = "";
    });

    console.log("‚úÖ Formul√°rios limpos.");
  }

  /* ======================================================
     STATUS / LISTAGEM / RESPOSTA ‚Äî DEFINITIVO (CORRIGIDO)
  ====================================================== */

  /* ======================================================
     STATUS / LISTAGEM / RESPOSTA ‚Äî DEFINITIVO (CORRIGIDO)
  ====================================================== */

  /* (Fun√ß√£o duplicada removida) */

  // ...


  /* ======================================================
     STATUS / LISTAGEM / RESPOSTA ‚Äî DEFINITIVO (CORRIGIDO)
  ====================================================== */

  function verificarEncerradas() {
    const agora = new Date();
    const cotacoes = getCotacoes();
    let alterou = false;

    cotacoes.forEach(c => {
      // Ignora se j√° estiver fechada ou finalizada
      if (["fechada", "finalizada", "cancelada"].includes(c.status)) return;

      if (!c.dataFechamento) return;

      const fechamento = new Date(c.dataFechamento);
      if (isNaN(fechamento.getTime())) return;

      // ‚è∞ PRAZO ACABOU
      if (fechamento <= agora && !c.prazoEncerrado) {

        // Marca que o prazo encerrou (importante para travar respostas de fornecedores)
        c.prazoEncerrado = true;
        alterou = true;

        // üìä L√≥gica de Movimenta√ß√£o de Status
        if (c.status === "aberta") {
          // S√≥ move para 'analise' se tiver respostas!
          const temRespostas = Array.isArray(c.respostasFornecedores) && c.respostasFornecedores.length > 0;

          if (temRespostas) {
            c.status = "analise";
            console.log(`üîÑ Cota√ß√£o ${c.numero} movida para An√°lise (Prazo expirado com respostas).`);
          } else {
            console.log(`‚ÑπÔ∏è Cota√ß√£o ${c.numero} expirou mas continua Aberta (Sem respostas).`);
            // Mant√©m "aberta" para continuar vis√≠vel em Publicadas
          }
        }
      }
    });

    if (alterou) salvarCotacoes(cotacoes);
  }



  function mostrarAbaCotacao(tipo) {
    ["Abertas", "Respondidas", "Encerradas"].forEach(t => {
      const lista = document.getElementById("lista" + t);
      const btn = document.getElementById("btn" + t);
      if (lista) lista.style.display = "none";
      if (btn) btn.style.background = "#333";
    });

    const listaAtiva =
      document.getElementById("lista" + tipo.charAt(0).toUpperCase() + tipo.slice(1));
    const btnAtivo =
      document.getElementById("btn" + tipo.charAt(0).toUpperCase() + tipo.slice(1));

    if (listaAtiva) listaAtiva.style.display = "block";
    if (btnAtivo) btnAtivo.style.background = "#661155";

    carregarCotacoes(tipo).catch(console.error);
  }



  async function carregarCotacoes(tipo = "abertas") {
    verificarEncerradas();

    const usuario = getUsuarioLogado();
    if (!usuario) return;

    // üîç BUSCA NO FIRESTORE (COM MERGE INTELIGENTE PARA EVITAR PERDA)
    let cotacoes = [];
    try {
      // 1. Busca Local (Sempre existe)
      const localCotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];

      // 2. Busca Nuvem
      const snapshot = await db.collection("cotacoes").get();
      const cloudCotacoes = snapshot.docs.map(doc => doc.data());

      // 3. MERGE: Prioriza Nuvem, mas mant√™m locais que n√£o est√£o na nuvem (Recentes/Erro Quota)
      const mapCotacoes = new Map();

      // Adiciona Cloud primeiro (Fonte da Verdade)
      cloudCotacoes.forEach(c => mapCotacoes.set(c.id, c));

      // Adiciona Local se n√£o existir ou se for mais recente (Ex: acabou de criar e falhou upload)
      localCotacoes.forEach(c => {
        if (!mapCotacoes.has(c.id)) {
          console.warn(`‚ö†Ô∏è Mantendo cota√ß√£o local (n√£o sincronizada): ${c.numero}`);
          mapCotacoes.set(c.id, c);
        }
      });

      // Converte volta para array
      cotacoes = Array.from(mapCotacoes.values());

      // 4. Salva o Merge no LocalStorage (Agora seguro)
      localStorage.setItem("cotacoes", JSON.stringify(cotacoes));

    } catch (e) {
      console.warn("‚ö†Ô∏è Erro Firebase/Rede. Usando vers√£o Local:", e);
      cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    }

    const div = document.getElementById(
      "lista" + tipo.charAt(0).toUpperCase() + tipo.slice(1)
    );
    if (!div) return;

    div.innerHTML = "";

    cotacoes.forEach(c => {

      /* ======================================================
         üîí FORNECEDOR S√ì V√ä COTA√á√ïES EM QUE FOI CONVIDADO
      ====================================================== */
      if (usuario.tipo === "fornecedor") {
        const emailUser = normalizarEmail(usuario.email);
        const nomeUser = (usuario.nome || "").toLowerCase().trim();

        const foiConvidado = Array.isArray(c.fornecedores) && c.fornecedores.some(f => {
          if (typeof f === 'string') {
            const fLower = f.toLowerCase();
            return fLower.includes(emailUser) || fLower.includes(nomeUser);
          } else if (typeof f === 'object' && f !== null) {
            // üõ°Ô∏è FIX: Garante que tratamos array ou string corretamente
            let emailsRaw = f.email || f.emails || "";
            if (Array.isArray(emailsRaw)) emailsRaw = emailsRaw.join(",");

            const emailF = normalizarEmail(emailsRaw);
            const nomeF = (f.nome || "").toLowerCase().trim();
            return emailF.includes(emailUser) || (nomeF && nomeF === nomeUser);
          }
          return false;
        });

        if (!foiConvidado) return;
      }

      const encerrada = c.prazoEncerrado === true;

      /* ======================================================
         üîê FORNECEDOR J√Å RESPONDEU?
      ====================================================== */
      let respondeu = false;
      if (usuario.tipo === "fornecedor") {
        respondeu =
          Array.isArray(c.respostasFornecedores) &&
          c.respostasFornecedores.some(r =>
            normalizarEmail(r.email) === normalizarEmail(usuario.email)
          );
      }

      /* ======================================================
         üîé FILTRO POR ABA
      ====================================================== */
      if (usuario.tipo === "fornecedor") {
        if (tipo === "abertas" && (respondeu || encerrada)) return;
        if (tipo === "respondidas" && (!respondeu || encerrada)) return;
        if (tipo === "encerradas" && !encerrada) return;
      } else {
        // comprador / admin

        // üîë an√°lise aceita analise + reanalise
        if (tipo === "analise") {
          if (!["analise", "reanalise"].includes(c.status)) return;
        }
        else {
          if (c.status !== tipo.slice(0, -1)) return;
        }
      }


      /* ======================================================
         üîò BOT√ÉO DE A√á√ÉO
      ====================================================== */
      let botao = "";

      if (usuario.tipo === "fornecedor") {

        if (encerrada) {
          // üîí hist√≥rico
          botao = `
          <button onclick="abrirResponderCotacao('${c.numero}', 'visualizar')">
            üîç Detalhes
          </button>`;
        }

        else if (respondeu) {
          botao = `
          <button onclick="abrirResponderCotacao('${c.numero}', 'respondida')">
            üîç Detalhes
          </button>`;
        }

        else {
          botao = `
          <button onclick="abrirResponderCotacao('${c.numero}', 'novo')">
            Responder
          </button>`;
        }
        botao = `
        <button onclick="verDetalhesCotacao('${c.numero}')">
          üîç Detalhes
        </button>`;
      } else {
        // üõí COMPRADOR / ADMIN
        if (c.status === "analise" || c.status === "reanalise") {
          botao = `
        <button onclick="abrirAnalise('${c.numero}')" style="background:#661155; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          Analisar Resposta
        </button>`;
        } else if (c.status === "aprovacao") {
          botao = `
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
          <span style="color:#f39c12; font-weight:bold; display:flex; align-items:center; gap:5px;">
            <i class="fa-solid fa-clock"></i> Aguardando Aprova√ß√£o
          </span>
          <button onclick="abrirAnalise('${c.numero}')" style="background:#661155; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:12px;">
            üëÅÔ∏è Ver Detalhes
          </button>
        </div>`;
        } else if (c.status === "fechada") {
          botao = `
        <button onclick="abrirAnalise('${c.numero}')" style="background:#28a745; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          Ver Pedido
        </button>`;
        } else {
          botao = `
        <button onclick="verDetalhesCotacao('${c.numero}')" style="background:#333; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          Gerenciar
        </button>`;
        }
      }

      /* ======================================================
         üß± RENDER FINAL
      ====================================================== */
      div.innerHTML += `
      <div class="linha-cotacao">
        <div class="info">
          <div style="font-weight:bold; font-size:15px; color:#fff;">${c.descricao || "Sem descri√ß√£o"}</div>
          <div style="font-size:12px; color:#aaa; margin-top:4px;">
            <strong>#${c.numero}</strong> ${window.obterBadgeWorkflow(c.status)}
          </div>
        </div>
        <div class="acoes">
          ${botao}
        </div>
      </div>
    `;
    });
  }



  /* ======================================================
     üöö FORNECEDOR ‚Äî ABRIR COTA√á√ÉO (RESPONDER / DETALHES)
  ====================================================== */

  let cotacaoRespostaAtual = null;

  function verDetalhesCotacao(numero) {
    // Reutiliza a fun√ß√£o de abrir em modo de visualiza√ß√£o
    abrirResponderCotacao(numero, 'visualizar');
  }

  function abrirResponderCotacao(numero, modo = "novo") {
    const usuario = getUsuarioLogado();
    if (!usuario || !usuario.email) {
      alert("Usu√°rio n√£o identificado.");
      return;
    }

    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === numero);

    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada.");
      return;
    }

    cotacaoRespostaAtual = numero;

    document.getElementById("respNumero").innerText = cotacao.numero;
    document.getElementById("respDescricao").innerText = cotacao.descricao || "-";
    document.getElementById("respDataCriacao").innerText = cotacao.dataCriacao || "-";
    document.getElementById("respDataFechamento").innerText =
      formatarDataHoraBR(cotacao.dataFechamento);

    /* ======================================================
       ‚è≥ L√ìGICA DO TIMER
    ====================================================== */
    const timerDisplay = document.getElementById("timerDisplay");

    // Limpa timer anterior se houver
    if (window.timerCotacaoInterval) {
      clearInterval(window.timerCotacaoInterval);
    }

    function atualizarTimer() {
      if (!cotacao.dataFechamento) {
        if (timerDisplay) timerDisplay.innerText = "--";
        return;
      }

      // Parser seguro da data (considerando o formato BR ou ISO)
      let dataFim;
      const valor = String(cotacao.dataFechamento).trim();
      if (valor.includes('/')) {
        const [data, hora] = valor.split(',');
        const [dia, mes, ano] = data.trim().split('/');
        const horaLimpa = (hora || "00:00:00").trim();
        dataFim = new Date(`${ano}-${mes}-${dia}T${horaLimpa}`);
      } else {
        dataFim = new Date(valor);
      }

      const agora = new Date();
      const diff = dataFim - agora;

      if (diff <= 0) {
        if (timerDisplay) {
          timerDisplay.innerText = "EXPIRADO";
          timerDisplay.style.color = "#ff5555";
        }
        clearInterval(window.timerCotacaoInterval);
        // Opcional: Bloquear inputs se quiser
        return;
      }

      const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
      const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const segundos = Math.floor((diff % (1000 * 60)) / 1000);

      if (timerDisplay) {
        timerDisplay.innerText = `${dias}d ${horas}h ${minutos}m ${segundos}s`;
        timerDisplay.style.color = "#00ff99";
      }
    }

    // Inicia imediatamente
    atualizarTimer();
    window.timerCotacaoInterval = setInterval(atualizarTimer, 1000);

    /* ======================================================
       FIM TIMER
    ====================================================== */

    const tbody = document.getElementById("tabelaResponderCorpo");
    tbody.innerHTML = "";

    cotacao.produtos.forEach((p, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td style="text-align: left; padding-left: 12px;">${p.nome}</td>
      <td style="text-align: center;">${p.marca || "-"}</td>
      <td style="text-align: center;">${p.quantidade}</td>
      <td style="text-align: center;">
        <input type="number" min="0" step="0.01" id="preco_${i}" style="width: 80px; text-align: center;">
      </td>
    `;
      tbody.appendChild(tr);
    });

    // üßπ LIMPEZA DE ARQUIVO (EFICAZ PARA NOVO UPLOAD)
    const inputAnexo = document.getElementById("respAnexo");
    if (inputAnexo) inputAnexo.value = "";

    const email = usuario.email.toLowerCase().trim();
    const chave = `resposta_${numero}_${email}`;
    const respostaRaw = localStorage.getItem(chave);

    if (respostaRaw) {
      const resposta = JSON.parse(respostaRaw);
      (resposta.itens || []).forEach((item, i) => {
        const input = document.getElementById("preco_" + i);
        if (input) input.value = item.preco ?? 0;
      });
    }

    // üîë CONTROLE DE MODO DEFINITIVO
    if (cotacao.prazoEncerrado) {
      configurarModalResposta("encerrada");
    } else if (respostaRaw) {
      configurarModalResposta("respondida");
    } else {
      configurarModalResposta("novo");
    }

    document.getElementById("modalResponder").style.display = "flex";
  }



  /* ======================================================
     üîÅ ALIAS DE COMPATIBILIDADE (N√ÉO REMOVER)
  ====================================================== */
  window.abrirPainelResponderCotacao = function (numero) {
    abrirResponderCotacao(numero, "novo");
  };

  /* ======================================================
     ‚ùå FECHAR MODAL RESPONDER (DEFINITIVO)
  ====================================================== */
  function fecharModalResponder() {
    const modal = document.getElementById("modalResponder");
    if (!modal) {
      console.warn("modalResponder n√£o encontrado");
      return;
    }

    modal.style.display = "none";
    document.body.style.overflow = "auto"; // üîì Unlock background scroll
    cotacaoRespostaAtual = null;

    // üõë Para o timer
    if (window.timerCotacaoInterval) {
      clearInterval(window.timerCotacaoInterval);
      window.timerCotacaoInterval = null;
    }

    // üîí limpeza opcional
    document
      .querySelectorAll("#tabelaResponderCorpo input")
      .forEach(inp => {
        inp.value = "";
        inp.disabled = false;
      });
  }

  // üîë garante acesso global (IMPORTANTE)
  window.fecharModalResponder = fecharModalResponder;


  function habilitarEdicaoResposta() {
    // libera inputs
    document
      .querySelectorAll("#tabelaResponderCorpo input")
      .forEach(inp => inp.disabled = false);

    const anexo = document.getElementById("respAnexo");
    if (anexo) anexo.disabled = false;

    // troca bot√µes
    document.getElementById("btnEditarResposta").style.display = "none";
    document.getElementById("btnEnviarResposta").style.display = "inline-block";
  }

  function configurarModalResposta(modo = "novo") {
    const inputs = document.querySelectorAll("#tabelaResponderCorpo input");
    const btnEditar = document.getElementById("btnEditarResposta");
    const btnEnviar = document.getElementById("btnEnviarResposta");

    if (!btnEditar || !btnEnviar) return;

    // reset
    btnEditar.style.display = "none";
    btnEnviar.style.display = "none";

    if (modo === "novo") {
      // üì¨ ABERTA
      inputs.forEach(i => i.disabled = false);
      btnEnviar.style.display = "inline-block";
      btnEnviar.innerText = "üì§ Enviar Resposta";
    }

    if (modo === "respondida") {
      // üì§ RESPONDIDA (VISUALIZA, MAS PODE EDITAR)
      inputs.forEach(i => i.disabled = true);
      btnEditar.style.display = "inline-block";
    }

    if (modo === "editar") {
      // ‚úèÔ∏è EDITANDO
      inputs.forEach(i => i.disabled = false);
      btnEnviar.style.display = "inline-block";
      btnEnviar.innerText = "üì§ Enviar Resposta Editada";
    }

    if (modo === "encerrada") {
      // üîí HIST√ìRICO
      inputs.forEach(i => i.disabled = true);
      // nenhum bot√£o aparece
    }
  }
  /* ======================================================
     üìã CARREGAR COTA√á√ïES RESPONDIDAS (AJUSTADA)
     - Aceita string ou array de status
     - Suporta: respondida / reanalise / aprovacao / fechada
  ====================================================== */
  window.encerrarCotacaoManualmente = function (numero) {
    if (!confirm(`Deseja realmente encerrar a cota√ß√£o #${numero} agora? Ela ser√° movida para An√°lise.`)) return;

    const cotacoes = getCotacoes();
    const cot = cotacoes.find(c => c.numero === numero);
    if (!cot) return;

    cot.status = "analise";
    cot.prazoEncerrado = true;
    cot.dataFechamento = new Date().toLocaleString(); // Define agora como fechamento

    salvarCotacoes(cotacoes);
    alert("‚úÖ Cota√ß√£o encerrada com sucesso!");
    toggleListaRespondidas("publicadas");
  };

  window.filtrarCotacoesInstantaneo = function () {
    const btnAtivo = document.querySelector('.btn-status.ativo');
    if (!btnAtivo) return;

    const idAba = btnAtivo.id;
    const statusMap = {
      'btnPublicadas': 'publicadas',
      'btnAnalise': 'analise',
      'btnAprovacao': 'aprovacao',
      'btnFechadas': 'fechada'
    };

    const statusAba = statusMap[idAba];
    if (statusAba) {
      const map = {
        'publicadas': { listId: 'listaPublicadas', status: 'aberta' },
        'analise': { listId: 'listaAnalise', status: ["respondida", "reanalise", "analise"] },
        'aprovacao': { listId: 'listaAprovacao', status: 'aprovacao' },
        'fechada': { listId: 'listaFechadas', status: 'fechada' }
      };
      const target = map[statusAba];
      const listEl = document.getElementById(target.listId);
      if (listEl) carregarRespondidas(target.status, listEl);
    }
  };

  function carregarRespondidas(status, container) {

    const cotacoes = getCotacoes(); // TODAS
    const usuario = getUsuarioLogado();

    container.innerHTML = "";

    // üîë normaliza status para array
    const statusFiltro = Array.isArray(status) ? status : [status];

    function fornecedorRespondeu(cotacao, email) {
      return Array.isArray(cotacao.respostasFornecedores) &&
        cotacao.respostasFornecedores.some(r =>
          normalizarEmail(r.email) === normalizarEmail(email)
        );
    }

    // üîç BUSCA
    const busca = document.getElementById("buscaCotacaoRespondida")?.value.toLowerCase().trim() || "";

    const filtrarPorBusca = (list) => {
      if (!busca) return list;
      return list.filter(c =>
        (c.numero && String(c.numero).toLowerCase().includes(busca)) ||
        (c.descricao && c.descricao.toLowerCase().includes(busca))
      );
    };

    let filtradas = [];

    /* ===========================
       üöö FORNECEDOR
    ============================ */
    if (usuario.tipo === "fornecedor") {

      filtradas = cotacoes.filter(c =>
        statusFiltro.includes(c.status) &&
        fornecedorRespondeu(c, usuario.email)
      );

    }
    /* ===========================
       üëî ADMIN / COMPRADOR / APROVADOR
    ============================ */
    else {
      filtradas = cotacoes.filter(c =>
        statusFiltro.includes(c.status)
      );
    }

    // Aplica o filtro de busca final
    filtradas = filtrarPorBusca(filtradas);

    if (filtradas.length === 0) {
      container.innerHTML =
        "<p style='text-align:center;'>Nenhuma cota√ß√£o encontrada.</p>";
      return;
    }

    // List each quotation
    filtradas.forEach(c => {

      const respostas = Array.isArray(c.respostasFornecedores) ? c.respostasFornecedores : [];
      const qtdRespostas = usuario.tipo === "fornecedor" ? 1 : respostas.length;
      const qtdConvidados = Array.isArray(c.fornecedores) ? c.fornecedores.length : 0;
      /* cleanup start */
      /* cleaning... */
      /* cleanup point 1 */
      /* line removed */

      /* line removed */
      /* line removed */

      const bloco = document.createElement("div");
      bloco.className = "linha-cotacao";

      if (c.status === "aberta") {
        const agora = new Date();
        const fim = new Date(c.dataFechamento);
        const diffMs = fim - agora;
        let tempoRestante = "Expirado";

        if (diffMs > 0) {
          const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
          tempoRestante = `${dias}d ${horas}h ${minutos}m`;
        }

        bloco.innerHTML = `
          <div class="info">
            <div style="font-weight:bold; font-size:16px; color:#fff;">${c.descricao || "Sem descri√ß√£o"}</div>
            <div style="margin-top:5px; font-size:12px; color:#aaa;">
               <strong>Cota√ß√£o #${c.numero}</strong> <span style="background:#555; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:5px; color:white;">üì¢ Publicada</span>
            </div>
            <div style="margin-top:5px; color:#ccc; font-size:13px;">
              <span>üë§ Com fornecedores (${qtdConvidados} convidados)</span><br>
              <span>üì© Respostas atuais: <b style="color:#0dcaf0;">${qtdRespostas}</b></span><br>
              <span style="color:${diffMs > 0 ? '#3ab9b6' : '#ff5555'};">‚è≥ Tempo restante: <b>${tempoRestante}</b></span>
            </div>
          </div>
          <div class="acoes" style="display:flex; flex-wrap:wrap; gap:8px;">
             <button onclick="encerrarCotacaoManualmente('${c.numero}')" style="background:#cc0000; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;" title="Encerrar cota√ß√£o agora">
                üîí Encerrar
             </button>
             
             <!-- Novos Bot√µes Solicitados -->
             <button onclick="reabrirCotacao('${c.numero}')" style="background:#e0a800; color:#000; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold;" title="Estender prazo por 3 dias">
                üîÑ Reabrir / Estender
             </button>
             <button onclick="excluirCotacao('${c.numero}')" style="background:transparent; border:1px solid #ff4444; color:#ff4444; padding:8px 12px; border-radius:5px; cursor:pointer;" title="Excluir Cota√ß√£o">
                <i class="fa-solid fa-trash"></i>
             </button>
          </div>
        `;
      } else {
        bloco.innerHTML = `
          <div class="info">
            <div style="font-weight:bold; font-size:15px; color:#fff;">${c.descricao || "Sem descri√ß√£o"}</div>
            <div style="font-size:12px; color:#aaa; margin-top:4px;">
              <strong>Cota√ß√£o #${c.numero}</strong>
            </div>
            <div style="margin-top:4px; font-size:13px; color:#ccc;">
              ${usuario.tipo === "fornecedor"
            ? "‚úÖ Voc√™ respondeu"
            : `Respostas recebidas: <b>${qtdRespostas}</b>`}
              ${c.status === "reanalise"
            ? "<br><span style='color:#ff5555;'>‚ùå Rejeitada ‚Äî voltou para an√°lise</span>"
            : ""}
              ${c.status === "fechada" ? "<br><span style='color:#0dcaf0;'>üèÅ Conclu√≠da</span>" : ""}
            </div>
          </div>

          <div class="acoes" style="display:flex; gap:10px;">
            <button onclick="analisarCotacao('${c.numero}')" style="background:#661155; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">
              üìä Analisar Respostas
            </button>
          </div>
        `;
      }

      container.appendChild(bloco);
    });
  }


  /* function abrirTela movida para consolida√ß√£o no final do script */

  /* ======================================================
     üì§ ENVIAR RESPOSTA ‚Äî DEFINITIVO (SEM VAZAMENTO)
  ====================================================== */
  /* ======================================================
     üì§ ENVIAR RESPOSTA ‚Äî COM UPLOAD DE ARQUIVO (ASYNC)
  ====================================================== */
  window.salvarRespostaComAnexo = async function (anexoArg = null) {
    const fileInput = document.getElementById("respAnexo");

    // üïµÔ∏è DEBUG PARA O USU√ÅRIO (REMOVIDO PARA PRODU√á√ÉO)
    // if (fileInput && fileInput.files.length > 0) { /* alert(`DEBUG SISTEMA: Arquivo identificado!\nNome: ${ fileInput.files[0].name } `); */ }

    const processarSalvamento = async (anexoFinal) => {
      if (!cotacaoRespostaAtual) {
        alert("Cota√ß√£o inv√°lida.");
        return;
      }

      const usuario = getUsuarioLogado();
      if (!usuario || !usuario.email) {
        alert("Usu√°rio n√£o identificado.");
        return;
      }

      const cotacoes = getCotacoes();

      const index = cotacoes.findIndex(
        c => c.numero === cotacaoRespostaAtual
      );

      if (index === -1) {
        alert("Cota√ß√£o n√£o encontrada.");
        return;
      }

      const cotacao = cotacoes[index];

      /* ======================
         üîí VALIDA√á√ïES
      ====================== */
      if (cotacao.status === "fechada") {
        alert("Esta cota√ß√£o j√° est√° fechada.");
        return;
      }

      if (!validarPrazo(cotacao)) {
        alert("üö´ O prazo desta cota√ß√£o expirou.");
        return;
      }

      /* ======================
         üì¶ COLETA ITENS
      ====================== */
      const itens = cotacao.produtos.map((p, i) => {
        const input = document.getElementById("preco_" + i);
        const valor = Number(String(input?.value || "").replace(",", "."));

        return {
          produto: p.nome,
          quantidade: p.quantidade,
          preco: isNaN(valor) ? 0 : valor
        };
      });

      /* ======================
         üìé SALVA ANEXO NOS DOCS DA COTA√á√ÉO (CLOUD)
      ===================== */
      if (anexoFinal) {
        const docsKey = `docs_${cotacao.numero}`;

        // Agora salvamos a refer√™ncia do anexo no Firestore tamb√©m para hist√≥rico
        try {
          const docRef = db.collection("documentos_cotacao").doc(docsKey);
          const currentDocs = (await docRef.get()).data()?.arquivos || [];
          currentDocs.push(anexoFinal);
          await docRef.set({ arquivos: currentDocs });

          console.log("‚úÖ Refer√™ncia do arquivo salva no Firestore");
        } catch (e) {
          console.warn("Falha ao salvar refer√™ncia no Firestore, tentando Local:", e);
          let docs = await dbDocs.buscar(docsKey) || [];
          docs.push(anexoFinal);
          await dbDocs.salvar(docsKey, docs);
        }
      } else {
        alert("‚ö†Ô∏è AVISO: A resposta foi enviada SEM nenhum anexo!");
      }

      /* ======================
         üîí SINCRONIZA COTA√á√ÉO NO FIRESTORE
      ====================== */
      // Atualiza a cota√ß√£o no Firestore com a nova resposta
      await db.collection("cotacoes").doc(String(cotacao.numero)).set(cotacao);

      /* ======================
         üîí ATUALIZA RESPOSTAS
      ====================== */

      // garante array
      cotacao.respostasFornecedores = Array.isArray(cotacao.respostasFornecedores)
        ? cotacao.respostasFornecedores
        : [];

      // remove resposta anterior deste fornecedor
      cotacao.respostasFornecedores = cotacao.respostasFornecedores.filter(
        r => normalizarEmail(r.email) !== normalizarEmail(usuario.email)
      );

      // nova resposta (SEM BASE64 no storage principal para n√£o estourar quota)
      const respostaFornecedor = {
        numeroCotacao: cotacao.numero,
        email: usuario.email,
        fornecedor: usuario.nome,
        data: new Date().toLocaleString(),
        itens,
        temAnexo: !!anexoFinal // Apenas indicador, o arquivo real est√° no IDB
      };

      cotacao.respostasFornecedores.push(respostaFornecedor);

      /* ======================
         üîë STATUS (IMPORTANTE)
         Mant√©m como aberta se ainda estiver no prazo (n√£o muda para respondida automaticamente)
      ====================== */
      // Removido a altera√ß√£o autom√°tica para 'respondida' pois o usu√°rio quer que continue em Publicadas
      // if (cotacao.status === "aberta") {
      //   cotacao.status = "respondida";
      // }

      /* ======================
         üíæ SALVA COTA√á√ÉO
      ====================== */
      salvarCotacoes(cotacoes);

      /* ======================
         üî• BACKUP INDIVIDUAL
      ====================== */
      const emailNormalizado = usuario.email.toLowerCase().trim();
      const chaveIndividual = `resposta_${cotacao.numero}_${emailNormalizado} `;

      localStorage.setItem(
        chaveIndividual,
        JSON.stringify(respostaFornecedor)
      );

      alert("‚úÖ Resposta enviada com sucesso!");

      fecharModalResponder();

      /* ======================
         üîÑ ATUALIZA LISTA
      ====================== */
      if (typeof carregarCotacoes === "function") {
        carregarCotacoes("respondidas");
      }
    };

    // 3. Processamento do Arquivo (F√çSICO NO STORAGE)
    const file = (!anexoArg && fileInput && fileInput.files.length > 0) ? fileInput.files[0] : null;

    if (file) {
      try {
        const msg = document.getElementById("msgSalvarResposta") || { innerText: "" };
        msg.innerText = "‚åõ Fazendo upload do arquivo para nuvem...";

        // Caminho no Storage: cotacoes/NUMERO/EMAIL_NOMEARQUIVO
        const usuario = getUsuarioLogado();
        const storageRef = storage.ref(`cotacoes/${cotacaoRespostaAtual}/${usuario.email}_${file.name}`);

        const uploadTask = await storageRef.put(file);
        const downloadURL = await uploadTask.ref.getDownloadURL();

        const novoAnexo = {
          nome: file.name,
          tipo: "Or√ßamento",
          data: new Date().toLocaleString(),
          tamanho: (file.size / 1024).toFixed(2) + " KB",
          url: downloadURL, // Link real da nuvem
          usuario: usuario.nome
        };

        await processarSalvamento(novoAnexo);
      } catch (error) {
        console.error("Erro no upload:", error);
        alert("‚ùå Falha ao enviar arquivo para o servidor. Verifique sua conex√£o.");
      }
    } else {
      await processarSalvamento(anexoArg);
    }
  };


  /* ======================================================
     üíæ SALVA RESPOSTA (SUBSTITUI NO ARRAY)
  ====================================================== */
  function salvarRespostaCorreta() {
    let idCotacao = document.getElementById('numCotacao').innerText;

    // 1. Pega o ID do fornecedor que est√° logado no momento
    let usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    let idFornecedor = usuarioLogado.id;

    let dadosDaResposta = {
      fornecedorNome: usuarioLogado.nome,
      data: new Date().toLocaleDateString(),
      precos: []
    };

    // 2. Captura os pre√ßos
    document.querySelectorAll('.input-preco').forEach(input => {
      dadosDaResposta.precos.push({
        produto: input.dataset.nome,
        valor: input.value
      });
    });

    // 3. O SEGREDO: A chave agora leva o ID da cota√ß√£o E o ID do fornecedor
    // Exemplo de chave: "resposta_105_forn_7"
    let chaveUnica = "res_" + idCotacao + "_forn_" + idFornecedor;

    localStorage.setItem(chaveUnica, JSON.stringify(dadosDaResposta));

    alert("Sua resposta foi enviada com sucesso e n√£o aparecer√° para outros!");
  }


  function atualizarStatusCotacao({ cotacao, acao, usuario }) {

    // status atual
    const statusAtual = cotacao.status || "aberta";

    // ‚õî nunca muda se j√° estiver fechada
    if (statusAtual === "fechada") {
      return statusAtual;
    }

    // ‚úÖ 1. Fornecedor enviou resposta
    if (acao === "enviar_resposta" && usuario.tipo === "fornecedor") {
      // N√ÉO muda status global
      // resposta √© individual
      return statusAtual; // continua aberta
    }

    // ‚úÖ 2. Comprador fechou manualmente
    if (acao === "fechar_manual" && usuario.tipo === "comprador") {
      cotacao.status = "fechada";
      return "fechada";
    }

    // ‚úÖ 3. Prazo acabou
    if (acao === "prazo_expirado") {
      cotacao.status = "fechada";
      return "fechada";
    }

    // üîí QUALQUER OUTRA COISA ‚Üí BLOQUEIA
    return statusAtual;
  }

  /* ======================================================
     STEPPER VISUAL WORKFLOW HELPER
  ====================================================== */
  function gerarStepperHTML(status) {
    const steps = [
      { id: 'pendente', label: 'Requisi√ß√£o' },
      { id: 'em_cotacao', label: 'Cota√ß√£o' },
      { id: 'respondida', label: 'An√°lise' },
      { id: 'aprovacao', label: 'Aprova√ß√£o' },
      { id: 'fechada', label: 'Pedido' },
      { id: 'finalizada', label: 'Finalizado' }
    ];

    // Mapeamento de progresso
    let activeIndex = 0;
    if (status === 'em_cotacao') activeIndex = 1;
    if (status === 'respondida' || status === 'reanalise') activeIndex = 2;
    if (status === 'aprovacao') activeIndex = 3;
    if (status === 'fechada') activeIndex = 4;
    if (status === 'finalizada') activeIndex = 5;

    let html = `
        <div class="stepper-container" style="margin-bottom:30px;">
          <div class="progress-bar-stepper" style="width: ${(activeIndex / (steps.length - 1)) * 100}%"></div>
      `;

    steps.forEach((step, index) => {
      let cssClass = '';
      if (index < activeIndex) cssClass = 'completed';
      if (index === activeIndex) cssClass = 'active';

      html += `
        <div class="step-item ${cssClass}">
          <div class="step-circle">${index + 1}</div>
          <div class="step-label">${step.label}</div>
        </div>
        `;
    });

    html += `</div>`;
    return html;
  }

  /* ======================================================
     üìä MATRIZ DE ADJUDICA√á√ÉO ‚Äî AN√ÅLISE DE COTA√á√ÉO (COMPRADOR)
  ====================================================== */
  /* ======================================================
     üìä AN√ÅLISE DE COTA√á√ÉO (COMPRADOR) - UNIFICADO
     Redireciona para renderizarTabelaAnalise para garantir
     l√≥gica √∫nica e corre√ß√£o de bugs visuais.
  ====================================================== */
  window.analisarCotacao = function (numero) {
    const modal = document.getElementById("modalAnaliseCotacao");
    if (modal) {
      // Garante estado inicial
      modal.style.display = "flex";
      document.body.style.overflow = "hidden"; // üîí Lock background scroll

      // Renderiza usando a fun√ß√£o principal mais completa
      renderizarTabelaAnalise(numero);
    }
  };

  window.fecharModalAnalise = function () {
    document.getElementById("modalAnaliseCotacao").style.display = "none";
    document.body.style.overflow = "auto"; // üîì Unlock background scroll
  };




  /* ======================================================
     üßæ GERAR PEDIDO DE COMPRA (PDF) ‚Äî DEFINITIVO
  ====================================================== */
  function gerarPedidoCompraPDF() {
    const { jsPDF } = window.jspdf;

    const c = window.cotacaoAtualPDF;
    if (!c) {
      alert("Nenhuma cota√ß√£o selecionada.");
      return;
    }

    if (!Array.isArray(c.adjudicacao) || c.adjudicacao.length === 0) {
      alert("‚ö†Ô∏è Esta cota√ß√£o n√£o possui itens adjudicados.");
      return;
    }

    // üîÑ Agrupa itens por fornecedor
    const itensPorFornecedor = {};
    c.adjudicacao.forEach(item => {
      const forn = item.fornecedor || "Fornecedor n√£o identificado";
      if (!itensPorFornecedor[forn]) itensPorFornecedor[forn] = [];
      itensPorFornecedor[forn].push(item);
    });

    // üöÄ Gera um PDF para cada fornecedor
    Object.entries(itensPorFornecedor).forEach(([fornecedorNome, itens]) => {
      const doc = new jsPDF("p", "mm", "a4");
      const pageWidth = doc.internal.pageSize.getWidth();
      let y = 15;

      /* ================= LOGO ================= */
      const customLogo = localStorage.getItem("logoBase64");
      if (customLogo) {
        try {
          doc.addImage(customLogo, "PNG", pageWidth - 45, 10, 30, 30);
        } catch (e) {
          desenharLogoPadrao(doc, pageWidth);
        }
      } else {
        desenharLogoPadrao(doc, pageWidth);
      }

      function desenharLogoPadrao(doc, pageWidth) {
        let logoX = pageWidth - 45;
        let logoY = 10;
        const corTurquesa = [58, 185, 182];
        const corRoxo = [102, 17, 85];
        doc.setFillColor(corTurquesa[0], corTurquesa[1], corTurquesa[2]);
        doc.ellipse(logoX + 7, logoY + 12, 7, 7, "F");
        doc.setFillColor(corRoxo[0], corRoxo[1], corRoxo[2]);
        doc.roundedRect(logoX + 11, logoY + 4, 11, 12, 2, 2, "F");
        doc.setTextColor(corRoxo[0], corRoxo[1], corRoxo[2]);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("ORAL UNIC", logoX - 35, logoY + 10, { align: "right" });
        doc.setFontSize(7);
        doc.setFont("helvetica", "normal");
        doc.text("IMPLANTES PREMIUM", logoX - 35, logoY + 14, { align: "right" });
      }

      /* ================= CABE√áALHO ================= */
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("O.U. CAMPO GRANDE CL√çNICA ODONTOL√ìGICA LTDA", pageWidth / 2, y, { align: "center" });
      y += 6;
      doc.setFontSize(11);
      doc.text("Nome Fantasia: ORAL UNIC", pageWidth / 2, y, { align: "center" });
      y += 6;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("CNPJ: 30.882.538/0001-38", pageWidth / 2, y, { align: "center" });
      y += 5;
      doc.text("Telefone: (67) 3304-9400", pageWidth / 2, y, { align: "center" });
      y += 5;
      doc.text("Av. Afonso Pena, 2728 - Centro", pageWidth / 2, y, { align: "center" });
      y += 5;
      doc.text("CEP 79.002-075 - Campo Grande - MS", pageWidth / 2, y, { align: "center" });
      y += 8;
      doc.line(10, y, pageWidth - 10, y);
      y += 10;

      /* ================= DADOS DO PEDIDO ================= */
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text(`Pedido de Compra - ${c.numero} `, 10, y);
      y += 6;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Data: ${new Date().toLocaleDateString()} `, 10, y);
      y += 8;
      doc.setFont("helvetica", "bold");
      doc.text(`Fornecedor: ${fornecedorNome} `, 10, y);
      y += 8;

      /* ================= TABELA ================= */
      const colX = { item: 10, qtd: 110, preco: 135, total: 165 };
      doc.setFont("helvetica", "bold");
      doc.rect(10, y, pageWidth - 20, 8);
      doc.text("Descri√ß√£o", colX.item, y + 5);
      doc.text("Qtd", colX.qtd, y + 5);
      doc.text("Pre√ßo Unit.", colX.preco, y + 5);
      doc.text("Total", colX.total, y + 5);
      y += 8;

      doc.setFont("helvetica", "normal");
      let totalPedido = 0;
      itens.forEach(item => {
        const totalItem = Number(item.preco) * Number(item.quantidade);
        totalPedido += totalItem;
        doc.rect(10, y, pageWidth - 20, 8);
        doc.text(item.produto, colX.item, y + 5);
        doc.text(String(item.quantidade), colX.qtd, y + 5);
        doc.text(`R$ ${Number(item.preco).toFixed(2)} `, colX.preco, y + 5);
        doc.text(`R$ ${totalItem.toFixed(2)} `, colX.total, y + 5);
        y += 8;
      });

      /* ================= TOTAL ================= */
      y += 6;
      doc.setFont("helvetica", "bold");
      doc.text(`Total do Pedido: R$ ${totalPedido.toFixed(2)} `, pageWidth - 10, y, { align: "right" });

      /* ================= SALVAR ================= */
      doc.save(`Pedido_Compra_${c.numero}_${fornecedorNome.replace(/\s+/g, '_')}.pdf`);
    });
  }



  /* ======================================================
     TOGGLE LISTA RESPONDIDAS (FILTRO)
  ====================================================== */
  window.toggleListaRespondidas = async function (modo) {
    const usuario = getUsuarioLogado();
    if (!usuario) return;

    // üî• SINCRONIZA COTA√á√ïES COM FIRESTORE ANTES DE RENDERIZAR
    try {
      const snapshot = await db.collection("cotacoes").get();
      const listaCotacoes = snapshot.docs.map(doc => doc.data());
      localStorage.setItem("cotacoes", JSON.stringify(listaCotacoes));
      console.log("‚úÖ Cota√ß√µes sincronizadas para listagem");
    } catch (e) {
      console.warn("‚ö†Ô∏è Usando dados locais para listagem:", e);
    }

    // 1. Reset buttons
    document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('ativo'));

    // 2. Hide all lists
    const listas = ['listaPublicadas', 'listaAnalise', 'listaAprovacao', 'listaFechadas'];
    listas.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

    // 3. Setup based on mode
    let targetId = '';
    let statusFiltro = '';
    let btnId = '';

    switch (modo) {
      case 'publicadas':
        targetId = 'listaPublicadas';
        statusFiltro = 'aberta';
        btnId = 'btnPublicadas';
        break;
      case 'analise':
        targetId = 'listaAnalise';
        statusFiltro = ['analise', 'reanalise'];
        btnId = 'btnAnalise';
        break;
      case 'aprovacao':
        targetId = 'listaAprovacao';
        statusFiltro = 'aprovacao';
        btnId = 'btnAprovacao';
        break;
      case 'fechada':
        targetId = 'listaFechadas';
        statusFiltro = 'fechada';
        btnId = 'btnFechadas';
        break;
    }

    const container = document.getElementById(targetId);
    const btn = document.getElementById(btnId);

    if (container) {
      container.style.display = 'block';
      if (btn) btn.classList.add('ativo');
      carregarRespondidas(statusFiltro, container);
    }
  };

  function renderizarListaParaFornecedor(filtroStatus) {
    const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
    const todasCotacoes = JSON.parse(localStorage.getItem('cotacoes')) || [];
    const container = document.getElementById('listaCotacoesParaResponder');
    container.innerHTML = "";

    todasCotacoes.forEach(cot => {
      // Verifica se este fornecedor est√° convidado para esta cota√ß√£o
      if (cot.fornecedores.includes(usuario.nome) || cot.fornecedores.includes(usuario.email)) {

        const chaveRes = `res_${cot.id}_${usuario.email.toLowerCase()} `;
        const jaRespondeu = localStorage.getItem(chaveRes) !== null;

        // L√≥gica de Separa√ß√£o:
        if (filtroStatus === 'abertas' && !jaRespondeu) {
          container.innerHTML += criarCardCotacao(cot, false);
        } else if (filtroStatus === 'respondidas' && jaRespondeu) {
          container.innerHTML += criarCardCotacao(cot, true);
        }
      }
    });
  }

  function renderizarListaFornecedor(aba = 'abertas') {
    const usuario = JSON.parse(sessionStorage.getItem("usuario_logado"));
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    const listaDiv = document.getElementById("listaCotacoesParaResponder");
    listaDiv.innerHTML = "";

    cotacoes.forEach(cot => {
      // Verifica se o fornecedor est√° na lista desta cota√ß√£o
      const convidado = cot.fornecedores.includes(usuario.nome) || cot.fornecedores.includes(usuario.email);
      if (!convidado) return;

      // üîë Busca se j√° existe resposta para esta cota√ß√£o + este usu√°rio
      const chaveRes = `res_${cot.id}_${usuario.email.toLowerCase().trim()} `;
      const jaRespondeu = localStorage.getItem(chaveRes) !== null;

      // L√≥gica das abas
      if (aba === 'abertas' && jaRespondeu) return; // Se j√° respondeu, n√£o mostra em abertas
      if (aba === 'respondidas' && !jaRespondeu) return; // Se n√£o respondeu, n√£o mostra em respondidas

      const card = document.createElement("div");
      card.className = "linha-cotacao";

      // Verifica se expirou para mudar o bot√£o
      const expirada = new Date() > new Date(cot.dataFechamento);
      const statusTexto = expirada ? "<span style='color:red'>(Expirada)</span>" : "";

      card.innerHTML = `
        <div class="info">
          <strong>${cot.descricao}</strong> ${statusTexto}<br>
                <small>Prazo: ${new Date(cot.dataFechamento).toLocaleString()}</small>
            </div>
            <div class="acoes">
                <button onclick="abrirModalResponder('${cot.id}')">
                    ${jaRespondeu ? (expirada ? "üëÅÔ∏è Ver" : "‚úèÔ∏è Editar") : "üìÑ Responder"}
                </button>
            </div>
      `;
      listaDiv.appendChild(card);
    });
  }

  /* ======================================================
     üöÄ FUN√á√ÉO: ENVIAR RESPOSTA (INDIVIDUAL POR FORNECEDOR)
     ====================================================== */
  function enviarRespostaCotacao(numeroCotacao) {
    try {
      // üîë Recupera usu√°rio logado (sessionStorage)
      const usuarioRaw = sessionStorage.getItem("usuario_logado");
      if (!usuarioRaw) {
        alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
        return;
      }

      const usuario = JSON.parse(usuarioRaw);

      // üîé Busca cota√ß√£o correta
      const todasCotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      const cotacao = todasCotacoes.find(c => c.numero === numeroCotacao);

      if (!cotacao) {
        alert("‚ùå Cota√ß√£o n√£o encontrada. Recarregue a p√°gina.");
        return;
      }

      // üö´ Verifica√ß√£o de status
      if (cotacao.status === "fechada") {
        alert("üö´ Esta cota√ß√£o j√° foi encerrada.");
        return;
      }

      // ‚è∞ Verifica√ß√£o de prazo (FUN√á√ÉO CENTRAL)
      if (!validarPrazo(cotacao)) {
        alert("üö´ O prazo desta cota√ß√£o expirou.");
        return;
      }

      // üì¶ Coleta dos itens respondidos
      const linhas = document.querySelectorAll("#tabelaResponderCorpo tr");
      const itensRespondidos = [];

      linhas.forEach(linha => {
        const produto = linha.cells[0]?.innerText?.trim();
        const inputPreco = linha.querySelector('input[type="number"]');

        if (produto && inputPreco) {
          const valor = parseFloat(inputPreco.value);
          itensRespondidos.push({
            produto: produto,
            preco: isNaN(valor) ? 0 : valor
          });
        }
      });

      if (itensRespondidos.length === 0) {
        alert("‚ö†Ô∏è Informe pelo menos um valor antes de enviar.");
        return;
      }

      // üîê Chave √∫nica por cota√ß√£o + fornecedor
      const chaveUnica = `res_${numeroCotacao}_${usuario.email.toLowerCase().trim()} `;

      const dadosResposta = {
        numeroCotacao: numeroCotacao,
        fornecedor: usuario.nome,
        email: usuario.email,
        itens: itensRespondidos,
        dataEnvio: new Date().toISOString()
      };

      // üíæ Salva resposta
      localStorage.setItem(chaveUnica, JSON.stringify(dadosResposta));

      alert("‚úÖ Resposta enviada e salva com sucesso!");

      // üîô Volta para o menu
      if (typeof voltarMenu === "function") {
        voltarMenu();
      }

    } catch (erro) {
      console.error("Erro ao enviar resposta da cota√ß√£o:", erro);
      alert("‚ùå Ocorreu um erro ao salvar sua resposta.");
    }
  }



  function validarPrazo(cotacao) {
    if (!cotacao || !cotacao.dataFechamento) return true;

    const agora = new Date();
    let dataFim;

    const valor = String(cotacao.dataFechamento).trim();

    // formato BR: DD/MM/YYYY, HH:mm:ss
    if (valor.includes('/')) {
      const [data, hora] = valor.split(',');
      const [dia, mes, ano] = data.trim().split('/');
      const horaLimpa = (hora || "00:00:00").trim();

      dataFim = new Date(`${ano} -${mes} -${dia}T${horaLimpa} `);
    } else {
      dataFim = new Date(valor);
    }

    // se a data for inv√°lida, N√ÉO bloqueia
    if (isNaN(dataFim.getTime())) return true;

    return agora <= dataFim;
  }

  /* ======================================================
     üîç ABRIR DETALHES DA RESPOSTA
     - Usa a tela de Responder Cota√ß√£o
     - Permite editar se prazo v√°lido
     - Bloqueia se fechada
  ====================================================== */
  window.abrirDetalhesRespostaFornecedor = function (numeroCotacao) {
    const usuario = getUsuarioLogado();
    if (!usuario || !usuario.email) {
      alert("Usu√°rio n√£o identificado.");
      return;
    }

    if (!numeroCotacao) {
      alert("Erro interno: n√∫mero da cota√ß√£o inv√°lido.");
      return;
    }

    const email = usuario.email.toLowerCase().trim();

    // üîç compatibilidade total de chaves
    const chavesPossiveis = [
      `resposta_${numeroCotacao}_${email} `,
      `RESPOSTA_${numeroCotacao}_${email} `,
      `res_${numeroCotacao}_${email} `
    ];

    let resposta = null;

    for (const chave of chavesPossiveis) {
      const raw = localStorage.getItem(chave);
      if (raw) {
        resposta = JSON.parse(raw);
        break;
      }
    }

    if (!resposta) {
      alert("Resposta do fornecedor n√£o encontrada.");
      return;
    }

    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === numeroCotacao);
    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada.");
      return;
    }

    // üîë guarda escopo global
    window.cotacaoEmEdicao = cotacao;
    window.respostaEmEdicao = resposta;
    cotacaoRespostaAtual = numeroCotacao;

    // üîÑ abre a tela padr√£o de responder
    abrirResponderCotacao(numeroCotacao);

    // ‚è≥ preenche valores ap√≥s render
    setTimeout(() => {
      (resposta.itens || []).forEach((item, i) => {
        const input = document.getElementById("preco_" + i);
        if (input) input.value = item.preco ?? 0;
      });

      // üîí controle de edi√ß√£o
      const podeEditar =
        validarPrazo(cotacao) &&
        cotacao.status !== "fechada" &&
        cotacao.status !== "aprovacao";

      document
        .querySelectorAll("#tabelaResponderCorpo input")
        .forEach(inp => inp.disabled = !podeEditar);

      const btnEnviar = document.getElementById("btnEnviarResposta");
      if (btnEnviar) {
        btnEnviar.style.display = podeEditar ? "inline-block" : "none";
      }

    }, 300);
  };


  /* ======================================================
     ‚öôÔ∏è FUN√á√ïES AUXILIARES
  ====================================================== */
  window.fecharDetalhesRespostaFornecedor = function () {
    const modal = document.getElementById("modalDetalhesRespostaFornecedor");
    if (modal) modal.style.display = "none";
    document.body.style.overflow = "auto";
  };

  function editarMinhaResposta() {
    if (!window.cotacaoEmEdicao || !window.respostaEmEdicao) {
      alert("Dados para edi√ß√£o n√£o encontrados.");
      return;
    }
    fecharDetalhesRespostaFornecedor();

    if (typeof abrirResponderCotacao === "function") {
      abrirResponderCotacao(window.cotacaoEmEdicao.numero);
      setTimeout(() => {
        window.respostaEmEdicao.itens.forEach((item, i) => {
          const input = document.getElementById("preco_" + i);
          if (input) input.value = item.preco || 0;
        });
      }, 300);
    }
  }

  /* ======================================================
     üîí VALIDA SE O FORNECEDOR FOI CONVIDADO (CORRETO)
  ====================================================== */
  function fornecedorFoiConvidado(cotacao, emailFornecedor) {
    if (
      !cotacao ||
      !Array.isArray(cotacao.fornecedores) ||
      !emailFornecedor
    ) {
      return false;
    }

    return cotacao.fornecedores.some(f =>
      normalizarEmail(f.email) === normalizarEmail(emailFornecedor)
    );
  }

  /* ======================================================
      üíæ SALVAR RESPOSTA (VERS√ÉO FINAL COMPLETA)
  ====================================================== */
  function salvarRespostaFornecedor(idCotacao) {
    // 1. Verifica se o usu√°rio est√° logado
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    if (!usuarioLogado) {
      return alert("Erro: Fa√ßa login novamente.");
    }

    // 2. Coleta os itens da tabela de resposta
    const itens = [];
    const linhas = document.querySelectorAll('#tabelaResponderCorpo tr');

    if (linhas.length === 0) {
      return alert("Erro: Nenhum item encontrado para salvar.");
    }

    linhas.forEach(linha => {
      const inputPreco = linha.querySelector('input');
      itens.push({
        descricao: linha.cells[0].innerText,
        quantidade: linha.cells[1].innerText,
        precoUnitario: inputPreco ? (parseFloat(inputPreco.value) || 0) : 0
      });
    });

    // 3. Gerencia o Banco de Dados no LocalStorage
    let db = JSON.parse(localStorage.getItem('bancoDados')) || { respostas: [] };

    // Garante que a estrutura de respostas existe
    if (!db.respostas) {
      db.respostas = [];
    }

    // 4. Monta o objeto da nova resposta
    const novaResposta = {
      numeroCotacao: idCotacao,
      fornecedorNome: usuarioLogado.nome,
      emailFornecedor: usuarioLogado.email,
      itens: itens,
      dataResposta: new Date().toISOString()
    };

    // 5. Remove resposta antiga desta mesma cota√ß√£o para este fornecedor (evita duplicados)
    db.respostas = db.respostas.filter(r =>
      !(r.numeroCotacao === idCotacao && r.emailFornecedor === usuarioLogado.email)
    );

    // 6. Adiciona a nova resposta e salva o "pacot√£o"
    db.respostas.push(novaResposta);
    localStorage.setItem('bancoDados', JSON.stringify(db));

    // 7. Backup Individual (para garantir que nada se perca)
    const chaveIndividual = `RESPOSTA_${idCotacao}_${usuarioLogado.email} `;
    localStorage.setItem(chaveIndividual, JSON.stringify(novaResposta));

    alert("Or√ßamento salvo com sucesso!");

    // 8. Fecha o modal de resposta
    if (typeof fecharModalResponder === "function") {
      fecharModalResponder();
    } else {
      const modal = document.getElementById("modalResponder");
      if (modal) modal.style.display = "none";
    }

    // Opcional: Atualiza a lista na tela se houver uma fun√ß√£o de renderiza√ß√£o
    if (typeof carregarCotacoesFornecedor === "function") carregarCotacoesFornecedor();
  }

  function carregarAnaliseComprador(idCotacao) {
    const tabela = document.getElementById('corpoMatrizAnalise');
    tabela.innerHTML = "";

    // Busca todas as respostas de todos os fornecedores para esta cota√ß√£o
    const respostasEncontradas = [];
    for (let i = 0; i < localStorage.length; i++) {
      const chave = localStorage.key(i);
      if (chave.startsWith(`resposta_${idCotacao} _`)) {
        respostasEncontradas.push(JSON.parse(localStorage.getItem(chave)));
      }
    }

    // Agora monte a sua tabela usando o array 'respostasEncontradas'
    // Cada item do array √© um fornecedor diferente com seus respectivos pre√ßos.
  }

  /* --- FUN√á√ïES ESSENCIAIS DE FORMATA√á√ÉO --- */

  function formatarDataHoraBR(dataISO) {
    if (!dataISO) return "-";
    const d = new Date(dataISO);
    // Verifica se a data √© v√°lida
    if (isNaN(d.getTime())) return dataISO;

    return d.toLocaleString("pt-BR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function formatarParaReal(valor) {
    const v = parseFloat(valor) || 0;
    return v.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }

  function preencherDadosParaEdicao(idCotacao) {
    const usuario = getUsuarioLogado();
    const chave = `resposta_${idCotacao}_${usuario.email.toLowerCase().trim()} `;
    const respostaExistente = JSON.parse(localStorage.getItem(chave));

    if (respostaExistente) {
      // Se j√° existe, percorre a tabela e preenche os inputs
      const linhas = document.querySelectorAll('#tabelaResponderCorpo tr');
      linhas.forEach(linha => {
        const nomeProduto = linha.cells[0].innerText;
        const itemSalvo = respostaExistente.itens.find(i => i.produto === nomeProduto);
        if (itemSalvo) {
          linha.querySelector('input').value = itemSalvo.preco;
        }
      });
    }
  }

  /* ===============================
     üîí FUN√á√ïES AUXILIARES GERAIS
  =============================== */

  if (typeof fecharTodasAsSecoes !== "function") {
    function fecharTodasAsSecoes() {
      document.querySelectorAll("section").forEach(e => e.style.display = "none");
    }
  }

  if (typeof voltarMenu !== "function") {
    function voltarMenu() {
      fecharTodasAsSecoes();
      document.getElementById("dashboard").style.display = "block";
    }
  }

  /* ===============================
     üë• FORNECEDORES ‚Äì LISTAGEM
  =============================== */

  if (typeof window.mostrarListaFornecedores !== "function") {
    window.mostrarListaFornecedores = async function () {
      const listaDiv = document.getElementById("listaFornecedoresCadastrados");
      const tbody = document.getElementById("tabelaFornecedores");
      if (!listaDiv || !tbody) return;

      // üîÅ toggle
      if (listaDiv.style.display === "block") {
        listaDiv.style.display = "none";
        return;
      }

      listaDiv.style.display = "block";
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>‚åõ Carregando fornecedores da nuvem...</td></tr>";

      // üî• BUSCA NO FIRESTORE (TEMPO REAL)
      let fornecedores = [];
      try {
        const snapshot = await db.collection("fornecedores").get();
        // üî• MAPEIA COM O ID DO DOCUMENTO (DOCID)
        const listaCrua = snapshot.docs.map(doc => ({
          docId: doc.id,
          ...doc.data()
        }));

        // üî• DEDUPLICA√á√ÉO AGRESSIVA (Sincronizada com Modal)
        const mapaDeduplicado = new Map();
        listaCrua.forEach(f => {
          const emailKey = (f.email || f.emails || "").toLowerCase().trim();
          const nomeKey = (f.nome || "").toLowerCase().trim();

          if (emailKey && !mapaDeduplicado.has(emailKey)) {
            mapaDeduplicado.set(emailKey, f);
          } else if (nomeKey && !mapaDeduplicado.has(nomeKey)) {
            const jaExistePorNome = Array.from(mapaDeduplicado.values()).some(existing =>
              (existing.nome || "").toLowerCase().trim() === nomeKey
            );
            if (!jaExistePorNome) mapaDeduplicado.set(nomeKey, f);
          }
        });
        fornecedores = Array.from(mapaDeduplicado.values());

        localStorage.setItem("fornecedores", JSON.stringify(fornecedores));
        console.log("‚úÖ Fornecedores sincronizados para listagem (Deduplicados)");
      } catch (e) {
        console.warn("Erro ao buscar fornecedores do Firebase, usando local:", e);
        fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
      }

      tbody.innerHTML = "";
      fornecedores.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));

      if (fornecedores.length === 0) {
        tbody.innerHTML = `
        <tr>
        <td colspan="5" style="text-align:center;padding:10px;">
          Nenhum fornecedor cadastrado.
        </td>
        </tr>
        `;
        return;
      }

      fornecedores.forEach((f, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
        <td>${f.nome || "-"}</td>
        <td>${f.endereco || f.logradouro || ""} ${f.numero || ""}</td>
        <td>${f.whats || f.whatsapp || "-"}</td>
        <td>${f.responsavel || "-"}</td>
        <td style="text-align:center;">
          <div style="display:flex; justify-content:center; gap:8px;">
            <button onclick="verFichaFornecedor(${index})" title="Ver ficha">üëÅÔ∏è</button>
            <button onclick="editarFornecedor(${index})" title="Editar">‚úèÔ∏è</button>
            <button onclick='window.excluirFornecedor(${index})' title="Excluir">üóëÔ∏è</button>
          </div>
        </td>
      `;

        tbody.appendChild(tr);
      });
    };
  }

  /* ===============================
     ‚úèÔ∏è EDITAR FORNECEDOR
  =============================== */

  if (typeof window.editarFornecedor !== "function") {
    window.editarFornecedor = function (index) {
      const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
      const f = fornecedores[index];
      if (!f) return;

      fornecedorEditando = index;

      document.getElementById("fornNome").value = f.nome || "";
      document.getElementById("fornCnpj").value = f.cnpj || "";
      document.getElementById("fornLogradouro").value = f.logradouro || "";
      document.getElementById("fornNumero").value = f.numero || "";
      document.getElementById("fornBairro").value = f.bairro || "";
      document.getElementById("fornCidade").value = f.cidade || "";
      document.getElementById("fornCep").value = f.cep || "";
      document.getElementById("fornTelefone").value = f.telefone || "";
      document.getElementById("fornWhats").value = f.whats || "";
      document.getElementById("fornEmails").value = f.emails || "";
      document.getElementById("fornResponsavel").value = f.responsavel || "";
      document.getElementById("fornTipo").value = f.tipo || "";

      window.scrollTo({ top: 0, behavior: "smooth" });
    };
  }

  /* ===============================
     üóëÔ∏è EXCLUIR FORNECEDOR
  =============================== */

  if (typeof window.excluirFornecedor !== "function") {
    window.excluirFornecedor = async function (index) {
      const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
      const fornecedor = fornecedores[index];

      if (!fornecedor) return;

      const docIdForn = fornecedor.docId;
      const emailForn = (fornecedor.email || fornecedor.emails || "").toLowerCase().trim();
      if (!confirm(`Deseja realmente excluir o fornecedor ${fornecedor.nome}?`)) return;

      // üî• 1. REMOVE NO FIRESTORE (ID DIRETO + QUERY P/ DUPLICADOS)
      try {
        const batch = db.batch();

        // A. Remove pelo ID √önico do Documento (MAIS SEGURO)
        if (docIdForn) {
          batch.delete(db.collection("fornecedores").doc(docIdForn));
        }

        // B. Remove duplicatas pelo e-mail
        if (emailForn) {
          const snap1 = await db.collection("fornecedores").where("email", "==", emailForn).get();
          const snap2 = await db.collection("fornecedores").where("emails", "==", emailForn).get();
          snap1.docs.forEach(doc => batch.delete(doc.ref));
          snap2.docs.forEach(doc => batch.delete(doc.ref));

          // Tenta tamb√©m pelo e-mail como ID caso tenha sido criado assim
          batch.delete(db.collection("fornecedores").doc(emailForn));
        }

        await batch.commit();
        console.log("‚úÖ Fornecedor eliminado totalmente do Firestore.");
      } catch (e) {
        console.error("‚ùå Erro ao excluir do Firestore:", e);
      }

      // 2. Local Cleanup
      const novaLista = fornecedores.filter(f =>
        (f.email || "").toLowerCase().trim() !== emailForn &&
        (f.emails || "").toLowerCase().trim() !== emailForn
      );
      localStorage.setItem("fornecedores", JSON.stringify(novaLista));

      alert("‚úÖ Fornecedor removido com sucesso!");

      // üîÅ reabre lista atualizada
      mostrarListaFornecedores();
      if (document.getElementById("listaFornecedoresCadastrados")?.style.display === "block") {
        mostrarListaFornecedores(); // Toggle Off/On
      }
    };
  }

  /* ===============================
     üëÅÔ∏è VER FICHA DO FORNECEDOR
  =============================== */

  window.verFichaFornecedor = function (index) {
    const fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
    const f = fornecedores[index];
    if (!f) return;

    const div = document.getElementById("conteudoVerFornecedor");

    div.innerHTML = `
        < div style = "background:#111;border:1px solid #661155;border-radius:10px;padding:20px;color:white;" >
      <p><strong>Nome da Empresa:</strong> ${f.nome || "-"}</p>
      <p><strong>CNPJ:</strong> ${f.cnpj || "-"}</p>
      <p><strong>Endere√ßo:</strong>
        ${f.logradouro || ""}, ${f.numero || ""} - ${f.bairro || ""}<br>
        ${f.cidade || ""} - ${f.cep || ""}
      </p>
      <p><strong>WhatsApp:</strong> ${f.whats || "-"}</p>
      <p><strong>Telefone:</strong> ${f.telefone || "-"}</p>
      <p><strong>E-mails:</strong> ${f.emails || "-"}</p>
      <p><strong>Respons√°vel:</strong> ${f.responsavel || "-"}</p>
      <p><strong>Tipo:</strong> ${f.tipo || "-"}</p>
    </div >
        `;

    document.getElementById("modalVerFornecedor").style.display = "flex";
  };

  window.fecharModalVerFornecedor = function () {
    document.getElementById("modalVerFornecedor").style.display = "none";
  };

  /* ===============================
     üì¶ MATERIAIS ‚Äì ABERTURA
  =============================== */

  // Abre o cadastro de material (N√ÉO abre a lista)
  if (typeof abrirCadastroMaterial !== "function") {
    function abrirCadastroMaterial() {
      // esconde todas as se√ß√µes
      document.querySelectorAll("section").forEach(sec => sec.style.display = "none");

      // mostra apenas o cadastro
      document.getElementById("cadastroMaterial").style.display = "block";

      // garante que a lista fique fechada
      const lista = document.getElementById("listaMateriais");
      if (lista) lista.style.display = "none";
    }
  }

  // Monta a lista de materiais (N√ÉO controla visibilidade)
  function mostrarListaMateriais() {
    const listaDiv = document.getElementById("listaMateriais");
    const tabela = document.getElementById("materiaisTabela");

    if (!listaDiv || !tabela) return;

    const materiais = JSON.parse(localStorage.getItem("materiais")) || [];
    tabela.innerHTML = "";

    if (materiais.length === 0) {
      tabela.innerHTML = `
        < tr >
        <td colspan="5" style="text-align:center;padding:10px;">
          Nenhum material cadastrado.
        </td>
      </tr >
        `;
      return;
    }

    materiais.sort((a, b) => a.nome.localeCompare(b.nome));

    materiais.forEach((m, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        < td > ${m.nome}</td >
      <td>${m.codigo || "-"}</td>
      <td>${m.embalagem || "-"}</td>
      <td>${m.qtdEmb || "-"}</td>
      <td style="text-align:center;">
        <div style="display:flex; justify-content:center; gap:8px;">
          <button onclick="editarMaterial(${i})">‚úèÔ∏è</button>
          <button onclick="excluirMaterial(${i})">üóëÔ∏è</button>
        </div>
      </td>
      `;
      tabela.appendChild(tr);
    });
  }


  // Abre a lista SOMENTE quando clicar em "Lista de Materiais"
  function abrirListaMateriais() {
    const listaDiv = document.getElementById("listaMateriais");
    if (!listaDiv) return;

    // se estiver aberta, fecha
    if (listaDiv.style.display === "block") {
      listaDiv.style.display = "none";
      return;
    }

    // se estiver fechada, monta e abre
    mostrarListaMateriais();
    listaDiv.style.display = "block";
  }

  function salvarMaterial() {
    const nome = document.getElementById("matNome")?.value.trim();
    const codigo = document.getElementById("matCodigo")?.value.trim();
    const embalagem = document.getElementById("matEmbalagem")?.value.trim();
    const qtdEmb = document.getElementById("matQtdEmb")?.value.trim();

    // üî¥ SOMENTE O NOME √â OBRIGAT√ìRIO
    if (!nome) {
      alert("‚ö†Ô∏è Informe o nome do material.");
      return;
    }

    const materiais = JSON.parse(localStorage.getItem("materiais")) || [];

    materiais.push({
      nome,
      codigo: codigo || "",       // opcional
      embalagem: embalagem || "", // opcional
      qtdEmb: qtdEmb || ""        // opcional
    });

    materiais.sort((a, b) => a.nome.localeCompare(b.nome));
    localStorage.setItem("materiais", JSON.stringify(materiais));

    alert("‚úÖ Material salvo com sucesso!");

    // üîπ limpa formul√°rio
    document.getElementById("matNome").value = "";
    document.getElementById("matCodigo").value = "";
    document.getElementById("matEmbalagem").value = "";
    document.getElementById("matQtdEmb").value = "";

    // üîÅ atualiza lista SOMENTE se estiver aberta
    const lista = document.getElementById("listaMateriais");
    if (lista && lista.style.display === "block") {
      mostrarListaMateriais();
    }
  }

  /* ===============================
     üì¶ MATERIAIS ‚Äì EDITAR / EXCLUIR
  =============================== */

  function editarMaterial(index) {
    const materiais = JSON.parse(localStorage.getItem("materiais")) || [];
    const m = materiais[index];
    if (!m) return;

    // Preenche formul√°rio
    document.getElementById("matNome").value = m.nome || "";
    document.getElementById("matCodigo").value = m.codigo || "";
    document.getElementById("matEmbalagem").value = m.embalagem || "";
    document.getElementById("matQtdEmb").value = m.qtdEmb || "";

    // Remove para salvar novamente (edi√ß√£o)
    materiais.splice(index, 1);
    localStorage.setItem("materiais", JSON.stringify(materiais));

    // Atualiza lista se aberta
    const lista = document.getElementById("listaMateriais");
    if (lista && lista.style.display === "block") {
      mostrarListaMateriais();
    }

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function excluirMaterial(index) {
    if (!confirm("‚ùå Deseja realmente excluir este material?")) return;

    const materiais = JSON.parse(localStorage.getItem("materiais")) || [];
    materiais.splice(index, 1);
    localStorage.setItem("materiais", JSON.stringify(materiais));

    // Atualiza lista se aberta
    const lista = document.getElementById("listaMateriais");
    if (lista && lista.style.display === "block") {
      mostrarListaMateriais();
    }
  }

  /* ===============================
     üõ†Ô∏è SERVI√áOS ‚Äì ABERTURA
  =============================== */

  if (typeof abrirCadastroServico !== "function") {
    function abrirCadastroServico() {
      fecharTodasAsSecoes();

      const tela = document.getElementById("cadastroServico");
      const lista = document.getElementById("listaServicos");

      if (!tela || !lista) return;

      tela.style.display = "block";
      lista.style.display = "none"; // üîë come√ßa sempre fechada
    }
  }
  /* ===============================
     üõ†Ô∏è SERVI√áOS ‚Äì TOGGLE LISTA (CORRETO)
  =============================== */

  function abrirListaServicos() {
    const lista = document.getElementById("listaServicos");
    if (!lista) return;

    const visivel = window.getComputedStyle(lista).display !== "none";

    if (visivel) {
      lista.style.display = "none";
    } else {
      mostrarListaServicos();
      lista.style.display = "block";
    }
  }


  function mostrarListaServicos() {
    const tabela = document.getElementById("servicosTabela");
    const lista = document.getElementById("listaServicos");

    if (!tabela || !lista) return;

    tabela.innerHTML = "";

    const servicos = JSON.parse(localStorage.getItem("servicos")) || [];

    if (servicos.length === 0) {
      tabela.innerHTML = `
        <tr>
        <td colspan="5" style="text-align:center; padding:10px;">
          Nenhum servi√ßo cadastrado ainda.
        </td>
        </tr>
        `;
      return;
    }

    servicos.sort((a, b) => a.nome.localeCompare(b.nome));

    servicos.forEach((s, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        < td > ${s.nome}</td >
      <td>${s.codigo || "-"}</td>
      <td>${s.categoria}</td>
      <td>${s.preco || "-"}</td>
      <td style="text-align:center;">
        <div style="display:flex; justify-content:center; gap:8px;">
          <button onclick="editarServico(${i})">‚úèÔ∏è</button>
          <button onclick="excluirServico(${i})">üóëÔ∏è</button>
        </div>
      </td>
    `;
      tabela.appendChild(tr);
    });
  }

  /* ===============================
     üõ†Ô∏è SERVI√áOS ‚Äì SALVAR
  =============================== */
  function salvarServico() {
    const nome = document.getElementById("servNome")?.value.trim();
    const codigo = document.getElementById("servCodigo")?.value.trim();
    const categoria = document.getElementById("servCategoria")?.value;
    const descricao = document.getElementById("servDescricao")?.value.trim();
    const preco = document.getElementById("servPreco")?.value.trim();

    // ‚úÖ SOMENTE NOME E CATEGORIA S√ÉO OBRIGAT√ìRIOS
    if (!nome || !categoria) {
      alert("‚ö†Ô∏è Preencha ao menos o Nome do Servi√ßo e a Categoria.");
      return;
    }

    const servicos = JSON.parse(localStorage.getItem("servicos")) || [];

    servicos.push({
      nome,
      codigo: codigo || "",        // opcional
      categoria,
      descricao: descricao || "",  // opcional
      preco: preco || ""           // opcional
    });

    servicos.sort((a, b) => a.nome.localeCompare(b.nome));
    localStorage.setItem("servicos", JSON.stringify(servicos));

    // üîπ limpa formul√°rio
    document.getElementById("servNome").value = "";
    document.getElementById("servCodigo").value = "";
    document.getElementById("servCategoria").value = "";
    document.getElementById("servDescricao").value = "";
    document.getElementById("servPreco").value = "";

    // üîÅ atualiza lista SOMENTE se estiver aberta
    const lista = document.getElementById("listaServicos");
    if (lista && lista.style.display === "block") {
      mostrarListaServicos();
    }

    alert("‚úÖ Servi√ßo salvo com sucesso!");
  }

  /* ===============================
     üõ†Ô∏è SERVI√áOS ‚Äì EDITAR / EXCLUIR
  =============================== */

  if (typeof editarServico !== "function") {
    function editarServico(index) {
      const servicos = JSON.parse(localStorage.getItem("servicos")) || [];
      const s = servicos[index];
      if (!s) return;

      // Preenche formul√°rio
      document.getElementById("servNome").value = s.nome || "";
      document.getElementById("servCodigo").value = s.codigo || "";
      document.getElementById("servCategoria").value = s.categoria || "";
      document.getElementById("servDescricao").value = s.descricao || "";
      document.getElementById("servPreco").value = s.preco || "";

      // Remove o item para salvar novamente ao editar
      servicos.splice(index, 1);
      localStorage.setItem("servicos", JSON.stringify(servicos));

      // Atualiza lista se estiver aberta
      const lista = document.getElementById("listaServicos");
      if (lista && lista.style.display === "block") {
        mostrarListaServicos();
      }

      // Garante que o usu√°rio veja o formul√°rio
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  if (typeof excluirServico !== "function") {
    function excluirServico(index) {
      if (!confirm("‚ùå Deseja realmente excluir este servi√ßo?")) return;

      const servicos = JSON.parse(localStorage.getItem("servicos")) || [];
      servicos.splice(index, 1);
      localStorage.setItem("servicos", JSON.stringify(servicos));

      // Atualiza lista se estiver aberta
      const lista = document.getElementById("listaServicos");
      if (lista && lista.style.display === "block") {
        mostrarListaServicos();
      }
    }
  }

  function cotacaoEstaAbertaParaFornecedor(cotacao, fornecedorEmail) {
    if (cotacao.status === "fechada") return false;

    return !cotacao.respostasFornecedores?.some(r =>
      (r.email || "").toLowerCase().trim() ===
      fornecedorEmail.toLowerCase().trim()
    );
  }

</script>

<script>

  function abrirAnaliseCotacao(id) {
    document.getElementById('modalAnaliseCotacao').style.display = 'flex';
    renderizarTabelaAnalise(id);
  }
  window.analisarCotacao = abrirAnaliseCotacao;

  function fecharModalAnalise() {
    document.getElementById('modalAnaliseCotacao').style.display = 'none';
  }

  window.toggleItemDetalhe = function (id) {
    const el = document.getElementById(id);
    const icon = document.getElementById('icon-' + id);
    if (el) {
      const isHidden = el.style.display === 'none';
      el.style.display = isHidden ? 'table-row' : 'none';
      if (icon) {
        icon.className = isHidden ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right';
      }
    }
  };

  // Vari√°vel para controlar o estado global (Expandir/Recolher Todos)
  window.estadoExpandidoGlobal = false;

  window.toggleExpansaoColunas = function () {
    window.isColunasExpandidas = !window.isColunasExpandidas;
    document.body.classList.toggle('modo-focalizado', window.isColunasExpandidas);

    const modalMain = document.getElementById('modalAnaliseCotacao');
    if (modalMain) {
      const children = modalMain.querySelector('.modal-content').children;
      for (let child of children) {
        if (child.id !== 'analiseConteudo') {
          child.style.display = window.isColunasExpandidas ? 'none' : '';
        }
      }
      // Garantir o √≠cone vis√≠vel se estiver em um th da tabela
      const container = document.getElementById('analiseConteudo');
      if (container) container.style.display = 'block';
    }

    const tabela = document.querySelector('.matriz-cotacao');
    const icon = document.getElementById('iconExpandirGlobal');
    const modalContent = modalMain ? modalMain.querySelector('.modal-content') : null;

    if (modalContent) {
      modalContent.style.width = window.isColunasExpandidas ? "99vw" : "1200px";
      modalContent.style.maxWidth = window.isColunasExpandidas ? "99vw" : "1200px";
    }

    if (icon) {
      icon.className = window.isColunasExpandidas ? 'fa-solid fa-compress' : 'fa-solid fa-expand';
      icon.title = window.isColunasExpandidas ? 'Contrair' : 'Expandir';
    }

    if (tabela) {
      tabela.classList.toggle('expandida', window.isColunasExpandidas);
      tabela.querySelectorAll('.col-fixa, .col-fixa-2, .col-fixa-3').forEach(td => {
        td.style.whiteSpace = window.isColunasExpandidas ? 'normal' : '';
      });
    }
  };

  function renderizarTabelaAnalise(textoOuId) {
    const container = document.getElementById('analiseConteudo');

    // üî• Limpa completamente para evitar duplica√ß√µes
    if (container) container.innerHTML = "";

    // üîç Helper Local
    const normalizarEmail = (e) => (e || "").toLowerCase().trim();

    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    let cotacao = cotacoes.find(c => c.id === textoOuId);
    if (!cotacao) {
      cotacao = cotacoes.find(c => c.numero === textoOuId);
    }

    if (!cotacao) {
      container.innerHTML = "<p>Cota√ß√£o n√£o encontrada.</p>";
      return;
    }

    /* ==========================
       üìå CABE√áALHO 
    ========================== */
    const elNum = document.getElementById("analiseNumero");
    if (elNum) elNum.textContent = cotacao.numero || cotacao.id;

    const elDesc = document.getElementById("analiseDescricao");
    if (elDesc) elDesc.textContent = cotacao.descricao || "‚Äî Sem descri√ß√£o";

    const elData = document.getElementById("analiseDataCriacao");
    if (elData) elData.textContent = cotacao.dataCriacao || "-";

    const elFech = document.getElementById("analiseDataFechamento");
    if (elFech) elFech.textContent = cotacao.dataFechamento || "-";

    // Controle de Status / Visibilidade de Bot√µes EXTERNOS
    const divAcoesFechada = document.getElementById("acoesFechada");
    const statusDiv = document.getElementById("statusAprovacao");
    const btnEnviarExterno = document.getElementById("btnEnviarAprovacao");
    const btnVerTodosAnexos = document.getElementById("btnVerTodosAnexos");
    const contEnviarAprovacao = document.getElementById("contEnviarAprovacao");

    // Reseta visibilidade externa - DESATIVADOS (bot√µes agora s√£o internos/premium)
    if (divAcoesFechada) divAcoesFechada.style.display = "none";
    if (statusDiv) statusDiv.innerHTML = "";
    if (btnEnviarExterno) btnEnviarExterno.style.display = "none";
    if (btnVerTodosAnexos) btnVerTodosAnexos.style.display = "none";
    if (contEnviarAprovacao) contEnviarAprovacao.style.display = "none"; // üî• Esconde container inteiro

    // 1. AN√ÅLISE (Comprador) - Bot√µes agora s√£o renderizados internamente
    const isAnalise = (cotacao.status === "analise" || cotacao.status === "respondida" || cotacao.status === "reanalise");
    // Removido a ativa√ß√£o dos bot√µes externos - agora usamos apenas os internos (premium)

    // 2. APROVA√á√ÉO (Aprovador v√™, Comprador v√™ status)
    if (cotacao.status === "aprovacao") {
      if (statusDiv) statusDiv.innerHTML = "‚è≥ Aguardando Aprova√ß√£o";
    }

    // 3. FECHADA
    if (cotacao.status === "fechada") {
      if (statusDiv) statusDiv.innerHTML = "üîí Fechada (Pedido Gerado)";
      if (divAcoesFechada) divAcoesFechada.style.display = "flex";
      window.cotacaoAtualPDF = cotacao;
    }

    // Bot√£o de Motivo
    const textAreaMotivo = document.getElementById("motivoRejeicao");
    const btnMotivo = document.getElementById("btnMotivoRejeicao");

    if (btnMotivo && btnMotivo.parentElement) {
      if (cotacao.motivoRejeicao) {
        btnMotivo.parentElement.style.display = "block";
      } else {
        btnMotivo.parentElement.style.display = "none";
      }
    }
    if (textAreaMotivo) {
      textAreaMotivo.value = cotacao.motivoRejeicao || "";
    }

    /* ==========================
       üìä DADOS 
    ========================== */
    let respostas = [];
    if (Array.isArray(cotacao.respostasFornecedores)) {
      respostas = [...cotacao.respostasFornecedores];
    }

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(`resposta_${cotacao.numero}_`) || key.startsWith(`resposta_${cotacao.numero} _`)) {
        try {
          const r = JSON.parse(localStorage.getItem(key));
          const jaExiste = respostas.some(
            existing => normalizarEmail(existing.email) === normalizarEmail(r.email)
          );
          if (!jaExiste) {
            respostas.push({
              fornecedor: r.fornecedor || r.fornecedorNome || "Fornecedor",
              email: r.email || r.emailFornecedor || "",
              itens: r.itens || r.precos || []
            });
          }
        } catch (e) { }
      }
    }

    if (respostas.length === 0) {
      container.innerHTML = "<p>Nenhuma resposta recebida para esta cota√ß√£o ainda.</p>";
      return;
    }

    /* ==========================
       üèóÔ∏è TABELA PREMIUM COM BADGES
    ========================== */
    let html = `
    <table class="matriz-cotacao" style="width:100%; border-collapse:collapse; margin-top:20px;">
      <thead style="background:#661155; color:white;">
        <tr>
          <th style="width:50px; text-align:center; padding:12px;">
            <i class="fa-solid fa-expand" style="cursor:pointer; color:#3ab9b6; font-size:14px;" onclick="toggleExpansaoColunas()" title="Expandir"></i>
          </th>
          <th style="width:60px; text-align:center;">#</th>
          <th style="text-align:left; padding-left:10px;">Item</th>
          <th style="text-align:center;">Marca</th>
          <th style="text-align:center;">Qtd</th>`;

    // Cabe√ßalhos fornecedores
    respostas.forEach(r => {
      html += `<th style="text-align:center; min-width:140px;">${r.fornecedor}</th>`;
    });

    // Coluna VENCEDOR
    html += `<th style="text-align:center; color:#00ff99; min-width:200px;">VENCEDOR</th>`;
    html += `</tr></thead><tbody style="background:#000;">`;

    // Iterar produtos
    const produtos = cotacao.itens || cotacao.produtos || [];
    produtos.forEach((prod, idx) => {
      const nomeProd = prod.nome || prod.descricao || prod.produto || "Item";
      const qtd = prod.quantidade || 0;

      // C√°lculo de melhor pre√ßo
      let precosRow = [];
      respostas.forEach(r => {
        const pItem = (r.itens || []).find(it => (it.produto === nomeProd) || (it.nome === nomeProd));
        if (pItem) {
          const valor = Number(pItem.preco) || Number(pItem.valor) || 0;
          if (valor > 0) precosRow.push({ fornecedor: r.fornecedor, email: r.email, val: valor });
        }
      });
      precosRow.sort((a, b) => a.val - b.val);
      const melhorPreco = precosRow.length > 0 ? precosRow[0] : null;

      html += `<tr style="border-bottom:1px solid #333;">
                <td style="text-align:center; padding:10px;">
                </td>
                <td style="text-align:center; padding:8px;">
                  <span style="background:#000; color:#fff; padding:4px 10px; border-radius:6px; font-size:13px; font-weight:bold; border:1px solid #661155;">#${idx + 1}</span>
                </td>
                <td style="padding:12px 10px; color:white;">${nomeProd}</td>
                <td style="text-align:center; color:#adb5bd;">${prod.marca || "-"}</td>
                <td style="text-align:center; color:#adb5bd;">${qtd}</td>`;

      // C√©lulas de Pre√ßo (COM BADGE COLORIDA OUTLINE)
      respostas.forEach(r => {
        const pItem = (r.itens || []).find(it => (it.produto === nomeProd) || (it.nome === nomeProd));
        const valor = pItem ? (Number(pItem.preco) || Number(pItem.valor) || 0) : 0;

        const rankIndex = precosRow.findIndex(x => normalizarEmail(x.email) === normalizarEmail(r.email));
        const badgeColors = [
          { color: '#00ff99', label: '1&ordm;' },  // Verde
          { color: '#ffd700', label: '2&ordm;' },  // Amarelo
          { color: '#ff4444', label: '3&ordm;' }   // Vermelho
        ];
        const badge = rankIndex >= 0 && rankIndex < 3 ? badgeColors[rankIndex] : null;

        html += `<td style="text-align:center; padding:8px;">`;

        if (valor > 0) {
          if (badge) {
            html += `
              <div style="display:inline-flex; align-items:center; gap:6px; background:transparent; padding:4px;">
                <span style="background:#000; color:${badge.color}; font-weight:900; border-radius:50%; width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center; font-size:12px; line-height:1; border:2px solid ${badge.color};">${badge.label}</span>
                <span style="color:${badge.color}; font-weight:bold; font-size:14px;">R$ ${valor.toFixed(2)}</span>
              </div>`;
          } else {
            html += `<span style="color:#ccc; font-size:14px;">R$ ${valor.toFixed(2)}</span>`;
          }
        } else {
          html += `<span style="color:#555;">-</span>`;
        }

        html += `</td>`;
      });

      // VENCEDOR com Trof√©u
      let emailEscolhido = window.decisoesAnalise?.[cotacao.numero]?.[nomeProd];
      if (!emailEscolhido && melhorPreco) {
        emailEscolhido = melhorPreco.email;
        if (!window.decisoesAnalise) window.decisoesAnalise = {};
        if (!window.decisoesAnalise[cotacao.numero]) window.decisoesAnalise[cotacao.numero] = {};
        window.decisoesAnalise[cotacao.numero][nomeProd] = emailEscolhido;
      }

      const fornEscolhido = respostas.find(r => normalizarEmail(r.email) === normalizarEmail(emailEscolhido));
      const nomeEscolhido = fornEscolhido ? fornEscolhido.fornecedor : "Selecione";

      html += `<td style="text-align:center; padding:8px;">
                <div style="background:#111; border:1px solid #00ff99; padding:8px 12px; border-radius:6px; display:inline-flex; align-items:center; gap:8px; min-width:160px; position:relative;">
                  <i class="fa-solid fa-trophy" style="color:#ffcc00;"></i>
                  <span style="color:#00ff99; font-weight:bold; flex:1;">${nomeEscolhido}</span>
                  ${isAnalise ? `
                    <select onchange="atualizarDecisaoVencedor('${cotacao.numero}', '${nomeProd}', this.value)" 
                            style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                      ${precosRow.map(p => `
                        <option value="${p.email}" ${normalizarEmail(p.email) === normalizarEmail(emailEscolhido) ? 'selected' : ''}>
                          ${p.fornecedor} - R$ ${p.val.toFixed(2)}
                        </option>
                      `).join('')}
                    </select>
                    <i class="fa-solid fa-chevron-down" style="color:#00ff99; font-size:10px;"></i>
                  ` : ''}
                </div>
              </td>`;

      html += `</tr>`;
    });

    html += `</tbody></table>`;

    // BOT√ïES FULL WIDTH (PREMIUM) - Exibidos apenas em modo de an√°lise
    if (isAnalise) {
      html += `
         <div style="margin-top:25px; display:flex; flex-direction:column; gap:12px;">
            <button onclick="visualizarDocumentos('${cotacao.numero}')" 
                 style="width:100%; background:#3ab9b6; color:#fff; border:none; padding:14px; border-radius:8px; cursor:pointer; font-weight:800; font-size:15px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 3px 0 #2a8f8c;">
               <i class="fa-solid fa-folder-open" style="color:#ffd700;"></i> <span style="color:#fff;">Ver Todos os Anexos</span>
            </button>
            <div style="display:flex; gap:12px;">
              <button onclick="excluirCotacao('${cotacao.numero}')" 
                   style="flex:1; background:#b93a3a; color:white; border:none; padding:14px; border-radius:8px; cursor:pointer; font-weight:800; font-size:15px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 3px 0 #8f2a2a;">
                 <i class="fa-solid fa-trash"></i> Excluir Cota√ß√£o
              </button>

              <button onclick="enviarParaAprovacao()" 
                   style="flex:1; background:#661155; color:white; border:none; padding:14px; border-radius:8px; cursor:pointer; font-weight:800; font-size:15px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 3px 0 #4a0c3e;">
                 <i class="fa-solid fa-square-check"></i> Enviar para Aprova√ß√£o
              </button>
            </div>
         </div>
      `;
    }

    container.innerHTML = html;
  }

  // üóëÔ∏è L√≥gica para Excluir Cota√ß√£o
  window.excluirCotacao = function (id) {
    if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja EXCLUIR permanentemente esta cota√ß√£o?\n\nEssa a√ß√£o apagar√° todos os itens e respostas vinculadas e N√ÉO poder√° ser desfeita.")) {
      return;
    }

    try {
      // 1. Remove da lista principal
      let cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      const novaLista = cotacoes.filter(c => c.numero !== id && c.id !== id);

      if (cotacoes.length === novaLista.length) {
        alert("Erro: Cota√ß√£o n√£o encontrada na lista.");
        return;
      }

      localStorage.setItem("cotacoes", JSON.stringify(novaLista));

      // 2. Remove respostas vinculadas (Limpeza)
      // Percorre keys para achar respostas desta cota√ß√£o
      const keysParaRemover = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith(`resposta_${id}_`) || key.startsWith(`resposta_${id} _`)) {
          keysParaRemover.push(key);
        }
      }

      keysParaRemover.forEach(k => localStorage.removeItem(k));

      // 3. Remove decis√µes salvas se houver
      if (window.decisoesAnalise && window.decisoesAnalise[id]) {
        delete window.decisoesAnalise[id];
      }

      alert("‚úÖ Cota√ß√£o exclu√≠da com sucesso!");

      // 4. Fecha modal e atualiza
      const modal = document.getElementById('modalAnaliseCotacao');
      if (modal) modal.style.display = "none";

      // Tenta recarregar a lista se a fun√ß√£o existir
      if (typeof carregarCotacoes === 'function') {
        carregarCotacoes();
      } else {
        window.location.reload();
      }

    } catch (e) {
      console.error(e);
      alert("Erro ao excluir cota√ß√£o: " + e.message);
    }
  };

  // Helper function
  function atualizarDecisaoVencedor(numeroCotacao, produto, emailFornecedor) {
    if (!window.decisoesAnalise) window.decisoesAnalise = {};
    if (!window.decisoesAnalise[numeroCotacao]) window.decisoesAnalise[numeroCotacao] = {};
    window.decisoesAnalise[numeroCotacao][produto] = emailFornecedor;
  }


  /* ======================================================
  üß© FUN√á√ïES ADICIONAIS FALTANTES (CRIA√á√ÉO)
  ====================================================== */
  if (!window.decisoesAnalise) window.decisoesAnalise = {}; // Cache tempor√°rio

  /* ======================================================
     üèÜ ATUALIZAR DECIS√ÉO DE VENCEDOR
  ====================================================== */
  window.atualizarDecisaoVencedor = function (numeroCotacao, produto, emailFornecedor) {
    if (!window.decisoesAnalise) window.decisoesAnalise = {};
    if (!window.decisoesAnalise[numeroCotacao]) window.decisoesAnalise[numeroCotacao] = {};

    // Salva a decis√£o
    window.decisoesAnalise[numeroCotacao][produto] = emailFornecedor;

    // Re-renderiza a tabela para atualizar visual
    renderizarTabelaAnalise(numeroCotacao);
  };


  /* ======================================================
     üì§ SALVAR AN√ÅLISE E ENVIAR PARA APROVA√á√ÉO (CORRIGIDO V2)
     ====================================================== */
  async function salvarAnaliseAdjudicacao(numeroCotacao) {
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    const cotacaoIndex = cotacoes.findIndex(c => c.numero === numeroCotacao);
    const cotacao = cotacoes[cotacaoIndex];

    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada.");
      return;
    }

    const decisoes = window.decisoesAnalise[numeroCotacao];
    if (!decisoes || Object.keys(decisoes).length === 0) {
      alert("Selecione pelo menos um fornecedor vencedor.");
      return;
    }

    /* Recalcula adjudica√ß√£o */
    const novaAdjudicacao = [];
    const respostas = [...(cotacao.respostasFornecedores || [])];

    // Backup Localstorage
    const normalizarEmail = (e) => (e || "").toLowerCase().trim();
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(`resposta_${cotacao.numero}_`)) {
        try {
          const r = JSON.parse(localStorage.getItem(key));
          if (!respostas.some(x => normalizarEmail(x.email) === normalizarEmail(r.email))) {
            respostas.push(r);
          }
        } catch (e) { }
      }
    }

    // Processa Decis√µes
    for (const [prodNome, emailVencedor] of Object.entries(decisoes)) {
      if (!emailVencedor) continue;

      const respForn = respostas.find(r => normalizarEmail(r.email) === normalizarEmail(emailVencedor));
      if (respForn) {
        const itemDados = (respForn.itens || []).find(i => i.produto === prodNome || i.nome === prodNome);
        const preco = itemDados ? (Number(itemDados.preco) || Number(itemDados.valor) || 0) : 0;
        const prodOriginal = (cotacao.produtos || []).find(p => (p.nome || p.descricao) === prodNome);
        const qtd = prodOriginal ? (Number(prodOriginal.quantidade) || 0) : 0;

        novaAdjudicacao.push({
          produto: prodNome,
          marca: prodOriginal ? (prodOriginal.marca || "-") : "-",
          quantidade: qtd,
          fornecedor: respForn.fornecedor || respForn.fornecedorNome,
          email: respForn.email,
          preco: preco,
          total: preco * qtd
        });
      }
    }

    if (novaAdjudicacao.length === 0) {
      alert("Nenhum item v√°lido selecionado.");
      return;
    }

    // ATUALIZA√á√ÉO LOCAL (CR√çTICA)
    cotacao.adjudicacao = novaAdjudicacao;
    cotacao.status = "aprovacao"; // Muda status para aprova√ß√£o

    // Salva no Array Principal
    cotacoes[cotacaoIndex] = cotacao;
    localStorage.setItem("cotacoes", JSON.stringify(cotacoes));

    console.log("‚úÖ Status atualizado localmente para 'aprovacao'");

    // FEEDBACK
    alert("‚úÖ Cota√ß√£o enviada para aprova√ß√£o com sucesso!");
    fecharModalAnalise();

    // ‚òÅÔ∏è SYNC FIRESTORE (BACKGROUND)
    if (typeof db !== "undefined" && firebase) {
      db.collection("cotacoes").doc(String(cotacao.numero)).update({
        adjudicacao: novaAdjudicacao,
        status: "aprovacao"
      })
        .then(() => console.log("‚òÅÔ∏è Status sincronizado na nuvem!"))
        .catch(err => console.warn("‚ö†Ô∏è Falha sync status (Quota?):", err));
    }

    // ATUALIZA UI (SEM EXECUTAR FETCH QUE POSSA REVERTER)
    // Removemos visualmente o card da lista de an√°lise para dar sensa√ß√£o de progresso
    // e recarregamos a lista de aprova√ß√£o se estiver vis√≠vel
    const listaAnalise = document.getElementById("listaAnalise");
    if (listaAnalise) {
      // Recarrega do LOCALSTORAGE (que acabamos de atualizar)
      // Isso evita o round-trip com o Firebase que poderia trazer dados antigos
      if (typeof carregarCotacoes === 'function') {
        // Hack: For√ßa leitura local temporariamente se a fun√ß√£o suportasse, 
        // mas como n√£o suporta, vamos confiar que o carregarCotacoes vai ler do Firestore 
        // e talvez sobrescrever.
        // MELHOR: N√£o chamar carregarCotacoes('analise'). O usu√°rio vai mudar de tela.
      }
    }
  }

  /* ======================================================
  üì§ ENVIAR PARA APROVA√á√ÉO (BOT√ÉO DO MODAL DE AN√ÅLISE)
  ====================================================== */
  function enviarParaAprovacao() {
    // Pega o n√∫mero da cota√ß√£o atual do modal
    const numeroElement = document.getElementById("analiseNumero");
    if (!numeroElement) {
      alert("Erro: Cota√ß√£o n√£o identificada.");
      return;
    }

    const numeroCotacao = numeroElement.textContent.trim();

    // Chama a fun√ß√£o que j√° existe para salvar a an√°lise
    salvarAnaliseAdjudicacao(numeroCotacao);
  }

  // Torna a fun√ß√£o global
  window.enviarParaAprovacao = enviarParaAprovacao;


  /* ======================================================
  ‚úî APROVAR COTA√á√ÉO DIRETAMENTE (APROVADOR)
  ====================================================== */
  function aprovarCotacaoDireto(numero) {
    if (!numero) {
      alert("N√∫mero da cota√ß√£o inv√°lido.");
      return;
    }

    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === numero);

    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada.");
      return;
    }

    // üîí valida se realmente est√° em aprova√ß√£o
    if (cotacao.status !== "aprovacao") {
      alert("Esta cota√ß√£o n√£o est√° aguardando aprova√ß√£o.");
      return;
    }

    // ‚úÖ aprova
    cotacao.status = "fechada";
    cotacao.dataAprovacao = new Date().toLocaleString();

    salvarCotacoes(cotacoes);

    alert("‚úÖ Cota√ß√£o aprovada com sucesso!");

    // üîÑ atualiza tela de aprova√ß√µes
    if (typeof carregarPendentesAprovacao === "function") {
      carregarPendentesAprovacao();
    }

    // üîí fecha modal se existir
    const modal = document.getElementById("modalAprovacao");
    if (modal) modal.style.display = "none";
  }

  /* üîë garante acesso global */
  window.aprovarCotacaoDireto = aprovarCotacaoDireto;



  /* ======================================================
  üìä CALCULAR RANKING DE PRE√áOS POR ITEM
  ====================================================== */
  function calcularRankingPrecos(lista) {
    return lista
      .map((item, index) => ({ ...item, indexOriginal: index }))
      .sort((a, b) => a.preco - b.preco)
      .map((item, rank) => ({
        ...item,
        rank: rank + 1
      }));
  }

</script>

<script>
  /* ======================================================
     üëÅÔ∏è MODAL DE APROVA√á√ÉO ‚Äî FUN√á√ÉO GLOBAL FINAL (CORRIGIDO)
  ====================================================== */

  let cotacaoAprovacaoAtual = null;

  function abrirModalAprovacao(numero) {
    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === numero);
    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada");
      return;
    }

    const div = document.getElementById("conteudoAprovacao");
    if (!div) {
      console.error("‚ùå Elemento #conteudoAprovacao n√£o encontrado no DOM");
      alert("Erro interno: √°rea de aprova√ß√£o n√£o encontrada.");
      return;
    }

    cotacaoAprovacaoAtual = numero;
    div.innerHTML = "";

    /* üîπ MONTA CONTE√öDO DA COTA√á√ÉO */
    let total = 0;

    // Busca documentos para exibir √≠cone
    const idDoc = `docs_${cotacao.numero} `;
    const arquivosCotacao = JSON.parse(localStorage.getItem(idDoc)) || [];

    if (!Array.isArray(cotacao.adjudicacao) || cotacao.adjudicacao.length === 0) {
      div.innerHTML = "<p>‚ö†Ô∏è Nenhum item adjudicado.</p>";
    } else {
      let html = `
        <table style="width:100%;border-collapse:collapse;margin-top:10px;">
        <thead style="background:#661155;">
          <tr>
            <th>Item</th>
            <th>Marca</th>
            <th>Qtd</th>
            <th>Fornecedor</th>
            <th>Pre√ßo</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
    `;

      cotacao.adjudicacao.forEach(i => {
        const t = Number(i.total) || 0;
        total += t;

        // Verifica anexo
        const temAnexo = arquivosCotacao.some(arq => (arq.usuario || "").toLowerCase() === (i.fornecedor || "").toLowerCase());
        let iconAnexo = "";
        if (temAnexo) {
          iconAnexo = `<i class="fa-solid fa-paperclip" 
               style="font-size:12px; cursor:pointer; margin-left:6px; color:#3ab9b6;" 
               title="Ver anexo deste fornecedor"
               onclick="visualizarDocumentos('${cotacao.numero}', '${i.fornecedor}')"></i>`;
        }

        html += `
        <tr style="background:#1a1a1a; border-bottom: 1px solid #333;">
          <td>${i.produto}</td>
          <td>${i.marca || "-"}</td>
          <td>${i.quantidade}</td>
          <td>${i.fornecedor} ${iconAnexo}</td>
          <td>R$ ${Number(i.preco).toFixed(2)}</td>
          <td>R$ ${t.toFixed(2)}</td>
        </tr>
      `;
      });

      html += `
        </tbody>
      </table>
      <h3 style="margin-top:15px; text-align:right;">üí∞ Total Geral: R$ ${total.toFixed(2)}</h3>

      <!-- üìÇ BOT√ÉO CENTRAL DE ANEXOS (CONSIST√äNCIA) -->
      <div style="text-align:center; margin-top:20px; padding-top:15px; border-top:1px solid #444; display:none;">
      </div>
      `;

      div.innerHTML = html;
    }

    document.getElementById("modalAprovacao").style.display = "flex";
    document.body.style.overflow = "hidden"; // üîí Lock background scroll
  }

  function fecharModalAprovacao() {
    const modal = document.getElementById("modalAprovacao");
    if (modal) modal.style.display = "none";
    document.body.style.overflow = "auto"; // üîì Unlock background scroll
  }

  function aprovarCotacaoAtual() {
    if (!cotacaoAprovacaoAtual) return;

    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === cotacaoAprovacaoAtual);
    if (!cotacao) return;

    cotacao.status = "fechada";
    cotacao.dataAprovacao = new Date().toLocaleString();

    salvarCotacoes(cotacoes);

    alert("‚úÖ Cota√ß√£o aprovada com sucesso!");
    fecharModalAprovacao();
    carregarPendentesAprovacao();
  }



  /* ======================================================
     üì• CARREGAR COTA√á√ïES PENDENTES DE APROVA√á√ÉO
  ====================================================== */

  function carregarPendentesAprovacao() {
    const div = document.getElementById("listaPendentesAprovacao");
    if (!div) {
      console.warn("listaPendentesAprovacao n√£o encontrada");
      return;
    }

    const cotacoes = getCotacoes();

    const pendentes = cotacoes.filter(c =>
      c.status === "aprovacao" &&
      Array.isArray(c.adjudicacao) &&
      c.adjudicacao.length > 0
    );

    div.innerHTML = "";

    if (pendentes.length === 0) {
      div.innerHTML =
        "<p style='text-align:center;color:#aaa;'>Nenhuma cota√ß√£o pendente de aprova√ß√£o.</p>";
      return;
    }

    pendentes.forEach(c => {
      const total = c.adjudicacao.reduce(
        (s, i) => s + (Number(i.total) || 0),
        0
      );

      const bloco = document.createElement("div");
      bloco.className = "linha-cotacao";

      bloco.innerHTML = `
        <div class="info">
        <div style="font-weight:bold;font-size:15px;color:#fff;">
          ${c.descricao || "Sem descri√ß√£o"}
        </div>

        <div style="font-size:13px;color:#ccc;margin:4px 0 8px;">
          <strong>Cota√ß√£o #${c.numero}</strong>
        </div>

        <div style="font-size:13px;">
          Itens adjudicados: <b>${c.adjudicacao.length}</b><br>
          Total estimado: <b>R$ ${total.toFixed(2)}</b>
        </div>
      </div>

        <div class="acoes">
          <button class="btn-detalhes" data-numero="${c.numero}">
            üîé Detalhes
          </button>
        </div>
      `;

      const detalhes = document.createElement("div");
      detalhes.id = `detalhes - ${c.numero} `;
      detalhes.style.display = "none";
      detalhes.innerHTML = gerarHTMLDetalhesAprovacao(c);

      div.appendChild(bloco);
      div.appendChild(detalhes);

      /* üî• AQUI √© onde o evento DEVE ser ligado */
      detalhes.querySelectorAll(".btn-rejeitar").forEach(btn => {
        btn.addEventListener("click", function () {
          const numero = this.dataset.numero;
          abrirRejeicaoCotacao(numero);
        });
      });

      bloco.querySelector(".btn-detalhes").addEventListener("click", () => {
        toggleDetalhesAprovacao(c.numero);
      });
    });
  }


  function toggleDetalhesAprovacao(numero) {
    const el = document.getElementById(`detalhes - ${numero} `);
    if (!el) return;

    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function gerarHTMLDetalhesAprovacao(cotacao) {
    if (!Array.isArray(cotacao.adjudicacao) || cotacao.adjudicacao.length === 0) {
      return "<p>‚ö†Ô∏è Nenhum item adjudicado.</p>";
    }

    let total = 0;

    // üî• Gera UID para mapa de rejei√ß√£o (seguran√ßa para ID fantasma)
    if (!window.rejectionMap) window.rejectionMap = {};
    const safeID = (cotacao.numero || cotacao.id || ("RND" + Math.random())).toString().replace(/\W/g, '');
    const rejectionUID = safeID + "_" + Math.floor(Math.random() * 10000);
    window.rejectionMap[rejectionUID] = cotacao;

    // Busca documentos para exibir √≠cone
    const idDoc = `docs_${cotacao.numero}`;
    const arquivosCotacao = JSON.parse(localStorage.getItem(idDoc)) || [];

    let html = `
        <table style="width:100%;border-collapse:collapse;margin-bottom:15px;">
      <thead style="background:#661155;">
        <tr>
          <th style="width: 40px; text-align: center; padding:8px;">
            <input type="checkbox" id="checkAprovarTodos" checked onclick="toggleTodosAprovacao(this)" style="cursor:pointer; transform: scale(1.2);">
          </th>
          <th style="text-align:left; padding:8px;">Item</th>
          <th style="text-align:center; padding:8px;">Marca</th>
          <th style="text-align:center; padding:8px;">Qtd</th>
          <th style="text-align:left; padding:8px;">Fornecedor</th>
          <th style="text-align:right; padding:8px;">Pre√ßo</th>
          <th style="text-align:right; padding:8px;">Total</th>
        </tr>
      </thead>
      <tbody id="listaItensAprovacao">
  `;

    cotacao.adjudicacao.forEach((i, idx) => {
      const t = Number(i.total) || 0;
      total += t;

      // Verifica anexo
      const temAnexo = arquivosCotacao.some(arq => (arq.usuario || "").toLowerCase() === (i.fornecedor || "").toLowerCase());
      let iconAnexo = "";
      if (temAnexo) {
        iconAnexo = `<i class="fa-solid fa-paperclip" 
             style="font-size:12px; cursor:pointer; margin-left:6px; color:#3ab9b6;" 
             title="Ver anexo deste fornecedor"
             onclick="visualizarDocumentos('${cotacao.numero}', '${i.fornecedor}')"></i>`;
      }

      html += `
      <tr style="background:#1a1a1a; border-bottom: 1px solid #333;">
        <td style="text-align:center; padding:8px;">
            <input type="checkbox" class="check-item-aprovacao" data-index="${idx}" checked style="cursor:pointer; transform: scale(1.2);">
        </td>
        <td style="padding:8px; text-align:left;">${i.produto}</td>
        <td style="padding:8px; text-align:center;">${i.marca || "-"}</td>
        <td style="padding:8px; text-align:center;">${i.quantidade}</td>
        <td style="padding:8px; text-align:left;">
           <div style="font-weight:bold; color:#00ff99; display:flex; align-items:center; gap:5px;">
             <i class="fa-solid fa-trophy" style="color:#ffcc00;"></i> ${i.fornecedor} ${iconAnexo}
           </div>
        </td>
        <td style="padding:8px; text-align:right;">R$ ${Number(i.preco).toFixed(2)}</td>
        <td style="padding:8px; text-align:right;"><strong>R$ ${t.toFixed(2)}</strong></td>
      </tr>
      `;
    });

    html += `
      </tbody>
    </table>

    <h3 style="margin:10px 0;">
      üí∞ Total Geral: R$ ${total.toFixed(2)}
    </h3>

    <!-- üîò A√á√ïES -->
        <div style="
      display:grid !important;
      grid-template-columns: auto auto auto auto !important;
      gap:10px;
      margin-top:20px;
      justify-content:center;
      align-items: center;
      width: 100%;
      padding: 10px 0;
    ">

          <!-- üìÇ VER ANEXOS -->
          <button
            type="button"
            onclick="visualizarDocumentos('${cotacao.numero}')"
            style="
          background:#3ab9b6;
          color:white;
          border:none;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          font-weight:bold;
          display:flex; align-items:center; gap:6px;
          width: auto !important;
        ">
            <i class="fa-solid fa-folder-open"></i> Ver Anexos
          </button>

          <!-- üó∫Ô∏è MAPA DE PRE√áOS -->
          <button
            type="button"
            onclick="abrirMapaPrecos('${cotacao.numero}')"
            style="
          background:#333;
          color:white;
          border:1px solid #661155;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          width: auto !important;
        ">
            üó∫Ô∏è Mapa de Pre√ßos
          </button>

          <!-- ‚úî APROVAR -->
          <button
            type="button"
            onclick="aprovarCotacaoDireto('${cotacao.numero}')"
            style="
          background:#198754;
          color:white;
          border:none;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          width: auto !important;
        ">
            ‚úî Aprovar Itens Selecionados
          </button>

          <!-- ‚ùå REJEITAR -->
          <button
            type="button"
            class="btn-rejeitar"
            onclick="abrirRejeicaoCotacao('${rejectionUID}')"
            style="
          background:#842029;
          color:white;
          border:none;
          padding:10px 22px;
          border-radius:6px;
          cursor:pointer;
          width: auto !important;
        ">
            ‚ùå Rejeitar
          </button>
        </div>
      </div>
        `;

    return html;
  }

  // Helper para marcar/desmarcar todos
  window.toggleTodosAprovacao = function (source) {
    const checkboxes = document.querySelectorAll('.check-item-aprovacao');
    checkboxes.forEach(cb => cb.checked = source.checked);
  };

  // Fun√ß√£o de Aprova√ß√£o Parcial
  window.aprovarCotacaoDireto = function (numeroCotacao) {
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    const index = cotacoes.findIndex(c => c.numero === numeroCotacao || c.id === numeroCotacao);

    if (index === -1) return alert("Cota√ß√£o n√£o encontrada.");

    const cotacao = cotacoes[index];

    // Coleta √≠ndices marcados
    const checkboxes = document.querySelectorAll('.check-item-aprovacao');
    const indicesAprovados = [];
    checkboxes.forEach(cb => {
      if (cb.checked) {
        indicesAprovados.push(parseInt(cb.dataset.index));
      }
    });

    if (indicesAprovados.length === 0) {
      return alert("‚ö†Ô∏è Selecione pelo menos um item para aprovar.");
    }

    if (!confirm(`Confirma a aprova√ß√£o de ${indicesAprovados.length} item(ns)?\nOs itens N√ÉO selecionados ser√£o removidos do pedido.`)) {
      return;
    }

    // Filtra adjudica√ß√£o mantendo apenas os aprovados
    const novaAdjudicacao = cotacao.adjudicacao.filter((_, idx) => indicesAprovados.includes(idx));

    cotacao.adjudicacao = novaAdjudicacao;
    cotacao.status = "fechada";
    cotacao.dataAprovacao = new Date().toLocaleString();

    cotacoes[index] = cotacao;
    localStorage.setItem("cotacoes", JSON.stringify(cotacoes));

    alert("‚úÖ Cota√ß√£o aprovada com sucesso!");

    // Atualiza lista
    if (typeof carregarPendentesAprovacao === 'function') carregarPendentesAprovacao();

    // Fecha detalhes se aberto
    const detalhesDiv = document.getElementById(`detalhes-${cotacao.numero}`);
    if (detalhesDiv) detalhesDiv.style.display = "none";
  };


  /* ======================================================
     üìÑ ABRIR APROVA√á√ÉO DE COMPRAS
  ====================================================== */
  window.abrirAprovarCompras = function () {
    abrirTela("aprovarCompras");

    if (typeof carregarPendentesAprovacao === "function") {
      carregarPendentesAprovacao();
    }
  };


  /* ======================================================
     ‚ùå REJEITAR COTA√á√ÉO ‚Äî SOLU√á√ÉO DEFINITIVA
  ====================================================== */
  let cotacaoRejeicaoAtual = null; // Vari√°vel global para armazenar o n√∫mero

  function abrirRejeicaoCotacao(numero) {
    if (numero === "undefined" || numero === "null") numero = "";

    if (!numero) {
      // Tenta recuperar ID se j√° estiver salvo
      if (window.cotacaoRejeicaoAtual) {
        numero = window.cotacaoRejeicaoAtual;
        console.warn("Recuperado ID global:", numero);
      } else {
        alert("Aviso: ID da cota√ß√£o inv√°lido. Valor recebido: '" + numero + "'");
        return;
      }
    }

    // BACKUP GLOBAL (Para garantir)
    window.rejectionTargetID = numero;
    cotacaoRejeicaoAtual = numero;

    const modal = document.getElementById("modalRejeicaoAprovacao");

    if (modal) {
      modal.dataset.rejectionId = numero;

      if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
      }

      const campo = document.getElementById("motivoRejeicaoAprovacao");
      if (campo) campo.value = "";

      modal.removeAttribute("style");
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modal.style.zIndex = "2147483647";

      console.log("‚úÖ Modal aberto. ID:", modal.dataset.rejectionId);
    } else {
      alert("Erro interno: Modal de rejei√ß√£o n√£o encontrado.");
    }
  }
  // Torna a fun√ß√£o global para o bot√£o conseguir achar
  window.abrirRejeicaoCotacao = abrirRejeicaoCotacao;

  function confirmarRejeicaoAprovacao() {
    if (!cotacaoRejeicaoAtual) return;

    const campo = document.getElementById("motivoRejeicaoAprovacao");
    const motivo = campo.value.trim();
    if (!motivo) {
      alert("Informe o motivo da rejei√ß√£o.");
      return;
    }

    // üî• FIX: Acesso direto ao LocalStorage (devido a erro de refer√™ncia)
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    const index = cotacoes.findIndex(c => c.numero === cotacaoRejeicaoAtual || c.id === cotacaoRejeicaoAtual);

    if (index !== -1) {
      cotacoes[index].status = "reanalise";
      cotacoes[index].motivoRejeicao = motivo;
      cotacoes[index].dataRejeicao = new Date().toLocaleString(); // Adicionado data

      localStorage.setItem("cotacoes", JSON.stringify(cotacoes));
      alert("‚úÖ Cota√ß√£o rejeitada e devolvida para an√°lise.");
    } else {
      alert("Erro: Cota√ß√£o n√£o encontrada para rejei√ß√£o.");
    }

    const modal = document.getElementById("modalRejeicaoAprovacao");
    if (modal) {
      modal.style.display = "none";
      // Reset manual de estilos cr√≠ticos
      modal.style.opacity = "";
      modal.style.visibility = "";
      modal.style.zIndex = "";
    }

    document.body.style.overflow = "auto";
    cotacaoRejeicaoAtual = null;

    if (typeof carregarPendentesAprovacao === "function") {
      carregarPendentesAprovacao();
    }
  }



  window.abrirRejeicaoCotacao = abrirRejeicaoCotacao;
  window.confirmarRejeicaoAprovacao = confirmarRejeicaoAprovacao;


  /* ======================================================
     EXPANS√ÉO DE COLUNAS (TOGGLE FULL SCREEN)
  ====================================================== */
  window.toggleFocoRespostas = function () {
    // Alias para manter compatibilidade
    toggleExpansaoColunas();
  };

  window.toggleExpansaoColunas = function () {
    window.isColunasExpandidas = !window.isColunasExpandidas;
    configurarModalExpandido();

    // Re-renderiza tabela para ajustar colunas
    const numero = document.getElementById("analiseNumero").textContent.trim();
    if (numero) renderizarTabelaAnalise(numero);
  };

  function configurarModalExpandido() {
    const modal = document.getElementById("modalAnaliseCotacao");
    const icon = document.getElementById("iconExpandirGlobal");

    if (!modal) return;

    const content = modal.querySelector(".modal-content");

    if (window.isColunasExpandidas) {
      content.style.width = "98%";
      content.style.maxWidth = "none";
      content.style.height = "95vh";
      if (icon) icon.className = "fa-solid fa-compress";
    } else {
      content.style.width = "900px"; // Voltar ao normal
      content.style.maxWidth = "900px";
      content.style.height = "";
      if (icon) icon.className = "fa-solid fa-expand";
    }
  }


  function abrirMapaPrecos(numero) {
    console.log("üó∫Ô∏è abrirMapaPrecos chamado com:", numero);

    const modal = document.getElementById("modalMapaPrecos");
    const conteudo = document.getElementById("conteudoMapaPrecos");
    const cabecalho = document.getElementById("cabecalhoMapa");

    if (!modal || !conteudo || !cabecalho) {
      console.error("Elementos do mapa n√£o encontrados");
      return;
    }

    conteudo.innerHTML = "";
    cabecalho.innerHTML = "";

    const cotacoes = getCotacoes();
    const cotacao = cotacoes.find(c => c.numero === numero || c.id === numero);

    if (!cotacao) {
      conteudo.innerHTML = "<p style='color:#aaa;'>Cota√ß√£o n√£o encontrada.</p>";
      modal.style.display = "flex";
      return;
    }

    // Preenche Cabe√ßalho
    // Preenche Cabe√ßalho - Usando Flex para alinhar o bot√£o √† direita
    cabecalho.innerHTML = `
        <div> <strong>Cota√ß√£o:</strong> ${cotacao.numero}</div>
      <div><strong>Descri√ß√£o:</strong> ${cotacao.descricao || "Sem descri√ß√£o"}</div>
      <div><strong>Status:</strong> <span style="color:#00ff99;">${(cotacao.status || "aberta").toUpperCase()}</span></div>
      
      <div style="margin-left:auto; cursor:pointer;" onclick="fecharMapaPrecos()">
         <i class="fa-solid fa-times" style="font-size:28px; color:#ff4444;"></i>
      </div>
      `;

    /* ======================================================
       üî• CONSOLIDA RESPOSTAS
    ====================================================== */
    let respostas = [];
    if (Array.isArray(cotacao.respostasFornecedores)) {
      respostas = [...cotacao.respostasFornecedores];
    }

    for (let i = 0; i < localStorage.length; i++) {
      const chave = localStorage.key(i);
      if (chave.startsWith(`resposta_${cotacao.numero} _`)) {
        try {
          const r = JSON.parse(localStorage.getItem(chave));
          if (!respostas.some(x => x.email === r.email)) {
            respostas.push({
              fornecedor: r.fornecedor || r.fornecedorNome || "Fornecedor",
              email: r.email || r.emailFornecedor || "",
              itens: r.itens || r.precos || []
            });
          }
        } catch { }
      }
    }

    if (respostas.length === 0) {
      conteudo.innerHTML = `<div style="text-align:center;color:#aaa;margin-top:40px;">üó∫Ô∏è Nenhuma resposta enviada.</div>`;
      modal.style.display = "flex";
      return;
    }

    /* ======================================================
       üìä RENDER FINAL PREMIUM (ID√äNTICO √Ä EXPANS√ÉO)
    ====================================================== */
    const produtos = cotacao.produtos || [];
    const temVencedor = Array.isArray(cotacao.adjudicacao) && cotacao.adjudicacao.length > 0;

    let html = `
        <div class="wrapper-matriz modo-foco" style="margin-top:0;">
          <table class="matriz-cotacao">
            <thead>
              <tr>
                <th style="width:40px; text-align:center;"></th>
                <th class="col-idx" style="width:60px; text-align:center;">#</th>
                <th class="col-fixa">Item</th>
                <th class="col-fixa-2" style="text-align:center;">Qtd</th>
                `;

    respostas.forEach(r => {
      html += `<th>${r.fornecedor}</th>`;
    });

    if (temVencedor) {
      html += `<th style="background:#500a40; color:#00ff99;">üèÜ Escolhido</th>`;
    }

    html += `
              </tr>
            </thead>
            <tbody>
              `;

    produtos.forEach((prod, idx) => {
      const nomeProd = prod.nome || prod.descricao;
      const qtd = prod.quantidade || 0;

      html += `
              <tr>
                <td style="text-align:center;"></td>
                <td class="col-idx" style="text-align:center;">
                  <span class="badge-idx">#${idx + 1}</span>
                </td>
                <td class="col-fixa item">${nomeProd}</td>
                <td class="col-fixa-2 qtd" style="text-align:center;">${qtd}</td>
                `;

      // Pre√ßos e Ranking por Item
      const precosDesteItem = respostas.map(r => {
        const itemResp = (r.itens || []).find(i => (i.produto === nomeProd) || (i.nome === nomeProd));
        const preco = itemResp ? (Number(itemResp.preco) || Number(itemResp.valor) || 0) : 0;
        return { fornecedor: r.fornecedor, email: r.email, preco: preco };
      });

      const validos = precosDesteItem.filter(p => p.preco > 0);
      const precosOrdenados = [...validos].sort((a, b) => a.preco - b.preco);

      precosDesteItem.forEach(p => {
        const rankIndex = precosOrdenados.findIndex(x => x.preco === p.preco);
        const rank = (p.preco > 0 && rankIndex >= 0) ? rankIndex + 1 : null;

        let rankClass = "";
        if (rank === 1) rankClass = "rank-1";
        else if (rank === 2) rankClass = "rank-2";
        else if (rank === 3) rankClass = "rank-3";

        const badgeHtml = rank ? `<span class="rank-badge ${rankClass}">${rank}¬∫</span>` : '';
        const textClass = p.preco > 0 ? (rank === 1 ? "preco-melhor" : "") : "preco-neutro";

        html += `
                <td class="preco">
                  <div style="display:flex; align-items:center; justify-content:center;">
                    ${badgeHtml}
                    <span class="${textClass}" style="white-space:nowrap;">R$ ${p.preco.toFixed(2)}</span>
                  </div>
                </td>
                `;
      });

      // Se houver adjudica√ß√£o, mostrar quem foi o vencedor
      if (temVencedor) {
        const v = cotacao.adjudicacao.find(adj => adj.produto === nomeProd);
        if (v) {
          html += `
            <td class="acao" style="text-align:center; vertical-align:middle;">
              <div style="color:#00ff99; font-weight:bold; margin-bottom:5px;">
                <i class="fa-solid fa-trophy" style="color:#ffcc00; margin-right:4px;"></i> ${v.fornecedor}
              </div>
              <button onclick="visualizarDocumentos('${cotacao.numero}')" style="padding:4px 8px; font-size:11px; background:#3ab9b6; color:white; border:none; border-radius:4px; cursor:pointer;">
                üìÑ Ver Anexos
              </button>
            </td>
          `;
        } else {
          html += `<td class="acao"><span style="color:#666; font-size:11px;">N√£o adjundicado</span></td>`;
        }
      }

      html += `</tr>`;
    });

    html += `
            </tbody>
          </table>
    </div>
        `;

    conteudo.innerHTML = html;
    modal.style.display = "flex";

    // üî• BOT√ÉO DE FECHAR REDUNDANTE NO RODAP√â
    const btnFecharBottom = document.createElement("div");
    btnFecharBottom.innerHTML = `
        <div style="text-align:center; padding:20px; border-top:1px solid #333; background:#111;">
          <button onclick="fecharMapaPrecos()" style="background:#dc3545; color:white; border:none; padding:15px 40px; border-radius:8px; font-size:16px; cursor:pointer; font-weight:bold;">
            ‚ùå Fechar Mapa
          </button>
      </div>`;
    conteudo.appendChild(btnFecharBottom);

    modal.style.zIndex = "2147483647";
    document.body.style.overflow = "hidden"; // trava scroll
  }







  function fecharMapaPrecos() {
    const modal = document.getElementById("modalMapaPrecos");
    if (modal) modal.style.display = "none";
    document.body.style.overflow = "auto";
  }

  function toggleMotivoRejeicao() {
    const box = document.getElementById("boxMotivoRejeicao");
    const btn = document.getElementById("btnMotivoRejeicao");

    const fechado = getComputedStyle(box).display === "none";

    if (fechado) {
      box.style.display = "block";
      btn.innerText = "‚ùå Ocultar motivo da rejei√ß√£o";
    } else {
      box.style.display = "none";
      btn.innerText = "üìÑ Ver motivo da rejei√ß√£o";
    }
  }


  /* ======================================================
     ‚úî SELECIONAR FORNECEDOR (CORRETO)
  ====================================================== */
  function selecionarFornecedor(email) {
    document
      .querySelectorAll("input[name='fornecedorVencedor']")
      .forEach(r => {
        r.checked = normalizarEmail(r.value) === normalizarEmail(email);
      });
  }


  /* ======================================================
     ‚è≥ TOGGLE ‚Äì COTA√á√ïES RESPONDIDAS (CORRIGIDO)
     - Analise mostra: respondida + reanalise
  ====================================================== */
  // Toggling tabs - CORRIGIDO PARA FECHAR SE ESTIVER ABERTO
  window.toggleListaRespondidas = function (status) {

    // Mapeamento de status para IDs
    const map = {
      'publicadas': { listId: 'listaPublicadas', btnId: 'btnPublicadas' },
      'analise': { listId: 'listaAnalise', btnId: 'btnAnalise' },
      'aprovacao': { listId: 'listaAprovacao', btnId: 'btnAprovacao' },
      'fechada': { listId: 'listaFechadas', btnId: 'btnFechadas' }
    };

    const target = map[status];
    if (!target) return;

    const listEl = document.getElementById(target.listId);
    const btnEl = document.getElementById(target.btnId);

    // 1. Verifica se J√Å est√° aberto para fechar (Toggle OFF)
    if (listEl && listEl.style.display === "block") {
      listEl.style.display = "none";
      if (btnEl) btnEl.classList.remove("ativo");
      return; // Encerra aqui
    }

    // 2. Se n√£o estava aberto, fecha todos os outros primeiro
    Object.values(map).forEach(item => {
      const l = document.getElementById(item.listId);
      const b = document.getElementById(item.btnId);
      if (l) l.style.display = "none";
      if (b) b.classList.remove("ativo");
    });

    // 3. Abre o alvo (Toggle ON)
    if (listEl) {
      listEl.style.display = "block";
      if (btnEl) btnEl.classList.add("ativo");

      // L√≥gica espec√≠fica de carregamento para cada tipo
      if (status === "publicadas") {
        carregarRespondidas("aberta", listEl);
      } else if (status === "analise") {
        carregarRespondidas(["respondida", "reanalise", "analise"], listEl);
      } else if (status === "aprovacao") {
        carregarRespondidas("aprovacao", listEl);
      } else if (status === "fechada") {
        carregarRespondidas("fechada", listEl);
      }
    }
  };




  window.editarMaterial = function (index) {
    const materiais = JSON.parse(localStorage.getItem("materiais")) || [];
    const m = materiais[index];
    if (!m) return;

    document.getElementById("matNome").value = m.nome || "";
    document.getElementById("matCodigo").value = m.codigo || "";
    document.getElementById("matEmbalagem").value = m.embalagem || "";
    document.getElementById("matQtdEmb").value = m.qtdEmb || "";

    // remove para salvar novamente ao editar
    materiais.splice(index, 1);
    localStorage.setItem("materiais", JSON.stringify(materiais));

    // atualiza lista se estiver aberta
    if (document.getElementById("listaMateriais")?.style.display === "block") {
      mostrarListaMateriais();
    }

    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  ;

  function abrirSolicitacaoCompra() {
    limparFormularioSolicitacao(); // üßπ Sempre come√ßa limpo

    // Pr√©-preenche se o usu√°rio estiver logado
    const user = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (user && user.nome) {
      const el = document.getElementById("solSolicitante");
      if (el) el.value = user.nome;
    }

    abrirTela("solicitacaoCompra");
  }

  async function enviarSolicitacaoCompra() {
    const solicitante = document.getElementById("solSolicitante").value.trim();
    const setor = document.getElementById("solSetor").value.trim();
    const tipo = document.getElementById("solTipo").value;
    const descricao = document.getElementById("solDescricao").value.trim();
    const anexosInput = document.getElementById("solAnexos");

    if (!solicitante || !setor || !tipo) {
      alert("‚ö†Ô∏è Preencha os dados principais (Solicitante, Setor e Tipo).");
      return;
    }

    /* üì¶ ITENS */
    const itens = [];
    document.querySelectorAll("#listaItensSolicitacao > div").forEach(linha => {
      const inputs = linha.querySelectorAll("input");
      if (inputs.length >= 3) {
        const nome = inputs[0].value.trim();
        const marca = inputs[1].value.trim();
        const qtd = inputs[2].value;
        if (nome && qtd) {
          itens.push({ nome, marca: marca || "", quantidade: Number(qtd) });
        }
      }
    });

    // ‚è≥ EXIBIR LOADING
    const overlay = document.getElementById("loadingOverlay");
    const label = document.getElementById("loadingText");
    if (overlay) {
      overlay.style.display = "flex";
      label.innerText = "Preparando envio...";
    }

    /* üìé ANEXOS */
    const anexos = [];
    const novaSolicitacao = {
      id: "SC-" + Date.now(),
      solicitante,
      setor,
      tipo,
      descricao,
      itens,
      anexos,
      data: new Date().toLocaleString(),
      status: "pendente"
    };

    if (anexosInput && anexosInput.files.length > 0) {
      const totalFiles = anexosInput.files.length;

      for (let i = 0; i < totalFiles; i++) {
        const file = anexosInput.files[i];
        if (label) label.innerText = `Enviando anexo (${i + 1}/${totalFiles}): ${file.name}`;

        try {
          const path = `solicitacoes/${novaSolicitacao.id}/${Date.now()}_${file.name}`;
          const storageRef = storage.ref(path);
          const uploadTask = await storageRef.put(file);
          const downloadURL = await uploadTask.ref.getDownloadURL();

          anexos.push({
            nome: file.name,
            tipo: file.type,
            tamanho: (file.size / 1024).toFixed(2) + " KB",
            url: downloadURL
          });

          console.log(`‚úÖ Upload conclu√≠do: ${file.name}`);
        } catch (err) {
          console.error("‚ùå Erro no upload:", err);
          alert(`‚ö†Ô∏è Falha ao enviar o arquivo: ${file.name}. Ele n√£o ficar√° dispon√≠vel na nuvem.`);
        }
      }
    }

    // üî• SALVAMENTO FINAL
    if (label) label.innerText = "Sincronizando com a nuvem...";
    await salvarSolicitacaoFinal(novaSolicitacao);
  }




  async function salvarSolicitacaoFinal(novaSolicitacao) {
    const overlay = document.getElementById("loadingOverlay");

    try {
      // 1. SALVA NO LOCALSTORAGE (Sempre faz, para redund√¢ncia r√°pida)
      const solicitacoes = JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];
      solicitacoes.push(novaSolicitacao);
      localStorage.setItem("solicitacoes_compra", JSON.stringify(solicitacoes));

      // 2. SALVA NO FIRESTORE (A nuvem que todos veem)
      if (typeof db !== "undefined") {
        await db.collection("solicitacoes_compra").doc(novaSolicitacao.id).set(novaSolicitacao);
        console.log("‚úÖ Solicita√ß√£o sincronizada com Firebase!");
      }

      // 3. NOTIFICA√á√ÉO E SUCESSO
      notificarSolicitante(
        "Requisi√ß√£o Recebida üìù",
        `Ol√° ${novaSolicitacao.solicitante}, sua requisi√ß√£o foi criada e j√° est√° dispon√≠vel para o comprador.`
      );

      if (overlay) overlay.style.display = "none";
      alert("‚úÖ Solicita√ß√£o enviada com sucesso para a nuvem!");

      voltarMenu();
      limparFormularioSolicitacao();

    } catch (err) {
      console.error("‚ùå Erro cr√≠tico ao salvar:", err);
      if (overlay) overlay.style.display = "none";
      alert("‚ùå ERRO AO ENVIAR: A solicita√ß√£o n√£o p√¥de ser salva na nuvem. Verifique sua conex√£o ou tente novamente.");
    }
  }

  function limparFormularioSolicitacao() {
    console.log("üßπ Limpando formul√°rio de solicita√ß√£o de compra...");
    const ids = ["solSolicitante", "solSetor", "solTipo", "solDescricao", "solAnexos"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    const lista = document.getElementById("listaItensSolicitacao");
    if (lista) {
      lista.innerHTML = `
        <div style="display:grid; grid-template-columns:2fr 2fr 1fr auto; gap:10px; margin-bottom:10px;">
          <input placeholder="Nome do item">
          <input placeholder="Marca (opcional)">
          <input type="number" min="1" placeholder="Qtd">
          <button onclick="this.parentElement.remove()">üóëÔ∏è</button>
        </div>
      `;
    }
    console.log("‚úÖ Formul√°rio de solicita√ß√£o limpo.");
  }


  function adicionarItemSolicitacao() {
    const container = document.getElementById("listaItensSolicitacao");

    const div = document.createElement("div");
    div.style.display = "grid";
    div.style.gridTemplateColumns = "2fr 2fr 1fr auto";
    div.style.gap = "10px";
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <input class="item-nome" placeholder="Nome do item">
      <input class="item-marca" placeholder="Marca (opcional)">
      <input class="item-qtd" type="number" min="1" placeholder="Qtd">
      <button onclick="this.parentElement.remove()">üóëÔ∏è</button>
    `;

    container.appendChild(div);
  }




  function removerLinhaSolicitacao(btn) {
    btn.closest("tr").remove();
  }

  function importarSolicitacaoExcel() {
    document.getElementById("excelSolicitacao").click();
  }

  function processarExcelSolicitacao(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function (e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      rows.forEach(item => {
        const container = document.getElementById("listaItensSolicitacao");

        const div = document.createElement("div");
        div.style.display = "grid";
        div.style.gridTemplateColumns = "2fr 2fr 1fr auto";
        div.style.gap = "10px";
        div.style.marginBottom = "10px";
        div.innerHTML = `
              <input value="${item.nome || item.produto || ""}">
              <input value="${item.marca || ""}">
              <input type="number" value="${item.quantidade || 1}">
                <button onclick="this.parentElement.remove()">üóëÔ∏è</button>
                `;

        container.appendChild(div);
      });
    };

    reader.readAsArrayBuffer(file);
  }

  function abrirSolicitacoesCompra() {
    abrirTela("gestaoRequisicoes");
    carregarSolicitacoesCompra();
  }


  window.abrirSolicitacoesCompra = abrirSolicitacoesCompra;



  async function carregarSolicitacoesCompra() {
    const lista = document.getElementById("listaSolicitacoesCompra");
    if (!lista) return;

    // üîç BUSCA NO FIRESTORE
    let solicitacoes = [];
    try {
      if (typeof db !== "undefined") {
        const snapshot = await db.collection("solicitacoes_compra").get();
        solicitacoes = snapshot.docs.map(doc => doc.data());
        // Sincroniza local para compatibilidade s√≠ncrona se necess√°rio
        localStorage.setItem("solicitacoes_compra", JSON.stringify(solicitacoes));
      }
    } catch (e) {
      console.warn("Erro ao buscar solicita√ß√µes do Firebase, usando local:", e);
      solicitacoes = JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];
    }

    lista.innerHTML = "";

    if (solicitacoes.length === 0) {
      lista.innerHTML = `
      <p style="text-align:center; opacity:0.7;">
        Nenhuma solicita√ß√£o encontrada.
      </p>
    `;
      return;
    }

    solicitacoes.forEach(s => {
      const bloco = document.createElement("div");
      bloco.className = "linha-cotacao";

      const badge = typeof obterBadgeWorkflow === "function" ? obterBadgeWorkflow(s.status) : s.status;

      bloco.innerHTML = `
                <div class="info">
                  <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                    <strong>${s.solicitante}</strong>
                    ${badge}
                  </div>
                  <small>Setor: ${s.setor}</small><br>
                  <small>Tipo: ${s.tipo.toUpperCase()}</small><br>
                  <small>Data: ${s.data}</small>
                </div>
                <div class="acoes">
                  <button onclick="verDetalhesSolicitacao('${s.id}')">
                    üëÅÔ∏è Ver Detalhes
                  </button>
                </div>
                `;

      lista.appendChild(bloco);
    });
  }

  function verDetalhesSolicitacao(id) {
    const solicitacoes =
      JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];

    const sol = solicitacoes.find(s => s.id === id);
    if (!sol) return;

    // üîë guarda a solicita√ß√£o selecionada
    window.solicitacaoSelecionada = sol;

    const div = document.getElementById("conteudoDetalhesSolicitacao");


    const badge = typeof obterBadgeWorkflow === "function" ? obterBadgeWorkflow(sol.status) : sol.status;

    div.innerHTML = `
                      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                          <p><strong>ID:</strong> ${sol.id}</p>
                          <p><strong>Solicitante:</strong> ${sol.solicitante}</p>
                        </div>
                        <div style="text-align:right;">
                          ${badge}
                        </div>
                      </div>
                      
                      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <p><strong>Setor:</strong> ${sol.setor}</p>
                        <p><strong>Tipo:</strong> ${sol.tipo.toUpperCase()}</p>
                        <p><strong>Data:</strong> ${sol.data}</p>
                        <div>
                          <strong>Alterar Status:</strong>
                          <select onchange="mudarStatusSolicitacao('${sol.id}', this.value)" style="margin-left:10px; background:#111; color:white; border:1px solid #661155; border-radius:4px; padding:4px;">
                            <option value="pendente" ${sol.status === 'pendente' ? 'selected' : ''}>üìù Pendente</option>
                            <option value="em_cotacao" ${sol.status === 'em_cotacao' ? 'selected' : ''}>üîç Em Cota√ß√£o</option>
                            <option value="finalizada" ${sol.status === 'finalizada' ? 'selected' : ''}>‚úÖ Finalizada</option>
                          </select>
                        </div>
                      </div>

                      <hr style="border-color:#661155;margin:15px 0;">

                        <h3 style="color:#661155;">üìù Observa√ß√µes do Requisitante</h3>
                        <div style="
    background:#1a1a1a;
    border:1px solid #661155;
    border-radius:6px;
    padding:12px;
    margin-bottom:15px;
    white-space:pre-wrap;
    color:white;
  ">
                          ${sol.descricao && sol.descricao.trim()
        ? sol.descricao
        : "‚Äî Nenhuma observa√ß√£o informada ‚Äî"}
                        </div>

                        <hr style="border-color:#661155;margin:15px 0;">

                          <h3 style="color:#661155;">üì¶ Itens Solicitados</h3>
                          ${renderizarItensSolicitacao(sol)}

                          <hr style="border-color:#661155;margin:15px 0;">

                            <h3 style="color:#661155;">üìé Arquivos Anexados</h3>
                            ${renderizarArquivosSolicitacao(sol)}
                            `;


    // üî• AQUI ESTAVA O ERRO
    ajustarAcoesSolicitacaoPorPerfil();

    document.getElementById("modalDetalhesSolicitacao").style.display = "flex";
    document.body.style.overflow = "hidden"; // üîí Lock background scroll
  }

  function mudarStatusSolicitacao(id, novoStatus) {
    const solicitacoes = JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];
    const idx = solicitacoes.findIndex(s => s.id === id);

    if (idx !== -1) {
      solicitacoes[idx].status = novoStatus;
      localStorage.setItem("solicitacoes_compra", JSON.stringify(solicitacoes));

      console.log(`‚úÖ Status da solicita√ß√£o ${id} alterado para ${novoStatus}`);

      // Recarrega a lista se estiver aberta
      if (typeof carregarSolicitacoesCompra === "function") carregarSolicitacoesCompra();
      if (typeof carregarMinhasSolicitacoes === "function") carregarMinhasSolicitacoes();

      // Atualiza o badge no modal se estiver aberto
      const badgeCont = document.querySelector("#conteudoDetalhesSolicitacao div div:last-child");
      if (badgeCont && typeof obterBadgeWorkflow === "function") {
        badgeCont.innerHTML = obterBadgeWorkflow(novoStatus);
      }
    }
  }

  function toggleMinhasSolicitacoes() {
    const div = document.getElementById("listaMinhasSolicitacoes");
    if (!div) return;

    if (div.style.display === "none") {
      div.style.display = "block";
      carregarMinhasSolicitacoes();
    } else {
      div.style.display = "none";
    }
  }

  function carregarMinhasSolicitacoes() {
    const lista = document.getElementById("listaMinhasSolicitacoes");
    if (!lista) return;

    const solicitacoes = JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];
    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));

    if (!usuarioLogado) {
      lista.innerHTML = "<p style='text-align:center;'>Erro: Usu√°rio n√£o identificado.</p>";
      return;
    }

    // Filtra solicita√ß√µes do usu√°rio atual
    const minhas = solicitacoes.filter(s =>
      s.solicitante.toLowerCase() === (usuarioLogado.nome || "").toLowerCase() ||
      s.solicitante.toLowerCase() === (usuarioLogado.email || "").toLowerCase()
    );

    if (minhas.length === 0) {
      lista.innerHTML = "<p style='text-align:center; opacity:0.6; padding: 10px;'>Voc√™ ainda n√£o enviou nenhuma solicita√ß√£o.</p>";
      return;
    }

    lista.innerHTML = "";
    minhas.reverse().forEach(s => {
      const item = document.createElement("div");
      item.style.cssText = "background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";

      const badge = typeof obterBadgeWorkflow === "function" ? obterBadgeWorkflow(s.status) : s.status;

      item.innerHTML = `
        <div style="text-align:left;">
          <strong>${s.data}</strong><br>
          <small>${s.tipo.toUpperCase()} - ${s.itens ? s.itens.length : 0} itens</small>
        </div>
        <div style="text-align:right;">
          ${badge}
        </div>
      `;
      lista.appendChild(item);
    });
  }

  function fecharModalDetalhesSolicitacao() {
    document.getElementById("modalDetalhesSolicitacao").style.display = "none";
    document.body.style.overflow = "auto";
  }


  function renderizarItensSolicitacao(sol) {
    if (!Array.isArray(sol.itens) || sol.itens.length === 0) {
      return "<p>‚Äî Nenhum item manual informado.</p>";
    }

    let html = `
                            <table style="width:100%;border-collapse:collapse;">
                              <thead style="background:#661155;">
                                <tr>
                                  <th style="padding: 10px; text-align: left;">Item</th>
                                  <th style="padding: 10px; text-align: left;">Marca</th>
                                  <th style="padding: 10px; text-align: center;">Qtd</th>
                                </tr>
                              </thead>
                              <tbody>
                                `;

    sol.itens.forEach(i => {
      html += `
      <tr style="background:#1a1a1a; border-bottom: 1px solid #333;">
        <td style="padding: 10px; text-align: left;">${i.nome || "-"}</td>
        <td style="padding: 10px; text-align: left;">${i.marca || "-"}</td>
        <td style="padding: 10px; text-align: center;">${i.quantidade ?? i.qtd ?? "-"}</td>
      </tr>
    `;
    });

    html += "</tbody></table>";
    return html;
  }



  function renderizarArquivosSolicitacao(sol) {
    if (!Array.isArray(sol.anexos) || sol.anexos.length === 0) {
      return "<p>‚Äî Nenhum arquivo anexado.</p>";
    }

    return `
                            <ul>
                              ${sol.anexos.map((a, i) => `
        <li>
          <button onclick="abrirAnexoSolicitacao('${sol.id}', ${i})">
            üìÑ ${a.nome}
          </button>
        </li>
      `).join("")}
                            </ul>
                            `;
  }

  async function abrirAnexoSolicitacao(idSolicitacao, index) {
    const solicitacoes =
      JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];

    const sol = solicitacoes.find(s => s.id === idSolicitacao);
    if (!sol || !Array.isArray(sol.anexos) || !sol.anexos[index]) {
      alert("Arquivo n√£o encontrado.");
      return;
    }

    const anexo = sol.anexos[index];

    // ‚òÅÔ∏è PRIORIDADE: Firebase Storage URL
    if (anexo.url) {
      window.open(anexo.url, '_blank');
      return;
    }

    // üìÇ FALLBACK: LocalStorage / IndexedDB
    let base64 = anexo.base64;

    // Se n√£o estiver no localStorage, busca no IndexedDB
    if (!base64 && anexo.fileKey) {
      try {
        base64 = await dbDocs.buscar(anexo.fileKey);
      } catch (err) {
        console.error("Erro ao buscar no IndexedDB:", err);
      }
    }

    if (!base64) {
      alert(
        "‚ö†Ô∏è Conte√∫do do arquivo n√£o encontrado.\n" +
        "Pode ter sido enviado em uma vers√£o anterior ou o armazenamento local foi limpo."
      );
      return;
    }

    // Exibe o arquivo Base64
    const win = window.open();
    if (win) {
      win.document.write(`<iframe src="${base64}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
    } else {
      alert('üö´ Pop-up bloqueado! Permita pop-ups para visualizar o arquivo.');
    }
  }




  function fecharModalDetalhesSolicitacao() {
    document.getElementById("modalDetalhesSolicitacao").style.display = "none";
    document.body.style.overflow = "auto"; // üîì Unlock background scroll
  }


  function ajustarAcoesSolicitacaoPorPerfil() {
    const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
    const divAcoes = document.getElementById("acoesSolicitacao");

    if (!divAcoes || !usuario) return;

    if (usuario.tipo === "comprador" || usuario.tipo === "administrador") {
      divAcoes.style.display = "block";
    } else {
      divAcoes.style.display = "none";
    }
  }


  function criarCotacaoDaSolicitacao() {
    if (!window.solicitacaoSelecionada) {
      alert("Solicita√ß√£o n√£o encontrada.");
      return;
    }

    const sol = window.solicitacaoSelecionada;

    // üîç ATUALIZA STATUS PARA "EM COTA√á√ÉO"
    sol.status = "em_cotacao";
    const solicitacoes = JSON.parse(localStorage.getItem("solicitacoes_compra")) || [];
    const idx = solicitacoes.findIndex(s => s.id === sol.id);
    if (idx !== -1) {
      solicitacoes[idx].status = "em_cotacao";
      localStorage.setItem("solicitacoes_compra", JSON.stringify(solicitacoes));
    }

    // üîî NOTIFICA√á√ÉO: COTA√á√ÉO INICIADA
    notificarSolicitante(
      "Cota√ß√£o Iniciada üîç",
      `Novidades! O comprador iniciou a coleta de pre√ßos para o seu pedido de ${sol.tipo}. Estimamos um retorno em breve.`
    );

    // guarda a origem
    window.cotacaoOrigemSolicitacao = sol;

    fecharModalDetalhesSolicitacao();

    // üîë SEMPRE abre a cota√ß√£o MANUAL
    abrirCotacaoManual();
  }

  function limparOverlays() {
    document.querySelectorAll(".modal").forEach(m => {
      m.style.display = "none";
      m.style.zIndex = "1";
    });

    document.querySelectorAll(".wrapper-matriz.modo-foco").forEach(w => {
      w.classList.remove("modo-foco");
    });

    document.body.style.overflow = "auto";
  }

  window.fecharModalAnalise = function () {
    document.getElementById("modalAnaliseCotacao").style.display = "none";
    document.body.style.overflow = "auto"; // Restore scrolling
  };

  /* ======================================================
     ‚öôÔ∏è CONFIGURA√á√ïES (LOGO, ETC)
  ====================================================== */
  function previewLogo(input) {
    const preview = document.getElementById("previewLogo");
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.innerHTML = `<img src="${e.target.result}" style="max-height:100px; max-width:100%;">`;
        window.tempLogoBase64 = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function salvarConfiguracoes() {
    if (window.tempLogoBase64) {
      localStorage.setItem("logoBase64", window.tempLogoBase64);
      alert("‚úÖ Configura√ß√µes salvas com sucesso!");
    } else {
      alert("‚ö†Ô∏è Nenhuma altera√ß√£o pendente.");
    }
  }

  function removerLogo() {
    if (confirm("Deseja remover a logomarca personalizada?")) {
      localStorage.removeItem("logoBase64");
      document.getElementById("previewLogo").innerHTML = '<span style="color:#666;">Sem logo carregada</span>';
      window.tempLogoBase64 = null;
      alert("‚úÖ Logo removida.");
    }
  }

  // Intercepta a abertura de telas para carregar dados de config
  const originalVoltarMenu = window.voltarMenu;
  window.voltarMenu = function () {
    if (typeof originalVoltarMenu === "function") originalVoltarMenu();
  };

  function abrirTela(id) {
    if (typeof fecharTodasAsSecoes === "function") fecharTodasAsSecoes();

    // Esconde listas se existirem
    ["listaFornecedoresCadastrados", "listaMateriais", "listaServicos"].forEach(lid => {
      const el = document.getElementById(lid);
      if (el) el.style.display = "none";
    });

    const target = document.getElementById(id);
    if (target) {
      target.style.display = "block";

      // L√≥gica espec√≠fica por tela
      if (id === "configuracoes") {
        const saved = localStorage.getItem("logoBase64");
        const preview = document.getElementById("previewLogo");
        if (saved && preview) {
          preview.innerHTML = `<img src="${saved}" style="max-height:100px; max-width:100%;">`;
        } else if (preview) {
          preview.innerHTML = '<span style="color:#666;">Sem logo carregada</span>';
        }
      }
    }

    // üîë S√≥ esconde o dashboard se a tela de destino N√ÉO for o dashboard
    if (id !== "dashboard") {
      const db = document.getElementById("dashboard");
      if (db) db.style.display = "none";
    }
  }
  window.abrirTela = abrirTela;

  /* ======================================================
     üöÄ NOVAS FUNCIONALIDADES (AGENTIC IMPROVEMENTS)
  ====================================================== */

  /* 1. TRABALHE CONOSCO (AUTOCADASTRO) */
  window.abrirTrabalheConosco = function () {
    document.getElementById("login-container").style.display = "none";
    document.getElementById("trabalhe-conosco").style.display = "block";
  };

  window.voltarParaLogin = function () {
    document.getElementById("trabalhe-conosco").style.display = "none";
    document.getElementById("login-container").style.display = "flex";
  };

  window.enviarAutoCadastro = function () {
    const nome = document.getElementById("autoFornNome").value.trim();
    const cnpj = document.getElementById("autoFornCnpj").value.trim();
    const email = document.getElementById("autoFornEmail").value.trim();

    if (!nome || !cnpj || !email) {
      alert("Por favor, preencha nome, CNPJ e e-mail.");
      return;
    }

    const preCadastros = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    preCadastros.push({
      id: Date.now(),
      nome, cnpj, email,
      whats: document.getElementById("autoFornWhats").value,
      tipo: document.getElementById("autoFornTipo").value,
      banco: document.getElementById("autoFornBanco").value,
      data: new Date().toLocaleString(),
      status: "pendente"
    });

    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(preCadastros));
    alert("‚úÖ Proposta enviada! Nossa equipe analisar√° seus dados em breve.");
    voltarParaLogin();
  };

  /* 2. NOTIFICA√á√ïES SIMULADAS (WHATSAPP/E-MAIL) */
  window.dispararNotificacaoFornecedores = function (cotacao) {
    console.log("üöÄ [SIMULA√á√ÉO API] Enviando alertas para fornecedores...");

    cotacao.fornecedores.forEach(f => {
      const msg = `Ol√° ${f.nome || f}, voc√™ recebeu uma nova cota√ß√£o (${cotacao.numero}). Responda aqui: [LINK DIRETO]`;
      console.log(`üì° Enviando para ${f.email || f}: "${msg}"`);
    });

    mostrarNotificacaoToast("Notifica√ß√µes autom√°ticas enviadas aos fornecedores selecionados! ‚úâÔ∏èüì±");
  };

  window.notificarSolicitante = function (titulo, mensagem, tipoStatus = "pendente") {
    console.log(`üîî [NOTIFICA√á√ÉO] ${titulo}: ${mensagem}`);
    mostrarNotificacaoToast(`${titulo}: ${mensagem}`);
  };

  function mostrarNotificacaoToast(texto) {
    const toast = document.createElement("div");
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = "#661155";
    toast.style.color = "white";
    toast.style.padding = "15px 25px";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 4px 15px rgba(0,0,0,0.5)";
    toast.style.zIndex = "10000000";
    toast.textContent = texto;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  /* 3. GEST√ÉO DE DOCUMENTOS (NOTAS E BOLETOS) */


  /* 4. HELPER PARA STATUS DO WORKFLOW */
  window.obterBadgeWorkflow = function (status) {
    if (status === "pendente") return '<span class="status-pulsante status-pendente">üìù Pendente</span>';
    if (status === "em_cotacao") return '<span class="status-pulsante status-cotacao">üîç Em Cota√ß√£o</span>';
    if (status === "finalizada") return '<span class="status-pulsante status-finalizada">‚úÖ Finalizada</span>';
    return status;
  };

  /* ======================================================
     üè∞ CADASTRO DE FORNECEDOR (INTERNO)
  ====================================================== */
  window.abrirCadastroFornecedor = function () {
    fecharTodasAsSecoes();
    const tela = document.getElementById("cadastroFornecedor");
    if (tela) {
      tela.style.display = "block";
      alternarAbaFornecedor('manual');
    }
  };

  window.alternarAbaFornecedor = function (aba) {
    const manual = document.getElementById("conteudoFornManual");
    const aprovacao = document.getElementById("conteudoFornAprovacao");
    const btnManual = document.getElementById("btnAbaManual");
    const btnAprovacao = document.getElementById("btnAbaAprovacao");

    if (!manual || !aprovacao) return;

    if (aba === 'manual') {
      manual.style.display = "block";
      aprovacao.style.display = "none";
      if (btnManual) {
        btnManual.style.background = "#661155";
        btnManual.style.color = "white";
      }
      if (btnAprovacao) {
        btnAprovacao.style.background = "#333";
        btnAprovacao.style.color = "white";
      }
    } else {
      manual.style.display = "none";
      aprovacao.style.display = "block";
      if (btnManual) {
        btnManual.style.background = "#333";
        btnManual.style.color = "white";
      }
      if (btnAprovacao) {
        btnAprovacao.style.background = "#661155";
        btnAprovacao.style.color = "white";
      }
      if (typeof carregarPreCadastros === "function") carregarPreCadastros();
    }
  };

  window.salvarFornecedor = function () {
    const nome = document.getElementById("fornNome").value.trim();
    const cnpj = document.getElementById("fornCnpj").value.trim();
    const emails = document.getElementById("fornEmails").value.trim();

    if (!nome) return alert("‚ö†Ô∏è Informe o nome da empresa.");
    if (!emails) return alert("‚ö†Ô∏è Informe ao menos um e-mail de contato.");

    let lista = JSON.parse(localStorage.getItem("fornecedores")) || [];

    const novosDados = {
      nome,
      cnpj: cnpj || "",
      logradouro: document.getElementById("fornLogradouro").value.trim(),
      numero: document.getElementById("fornNumero").value.trim(),
      bairro: document.getElementById("fornBairro").value.trim(),
      cidade: document.getElementById("fornCidade").value.trim(),
      cep: document.getElementById("fornCep").value.trim(),
      telefone: document.getElementById("fornTelefone").value.trim(),
      whats: document.getElementById("fornWhats").value.trim(),
      emails: emails,
      responsavel: document.getElementById("fornResponsavel").value.trim(),
      tipo: document.getElementById("fornTipo").value
    };

    if (fornecedorEditando !== null) {
      lista[fornecedorEditando] = novosDados;
      fornecedorEditando = null;
      alert("‚úÖ Fornecedor atualizado com sucesso!");
    } else {
      lista.push(novosDados);
      alert("‚úÖ Fornecedor cadastrado com sucesso!");
    }

    localStorage.setItem("fornecedores", JSON.stringify(lista));
    limparFormFornecedor();

    if (typeof mostrarListaFornecedores === "function") {
      const listaDiv = document.getElementById("listaFornecedoresCadastrados");
      if (listaDiv && listaDiv.style.display === "block") {
        mostrarListaFornecedores(); // Re-renderiza para atualizar
        mostrarListaFornecedores(); // Abre novamente (j√° que mostrarLista √© um toggle)
      }
    }
  };

  window.limparFormFornecedor = function () {
    const campos = [
      "fornNome", "fornCnpj", "fornLogradouro", "fornNumero", "fornBairro",
      "fornCidade", "fornCep", "fornTelefone", "fornWhats", "fornEmails",
      "fornResponsavel", "fornTipo"
    ];
    campos.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    fornecedorEditando = null;
  };

  /* ======================================================
     üîó APROVA√á√ÉO DE AUTOCADASTRO (TRABALHE CONOSCO)
  ====================================================== */
  window.carregarPreCadastros = function () {
    const listaDiv = document.getElementById("listaFornPendentes");
    const badge = document.getElementById("badgeFornPendentes");
    if (!listaDiv) return;

    const preCadastros = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    const pendentes = preCadastros.filter(p => p.status === "pendente");

    // Badge
    if (badge) {
      badge.innerText = pendentes.length;
      badge.style.display = pendentes.length > 0 ? "inline-block" : "none";
    }

    listaDiv.innerHTML = "";

    if (pendentes.length === 0) {
      listaDiv.innerHTML = "<p style='text-align:center; opacity:0.6; padding:20px;'>Nenhuma solicita√ß√£o pendente.</p>";
      return;
    }

    pendentes.forEach(p => {
      const div = document.createElement("div");
      div.className = "linha-cotacao";
      div.style.marginBottom = "15px";
      div.style.border = "1px solid #333";
      div.style.padding = "15px";
      div.style.borderRadius = "8px";

      div.innerHTML = `
                            <div class="info">
                              <strong style="color:#661155; font-size:16px;">${p.nome}</strong><br>
                                <small>CNPJ: ${p.cnpj}</small><br>
                                  <small>E-mail: ${p.email} | WhatsApp: ${p.whats}</small><br>
                                    <small>Categoria: ${p.tipo}</small><br>
                                      <small>Data: ${p.data}</small>
                                    </div>
                                    <div class="acoes" style="margin-top:10px;">
                                      <button onclick="aprovarPreCadastro(${p.id})" style="background:#198754; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">‚úÖ Aprovar</button>
                                      <button onclick="rejeitarPreCadastro(${p.id})" style="background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; margin-left:5px;">‚ùå Rejeitar</button>
                                    </div>
      `;
      listaDiv.appendChild(div);
    });
  };

  window.aprovarPreCadastro = async function (id) {
    if (!confirm("Confirmar aprova√ß√£o deste fornecedor?")) return;

    let preCadastros = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    const index = preCadastros.findIndex(p => p.id === id);
    if (index === -1) return;

    const p = preCadastros[index];

    // 1. Move para a lista oficial de fornecedores
    let fornecedores = JSON.parse(localStorage.getItem("fornecedores")) || [];
    const novoForn = {
      id: Date.now(),
      nome: p.nome,
      cnpj: p.cnpj,
      emails: p.email,
      whats: p.whats,
      tipo: p.tipo,
      banco: p.banco,
      origem: "autocadastro",
      dataAprovacao: new Date().toLocaleString()
    };
    fornecedores.push(novoForn);
    localStorage.setItem("fornecedores", JSON.stringify(fornecedores));

    // 2. Cria usu√°rio de login para o fornecedor
    const novoUsuario = {
      nome: p.nome,
      email: p.email,
      senha: "123", // Senha padr√£o inicial
      tipo: "fornecedor"
    };
    let usuarios = JSON.parse(localStorage.getItem("usuarios_teste")) || [];
    usuarios.push(novoUsuario);
    localStorage.setItem("usuarios_teste", JSON.stringify(usuarios));

    // --- FIREBASE SYNC ---
    try {
      await db.collection("fornecedores").doc(String(novoForn.id)).set(novoForn);
      await db.collection("usuarios").doc(p.email.toLowerCase().trim()).set(novoUsuario);

      // Atualiza status no Firebase tamb√©m
      await db.collection("pre_cadastros_fornecedores").doc(String(id)).update({ status: "aprovado" });
    } catch (e) {
      console.warn("Erro ao sincronizar aprova√ß√£o no Firebase:", e);
    }

    // 3. Atualiza status do pr√©-cadastro
    preCadastros[index].status = "aprovado";
    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(preCadastros));

    alert("‚úÖ Fornecedor aprovado! Usu√°rio criado com sucesso na nuvem (E-mail: " + p.email + " / Senha: 123)");
    carregarPreCadastros();
  };

  window.rejeitarPreCadastro = function (id) {
    const motivo = prompt("Informe o motivo da rejei√ß√£o:");
    if (motivo === null) return;

    let preCadastros = JSON.parse(localStorage.getItem("pre_cadastros_fornecedores")) || [];
    const index = preCadastros.findIndex(p => p.id === id);
    if (index === -1) return;

    preCadastros[index].status = "rejeitado";
    preCadastros[index].motivoRejeicao = motivo;
    localStorage.setItem("pre_cadastros_fornecedores", JSON.stringify(preCadastros));

    alert("‚ùå Solicita√ß√£o rejeitada.");
    carregarPreCadastros();
  };


  /* ======================================================
     üß© FUN√á√ïES GLOBAIS DE VISUALIZA√á√ÉO
     (Adicionadas para corrigir erros de refer√™ncia)
  ====================================================== */
  window.isColunasExpandidas = false;

  function toggleExpansaoColunas() {
    window.isColunasExpandidas = !window.isColunasExpandidas;

    // Atualiza √≠cone global
    const icon = document.getElementById("iconExpandirGlobal");
    if (icon) {
      icon.className = window.isColunasExpandidas ? "fa-solid fa-compress" : "fa-solid fa-expand";
      icon.title = window.isColunasExpandidas ? "Contrair Visualiza√ß√£o" : "Expandir Visualiza√ß√£o";
    }

    // Expandir/Contrair Modal
    const analiseModal = document.getElementById("analiseCotacaoModal");
    if (analiseModal) {
      const content = analiseModal.querySelector(".modal-content");
      if (content) {
        content.style.maxWidth = window.isColunasExpandidas ? "98vw" : "1200px";
        content.style.width = window.isColunasExpandidas ? "98vw" : "90%";
      }
    }

    const ths = document.querySelectorAll(".matriz-cotacao th, .matriz-cotacao td");
    ths.forEach(el => {
      if (window.isColunasExpandidas) el.style.whiteSpace = "normal";
      else el.style.whiteSpace = "";
    });
  }

  function toggleDetalhesItem(idx) {
    console.log("Toggle detalhes para item " + idx);
    // Placeholder silencioso ou alerta opcional
  }

  /* ======================================================
     ‚ùå REJEI√á√ÉO V2 (FOR√áADO PARA IGNORAR ERRO)
  ====================================================== */
  window.fecharRejeicaoV2 = function () {
    const modal = document.getElementById("modalRejeicaoAprovacao");
    if (modal) {
      modal.style.display = "none";
      modal.style.opacity = "";
      modal.style.zIndex = "";
      modal.style.visibility = "";
    }
    document.body.style.overflow = "auto";
  };

  window.confirmarRejeicaoV2 = function () {
    const modal = document.getElementById("modalRejeicaoAprovacao");

    // Tenta obter ID de M√öLTIPLAS fontes para garantir
    let alvo = modal ? modal.dataset.rejectionId : null;
    if (!alvo) alvo = window.rejectionTargetID;
    if (!alvo) alvo = cotacaoRejeicaoAtual;

    console.log("üî• confirmarRejeicaoV2 CHAMADO! ID Final:", alvo);

    if (!alvo) {
      alert("Erro CR√çTICO: N√£o foi poss√≠vel identificar a cota√ß√£o.\nPor favor, recarregue a p√°gina e tente novamente.");
      return;
    }

    const campo = document.getElementById("motivoRejeicaoAprovacao");
    const motivo = campo.value.trim();
    if (!motivo) {
      alert("‚ö†Ô∏è Por favor, informe o motivo da rejei√ß√£o.");
      return;
    }

    // FIX: Acesso direto ao LocalStorage
    const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    const index = cotacoes.findIndex(c => c.numero === alvo || c.id === alvo);

    if (index !== -1) {
      cotacoes[index].status = "reanalise";
      cotacoes[index].motivoRejeicao = motivo;
      cotacoes[index].dataRejeicao = new Date().toLocaleString();

      localStorage.setItem("cotacoes", JSON.stringify(cotacoes));
      alert("‚úÖ Cota√ß√£o rejeitada com sucesso!");
    } else {
      alert("‚ùå Erro: Cota√ß√£o ID '" + alvo + "' n√£o encontrada no banco de dados.");
    }

    window.fecharRejeicaoV2();
    if (modal) modal.dataset.rejectionId = "";

    if (typeof carregarPendentesAprovacao === "function") {
      carregarPendentesAprovacao();
    }
  };

  /* ======================================================
     üîÑ REJEI√á√ÉO V3 (SAFE MAP OVERRIDE) - EXECUTADO POR √öLTIMO
  ====================================================== */
  window.abrirRejeicaoCotacao = function (input) {
    if (!input || input === "undefined" || input === "null") input = "";

    let numeroReal = input;

    // 1. Tenta achar via MAPA (UID)
    if (window.rejectionMap && window.rejectionMap[input]) {
      const c = window.rejectionMap[input];
      // Prioriza todas as variantes poss√≠veis de ID
      numeroReal = c.numero || c.id || c.codigo || c.cod || c._id || c.uuid;

      if (!numeroReal) {
        console.error("ERRO: Objeto no rejectionMap n√£o tem ID vis√≠vel", c);
      }
    }

    // 2. Fallback: Vari√°vel global antiga
    if (!numeroReal && window.cotacaoRejeicaoAtual) {
      numeroReal = window.cotacaoRejeicaoAtual;
    }

    // 3. Log para debug silencioso
    if (!numeroReal) {
      console.warn("abrirRejeicaoCotacao chamado com input vazio e sem fallback.");
      // N√£o alerta "undefined", apenas segue. Se confirmar, dar√° erro l√°.
    } else {
      // Salva globalmente
      window.rejectionTargetID = numeroReal;
      cotacaoRejeicaoAtual = numeroReal;
    }

    const modal = document.getElementById("modalRejeicaoAprovacao");
    if (modal) {
      modal.dataset.rejectionId = numeroReal || "";

      // Move e exibe
      if (modal.parentElement !== document.body) document.body.appendChild(modal);

      // Limpa campo
      const campo = document.getElementById("motivoRejeicaoAprovacao");
      if (campo) campo.value = "";

      // Exibe sem estilos hardcoded
      modal.removeAttribute("style");
      modal.style.display = "flex";

      // CSS Inline cr√≠tico
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.zIndex = "2147483647";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modal.style.backgroundColor = "rgba(0,0,0,0.8)";

      console.log("‚úÖ Modal V3 Aberto. ID:", numeroReal);
    } else {
      console.error("Erro: Modal de rejei√ß√£o n√£o encontrado (V3).");
    }
  };

  /**
   * üöÄ MOTOR DE MIGRA√á√ÉO PROFUNDA (FIREBASE CLOUD)
   * Migra dados do LocalStorage para Firestore e Storage (anexos).
   */
  async function migrarParaFirebaseCompleto() {
    console.log("üöÄ Iniciando migra√ß√£o para Firebase Cloud...");
    const statusDiv = document.createElement("div");
    statusDiv.style = "position:fixed; bottom:10px; right:10px; background:rgba(0,0,0,0.8); color:#00ff99; padding:10px; border-radius:5px; z-index:999999; font-size:12px; border:1px solid #00ff99;";
    statusDiv.innerHTML = "üì° Sincronizando com a nuvem...";
    document.body.appendChild(statusDiv);

    const colecoes = ["fornecedores", "materiais", "servicos", "cotacoes", "solicitacoes_compra", "usuarios", "pre_cadastros_fornecedores"];

    // 1. Sincronizar Tabelas Estruturais
    for (const col of colecoes) {
      try {
        // Mapeia chaves do LS para cole√ß√µes do Firebase (se diferente)
        let lsKey = col;
        if (col === "usuarios") lsKey = "usuarios_teste";

        const dados = JSON.parse(localStorage.getItem(lsKey)) || [];
        if (dados.length > 0) {
          statusDiv.innerText = `üì¶ Sincronizando ${col}...`;
          for (const item of dados) {
            const id = item.email || item.id || item.numero || `sync_${Date.now()}_${Math.random()}`;

            // üìé TRATAMENTO DE ANEXOS (Cota√ß√µes e Solicita√ß√µes)
            if ((col === "cotacoes" || col === "solicitacoes_compra") && item.anexos) {
              for (let anexo of item.anexos) {
                if (!anexo.url) {
                  let blob = null;

                  // Tenta Base64
                  if (anexo.base64) {
                    statusDiv.innerText = `‚òÅÔ∏è Subindo anexo: ${anexo.nome}...`;
                    blob = await fetch(anexo.base64).then(res => res.blob());
                    delete anexo.base64;
                  }
                  // Tenta IndexedDB (para Solicita√ß√µes)
                  else if (anexo.fileKey) {
                    statusDiv.innerText = `üì¶ Buscando anexo local: ${anexo.nome}...`;
                    const data = await dbDocs.buscar(anexo.fileKey);
                    if (data) {
                      blob = await fetch(data).then(res => res.blob());
                    }
                  }

                  if (blob) {
                    const path = col === "cotacoes" ? `cotacoes/${item.numero}/${anexo.nome}` : `solicitacoes/${item.id}/${anexo.nome}`;
                    const ref = storage.ref(path);
                    await ref.put(blob);
                    anexo.url = await ref.getDownloadURL();
                  }
                }
              }
            }
            // Usa e-mail como ID para usu√°rios para facilitar login
            const docId = col === "usuarios" ? String(item.email).toLowerCase().trim() : String(id);
            await db.collection(col).doc(docId).set(item);
          }
          localStorage.setItem(lsKey, JSON.stringify(dados)); // Salva com as novas URLs
          console.log(`‚úÖ Cole√ß√£o ${col} sincronizada.`);
        }
      } catch (e) {
        console.warn(`Erro ao sincronizar ${col}:`, e);
      }
    }

    // 2. Migrar Documentos Financeiros (docs_...)
    try {
      statusDiv.innerText = "üìÇ Migrando documentos financeiros...";
      const chaves = Object.keys(localStorage);
      for (const key of chaves) {
        if (key.startsWith("docs_")) {
          const arquivos = JSON.parse(localStorage.getItem(key)) || [];
          const numeroCotacao = key.replace("docs_", "");

          for (let arq of arquivos) {
            if (arq.base64 && !arq.url) {
              statusDiv.innerText = `‚òÅÔ∏è Subindo doc: ${arq.nome}...`;
              try {
                const blob = await fetch(arq.base64).then(res => res.blob());
                const ref = storage.ref(`financeiro/${numeroCotacao}/${Date.now()}_${arq.nome}`);
                await ref.put(blob);
                arq.url = await ref.getDownloadURL();
                delete arq.base64;
              } catch (e) { console.error("Erro upload doc manual", e); }
            }
          }
          await db.collection("documentos_cotacao").doc(key).set({ arquivos });
        }
      }
    } catch (e) { console.warn("Erro documentos financeiros:", e); }

    statusDiv.innerHTML = "‚úÖ Nuvem Sincronizada!";
    setTimeout(() => statusDiv.remove(), 5000);
    console.log("üèÅ Migra√ß√£o Firebase conclu√≠da.");
  }

  // ‚ö†Ô∏è DESATIVADO: Migra√ß√£o autom√°tica removida para evitar que dados deletados localmente reapare√ßam no Firestore.
  // A migra√ß√£o agora s√≥ deve ser feita via comando manual se estritamente necess√°rio.
  /*
  setTimeout(() => {
    if (typeof db !== "undefined" && getUsuarioLogado()) {
      migrarParaFirebaseCompleto();
    }
  }, 5000);
  */
  /* ======================================================
     üìß NOTIFICA√á√ïES VIA WEBHOOK (MAKE.COM)
  ====================================================== */

  // URL do webhook Make.com
  const WEBHOOK_URL_NOTIFICACAO = "https://hook.us2.make.com/88kkwk8fhnwxq8hxpjl1uda6ikqqv6xk";

  /**
   * Envia notifica√ß√£o via webhook quando cota√ß√£o √© publicada
   * @param {Object} cotacao - Objeto da cota√ß√£o publicada
   */
  window.enviarNotificacaoCotacao = async function (cotacao) {
    try {
      console.log("üìß Enviando notifica√ß√µes para cota√ß√£o:", cotacao.numero);

      const fornecedores = (cotacao.fornecedores || []).map(f => ({
        nome: f.nome || f.fornecedor || "Fornecedor",
        email: f.email || "",
        whatsapp: f.whatsapp || f.telefone || ""
      }));

      const fornecedoresValidos = fornecedores.filter(f => f.email && f.email.includes('@'));

      if (fornecedoresValidos.length === 0) {
        console.warn("‚ö†Ô∏è Nenhum fornecedor com e-mail v√°lido encontrado para notificar.");
        return false;
      }

      const payload = {
        tipo: "nova_cotacao",
        numero: cotacao.numero || cotacao.id,
        descricao: cotacao.descricao || "Cota√ß√£o sem descri√ß√£o",
        dataFechamento: cotacao.dataFechamento || "N√£o definido",
        fornecedores: fornecedoresValidos,
        link: window.location.origin,
        mensagem: `Nova cota√ß√£o ${cotacao.numero || cotacao.id} dispon√≠vel. Prazo: ${cotacao.dataFechamento || 'N√£o definido'}`
      };

      console.log("üì§ Payload Notifica√ß√£o:", payload);

      // Usando no-cors ou cors dependendo da config do Make, mas POST simples costuma funcionar
      const response = await fetch(WEBHOOK_URL_NOTIFICACAO, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        console.log("‚úÖ Notifica√ß√µes enviadas com sucesso!");
        return true;
      } else {
        console.warn("‚ö†Ô∏è Erro ao enviar notifica√ß√µes (status):", response.statusText);
        return false;
      }
    } catch (erro) {
      console.error("‚ùå Erro ao enviar notifica√ß√µes:", erro);
      return false;
    }
  };

  /* ======================================================
     üîá SILENCIAR ERROS DE COTA (UX MELHORADA)
  ====================================================== */
  try {
    if (typeof firebase !== 'undefined' && firebase.firestore) {
      firebase.firestore.setLogLevel('silent');
      console.log("üîï Logs do Firestore silenciados com sucesso.");
    }
  } catch (e) {
    console.log("‚ÑπÔ∏è Info: N√£o foi poss√≠vel configurar log level.");
  }

  /* ======================================================
     üöÄ FIX DEFINITIVO (V2) - NON-BLOCKING PUBLISH
  ====================================================== */
  async function publicarCotacaoV2(tipo = "manual") {
    console.log("üöÄ Iniciando publica√ß√£o V2 (Robust Sync)...");
    let fechamento = "";
    let produtos = [];
    let descricao = "";

    // 1. COLETA DE DADOS (C√≥pia da l√≥gica original)
    if (tipo === "excel") {
      fechamento = document.getElementById("dataFechamentoExcel")?.value;
      descricao = document.getElementById("descricaoCotacaoExcel")?.value.trim();
      document.querySelectorAll("#tabelaCotacaoExcelCorpo tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds[1]?.innerText && tds[3]?.innerText) {
          produtos.push({ nome: tds[1].innerText, marca: tds[2]?.innerText || "-", quantidade: Number(tds[3].innerText) });
        }
      });
    } else if (tipo === "manual") {
      fechamento = document.getElementById("dataFechamentoManual")?.value;
      descricao = document.getElementById("descricaoCotacaoManual")?.value.trim();
      document.querySelectorAll("#tabelaManualCorpo tr").forEach(tr => {
        const inputs = tr.querySelectorAll("input");
        if (inputs[0]?.value && inputs[2]?.value) {
          produtos.push({ nome: inputs[0].value, marca: inputs[1]?.value || "-", quantidade: Number(inputs[2].value) });
        }
      });
    } else if (tipo === "materiais") {
      fechamento = document.getElementById("dataFechamentoMateriais")?.value;
      descricao = document.getElementById("descricaoCotacaoMateriais")?.value.trim();
      document.querySelectorAll("#listaMateriaisCotacao input[type='number']").forEach(inp => {
        if (Number(inp.value) > 0) {
          produtos.push({ nome: inp.dataset.nome, marca: inp.dataset.marca || "-", quantidade: Number(inp.value) });
        }
      });
    } else if (tipo === "servicos") {
      fechamento = document.getElementById("dataFechamentoServicos")?.value;
      descricao = document.getElementById("descricaoCotacaoServicos")?.value.trim();
      document.querySelectorAll("#listaServicosCotacao input[type='number']").forEach(inp => {
        if (Number(inp.value) > 0) {
          produtos.push({ nome: inp.dataset.nome, marca: "-", quantidade: Number(inp.value) });
        }
      });
    }

    // 2. VALIDA√á√ïES
    if (!fechamento) return alert("‚ö†Ô∏è Preencha a data e hora de fechamento!");
    if (produtos.length === 0) return alert("‚ö†Ô∏è Informe ao menos um item!");
    const fornecedores = window.fornecedoresSelecionadosTemp || [];
    if (fornecedores.length === 0) return alert("‚ö†Ô∏è Selecione ao menos um fornecedor!");

    if (!numeroCotacaoAtual) numeroCotacaoAtual = "COT-" + Date.now();

    // üîó ANEXOS
    let anexosHerdados = [];
    if (window.cotacaoOrigemSolicitacao && Array.isArray(window.cotacaoOrigemSolicitacao.anexos)) {
      anexosHerdados = window.cotacaoOrigemSolicitacao.anexos;
    }

    const novaCotacao = {
      id: numeroCotacaoAtual,
      numero: numeroCotacaoAtual,
      tipo: tipo,
      descricao: (descricao && descricao.length > 0) ? descricao : "Sem descri√ß√£o",
      dataCriacao: new Date().toLocaleString(),
      dataFechamento: fechamento,
      fornecedores: fornecedores,
      produtos: produtos,
      anexos: anexosHerdados,
      idSolicitacao: window.cotacaoOrigemSolicitacao ? window.cotacaoOrigemSolicitacao.id : null,
      status: "aberta"
    };

    // üîí BLOQUEIO DE UI
    const btnSalvar = document.activeElement;
    let textoOriginal = "";
    if (btnSalvar && btnSalvar.tagName === "BUTTON") {
      textoOriginal = btnSalvar.innerText;
      btnSalvar.disabled = true;
      btnSalvar.innerText = "‚òÅÔ∏è Enviando para Fornecedores...";
    }

    try {
      // ‚úÖ 1. LOCAL (Imediato - Backup)
      const cotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
      cotacoes.push(novaCotacao);
      localStorage.setItem("cotacoes", JSON.stringify(cotacoes));
      console.log("‚úÖ V2: Backup local salvo.");

      // ‚òÅÔ∏è 2. REALTIME DATABASE (R√°pido e confi√°vel)
      console.log("üîÑ Enviando para Realtime Database...");

      if (typeof rtdb !== "undefined") {
        try {
          console.log(`üì§ Enviando cota√ß√£o ${novaCotacao.numero} para RTDB...`);
          await rtdb.ref("cotacoes/" + novaCotacao.numero).set(novaCotacao);
          console.log("‚úÖ V2: Sincroniza√ß√£o RTDB CONFIRMADA.");

          alert("‚úÖ Cota√ß√£o publicada com sucesso!\n\nOs fornecedores podem visualizar agora.");
        } catch (errSync) {
          console.error("‚ùå ERRO AO ENVIAR PARA RTDB:", errSync);
          alert(`‚ùå Erro ao publicar:\n\n${errSync.message}\n\nVerifique sua conex√£o e tente novamente.`);

          if (btnSalvar && btnSalvar.tagName === "BUTTON") {
            btnSalvar.disabled = false;
            btnSalvar.innerText = textoOriginal;
          }
          return;
        }
      } else {
        console.error("‚ùå RTDB N√ÉO INICIALIZADO!");
        alert("‚ùå ERRO: Realtime Database n√£o inicializado.");

        if (btnSalvar && btnSalvar.tagName === "BUTTON") {
          btnSalvar.disabled = false;
          btnSalvar.innerText = textoOriginal;
        }
        return;
      }

      // üîî 3. NOTIFICA√á√ÉO (Tentativa)
      if (typeof enviarNotificacaoCotacao === "function") {
        try {
          await enviarNotificacaoCotacao(novaCotacao);
        } catch (errNotif) {
          console.error("Erro no envio de notifica√ß√£o (ignorado):", errNotif);
        }
      }

      // 4. LIMPEZA E UI
      window.fornecedoresSelecionadosTemp = [];
      numeroCotacaoAtual = null;

      limparFormulariosCotacao();

      // Volta ao painel sem recarregar (evita logout)
      const loginContainer = document.getElementById("login-container");
      const dashboardEl = document.getElementById("dashboard");
      if (loginContainer) loginContainer.style.display = "none";
      if (dashboardEl) dashboardEl.style.display = "block";
      // Esconde se√ß√µes de cria√ß√£o de cota√ß√£o
      ["nova-cotacao", "novaCotacao", "secao-cotacao", "criar-cotacao"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
      document.querySelectorAll("section.secao").forEach(s => s.style.display = "none");
      if (dashboardEl) dashboardEl.style.display = "block";

    } catch (e) {
      console.error("Erro FATAL V2:", e);
      alert("‚ùå Erro ao publicar: " + e.message + "\n\nVerifique sua conex√£o e tente novamente. Se persistir, contate o suporte.");

      if (btnSalvar && btnSalvar.tagName === "BUTTON") {
        btnSalvar.disabled = false;
        btnSalvar.innerText = textoOriginal;
      }
    }
  }

  // üõ°Ô∏è STUB NOTIFICA√á√ÉO (Para evitar crash se n√£o existir)
  if (typeof enviarNotificacaoCotacao === "undefined") {
    window.enviarNotificacaoCotacao = async function (cot) {
      console.log("üîî [SIMULA√á√ÉO] Enviando e-mail para:", cot.fornecedores.map(f => f.email));
      // Aqui entraria a chamada fetch para seu Webhook (n8n, make, zapier, etc)
      return true;
    }
  }

  // üîÑ OVERRIDE RUNTIME
  window.publicarCotacao = publicarCotacaoV2;

  // üõ°Ô∏è HELPER GET (Garante lista)
  window.getCotacoes = function () {
    try {
      return JSON.parse(localStorage.getItem("cotacoes")) || [];
    } catch (e) { return []; }
  };
  console.log("üöÄ PATCH V2 APLICADO: Funcionalidade de publica√ß√£o otimizada.");

  /* ======================================================
     üÜò FUN√á√ÉO DE EMERG√äNCIA - RECUPERAR COTA√á√ïES PERDIDAS
     ====================================================== */
  window.recuperarCotacoes = async function () {
    const local = JSON.parse(localStorage.getItem("cotacoes")) || [];

    if (local.length === 0) {
      console.log("‚úÖ Nenhuma cota√ß√£o local para recuperar.");
      return;
    }

    console.log(`üîÑ Tentando enviar ${local.length} cota√ß√µes para Firestore...`);
    let ok = 0, fail = 0;

    for (const cot of local) {
      try {
        await rtdb.ref("cotacoes/" + cot.numero).set(cot);
        console.log(`‚úÖ ${cot.numero} enviado`);
        ok++;
      } catch (e) {
        console.error(`‚ùå ${cot.numero} falhou:`, e.code, e.message);
        fail++;
      }
    }

    console.log(`\nüìä RESULTADO:\n‚úÖ Sucesso: ${ok}\n‚ùå Falha: ${fail}`);

    if (ok > 0) {
      alert(`‚úÖ ${ok} cota√ß√µes enviadas!\n\nRecarregue a p√°gina para atualizar.`);
    } else {
      alert(`‚ùå Todas falharam.\n\nVerifique sua conex√£o com a internet.`);
    }
  };
  console.log("üÜò EMERG√äNCIA: Digite 'recuperarCotacoes()' no Console para for√ßar envio.");



  /* ======================================================
     üì§ SALVAR RESPOSTA DO FORNECEDOR (CORRIGIDO V3)
     ====================================================== */
  async function salvarRespostaComAnexo() {
    console.log("üöÄ Iniciando envio de resposta...");

    // 1. Identificar Usu√°rio Logado
    const usuario = JSON.parse(sessionStorage.getItem("usuario_logado"));
    if (!usuario) {
      alert("‚ö†Ô∏è Voc√™ precisa estar logado para responder.");
      return;
    }

    // 2. Identificar Cota√ß√£o
    const numCotacao = document.getElementById("respNumero").textContent.trim();
    if (!numCotacao) {
      alert("Erro ao identificar o n√∫mero da cota√ß√£o.");
      return;
    }

    let todasCotacoes = JSON.parse(localStorage.getItem("cotacoes")) || [];
    let cotacaoIndex = todasCotacoes.findIndex(c => String(c.numero) === String(numCotacao) || String(c.id) === String(numCotacao));
    let cotacao = todasCotacoes[cotacaoIndex];

    if (!cotacao) {
      alert("Cota√ß√£o n√£o encontrada na base local.");
      return;
    }

    // 3. Coletar Itens da Tabela
    const linhas = document.querySelectorAll("#tabelaResponderCorpo tr");
    let itensRespondidos = [];

    linhas.forEach(tr => {
      const cells = tr.querySelectorAll("td");
      if (cells.length >= 3) {
        const produto = cells[0].innerText.trim();
        const input = tr.querySelector("input");
        const preco = parseFloat(input.value) || 0;

        if (preco > 0) {
          itensRespondidos.push({
            produto: produto,
            nome: produto,
            preco: preco,
            valor: preco
          });
        }
      }
    });

    if (itensRespondidos.length === 0) {
      alert("‚ö†Ô∏è Preencha o pre√ßo de pelo menos um item.");
      return;
    }

    // 4. Upload de Anexo (Best Effort - Async)
    const fileInput = document.getElementById("respAnexo");
    let anexoDados = { nome: "", url: "" };

    // Upload separado para n√£o travar o fluxo caso demore
    let uploadPromise = Promise.resolve(null);

    if (fileInput && fileInput.files.length > 0) {
      const arquivo = fileInput.files[0];
      anexoDados.nome = arquivo.name;

      if (typeof storage !== "undefined") {
        const path = `respostas/${cotacao.numero}/${Date.now()}_${arquivo.name}`;
        const ref = storage.ref(path);
        uploadPromise = ref.put(arquivo)
          .then(task => task.ref.getDownloadURL())
          .then(url => {
            anexoDados.url = url;
            console.log("‚úÖ Anexo enviado:", url);
            return url;
          })
          .catch(err => {
            console.warn("‚ö†Ô∏è Falha upload anexo (Quota?):", err);
            return "";
          });
      }
    }

    // O objeto de resposta base (sem URL de anexo ainda se o upload estiver rodando)
    // Mas para UX imediata, salvamos assim mesmo. O anexo pode atualizar depois na nuvem.
    const resposta = {
      fornecedor: usuario.nome || usuario.razaoSocial || usuario.email.split('@')[0],
      fornecedorNome: usuario.nome || usuario.razaoSocial,
      email: usuario.email,
      emailFornecedor: usuario.email,
      data: new Date().toLocaleString(),
      itens: itensRespondidos,
      anexo: anexoDados, // URL ser√° vazia se n√£o esperar
      anexos: [anexoDados]
    };

    // 5. ATUALIZA√á√ÉO LOCAL ROBUSTA (CR√çTICO PARA MUDAR DE ABA)
    // Salva caches individuais
    const chave = `res_${cotacao.id}_${usuario.email.toLowerCase().trim()}`;
    const chave2 = `resposta_${cotacao.numero}_${usuario.email.toLowerCase().trim()}`;
    localStorage.setItem(chave, JSON.stringify(resposta));
    localStorage.setItem(chave2, JSON.stringify(resposta));

    // ATUALIZA ARRAY NA COTA√á√ÉO VIVA (Fundamental para carregarCotacoes funcionar)
    if (!Array.isArray(cotacao.respostasFornecedores)) {
      cotacao.respostasFornecedores = [];
    }
    // Remove resposta anterior do mesmo user se houver (para update)
    cotacao.respostasFornecedores = cotacao.respostasFornecedores.filter(r =>
      normalizarEmail(r.email) !== normalizarEmail(usuario.email)
    );
    cotacao.respostasFornecedores.push(resposta);

    // Salva cota√ß√£o atualizada no LS
    todasCotacoes[cotacaoIndex] = cotacao;
    localStorage.setItem("cotacoes", JSON.stringify(todasCotacoes));

    console.log("‚úÖ Resposta salva e vinculada localmente.");

    // 6. UI FEEDBACK IMEDIATO (Otimista)
    alert("‚úÖ Resposta enviada com sucesso!");

    // Fecha modal e atualiza tela
    const modal = document.getElementById("modalResponder");
    if (modal) modal.style.display = 'none';
    document.body.style.overflow = "auto";

    // For√ßa atualiza√ß√£o da listagem
    if (typeof mostrarAbaCotacao === 'function') {
      mostrarAbaCotacao('respondidas');
    }

    // 7. SYNC CLOUD (BACKGROUND PROMISES)
    // N√£o usamos AWAIT aqui para n√£o travar a UI
    // Primeiro tenta o upload (se houver), depois o firestore
    uploadPromise.then(urlAnexo => {
      if (urlAnexo) resposta.anexo.url = urlAnexo; // Atualiza URL se sucesso

      if (typeof db !== "undefined" && firebase) {
        const docRef = db.collection("cotacoes").doc(String(cotacao.numero));

        // Tenta update no array
        docRef.update({
          respostasFornecedores: firebase.firestore.FieldValue.arrayUnion(resposta)
        })
          .then(() => console.log("‚òÅÔ∏è Sync Cloud: Sucesso"))
          .catch(err => console.warn("‚òÅÔ∏è Sync Cloud: Falha silenciosa (Quota/Rede)", err));
      }
    });
  }

  // Torna global explicitamente
  window.salvarRespostaComAnexo = salvarRespostaComAnexo;

  /* ======================================================
     ‚úèÔ∏è HABILITAR EDI√á√ÉO DE RESPOSTA (MISSING FUNCTION RESTORED)
     ====================================================== */
  function habilitarEdicaoResposta() {
    const btnEdit = document.getElementById("btnEditarResposta");
    const btnSend = document.getElementById("btnEnviarResposta");

    if (btnEdit) btnEdit.style.display = 'none';
    if (btnSend) btnSend.style.display = 'inline-block';

    const inputs = document.querySelectorAll("#tabelaResponderCorpo input");
    inputs.forEach(inp => inp.disabled = false);

    const fileInput = document.getElementById("respAnexo");
    if (fileInput) fileInput.disabled = false;
  }
  window.habilitarEdicaoResposta = habilitarEdicaoResposta;

  /* ======================================================
     ‚ùå FECHAR MODAL DE RESPOSTA (MISSING FUNCTION RESTORED)
     ====================================================== */
  function fecharModalResponder() {
    const modal = document.getElementById("modalResponder");
    if (modal) modal.style.display = 'none';
    document.body.style.overflow = "auto";
  }
  window.fecharModalResponder = fecharModalResponder;

</script>


<script src="premium_render.js?v=10015"></script>
</body>

</html>